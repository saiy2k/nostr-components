var je=Object.defineProperty;var qe=(t,e,n)=>e in t?je(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var g=(t,e,n)=>qe(t,typeof e!="symbol"?e+"":e,n);var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var lib$1={},types={};Object.defineProperty(types,"__esModule",{value:!0});var ee={},taskCollection$1={},taskCollection={},utils$1={};Object.defineProperty(utils$1,"__esModule",{value:!0});utils$1._fast_remove_single=void 0;function _fast_remove_single(t,e){e!==-1&&(e===0?t.shift():e===t.length-1?t.length=t.length-1:t.splice(e,1))}utils$1._fast_remove_single=_fast_remove_single;var bakeCollection={};(function(exports$1){Object.defineProperty(exports$1,"__esModule",{value:!0}),exports$1.bakeCollectionVariadic=exports$1.bakeCollectionAwait=exports$1.bakeCollection=exports$1.BAKED_EMPTY_FUNC=void 0,exports$1.BAKED_EMPTY_FUNC=function(){};var FORLOOP_FALLBACK=1500;function generateArgsDefCode(t){var e="";if(t===0)return e;for(var n=0;n<t-1;++n)e+="arg"+String(n)+", ";return e+="arg"+String(t-1),e}function generateBodyPartsCode(t,e){for(var n="",s="",r=0;r<e;++r)n+="var f".concat(r," = collection[").concat(r,`];
`),s+="f".concat(r,"(").concat(t,`)
`);return{funcDefCode:n,funcCallCode:s}}function generateBodyPartsVariadicCode(t){for(var e="",n="",s=0;s<t;++s)e+="var f".concat(s," = collection[").concat(s,`];
`),n+="f".concat(s,`.apply(undefined, arguments)
`);return{funcDefCode:e,funcCallCode:n}}function bakeCollection(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                `).concat(funcCallCode,`
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);collection.length%10===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 10) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                        collection[i+4](`).concat(argsDefCode,`);
                        collection[i+5](`).concat(argsDefCode,`);
                        collection[i+6](`).concat(argsDefCode,`);
                        collection[i+7](`).concat(argsDefCode,`);
                        collection[i+8](`).concat(argsDefCode,`);
                        collection[i+9](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%4===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 4) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%3===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 3) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                    }
                });
            })`):funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; ++i) {
                        collection[i](`).concat(argsDefCode,`);
                    }
                });
            })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollection=bakeCollection;function bakeCollectionAwait(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                return Promise.all([ `).concat(funcCallCode,` ]);
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode=`(function(collection) {
            return (function(`.concat(argsDefCode,`) {
                var promises = Array(collection.length);
                for (var i = 0; i < collection.length; ++i) {
                    promises[i] = collection[i](`).concat(argsDefCode,`);
                }
                return Promise.all(promises);
            });
        })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionAwait=bakeCollectionAwait;function bakeCollectionVariadic(collection){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var _a=generateBodyPartsVariadicCode(collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function() {
                `).concat(funcCallCode,`
            });
        })`)}else funcFactoryCode=`(function(collection) {
            return (function() {
                for (var i = 0; i < collection.length; ++i) {
                    collection[i].apply(undefined, arguments);
                }
            });
        })`;{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionVariadic=bakeCollectionVariadic})(bakeCollection);var __spreadArray$1=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,n){if(n||arguments.length===2)for(var s=0,r=e.length,o;s<r;s++)(o||!(s in e))&&(o||(o=Array.prototype.slice.call(e,0,s)),o[s]=e[s]);return t.concat(o||Array.prototype.slice.call(e))};Object.defineProperty(taskCollection,"__esModule",{value:!0});taskCollection.TaskCollection=void 0;var utils_1$1=utils$1,bake_collection_1=bakeCollection;function push_norebuild(t,e){var n=this.length;if(n>1)if(e){var s;(s=this._tasks).push.apply(s,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(n===1){var r=Array(1+arguments.length);r.push(r),r.push.apply(r,arguments),this._tasks=r}else{var r=Array(arguments.length);r.push.apply(r,arguments),this._tasks=r}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++}function push_rebuild(t,e){var n=this.length;if(n>1)if(e){var s;(s=this._tasks).push.apply(s,arguments),this.length+=arguments.length}else this._tasks.push(t),this.length++;else if(e){if(n===1){var r=Array(1+arguments.length);r.push(r),r.push.apply(r,arguments),this._tasks=r}else{var r=Array(arguments.length);r.push.apply(r,arguments),this._tasks=r}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,t]:this._tasks=t,this.length++;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function removeLast_norebuild(t){this.length!==0&&(this.length===1?this._tasks===t&&(this.length=0):((0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length))}function removeLast_rebuild(t){if(this.length!==0){if(this.length===1)if(this._tasks===t&&(this.length=0),this.firstEmitBuildStrategy){this.call=bake_collection_1.BAKED_EMPTY_FUNC;return}else{this.rebuild();return}else(0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(t)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}}function insert_norebuild(t){for(var e,n=[],s=1;s<arguments.length;s++)n[s-1]=arguments[s];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],n,!1)),this.length=this._tasks.length)}function insert_rebuild(t){for(var e,n=[],s=1;s<arguments.length;s++)n[s-1]=arguments[s];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((e=this._tasks).splice.apply(e,__spreadArray$1([t,0],n,!1)),this.length=this._tasks.length),this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function rebuild_noawait(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollection)(this._tasks,this.argsNum)}function rebuild_await(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollectionAwait)(this._tasks,this.argsNum)}function rebuild_on_first_call(){this.rebuild(),this.call.apply(void 0,arguments)}var TaskCollection=function(){function t(e,n,s,r){n===void 0&&(n=!0),s===void 0&&(s=null),r===void 0&&(r=!1),this.awaitTasks=r,this.call=bake_collection_1.BAKED_EMPTY_FUNC,this.argsNum=e,this.firstEmitBuildStrategy=!0,r?this.rebuild=rebuild_await.bind(this):this.rebuild=rebuild_noawait.bind(this),this.setAutoRebuild(n),s?typeof s=="function"?(this._tasks=s,this.length=1):(this._tasks=s,this.length=s.length):(this._tasks=null,this.length=0),n&&this.rebuild()}return t}();taskCollection.TaskCollection=TaskCollection;function fastClear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function clear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function growArgsNum(t){this.argsNum<t&&(this.argsNum=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}function setAutoRebuild(t){t?(this.push=push_rebuild.bind(this),this.insert=insert_rebuild.bind(this),this.removeLast=removeLast_rebuild.bind(this)):(this.push=push_norebuild.bind(this),this.insert=insert_norebuild.bind(this),this.removeLast=removeLast_norebuild.bind(this))}function tasksAsArray(){return this.length===0?[]:this.length===1?[this._tasks]:this._tasks}function setTasks(t){t.length===0?(this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC):t.length===1?(this.length=1,this.call=t[0],this._tasks=t[0]):(this.length=t.length,this._tasks=t,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}TaskCollection.prototype.fastClear=fastClear;TaskCollection.prototype.clear=clear;TaskCollection.prototype.growArgsNum=growArgsNum;TaskCollection.prototype.setAutoRebuild=setAutoRebuild;TaskCollection.prototype.tasksAsArray=tasksAsArray;TaskCollection.prototype.setTasks=setTasks;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(s,r,o,a){a===void 0&&(a=o);var c=Object.getOwnPropertyDescriptor(r,o);(!c||("get"in c?!r.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return r[o]}}),Object.defineProperty(s,a,c)}:function(s,r,o,a){a===void 0&&(a=o),s[a]=r[o]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(s,r){for(var o in s)o!=="default"&&!Object.prototype.hasOwnProperty.call(r,o)&&e(r,s,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(taskCollection,t)})(taskCollection$1);var utils={};Object.defineProperty(utils,"__esModule",{value:!0});utils.nullObj=void 0;function nullObj(){var t={};return t.__proto__=null,t}utils.nullObj=nullObj;var __spreadArray=commonjsGlobal&&commonjsGlobal.__spreadArray||function(t,e,n){if(n||arguments.length===2)for(var s=0,r=e.length,o;s<r;s++)(o||!(s in e))&&(o||(o=Array.prototype.slice.call(e,0,s)),o[s]=e[s]);return t.concat(o||Array.prototype.slice.call(e))};Object.defineProperty(ee,"__esModule",{value:!0});ee.EventEmitter=void 0;var task_collection_1=taskCollection$1,utils_1=utils$1,utils_2=utils;function emit(t,e,n,s,r,o){var a=this.events[t];if(a){if(a.length===0)return!1;if(a.argsNum<6)a.call(e,n,s,r,o);else{for(var c=new Array(a.argsNum),l=0,u=c.length;l<u;++l)c[l]=arguments[l+1];a.call.apply(void 0,c)}return!0}return!1}function emitHasOnce(t,e,n,s,r,o){var a=this.events[t],c;if(a!==void 0){if(a.length===0)return!1;if(a.argsNum<6)a.call(e,n,s,r,o);else{c=new Array(a.argsNum);for(var l=0,u=c.length;l<u;++l)c[l]=arguments[l+1];a.call.apply(void 0,c)}}var f=this.onceEvents[t];if(f){if(typeof f=="function")if(this.onceEvents[t]=void 0,arguments.length<6)f(e,n,s,r,o);else{if(c===void 0){c=new Array(arguments.length-1);for(var l=0,u=c.length;l<u;++l)c[l]=arguments[l+1]}f.apply(void 0,c)}else{var h=f;if(this.onceEvents[t]=void 0,arguments.length<6)for(var l=0;l<h.length;++l)h[l](e,n,s,r,o);else{if(c===void 0){c=new Array(arguments.length-1);for(var l=0,u=c.length;l<u;++l)c[l]=arguments[l+1]}for(var l=0;l<h.length;++l)h[l].apply(void 0,c)}}return!0}return a!==void 0}var EventEmitter=function(){function t(){this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set,this.maxListeners=1/0}return Object.defineProperty(t.prototype,"_eventsCount",{get:function(){return this.eventNames().length},enumerable:!1,configurable:!0}),t}();ee.EventEmitter=EventEmitter;function once(t,e){switch(this.emit===emit&&(this.emit=emitHasOnce),typeof this.onceEvents[t]){case"undefined":this.onceEvents[t]=e,typeof t=="symbol"&&this._symbolKeys.add(t);break;case"function":this.onceEvents[t]=[this.onceEvents[t],e];break;case"object":this.onceEvents[t].push(e)}return this}function addListener(t,e,n){if(n===void 0&&(n=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var s=this.events[t];return s?(s.push(e),s.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=s.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))):(this.events[t]=new task_collection_1.TaskCollection(n,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeListener(t,e){var n=this.events[t];n&&n.removeLast(e);var s=this.onceEvents[t];return s&&(typeof s=="function"?this.onceEvents[t]=void 0:typeof s=="object"&&(s.length===1&&s[0]===e?this.onceEvents[t]=void 0:(0,utils_1._fast_remove_single)(s,s.lastIndexOf(e)))),this}function addListenerBound(t,e,n,s){n===void 0&&(n=this),s===void 0&&(s=e.length),this.boundFuncs||(this.boundFuncs=new Map);var r=e.bind(n);return this.boundFuncs.set(e,r),this.addListener(t,r,s)}function removeListenerBound(t,e){var n,s,r=(n=this.boundFuncs)===null||n===void 0?void 0:n.get(e);return(s=this.boundFuncs)===null||s===void 0||s.delete(e),this.removeListener(t,r)}function hasListeners(t){return this.events[t]&&!!this.events[t].length}function prependListener(t,e,n){if(n===void 0&&(n=e.length),typeof e!="function")throw new TypeError("The listener must be a function");var s=this.events[t];return!s||!(s instanceof task_collection_1.TaskCollection)?(s=this.events[t]=new task_collection_1.TaskCollection(n,!0,e,!1),typeof t=="symbol"&&this._symbolKeys.add(t)):(s.insert(0,e),s.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=s.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" event!'))),this}function prependOnceListener(t,e){this.emit===emit&&(this.emit=emitHasOnce);var n=this.onceEvents[t];return n?typeof n!="object"?(this.onceEvents[t]=[e,n],typeof t=="symbol"&&this._symbolKeys.add(t)):(n.unshift(e),this.maxListeners!==1/0&&this.maxListeners<=n.length&&console.warn('Maximum event listeners for "'.concat(String(t),'" once event!'))):(this.onceEvents[t]=[e],typeof t=="symbol"&&this._symbolKeys.add(t)),this}function removeAllListeners(t){return t===void 0?(this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set):(this.events[t]=void 0,this.onceEvents[t]=void 0,typeof t=="symbol"&&this._symbolKeys.delete(t)),this}function setMaxListeners(t){return this.maxListeners=t,this}function getMaxListeners(){return this.maxListeners}function listeners(t){return this.emit===emit?this.events[t]?this.events[t].tasksAsArray().slice():[]:this.events[t]&&this.onceEvents[t]?__spreadArray(__spreadArray([],this.events[t].tasksAsArray(),!0),typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t],!0):this.events[t]?this.events[t].tasksAsArray():this.onceEvents[t]?typeof this.onceEvents[t]=="function"?[this.onceEvents[t]]:this.onceEvents[t]:[]}function eventNames(){var t=this;if(this.emit===emit){var e=Object.keys(this.events);return __spreadArray(__spreadArray([],e,!0),Array.from(this._symbolKeys),!0).filter(function(s){return s in t.events&&t.events[s]&&t.events[s].length})}else{var e=Object.keys(this.events).filter(function(r){return t.events[r]&&t.events[r].length}),n=Object.keys(this.onceEvents).filter(function(r){return t.onceEvents[r]&&t.onceEvents[r].length});return __spreadArray(__spreadArray(__spreadArray([],e,!0),n,!0),Array.from(this._symbolKeys).filter(function(r){return r in t.events&&t.events[r]&&t.events[r].length||r in t.onceEvents&&t.onceEvents[r]&&t.onceEvents[r].length}),!0)}}function listenerCount(t){return this.emit===emit?this.events[t]&&this.events[t].length||0:(this.events[t]&&this.events[t].length||0)+(this.onceEvents[t]&&this.onceEvents[t].length||0)}EventEmitter.prototype.emit=emit;EventEmitter.prototype.on=addListener;EventEmitter.prototype.once=once;EventEmitter.prototype.addListener=addListener;EventEmitter.prototype.removeListener=removeListener;EventEmitter.prototype.addListenerBound=addListenerBound;EventEmitter.prototype.removeListenerBound=removeListenerBound;EventEmitter.prototype.hasListeners=hasListeners;EventEmitter.prototype.prependListener=prependListener;EventEmitter.prototype.prependOnceListener=prependOnceListener;EventEmitter.prototype.off=removeListener;EventEmitter.prototype.removeAllListeners=removeAllListeners;EventEmitter.prototype.setMaxListeners=setMaxListeners;EventEmitter.prototype.getMaxListeners=getMaxListeners;EventEmitter.prototype.listeners=listeners;EventEmitter.prototype.eventNames=eventNames;EventEmitter.prototype.listenerCount=listenerCount;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(s,r,o,a){a===void 0&&(a=o);var c=Object.getOwnPropertyDescriptor(r,o);(!c||("get"in c?!r.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return r[o]}}),Object.defineProperty(s,a,c)}:function(s,r,o,a){a===void 0&&(a=o),s[a]=r[o]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(s,r){for(var o in s)o!=="default"&&!Object.prototype.hasOwnProperty.call(r,o)&&e(r,s,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(types,t),n(ee,t)})(lib$1);var browser={exports:{}},ms,hasRequiredMs;function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var t=1e3,e=t*60,n=e*60,s=n*24,r=s*7,o=s*365.25;ms=function(f,h){h=h||{};var p=typeof f;if(p==="string"&&f.length>0)return a(f);if(p==="number"&&isFinite(f))return h.long?l(f):c(f);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(f))};function a(f){if(f=String(f),!(f.length>100)){var h=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(f);if(h){var p=parseFloat(h[1]),y=(h[2]||"ms").toLowerCase();switch(y){case"years":case"year":case"yrs":case"yr":case"y":return p*o;case"weeks":case"week":case"w":return p*r;case"days":case"day":case"d":return p*s;case"hours":case"hour":case"hrs":case"hr":case"h":return p*n;case"minutes":case"minute":case"mins":case"min":case"m":return p*e;case"seconds":case"second":case"secs":case"sec":case"s":return p*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function c(f){var h=Math.abs(f);return h>=s?Math.round(f/s)+"d":h>=n?Math.round(f/n)+"h":h>=e?Math.round(f/e)+"m":h>=t?Math.round(f/t)+"s":f+"ms"}function l(f){var h=Math.abs(f);return h>=s?u(f,h,s,"day"):h>=n?u(f,h,n,"hour"):h>=e?u(f,h,e,"minute"):h>=t?u(f,h,t,"second"):f+" ms"}function u(f,h,p,y){var b=h>=p*1.5;return Math.round(f/p)+" "+y+(b?"s":"")}return ms}function setup(t){n.debug=n,n.default=n,n.coerce=l,n.disable=a,n.enable=r,n.enabled=c,n.humanize=requireMs(),n.destroy=u,Object.keys(t).forEach(f=>{n[f]=t[f]}),n.names=[],n.skips=[],n.formatters={};function e(f){let h=0;for(let p=0;p<f.length;p++)h=(h<<5)-h+f.charCodeAt(p),h|=0;return n.colors[Math.abs(h)%n.colors.length]}n.selectColor=e;function n(f){let h,p=null,y,b;function m(...w){if(!m.enabled)return;const k=m,A=Number(new Date),B=A-(h||A);k.diff=B,k.prev=h,k.curr=A,h=A,w[0]=n.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let P=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(U,M)=>{if(U==="%%")return"%";P++;const D=n.formatters[M];if(typeof D=="function"){const F=w[P];U=D.call(k,F),w.splice(P,1),P--}return U}),n.formatArgs.call(k,w),(k.log||n.log).apply(k,w)}return m.namespace=f,m.useColors=n.useColors(),m.color=n.selectColor(f),m.extend=s,m.destroy=n.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(y!==n.namespaces&&(y=n.namespaces,b=n.enabled(f)),b),set:w=>{p=w}}),typeof n.init=="function"&&n.init(m),m}function s(f,h){const p=n(this.namespace+(typeof h>"u"?":":h)+f);return p.log=this.log,p}function r(f){n.save(f),n.namespaces=f,n.names=[],n.skips=[];const h=(typeof f=="string"?f:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const p of h)p[0]==="-"?n.skips.push(p.slice(1)):n.names.push(p)}function o(f,h){let p=0,y=0,b=-1,m=0;for(;p<f.length;)if(y<h.length&&(h[y]===f[p]||h[y]==="*"))h[y]==="*"?(b=y,m=p,y++):(p++,y++);else if(b!==-1)y=b+1,m++,p=m;else return!1;for(;y<h.length&&h[y]==="*";)y++;return y===h.length}function a(){const f=[...n.names,...n.skips.map(h=>"-"+h)].join(",");return n.enable(""),f}function c(f){for(const h of n.skips)if(o(f,h))return!1;for(const h of n.names)if(o(f,h))return!0;return!1}function l(f){return f instanceof Error?f.stack||f.message:f}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}var common=setup;(function(t,e){var n={};e.formatArgs=r,e.save=o,e.load=a,e.useColors=s,e.storage=c(),e.destroy=(()=>{let u=!1;return()=>{u||(u=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function s(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let u;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(u=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(u[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function r(u){if(u[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+u[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const f="color: "+this.color;u.splice(1,0,f,"color: inherit");let h=0,p=0;u[0].replace(/%[a-zA-Z%]/g,y=>{y!=="%%"&&(h++,y==="%c"&&(p=h))}),u.splice(p,0,f)}e.log=console.debug||console.log||(()=>{});function o(u){try{u?e.storage.setItem("debug",u):e.storage.removeItem("debug")}catch{}}function a(){let u;try{u=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!u&&typeof process<"u"&&"env"in process&&(u=n.DEBUG),u}function c(){try{return localStorage}catch{}}t.exports=common(e);const{formatters:l}=t.exports;l.j=function(u){try{return JSON.stringify(u)}catch(f){return"[UnexpectedJSONParseError]: "+f.message}}})(browser,browser.exports);var browserExports=browser.exports;const createDebug5=getDefaultExportFromCjs(browserExports);function number$2(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}function bytes$2(t,...e){if(!(t instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}function hash$1(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");number$2(t.outputLen),number$2(t.blockLen)}function exists$2(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function output$2(t,e){bytes$2(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const crypto$2=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const u8a$2=t=>t instanceof Uint8Array,createView$3=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),rotr$2=(t,e)=>t<<32-e|t>>>e,isLE$2=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE$2)throw new Error("Non little-endian hardware is not supported");function utf8ToBytes$4(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function toBytes$3(t){if(typeof t=="string"&&(t=utf8ToBytes$4(t)),!u8a$2(t))throw new Error(`expected Uint8Array, got ${typeof t}`);return t}function concatBytes$3(...t){const e=new Uint8Array(t.reduce((s,r)=>s+r.length,0));let n=0;return t.forEach(s=>{if(!u8a$2(s))throw new Error("Uint8Array expected");e.set(s,n),n+=s.length}),e}let Hash$2=class{clone(){return this._cloneInto()}};function wrapConstructor$1(t){const e=s=>t().update(toBytes$3(s)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function randomBytes$2(t=32){if(crypto$2&&typeof crypto$2.getRandomValues=="function")return crypto$2.getRandomValues(new Uint8Array(t));throw new Error("crypto.getRandomValues must be defined")}function setBigUint64$3(t,e,n,s){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,s);const r=BigInt(32),o=BigInt(4294967295),a=Number(n>>r&o),c=Number(n&o),l=s?4:0,u=s?0:4;t.setUint32(e+l,a,s),t.setUint32(e+u,c,s)}let SHA2$1=class extends Hash$2{constructor(e,n,s,r){super(),this.blockLen=e,this.outputLen=n,this.padOffset=s,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=createView$3(this.buffer)}update(e){exists$2(this);const{view:n,buffer:s,blockLen:r}=this;e=toBytes$3(e);const o=e.length;for(let a=0;a<o;){const c=Math.min(r-this.pos,o-a);if(c===r){const l=createView$3(e);for(;r<=o-a;a+=r)this.process(l,a);continue}s.set(e.subarray(a,a+c),this.pos),this.pos+=c,a+=c,this.pos===r&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){exists$2(this),output$2(e,this),this.finished=!0;const{buffer:n,view:s,blockLen:r,isLE:o}=this;let{pos:a}=this;n[a++]=128,this.buffer.subarray(a).fill(0),this.padOffset>r-a&&(this.process(s,0),a=0);for(let h=a;h<r;h++)n[h]=0;setBigUint64$3(s,r-8,BigInt(this.length*8),o),this.process(s,0);const c=createView$3(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=l/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)c.setUint32(4*h,f[h],o)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const s=e.slice(0,n);return this.destroy(),s}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:s,length:r,finished:o,destroyed:a,pos:c}=this;return e.length=r,e.pos=c,e.finished=o,e.destroyed=a,r%n&&e.buffer.set(s),e}};const Chi$2=(t,e,n)=>t&e^~t&n,Maj$2=(t,e,n)=>t&e^t&n^e&n,SHA256_K$2=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),IV$1=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_W$2=new Uint32Array(64);let SHA256$2=class extends SHA2$1{constructor(){super(64,32,8,!1),this.A=IV$1[0]|0,this.B=IV$1[1]|0,this.C=IV$1[2]|0,this.D=IV$1[3]|0,this.E=IV$1[4]|0,this.F=IV$1[5]|0,this.G=IV$1[6]|0,this.H=IV$1[7]|0}get(){const{A:e,B:n,C:s,D:r,E:o,F:a,G:c,H:l}=this;return[e,n,s,r,o,a,c,l]}set(e,n,s,r,o,a,c,l){this.A=e|0,this.B=n|0,this.C=s|0,this.D=r|0,this.E=o|0,this.F=a|0,this.G=c|0,this.H=l|0}process(e,n){for(let h=0;h<16;h++,n+=4)SHA256_W$2[h]=e.getUint32(n,!1);for(let h=16;h<64;h++){const p=SHA256_W$2[h-15],y=SHA256_W$2[h-2],b=rotr$2(p,7)^rotr$2(p,18)^p>>>3,m=rotr$2(y,17)^rotr$2(y,19)^y>>>10;SHA256_W$2[h]=m+SHA256_W$2[h-7]+b+SHA256_W$2[h-16]|0}let{A:s,B:r,C:o,D:a,E:c,F:l,G:u,H:f}=this;for(let h=0;h<64;h++){const p=rotr$2(c,6)^rotr$2(c,11)^rotr$2(c,25),y=f+p+Chi$2(c,l,u)+SHA256_K$2[h]+SHA256_W$2[h]|0,m=(rotr$2(s,2)^rotr$2(s,13)^rotr$2(s,22))+Maj$2(s,r,o)|0;f=u,u=l,l=c,c=a+y|0,a=o,o=r,r=s,s=y+m|0}s=s+this.A|0,r=r+this.B|0,o=o+this.C|0,a=a+this.D|0,c=c+this.E|0,l=l+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(s,r,o,a,c,l,u,f)}roundClean(){SHA256_W$2.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};const sha256$3=wrapConstructor$1(()=>new SHA256$2);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$9=BigInt(0),_1n$9=BigInt(1),_2n$5=BigInt(2),u8a$1=t=>t instanceof Uint8Array,hexes$3=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex$3(t){if(!u8a$1(t))throw new Error("Uint8Array expected");let e="";for(let n=0;n<t.length;n++)e+=hexes$3[t[n]];return e}function numberToHexUnpadded$1(t){const e=t.toString(16);return e.length&1?`0${e}`:e}function hexToNumber$1(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return BigInt(t===""?"0":`0x${t}`)}function hexToBytes$3(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(e/2);for(let s=0;s<n.length;s++){const r=s*2,o=t.slice(r,r+2),a=Number.parseInt(o,16);if(Number.isNaN(a)||a<0)throw new Error("Invalid byte sequence");n[s]=a}return n}function bytesToNumberBE$1(t){return hexToNumber$1(bytesToHex$3(t))}function bytesToNumberLE$1(t){if(!u8a$1(t))throw new Error("Uint8Array expected");return hexToNumber$1(bytesToHex$3(Uint8Array.from(t).reverse()))}function numberToBytesBE$1(t,e){return hexToBytes$3(t.toString(16).padStart(e*2,"0"))}function numberToBytesLE$1(t,e){return numberToBytesBE$1(t,e).reverse()}function numberToVarBytesBE(t){return hexToBytes$3(numberToHexUnpadded$1(t))}function ensureBytes$1(t,e,n){let s;if(typeof e=="string")try{s=hexToBytes$3(e)}catch(o){throw new Error(`${t} must be valid hex string, got "${e}". Cause: ${o}`)}else if(u8a$1(e))s=Uint8Array.from(e);else throw new Error(`${t} must be hex string or Uint8Array`);const r=s.length;if(typeof n=="number"&&r!==n)throw new Error(`${t} expected ${n} bytes, got ${r}`);return s}function concatBytes$2(...t){const e=new Uint8Array(t.reduce((s,r)=>s+r.length,0));let n=0;return t.forEach(s=>{if(!u8a$1(s))throw new Error("Uint8Array expected");e.set(s,n),n+=s.length}),e}function equalBytes$1(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}function utf8ToBytes$3(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function bitLen$1(t){let e;for(e=0;t>_0n$9;t>>=_1n$9,e+=1);return e}function bitGet(t,e){return t>>BigInt(e)&_1n$9}const bitSet=(t,e,n)=>t|(n?_1n$9:_0n$9)<<BigInt(e),bitMask$1=t=>(_2n$5<<BigInt(t-1))-_1n$9,u8n=t=>new Uint8Array(t),u8fr=t=>Uint8Array.from(t);function createHmacDrbg$1(t,e,n){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let s=u8n(t),r=u8n(t),o=0;const a=()=>{s.fill(1),r.fill(0),o=0},c=(...h)=>n(r,s,...h),l=(h=u8n())=>{r=c(u8fr([0]),h),s=c(),h.length!==0&&(r=c(u8fr([1]),h),s=c())},u=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let h=0;const p=[];for(;h<e;){s=c();const y=s.slice();p.push(y),h+=s.length}return concatBytes$2(...p)};return(h,p)=>{a(),l(h);let y;for(;!(y=p(u()));)l();return a(),y}}const validatorFns={bigint:t=>typeof t=="bigint",function:t=>typeof t=="function",boolean:t=>typeof t=="boolean",string:t=>typeof t=="string",stringOrUint8Array:t=>typeof t=="string"||t instanceof Uint8Array,isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>typeof t=="function"&&Number.isSafeInteger(t.outputLen)};function validateObject(t,e,n={}){const s=(r,o,a)=>{const c=validatorFns[o];if(typeof c!="function")throw new Error(`Invalid validator "${o}", expected function`);const l=t[r];if(!(a&&l===void 0)&&!c(l,t))throw new Error(`Invalid param ${String(r)}=${l} (${typeof l}), expected ${o}`)};for(const[r,o]of Object.entries(e))s(r,o,!1);for(const[r,o]of Object.entries(n))s(r,o,!0);return t}const ut=Object.freeze(Object.defineProperty({__proto__:null,bitGet,bitLen:bitLen$1,bitMask:bitMask$1,bitSet,bytesToHex:bytesToHex$3,bytesToNumberBE:bytesToNumberBE$1,bytesToNumberLE:bytesToNumberLE$1,concatBytes:concatBytes$2,createHmacDrbg:createHmacDrbg$1,ensureBytes:ensureBytes$1,equalBytes:equalBytes$1,hexToBytes:hexToBytes$3,hexToNumber:hexToNumber$1,numberToBytesBE:numberToBytesBE$1,numberToBytesLE:numberToBytesLE$1,numberToHexUnpadded:numberToHexUnpadded$1,numberToVarBytesBE,utf8ToBytes:utf8ToBytes$3,validateObject},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$8=BigInt(0),_1n$8=BigInt(1),_2n$4=BigInt(2),_3n$3=BigInt(3),_4n$2=BigInt(4),_5n$1=BigInt(5),_8n$1=BigInt(8);BigInt(9);BigInt(16);function mod$1(t,e){const n=t%e;return n>=_0n$8?n:e+n}function pow(t,e,n){if(n<=_0n$8||e<_0n$8)throw new Error("Expected power/modulo > 0");if(n===_1n$8)return _0n$8;let s=_1n$8;for(;e>_0n$8;)e&_1n$8&&(s=s*t%n),t=t*t%n,e>>=_1n$8;return s}function pow2$1(t,e,n){let s=t;for(;e-- >_0n$8;)s*=s,s%=n;return s}function invert$1(t,e){if(t===_0n$8||e<=_0n$8)throw new Error(`invert: expected positive integers, got n=${t} mod=${e}`);let n=mod$1(t,e),s=e,r=_0n$8,o=_1n$8;for(;n!==_0n$8;){const c=s/n,l=s%n,u=r-o*c;s=n,n=l,r=o,o=u}if(s!==_1n$8)throw new Error("invert: does not exist");return mod$1(r,e)}function tonelliShanks$1(t){const e=(t-_1n$8)/_2n$4;let n,s,r;for(n=t-_1n$8,s=0;n%_2n$4===_0n$8;n/=_2n$4,s++);for(r=_2n$4;r<t&&pow(r,e,t)!==t-_1n$8;r++);if(s===1){const a=(t+_1n$8)/_4n$2;return function(l,u){const f=l.pow(u,a);if(!l.eql(l.sqr(f),u))throw new Error("Cannot find square root");return f}}const o=(n+_1n$8)/_2n$4;return function(c,l){if(c.pow(l,e)===c.neg(c.ONE))throw new Error("Cannot find square root");let u=s,f=c.pow(c.mul(c.ONE,r),n),h=c.pow(l,o),p=c.pow(l,n);for(;!c.eql(p,c.ONE);){if(c.eql(p,c.ZERO))return c.ZERO;let y=1;for(let m=c.sqr(p);y<u&&!c.eql(m,c.ONE);y++)m=c.sqr(m);const b=c.pow(f,_1n$8<<BigInt(u-y-1));f=c.sqr(b),h=c.mul(h,b),p=c.mul(p,f),u=y}return h}}function FpSqrt$1(t){if(t%_4n$2===_3n$3){const e=(t+_1n$8)/_4n$2;return function(s,r){const o=s.pow(r,e);if(!s.eql(s.sqr(o),r))throw new Error("Cannot find square root");return o}}if(t%_8n$1===_5n$1){const e=(t-_5n$1)/_8n$1;return function(s,r){const o=s.mul(r,_2n$4),a=s.pow(o,e),c=s.mul(r,a),l=s.mul(s.mul(c,_2n$4),a),u=s.mul(c,s.sub(l,s.ONE));if(!s.eql(s.sqr(u),r))throw new Error("Cannot find square root");return u}}return tonelliShanks$1(t)}const FIELD_FIELDS$1=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField$1(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=FIELD_FIELDS$1.reduce((s,r)=>(s[r]="function",s),e);return validateObject(t,n)}function FpPow$1(t,e,n){if(n<_0n$8)throw new Error("Expected power > 0");if(n===_0n$8)return t.ONE;if(n===_1n$8)return e;let s=t.ONE,r=e;for(;n>_0n$8;)n&_1n$8&&(s=t.mul(s,r)),r=t.sqr(r),n>>=_1n$8;return s}function FpInvertBatch$1(t,e){const n=new Array(e.length),s=e.reduce((o,a,c)=>t.is0(a)?o:(n[c]=o,t.mul(o,a)),t.ONE),r=t.inv(s);return e.reduceRight((o,a,c)=>t.is0(a)?o:(n[c]=t.mul(o,n[c]),t.mul(o,a)),r),n}function nLength$1(t,e){const n=e!==void 0?e:t.toString(2).length,s=Math.ceil(n/8);return{nBitLength:n,nByteLength:s}}function Field$1(t,e,n=!1,s={}){if(t<=_0n$8)throw new Error(`Expected Field ORDER > 0, got ${t}`);const{nBitLength:r,nByteLength:o}=nLength$1(t,e);if(o>2048)throw new Error("Field lengths over 2048 bytes are not supported");const a=FpSqrt$1(t),c=Object.freeze({ORDER:t,BITS:r,BYTES:o,MASK:bitMask$1(r),ZERO:_0n$8,ONE:_1n$8,create:l=>mod$1(l,t),isValid:l=>{if(typeof l!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof l}`);return _0n$8<=l&&l<t},is0:l=>l===_0n$8,isOdd:l=>(l&_1n$8)===_1n$8,neg:l=>mod$1(-l,t),eql:(l,u)=>l===u,sqr:l=>mod$1(l*l,t),add:(l,u)=>mod$1(l+u,t),sub:(l,u)=>mod$1(l-u,t),mul:(l,u)=>mod$1(l*u,t),pow:(l,u)=>FpPow$1(c,l,u),div:(l,u)=>mod$1(l*invert$1(u,t),t),sqrN:l=>l*l,addN:(l,u)=>l+u,subN:(l,u)=>l-u,mulN:(l,u)=>l*u,inv:l=>invert$1(l,t),sqrt:s.sqrt||(l=>a(c,l)),invertBatch:l=>FpInvertBatch$1(c,l),cmov:(l,u,f)=>f?u:l,toBytes:l=>n?numberToBytesLE$1(l,o):numberToBytesBE$1(l,o),fromBytes:l=>{if(l.length!==o)throw new Error(`Fp.fromBytes: expected ${o}, got ${l.length}`);return n?bytesToNumberLE$1(l):bytesToNumberBE$1(l)}});return Object.freeze(c)}function getFieldBytesLength$1(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function getMinHashLength$1(t){const e=getFieldBytesLength$1(t);return e+Math.ceil(e/2)}function mapHashToField$1(t,e,n=!1){const s=t.length,r=getFieldBytesLength$1(e),o=getMinHashLength$1(e);if(s<16||s<o||s>1024)throw new Error(`expected ${o}-1024 bytes of input, got ${s}`);const a=n?bytesToNumberBE$1(t):bytesToNumberLE$1(t),c=mod$1(a,e-_1n$8)+_1n$8;return n?numberToBytesLE$1(c,r):numberToBytesBE$1(c,r)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$7=BigInt(0),_1n$7=BigInt(1);function wNAF$1(t,e){const n=(r,o)=>{const a=o.negate();return r?a:o},s=r=>{const o=Math.ceil(e/r)+1,a=2**(r-1);return{windows:o,windowSize:a}};return{constTimeNegate:n,unsafeLadder(r,o){let a=t.ZERO,c=r;for(;o>_0n$7;)o&_1n$7&&(a=a.add(c)),c=c.double(),o>>=_1n$7;return a},precomputeWindow(r,o){const{windows:a,windowSize:c}=s(o),l=[];let u=r,f=u;for(let h=0;h<a;h++){f=u,l.push(f);for(let p=1;p<c;p++)f=f.add(u),l.push(f);u=f.double()}return l},wNAF(r,o,a){const{windows:c,windowSize:l}=s(r);let u=t.ZERO,f=t.BASE;const h=BigInt(2**r-1),p=2**r,y=BigInt(r);for(let b=0;b<c;b++){const m=b*l;let w=Number(a&h);a>>=y,w>l&&(w-=p,a+=_1n$7);const k=m,A=m+Math.abs(w)-1,B=b%2!==0,P=w<0;w===0?f=f.add(n(B,o[k])):u=u.add(n(P,o[A]))}return{p:u,f}},wNAFCached(r,o,a,c){const l=r._WINDOW_SIZE||1;let u=o.get(r);return u||(u=this.precomputeWindow(r,l),l!==1&&o.set(r,c(u))),this.wNAF(l,u,a)}}}function validateBasic(t){return validateField$1(t.Fp),validateObject(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...nLength$1(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function validatePointOpts(t){const e=validateBasic(t);validateObject(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:s,a:r}=e;if(n){if(!s.eql(r,s.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:b2n,hexToBytes:h2b}=ut,DER$1={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(t){const{Err:e}=DER$1;if(t.length<2||t[0]!==2)throw new e("Invalid signature integer tag");const n=t[1],s=t.subarray(2,n+2);if(!n||s.length!==n)throw new e("Invalid signature integer: wrong length");if(s[0]&128)throw new e("Invalid signature integer: negative");if(s[0]===0&&!(s[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:b2n(s),l:t.subarray(n+2)}},toSig(t){const{Err:e}=DER$1,n=typeof t=="string"?h2b(t):t;if(!(n instanceof Uint8Array))throw new Error("ui8a expected");let s=n.length;if(s<2||n[0]!=48)throw new e("Invalid signature tag");if(n[1]!==s-2)throw new e("Invalid signature: incorrect length");const{d:r,l:o}=DER$1._parseInt(n.subarray(2)),{d:a,l:c}=DER$1._parseInt(o);if(c.length)throw new e("Invalid signature: left bytes after parsing");return{r,s:a}},hexFromSig(t){const e=u=>Number.parseInt(u[0],16)&8?"00"+u:u,n=u=>{const f=u.toString(16);return f.length&1?`0${f}`:f},s=e(n(t.s)),r=e(n(t.r)),o=s.length/2,a=r.length/2,c=n(o),l=n(a);return`30${n(a+o+4)}02${l}${r}02${c}${s}`}},_0n$6=BigInt(0),_1n$6=BigInt(1);BigInt(2);const _3n$2=BigInt(3);BigInt(4);function weierstrassPoints(t){const e=validatePointOpts(t),{Fp:n}=e,s=e.toBytes||((b,m,w)=>{const k=m.toAffine();return concatBytes$2(Uint8Array.from([4]),n.toBytes(k.x),n.toBytes(k.y))}),r=e.fromBytes||(b=>{const m=b.subarray(1),w=n.fromBytes(m.subarray(0,n.BYTES)),k=n.fromBytes(m.subarray(n.BYTES,2*n.BYTES));return{x:w,y:k}});function o(b){const{a:m,b:w}=e,k=n.sqr(b),A=n.mul(k,b);return n.add(n.add(A,n.mul(b,m)),w)}if(!n.eql(n.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function a(b){return typeof b=="bigint"&&_0n$6<b&&b<e.n}function c(b){if(!a(b))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function l(b){const{allowedPrivateKeyLengths:m,nByteLength:w,wrapPrivateKey:k,n:A}=e;if(m&&typeof b!="bigint"){if(b instanceof Uint8Array&&(b=bytesToHex$3(b)),typeof b!="string"||!m.includes(b.length))throw new Error("Invalid key");b=b.padStart(w*2,"0")}let B;try{B=typeof b=="bigint"?b:bytesToNumberBE$1(ensureBytes$1("private key",b,w))}catch{throw new Error(`private key must be ${w} bytes, hex or bigint, not ${typeof b}`)}return k&&(B=mod$1(B,A)),c(B),B}const u=new Map;function f(b){if(!(b instanceof h))throw new Error("ProjectivePoint expected")}class h{constructor(m,w,k){if(this.px=m,this.py=w,this.pz=k,m==null||!n.isValid(m))throw new Error("x required");if(w==null||!n.isValid(w))throw new Error("y required");if(k==null||!n.isValid(k))throw new Error("z required")}static fromAffine(m){const{x:w,y:k}=m||{};if(!m||!n.isValid(w)||!n.isValid(k))throw new Error("invalid affine point");if(m instanceof h)throw new Error("projective point not allowed");const A=B=>n.eql(B,n.ZERO);return A(w)&&A(k)?h.ZERO:new h(w,k,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(m){const w=n.invertBatch(m.map(k=>k.pz));return m.map((k,A)=>k.toAffine(w[A])).map(h.fromAffine)}static fromHex(m){const w=h.fromAffine(r(ensureBytes$1("pointHex",m)));return w.assertValidity(),w}static fromPrivateKey(m){return h.BASE.multiply(l(m))}_setWindowSize(m){this._WINDOW_SIZE=m,u.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!n.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:m,y:w}=this.toAffine();if(!n.isValid(m)||!n.isValid(w))throw new Error("bad point: x or y not FE");const k=n.sqr(w),A=o(m);if(!n.eql(k,A))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:m}=this.toAffine();if(n.isOdd)return!n.isOdd(m);throw new Error("Field doesn't support isOdd")}equals(m){f(m);const{px:w,py:k,pz:A}=this,{px:B,py:P,pz:O}=m,U=n.eql(n.mul(w,O),n.mul(B,A)),M=n.eql(n.mul(k,O),n.mul(P,A));return U&&M}negate(){return new h(this.px,n.neg(this.py),this.pz)}double(){const{a:m,b:w}=e,k=n.mul(w,_3n$2),{px:A,py:B,pz:P}=this;let O=n.ZERO,U=n.ZERO,M=n.ZERO,D=n.mul(A,A),F=n.mul(B,B),H=n.mul(P,P),T=n.mul(A,B);return T=n.add(T,T),M=n.mul(A,P),M=n.add(M,M),O=n.mul(m,M),U=n.mul(k,H),U=n.add(O,U),O=n.sub(F,U),U=n.add(F,U),U=n.mul(O,U),O=n.mul(T,O),M=n.mul(k,M),H=n.mul(m,H),T=n.sub(D,H),T=n.mul(m,T),T=n.add(T,M),M=n.add(D,D),D=n.add(M,D),D=n.add(D,H),D=n.mul(D,T),U=n.add(U,D),H=n.mul(B,P),H=n.add(H,H),D=n.mul(H,T),O=n.sub(O,D),M=n.mul(H,F),M=n.add(M,M),M=n.add(M,M),new h(O,U,M)}add(m){f(m);const{px:w,py:k,pz:A}=this,{px:B,py:P,pz:O}=m;let U=n.ZERO,M=n.ZERO,D=n.ZERO;const F=e.a,H=n.mul(e.b,_3n$2);let T=n.mul(w,B),$=n.mul(k,P),E=n.mul(A,O),x=n.add(w,k),v=n.add(B,P);x=n.mul(x,v),v=n.add(T,$),x=n.sub(x,v),v=n.add(w,A);let _=n.add(B,O);return v=n.mul(v,_),_=n.add(T,E),v=n.sub(v,_),_=n.add(k,A),U=n.add(P,O),_=n.mul(_,U),U=n.add($,E),_=n.sub(_,U),D=n.mul(F,v),U=n.mul(H,E),D=n.add(U,D),U=n.sub($,D),D=n.add($,D),M=n.mul(U,D),$=n.add(T,T),$=n.add($,T),E=n.mul(F,E),v=n.mul(H,v),$=n.add($,E),E=n.sub(T,E),E=n.mul(F,E),v=n.add(v,E),T=n.mul($,v),M=n.add(M,T),T=n.mul(_,v),U=n.mul(x,U),U=n.sub(U,T),T=n.mul(x,$),D=n.mul(_,D),D=n.add(D,T),new h(U,M,D)}subtract(m){return this.add(m.negate())}is0(){return this.equals(h.ZERO)}wNAF(m){return y.wNAFCached(this,u,m,w=>{const k=n.invertBatch(w.map(A=>A.pz));return w.map((A,B)=>A.toAffine(k[B])).map(h.fromAffine)})}multiplyUnsafe(m){const w=h.ZERO;if(m===_0n$6)return w;if(c(m),m===_1n$6)return this;const{endo:k}=e;if(!k)return y.unsafeLadder(this,m);let{k1neg:A,k1:B,k2neg:P,k2:O}=k.splitScalar(m),U=w,M=w,D=this;for(;B>_0n$6||O>_0n$6;)B&_1n$6&&(U=U.add(D)),O&_1n$6&&(M=M.add(D)),D=D.double(),B>>=_1n$6,O>>=_1n$6;return A&&(U=U.negate()),P&&(M=M.negate()),M=new h(n.mul(M.px,k.beta),M.py,M.pz),U.add(M)}multiply(m){c(m);let w=m,k,A;const{endo:B}=e;if(B){const{k1neg:P,k1:O,k2neg:U,k2:M}=B.splitScalar(w);let{p:D,f:F}=this.wNAF(O),{p:H,f:T}=this.wNAF(M);D=y.constTimeNegate(P,D),H=y.constTimeNegate(U,H),H=new h(n.mul(H.px,B.beta),H.py,H.pz),k=D.add(H),A=F.add(T)}else{const{p:P,f:O}=this.wNAF(w);k=P,A=O}return h.normalizeZ([k,A])[0]}multiplyAndAddUnsafe(m,w,k){const A=h.BASE,B=(O,U)=>U===_0n$6||U===_1n$6||!O.equals(A)?O.multiplyUnsafe(U):O.multiply(U),P=B(this,w).add(B(m,k));return P.is0()?void 0:P}toAffine(m){const{px:w,py:k,pz:A}=this,B=this.is0();m==null&&(m=B?n.ONE:n.inv(A));const P=n.mul(w,m),O=n.mul(k,m),U=n.mul(A,m);if(B)return{x:n.ZERO,y:n.ZERO};if(!n.eql(U,n.ONE))throw new Error("invZ was invalid");return{x:P,y:O}}isTorsionFree(){const{h:m,isTorsionFree:w}=e;if(m===_1n$6)return!0;if(w)return w(h,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:m,clearCofactor:w}=e;return m===_1n$6?this:w?w(h,this):this.multiplyUnsafe(e.h)}toRawBytes(m=!0){return this.assertValidity(),s(h,this,m)}toHex(m=!0){return bytesToHex$3(this.toRawBytes(m))}}h.BASE=new h(e.Gx,e.Gy,n.ONE),h.ZERO=new h(n.ZERO,n.ONE,n.ZERO);const p=e.nBitLength,y=wNAF$1(h,e.endo?Math.ceil(p/2):p);return{CURVE:e,ProjectivePoint:h,normPrivateKeyToScalar:l,weierstrassEquation:o,isWithinCurveOrder:a}}function validateOpts(t){const e=validateBasic(t);return validateObject(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function weierstrass$1(t){const e=validateOpts(t),{Fp:n,n:s}=e,r=n.BYTES+1,o=2*n.BYTES+1;function a(v){return _0n$6<v&&v<n.ORDER}function c(v){return mod$1(v,s)}function l(v){return invert$1(v,s)}const{ProjectivePoint:u,normPrivateKeyToScalar:f,weierstrassEquation:h,isWithinCurveOrder:p}=weierstrassPoints({...e,toBytes(v,_,S){const I=_.toAffine(),R=n.toBytes(I.x),N=concatBytes$2;return S?N(Uint8Array.from([_.hasEvenY()?2:3]),R):N(Uint8Array.from([4]),R,n.toBytes(I.y))},fromBytes(v){const _=v.length,S=v[0],I=v.subarray(1);if(_===r&&(S===2||S===3)){const R=bytesToNumberBE$1(I);if(!a(R))throw new Error("Point is not on curve");const N=h(R);let C=n.sqrt(N);const L=(C&_1n$6)===_1n$6;return(S&1)===1!==L&&(C=n.neg(C)),{x:R,y:C}}else if(_===o&&S===4){const R=n.fromBytes(I.subarray(0,n.BYTES)),N=n.fromBytes(I.subarray(n.BYTES,2*n.BYTES));return{x:R,y:N}}else throw new Error(`Point of length ${_} was invalid. Expected ${r} compressed bytes or ${o} uncompressed bytes`)}}),y=v=>bytesToHex$3(numberToBytesBE$1(v,e.nByteLength));function b(v){const _=s>>_1n$6;return v>_}function m(v){return b(v)?c(-v):v}const w=(v,_,S)=>bytesToNumberBE$1(v.slice(_,S));class k{constructor(_,S,I){this.r=_,this.s=S,this.recovery=I,this.assertValidity()}static fromCompact(_){const S=e.nByteLength;return _=ensureBytes$1("compactSignature",_,S*2),new k(w(_,0,S),w(_,S,2*S))}static fromDER(_){const{r:S,s:I}=DER$1.toSig(ensureBytes$1("DER",_));return new k(S,I)}assertValidity(){if(!p(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!p(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(_){return new k(this.r,this.s,_)}recoverPublicKey(_){const{r:S,s:I,recovery:R}=this,N=M(ensureBytes$1("msgHash",_));if(R==null||![0,1,2,3].includes(R))throw new Error("recovery id invalid");const C=R===2||R===3?S+e.n:S;if(C>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const L=R&1?"03":"02",j=u.fromHex(L+y(C)),V=l(C),z=c(-N*V),q=c(I*V),G=u.BASE.multiplyAndAddUnsafe(j,z,q);if(!G)throw new Error("point at infinify");return G.assertValidity(),G}hasHighS(){return b(this.s)}normalizeS(){return this.hasHighS()?new k(this.r,c(-this.s),this.recovery):this}toDERRawBytes(){return hexToBytes$3(this.toDERHex())}toDERHex(){return DER$1.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return hexToBytes$3(this.toCompactHex())}toCompactHex(){return y(this.r)+y(this.s)}}const A={isValidPrivateKey(v){try{return f(v),!0}catch{return!1}},normPrivateKeyToScalar:f,randomPrivateKey:()=>{const v=getMinHashLength$1(e.n);return mapHashToField$1(e.randomBytes(v),e.n)},precompute(v=8,_=u.BASE){return _._setWindowSize(v),_.multiply(BigInt(3)),_}};function B(v,_=!0){return u.fromPrivateKey(v).toRawBytes(_)}function P(v){const _=v instanceof Uint8Array,S=typeof v=="string",I=(_||S)&&v.length;return _?I===r||I===o:S?I===2*r||I===2*o:v instanceof u}function O(v,_,S=!0){if(P(v))throw new Error("first arg must be private key");if(!P(_))throw new Error("second arg must be public key");return u.fromHex(_).multiply(f(v)).toRawBytes(S)}const U=e.bits2int||function(v){const _=bytesToNumberBE$1(v),S=v.length*8-e.nBitLength;return S>0?_>>BigInt(S):_},M=e.bits2int_modN||function(v){return c(U(v))},D=bitMask$1(e.nBitLength);function F(v){if(typeof v!="bigint")throw new Error("bigint expected");if(!(_0n$6<=v&&v<D))throw new Error(`bigint expected < 2^${e.nBitLength}`);return numberToBytesBE$1(v,e.nByteLength)}function H(v,_,S=T){if(["recovered","canonical"].some(W=>W in S))throw new Error("sign() legacy options not supported");const{hash:I,randomBytes:R}=e;let{lowS:N,prehash:C,extraEntropy:L}=S;N==null&&(N=!0),v=ensureBytes$1("msgHash",v),C&&(v=ensureBytes$1("prehashed msgHash",I(v)));const j=M(v),V=f(_),z=[F(V),F(j)];if(L!=null){const W=L===!0?R(n.BYTES):L;z.push(ensureBytes$1("extraEntropy",W))}const q=concatBytes$2(...z),G=j;function K(W){const Z=U(W);if(!p(Z))return;const _e=l(Z),X=u.BASE.multiply(Z).toAffine(),Y=c(X.x);if(Y===_0n$6)return;const Ue=c(_e*c(G+Y*V));if(Ue===_0n$6)return;let Oe=(X.x===Y?0:2)|Number(X.y&_1n$6),De=Ue;return N&&b(Ue)&&(De=m(Ue),Oe^=1),new k(Y,De,Oe)}return{seed:q,k2sig:K}}const T={lowS:e.lowS,prehash:!1},$={lowS:e.lowS,prehash:!1};function E(v,_,S=T){const{seed:I,k2sig:R}=H(v,_,S),N=e;return createHmacDrbg$1(N.hash.outputLen,N.nByteLength,N.hmac)(I,R)}u.BASE._setWindowSize(8);function x(v,_,S,I=$){var X;const R=v;if(_=ensureBytes$1("msgHash",_),S=ensureBytes$1("publicKey",S),"strict"in I)throw new Error("options.strict was renamed to lowS");const{lowS:N,prehash:C}=I;let L,j;try{if(typeof R=="string"||R instanceof Uint8Array)try{L=k.fromDER(R)}catch(Y){if(!(Y instanceof DER$1.Err))throw Y;L=k.fromCompact(R)}else if(typeof R=="object"&&typeof R.r=="bigint"&&typeof R.s=="bigint"){const{r:Y,s:Ue}=R;L=new k(Y,Ue)}else throw new Error("PARSE");j=u.fromHex(S)}catch(Y){if(Y.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(N&&L.hasHighS())return!1;C&&(_=e.hash(_));const{r:V,s:z}=L,q=M(_),G=l(z),K=c(q*G),W=c(V*G),Z=(X=u.BASE.multiplyAndAddUnsafe(j,K,W))==null?void 0:X.toAffine();return Z?c(Z.x)===V:!1}return{CURVE:e,getPublicKey:B,getSharedSecret:O,sign:E,verify:x,ProjectivePoint:u,Signature:k,utils:A}}let HMAC$2=class extends Hash$2{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,hash$1(e);const s=toBytes$3(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,o=new Uint8Array(r);o.set(s.length>r?e.create().update(s).digest():s);for(let a=0;a<o.length;a++)o[a]^=54;this.iHash.update(o),this.oHash=e.create();for(let a=0;a<o.length;a++)o[a]^=106;this.oHash.update(o),o.fill(0)}update(e){return exists$2(this),this.iHash.update(e),this}digestInto(e){exists$2(this),bytes$2(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:s,finished:r,destroyed:o,blockLen:a,outputLen:c}=this;return e=e,e.finished=r,e.destroyed=o,e.blockLen=a,e.outputLen=c,e.oHash=n._cloneInto(e.oHash),e.iHash=s._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const hmac$2=(t,e,n)=>new HMAC$2(t,e).update(n).digest();hmac$2.create=(t,e)=>new HMAC$2(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function getHash(t){return{hash:t,hmac:(e,...n)=>hmac$2(t,e,concatBytes$3(...n)),randomBytes:randomBytes$2}}function createCurve$1(t,e){const n=s=>weierstrass$1({...t,...getHash(s)});return Object.freeze({...n(e),create:n})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1P=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),secp256k1N=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),_1n$5=BigInt(1),_2n$3=BigInt(2),divNearest$1=(t,e)=>(t+e/_2n$3)/e;function sqrtMod$1(t){const e=secp256k1P,n=BigInt(3),s=BigInt(6),r=BigInt(11),o=BigInt(22),a=BigInt(23),c=BigInt(44),l=BigInt(88),u=t*t*t%e,f=u*u*t%e,h=pow2$1(f,n,e)*f%e,p=pow2$1(h,n,e)*f%e,y=pow2$1(p,_2n$3,e)*u%e,b=pow2$1(y,r,e)*y%e,m=pow2$1(b,o,e)*b%e,w=pow2$1(m,c,e)*m%e,k=pow2$1(w,l,e)*w%e,A=pow2$1(k,c,e)*m%e,B=pow2$1(A,n,e)*f%e,P=pow2$1(B,a,e)*b%e,O=pow2$1(P,s,e)*u%e,U=pow2$1(O,_2n$3,e);if(!Fp.eql(Fp.sqr(U),t))throw new Error("Cannot find square root");return U}const Fp=Field$1(secp256k1P,void 0,void 0,{sqrt:sqrtMod$1}),secp256k1$1=createCurve$1({a:BigInt(0),b:BigInt(7),Fp,n:secp256k1N,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{const e=secp256k1N,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),s=-_1n$5*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),r=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=n,a=BigInt("0x100000000000000000000000000000000"),c=divNearest$1(o*t,e),l=divNearest$1(-s*t,e);let u=mod$1(t-c*n-l*r,e),f=mod$1(-c*s-l*o,e);const h=u>a,p=f>a;if(h&&(u=e-u),p&&(f=e-f),u>a||f>a)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:h,k1:u,k2neg:p,k2:f}}}},sha256$3),_0n$5=BigInt(0),fe=t=>typeof t=="bigint"&&_0n$5<t&&t<secp256k1P,ge=t=>typeof t=="bigint"&&_0n$5<t&&t<secp256k1N,TAGGED_HASH_PREFIXES$1={};function taggedHash$1(t,...e){let n=TAGGED_HASH_PREFIXES$1[t];if(n===void 0){const s=sha256$3(Uint8Array.from(t,r=>r.charCodeAt(0)));n=concatBytes$2(s,s),TAGGED_HASH_PREFIXES$1[t]=n}return sha256$3(concatBytes$2(n,...e))}const pointToBytes$1=t=>t.toRawBytes(!0).slice(1),numTo32b=t=>numberToBytesBE$1(t,32),modP=t=>mod$1(t,secp256k1P),modN=t=>mod$1(t,secp256k1N),Point=secp256k1$1.ProjectivePoint,GmulAdd=(t,e,n)=>Point.BASE.multiplyAndAddUnsafe(t,e,n);function schnorrGetExtPubKey$1(t){let e=secp256k1$1.utils.normPrivateKeyToScalar(t),n=Point.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:modN(-e),bytes:pointToBytes$1(n)}}function lift_x$1(t){if(!fe(t))throw new Error("bad x: need 0 < x < p");const e=modP(t*t),n=modP(e*t+BigInt(7));let s=sqrtMod$1(n);s%_2n$3!==_0n$5&&(s=modP(-s));const r=new Point(t,s,_1n$5);return r.assertValidity(),r}function challenge$1(...t){return modN(bytesToNumberBE$1(taggedHash$1("BIP0340/challenge",...t)))}function schnorrGetPublicKey$1(t){return schnorrGetExtPubKey$1(t).bytes}function schnorrSign$1(t,e,n=randomBytes$2(32)){const s=ensureBytes$1("message",t),{bytes:r,scalar:o}=schnorrGetExtPubKey$1(e),a=ensureBytes$1("auxRand",n,32),c=numTo32b(o^bytesToNumberBE$1(taggedHash$1("BIP0340/aux",a))),l=taggedHash$1("BIP0340/nonce",c,r,s),u=modN(bytesToNumberBE$1(l));if(u===_0n$5)throw new Error("sign failed: k is zero");const{bytes:f,scalar:h}=schnorrGetExtPubKey$1(u),p=challenge$1(f,r,s),y=new Uint8Array(64);if(y.set(f,0),y.set(numTo32b(modN(h+p*o)),32),!schnorrVerify$1(y,s,r))throw new Error("sign: Invalid signature produced");return y}function schnorrVerify$1(t,e,n){const s=ensureBytes$1("signature",t,64),r=ensureBytes$1("message",e),o=ensureBytes$1("publicKey",n,32);try{const a=lift_x$1(bytesToNumberBE$1(o)),c=bytesToNumberBE$1(s.subarray(0,32));if(!fe(c))return!1;const l=bytesToNumberBE$1(s.subarray(32,64));if(!ge(l))return!1;const u=challenge$1(numTo32b(c),pointToBytes$1(a),r),f=GmulAdd(a,l,modN(-u));return!(!f||!f.hasEvenY()||f.toAffine().x!==c)}catch{return!1}}const schnorr$1={getPublicKey:schnorrGetPublicKey$1,sign:schnorrSign$1,verify:schnorrVerify$1,utils:{randomPrivateKey:secp256k1$1.utils.randomPrivateKey,lift_x:lift_x$1,pointToBytes:pointToBytes$1,numberToBytesBE:numberToBytesBE$1,bytesToNumberBE:bytesToNumberBE$1,taggedHash:taggedHash$1,mod:mod$1}},crypto$1=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const u8a=t=>t instanceof Uint8Array,u32$1=t=>new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4)),createView$2=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),rotr$1=(t,e)=>t<<32-e|t>>>e,isLE$1=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE$1)throw new Error("Non little-endian hardware is not supported");const hexes$2=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex$2(t){if(!u8a(t))throw new Error("Uint8Array expected");let e="";for(let n=0;n<t.length;n++)e+=hexes$2[t[n]];return e}function hexToBytes$2(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(e/2);for(let s=0;s<n.length;s++){const r=s*2,o=t.slice(r,r+2),a=Number.parseInt(o,16);if(Number.isNaN(a)||a<0)throw new Error("Invalid byte sequence");n[s]=a}return n}function utf8ToBytes$2(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function toBytes$2(t){if(typeof t=="string"&&(t=utf8ToBytes$2(t)),!u8a(t))throw new Error(`expected Uint8Array, got ${typeof t}`);return t}function concatBytes$1(...t){const e=new Uint8Array(t.reduce((s,r)=>s+r.length,0));let n=0;return t.forEach(s=>{if(!u8a(s))throw new Error("Uint8Array expected");e.set(s,n),n+=s.length}),e}let Hash$1=class{clone(){return this._cloneInto()}};const isPlainObject=t=>Object.prototype.toString.call(t)==="[object Object]"&&t.constructor===Object;function checkOpts$1(t,e){if(e!==void 0&&(typeof e!="object"||!isPlainObject(e)))throw new Error("Options should be object or undefined");return Object.assign(t,e)}function wrapConstructor(t){const e=s=>t().update(toBytes$2(s)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function randomBytes$1(t=32){if(crypto$1&&typeof crypto$1.getRandomValues=="function")return crypto$1.getRandomValues(new Uint8Array(t));throw new Error("crypto.getRandomValues must be defined")}function number$1(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}function bool$1(t){if(typeof t!="boolean")throw new Error(`Expected boolean, not ${t}`)}function bytes$1(t,...e){if(!(t instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}function hash(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");number$1(t.outputLen),number$1(t.blockLen)}function exists$1(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function output$1(t,e){bytes$1(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const assert={number:number$1,bool:bool$1,bytes:bytes$1,hash,exists:exists$1,output:output$1};function setBigUint64$2(t,e,n,s){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,s);const r=BigInt(32),o=BigInt(4294967295),a=Number(n>>r&o),c=Number(n&o),l=s?4:0,u=s?0:4;t.setUint32(e+l,a,s),t.setUint32(e+u,c,s)}class SHA2 extends Hash$1{constructor(e,n,s,r){super(),this.blockLen=e,this.outputLen=n,this.padOffset=s,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=createView$2(this.buffer)}update(e){assert.exists(this);const{view:n,buffer:s,blockLen:r}=this;e=toBytes$2(e);const o=e.length;for(let a=0;a<o;){const c=Math.min(r-this.pos,o-a);if(c===r){const l=createView$2(e);for(;r<=o-a;a+=r)this.process(l,a);continue}s.set(e.subarray(a,a+c),this.pos),this.pos+=c,a+=c,this.pos===r&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){assert.exists(this),assert.output(e,this),this.finished=!0;const{buffer:n,view:s,blockLen:r,isLE:o}=this;let{pos:a}=this;n[a++]=128,this.buffer.subarray(a).fill(0),this.padOffset>r-a&&(this.process(s,0),a=0);for(let h=a;h<r;h++)n[h]=0;setBigUint64$2(s,r-8,BigInt(this.length*8),o),this.process(s,0);const c=createView$2(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=l/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)c.setUint32(4*h,f[h],o)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const s=e.slice(0,n);return this.destroy(),s}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:s,length:r,finished:o,destroyed:a,pos:c}=this;return e.length=r,e.pos=c,e.finished=o,e.destroyed=a,r%n&&e.buffer.set(s),e}}const Chi$1=(t,e,n)=>t&e^~t&n,Maj$1=(t,e,n)=>t&e^t&n^e&n,SHA256_K$1=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),IV=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_W$1=new Uint32Array(64);let SHA256$1=class extends SHA2{constructor(){super(64,32,8,!1),this.A=IV[0]|0,this.B=IV[1]|0,this.C=IV[2]|0,this.D=IV[3]|0,this.E=IV[4]|0,this.F=IV[5]|0,this.G=IV[6]|0,this.H=IV[7]|0}get(){const{A:e,B:n,C:s,D:r,E:o,F:a,G:c,H:l}=this;return[e,n,s,r,o,a,c,l]}set(e,n,s,r,o,a,c,l){this.A=e|0,this.B=n|0,this.C=s|0,this.D=r|0,this.E=o|0,this.F=a|0,this.G=c|0,this.H=l|0}process(e,n){for(let h=0;h<16;h++,n+=4)SHA256_W$1[h]=e.getUint32(n,!1);for(let h=16;h<64;h++){const p=SHA256_W$1[h-15],y=SHA256_W$1[h-2],b=rotr$1(p,7)^rotr$1(p,18)^p>>>3,m=rotr$1(y,17)^rotr$1(y,19)^y>>>10;SHA256_W$1[h]=m+SHA256_W$1[h-7]+b+SHA256_W$1[h-16]|0}let{A:s,B:r,C:o,D:a,E:c,F:l,G:u,H:f}=this;for(let h=0;h<64;h++){const p=rotr$1(c,6)^rotr$1(c,11)^rotr$1(c,25),y=f+p+Chi$1(c,l,u)+SHA256_K$1[h]+SHA256_W$1[h]|0,m=(rotr$1(s,2)^rotr$1(s,13)^rotr$1(s,22))+Maj$1(s,r,o)|0;f=u,u=l,l=c,c=a+y|0,a=o,o=r,r=s,s=y+m|0}s=s+this.A|0,r=r+this.B|0,o=o+this.C|0,a=a+this.D|0,c=c+this.E|0,l=l+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(s,r,o,a,c,l,u,f)}roundClean(){SHA256_W$1.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};class SHA224 extends SHA256$1{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const sha256$2=wrapConstructor(()=>new SHA256$1);wrapConstructor(()=>new SHA224);/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */function assertNumber(t){if(!Number.isSafeInteger(t))throw new Error(`Wrong integer: ${t}`)}function chain(...t){const e=(r,o)=>a=>r(o(a)),n=Array.from(t).reverse().reduce((r,o)=>r?e(r,o.encode):o.encode,void 0),s=t.reduce((r,o)=>r?e(r,o.decode):o.decode,void 0);return{encode:n,decode:s}}function alphabet(t){return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return e.map(n=>{if(assertNumber(n),n<0||n>=t.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${t.length})`);return t[n]})},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("alphabet.decode input should be array of strings");return e.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);const s=t.indexOf(n);if(s===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${t}`);return s})}}}function join(t=""){if(typeof t!="string")throw new Error("join separator should be string");return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("join.encode input should be array of strings");for(let n of e)if(typeof n!="string")throw new Error(`join.encode: non-string input=${n}`);return e.join(t)},decode:e=>{if(typeof e!="string")throw new Error("join.decode input should be string");return e.split(t)}}}function padding(t,e="="){if(assertNumber(t),typeof e!="string")throw new Error("padding chr should be string");return{encode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let s of n)if(typeof s!="string")throw new Error(`padding.encode: non-string input=${s}`);for(;n.length*t%8;)n.push(e);return n},decode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let r of n)if(typeof r!="string")throw new Error(`padding.decode: non-string input=${r}`);let s=n.length;if(s*t%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;s>0&&n[s-1]===e;s--)if(!((s-1)*t%8))throw new Error("Invalid padding: string has too much padding");return n.slice(0,s)}}}function normalize$1(t){if(typeof t!="function")throw new Error("normalize fn should be function");return{encode:e=>e,decode:e=>t(e)}}function convertRadix(t,e,n){if(e<2)throw new Error(`convertRadix: wrong from=${e}, base cannot be less than 2`);if(n<2)throw new Error(`convertRadix: wrong to=${n}, base cannot be less than 2`);if(!Array.isArray(t))throw new Error("convertRadix: data should be array");if(!t.length)return[];let s=0;const r=[],o=Array.from(t);for(o.forEach(a=>{if(assertNumber(a),a<0||a>=e)throw new Error(`Wrong integer: ${a}`)});;){let a=0,c=!0;for(let l=s;l<o.length;l++){const u=o[l],f=e*a+u;if(!Number.isSafeInteger(f)||e*a/e!==a||f-u!==e*a)throw new Error("convertRadix: carry overflow");if(a=f%n,o[l]=Math.floor(f/n),!Number.isSafeInteger(o[l])||o[l]*n+a!==f)throw new Error("convertRadix: carry overflow");if(c)o[l]?c=!1:s=l;else continue}if(r.push(a),c)break}for(let a=0;a<t.length-1&&t[a]===0;a++)r.push(0);return r.reverse()}const gcd=(t,e)=>e?gcd(e,t%e):t,radix2carry=(t,e)=>t+(e-gcd(t,e));function convertRadix2(t,e,n,s){if(!Array.isArray(t))throw new Error("convertRadix2: data should be array");if(e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(radix2carry(e,n)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${n} carryBits=${radix2carry(e,n)}`);let r=0,o=0;const a=2**n-1,c=[];for(const l of t){if(assertNumber(l),l>=2**e)throw new Error(`convertRadix2: invalid data word=${l} from=${e}`);if(r=r<<e|l,o+e>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${e}`);for(o+=e;o>=n;o-=n)c.push((r>>o-n&a)>>>0);r&=2**o-1}if(r=r<<n-o&a,!s&&o>=e)throw new Error("Excess padding");if(!s&&r)throw new Error(`Non-zero padding: ${r}`);return s&&o>0&&c.push(r>>>0),c}function radix(t){return assertNumber(t),{encode:e=>{if(!(e instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return convertRadix(Array.from(e),2**8,t)},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(convertRadix(e,t,2**8))}}}function radix2(t,e=!1){if(assertNumber(t),t<=0||t>32)throw new Error("radix2: bits should be in (0..32]");if(radix2carry(8,t)>32||radix2carry(t,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!(n instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return convertRadix2(Array.from(n),8,t,!e)},decode:n=>{if(!Array.isArray(n)||n.length&&typeof n[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(convertRadix2(n,t,8,e))}}}function unsafeWrapper(t){if(typeof t!="function")throw new Error("unsafeWrapper fn should be function");return function(...e){try{return t.apply(null,e)}catch{}}}const base16=chain(radix2(4),alphabet("0123456789ABCDEF"),join("")),base32=chain(radix2(5),alphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),padding(5),join(""));chain(radix2(5),alphabet("0123456789ABCDEFGHIJKLMNOPQRSTUV"),padding(5),join(""));chain(radix2(5),alphabet("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),join(""),normalize$1(t=>t.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")));const base64=chain(radix2(6),alphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),padding(6),join("")),base64url=chain(radix2(6),alphabet("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),padding(6),join("")),genBase58=t=>chain(radix(58),alphabet(t),join("")),base58=genBase58("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");genBase58("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ");genBase58("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const XMR_BLOCK_LEN=[0,2,3,5,6,7,9,10,11],base58xmr={encode(t){let e="";for(let n=0;n<t.length;n+=8){const s=t.subarray(n,n+8);e+=base58.encode(s).padStart(XMR_BLOCK_LEN[s.length],"1")}return e},decode(t){let e=[];for(let n=0;n<t.length;n+=11){const s=t.slice(n,n+11),r=XMR_BLOCK_LEN.indexOf(s.length),o=base58.decode(s);for(let a=0;a<o.length-r;a++)if(o[a]!==0)throw new Error("base58xmr: wrong padding");e=e.concat(Array.from(o.slice(o.length-r)))}return Uint8Array.from(e)}},BECH_ALPHABET=chain(alphabet("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),join("")),POLYMOD_GENERATORS=[996825010,642813549,513874426,1027748829,705979059];function bech32Polymod(t){const e=t>>25;let n=(t&33554431)<<5;for(let s=0;s<POLYMOD_GENERATORS.length;s++)(e>>s&1)===1&&(n^=POLYMOD_GENERATORS[s]);return n}function bechChecksum(t,e,n=1){const s=t.length;let r=1;for(let o=0;o<s;o++){const a=t.charCodeAt(o);if(a<33||a>126)throw new Error(`Invalid prefix (${t})`);r=bech32Polymod(r)^a>>5}r=bech32Polymod(r);for(let o=0;o<s;o++)r=bech32Polymod(r)^t.charCodeAt(o)&31;for(let o of e)r=bech32Polymod(r)^o;for(let o=0;o<6;o++)r=bech32Polymod(r);return r^=n,BECH_ALPHABET.encode(convertRadix2([r%2**30],30,5,!1))}function genBech32(t){const e=t==="bech32"?1:734539939,n=radix2(5),s=n.decode,r=n.encode,o=unsafeWrapper(s);function a(f,h,p=90){if(typeof f!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof f}`);if(!Array.isArray(h)||h.length&&typeof h[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof h}`);const y=f.length+7+h.length;if(p!==!1&&y>p)throw new TypeError(`Length ${y} exceeds limit ${p}`);return f=f.toLowerCase(),`${f}1${BECH_ALPHABET.encode(h)}${bechChecksum(f,h,e)}`}function c(f,h=90){if(typeof f!="string")throw new Error(`bech32.decode input should be string, not ${typeof f}`);if(f.length<8||h!==!1&&f.length>h)throw new TypeError(`Wrong string length: ${f.length} (${f}). Expected (8..${h})`);const p=f.toLowerCase();if(f!==p&&f!==f.toUpperCase())throw new Error("String must be lowercase or uppercase");f=p;const y=f.lastIndexOf("1");if(y===0||y===-1)throw new Error('Letter "1" must be present between prefix and data only');const b=f.slice(0,y),m=f.slice(y+1);if(m.length<6)throw new Error("Data must be at least 6 characters long");const w=BECH_ALPHABET.decode(m).slice(0,-6),k=bechChecksum(b,w,e);if(!m.endsWith(k))throw new Error(`Invalid checksum in ${f}: expected "${k}"`);return{prefix:b,words:w}}const l=unsafeWrapper(c);function u(f){const{prefix:h,words:p}=c(f,!1);return{prefix:h,words:p,bytes:s(p)}}return{encode:a,decode:c,decodeToBytes:u,decodeUnsafe:l,fromWords:s,fromWordsUnsafe:o,toWords:r}}const bech32$1=genBech32("bech32");genBech32("bech32m");const utf8$1={encode:t=>new TextDecoder().decode(t),decode:t=>new TextEncoder().encode(t)},hex$1=chain(radix2(4),alphabet("0123456789abcdef"),join(""),normalize$1(t=>{if(typeof t!="string"||t.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof t} with length ${t.length}`);return t.toLowerCase()})),CODERS={utf8:utf8$1,hex:hex$1,base16,base32,base64,base64url,base58,base58xmr};`${Object.keys(CODERS).join(", ")}`;function number(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`positive integer expected, not ${t}`)}function bool(t){if(typeof t!="boolean")throw new Error(`boolean expected, not ${t}`)}function isBytes$1(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function bytes(t,...e){if(!isBytes$1(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${t.length}`)}function exists(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function output(t,e){bytes(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const u32=t=>new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4)),createView$1=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE)throw new Error("Non little-endian hardware is not supported");const hexes$1=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex$1(t){bytes(t);let e="";for(let n=0;n<t.length;n++)e+=hexes$1[t[n]];return e}const asciis$1={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function asciiToBase16$1(t){if(t>=asciis$1._0&&t<=asciis$1._9)return t-asciis$1._0;if(t>=asciis$1._A&&t<=asciis$1._F)return t-(asciis$1._A-10);if(t>=asciis$1._a&&t<=asciis$1._f)return t-(asciis$1._a-10)}function hexToBytes$1(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const s=new Uint8Array(n);for(let r=0,o=0;r<n;r++,o+=2){const a=asciiToBase16$1(t.charCodeAt(o)),c=asciiToBase16$1(t.charCodeAt(o+1));if(a===void 0||c===void 0){const l=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+o)}s[r]=a*16+c}return s}function utf8ToBytes$1(t){if(typeof t!="string")throw new Error(`string expected, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function toBytes$1(t){if(typeof t=="string")t=utf8ToBytes$1(t);else if(isBytes$1(t))t=t.slice();else throw new Error(`Uint8Array expected, got ${typeof t}`);return t}function checkOpts(t,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(t,e)}function equalBytes(t,e){if(t.length!==e.length)return!1;let n=0;for(let s=0;s<t.length;s++)n|=t[s]^e[s];return n===0}const wrapCipher=(t,e)=>(Object.assign(e,t),e);function setBigUint64$1(t,e,n,s){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,s);const r=BigInt(32),o=BigInt(4294967295),a=Number(n>>r&o),c=Number(n&o),l=4,u=0;t.setUint32(e+l,a,s),t.setUint32(e+u,c,s)}const BLOCK_SIZE=16,POLY=283;function mul2(t){return t<<1^POLY&-(t>>7)}function mul(t,e){let n=0;for(;e>0;e>>=1)n^=t&-(e&1),t=mul2(t);return n}const sbox=(()=>{let t=new Uint8Array(256);for(let n=0,s=1;n<256;n++,s^=mul2(s))t[n]=s;const e=new Uint8Array(256);e[0]=99;for(let n=0;n<255;n++){let s=t[255-n];s|=s<<8,e[t[n]]=(s^s>>4^s>>5^s>>6^s>>7^99)&255}return e})(),invSbox=sbox.map((t,e)=>sbox.indexOf(e)),rotr32_8=t=>t<<24|t>>>8,rotl32_8=t=>t<<8|t>>>24;function genTtable(t,e){if(t.length!==256)throw new Error("Wrong sbox length");const n=new Uint32Array(256).map((u,f)=>e(t[f])),s=n.map(rotl32_8),r=s.map(rotl32_8),o=r.map(rotl32_8),a=new Uint32Array(256*256),c=new Uint32Array(256*256),l=new Uint16Array(256*256);for(let u=0;u<256;u++)for(let f=0;f<256;f++){const h=u*256+f;a[h]=n[u]^s[f],c[h]=r[u]^o[f],l[h]=t[u]<<8|t[f]}return{sbox:t,sbox2:l,T0:n,T1:s,T2:r,T3:o,T01:a,T23:c}}const tableEncoding=genTtable(sbox,t=>mul(t,3)<<24|t<<16|t<<8|mul(t,2)),tableDecoding=genTtable(invSbox,t=>mul(t,11)<<24|mul(t,13)<<16|mul(t,9)<<8|mul(t,14)),xPowers=(()=>{const t=new Uint8Array(16);for(let e=0,n=1;e<16;e++,n=mul2(n))t[e]=n;return t})();function expandKeyLE(t){bytes(t);const e=t.length;if(![16,24,32].includes(e))throw new Error(`aes: wrong key size: should be 16, 24 or 32, got: ${e}`);const{sbox2:n}=tableEncoding,s=u32(t),r=s.length,o=c=>applySbox(n,c,c,c,c),a=new Uint32Array(e+28);a.set(s);for(let c=r;c<a.length;c++){let l=a[c-1];c%r===0?l=o(rotr32_8(l))^xPowers[c/r-1]:r>6&&c%r===4&&(l=o(l)),a[c]=a[c-r]^l}return a}function expandKeyDecLE(t){const e=expandKeyLE(t),n=e.slice(),s=e.length,{sbox2:r}=tableEncoding,{T0:o,T1:a,T2:c,T3:l}=tableDecoding;for(let u=0;u<s;u+=4)for(let f=0;f<4;f++)n[u+f]=e[s-u-4+f];e.fill(0);for(let u=4;u<s-4;u++){const f=n[u],h=applySbox(r,f,f,f,f);n[u]=o[h&255]^a[h>>>8&255]^c[h>>>16&255]^l[h>>>24]}return n}function apply0123(t,e,n,s,r,o){return t[n<<8&65280|s>>>8&255]^e[r>>>8&65280|o>>>24&255]}function applySbox(t,e,n,s,r){return t[e&255|n&65280]|t[s>>>16&255|r>>>16&65280]<<16}function encrypt$3(t,e,n,s,r){const{sbox2:o,T01:a,T23:c}=tableEncoding;let l=0;e^=t[l++],n^=t[l++],s^=t[l++],r^=t[l++];const u=t.length/4-2;for(let b=0;b<u;b++){const m=t[l++]^apply0123(a,c,e,n,s,r),w=t[l++]^apply0123(a,c,n,s,r,e),k=t[l++]^apply0123(a,c,s,r,e,n),A=t[l++]^apply0123(a,c,r,e,n,s);e=m,n=w,s=k,r=A}const f=t[l++]^applySbox(o,e,n,s,r),h=t[l++]^applySbox(o,n,s,r,e),p=t[l++]^applySbox(o,s,r,e,n),y=t[l++]^applySbox(o,r,e,n,s);return{s0:f,s1:h,s2:p,s3:y}}function decrypt$3(t,e,n,s,r){const{sbox2:o,T01:a,T23:c}=tableDecoding;let l=0;e^=t[l++],n^=t[l++],s^=t[l++],r^=t[l++];const u=t.length/4-2;for(let b=0;b<u;b++){const m=t[l++]^apply0123(a,c,e,r,s,n),w=t[l++]^apply0123(a,c,n,e,r,s),k=t[l++]^apply0123(a,c,s,n,e,r),A=t[l++]^apply0123(a,c,r,s,n,e);e=m,n=w,s=k,r=A}const f=t[l++]^applySbox(o,e,r,s,n),h=t[l++]^applySbox(o,n,e,r,s),p=t[l++]^applySbox(o,s,n,e,r),y=t[l++]^applySbox(o,r,s,n,e);return{s0:f,s1:h,s2:p,s3:y}}function getDst(t,e){if(!e)return new Uint8Array(t);if(bytes(e),e.length<t)throw new Error(`aes: wrong destination length, expected at least ${t}, got: ${e.length}`);return e}function validateBlockDecrypt(t){if(bytes(t),t.length%BLOCK_SIZE!==0)throw new Error(`aes/(cbc-ecb).decrypt ciphertext should consist of blocks with size ${BLOCK_SIZE}`)}function validateBlockEncrypt(t,e,n){let s=t.length;const r=s%BLOCK_SIZE;if(!e&&r!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");const o=u32(t);if(e){let l=BLOCK_SIZE-r;l||(l=BLOCK_SIZE),s=s+l}const a=getDst(s,n),c=u32(a);return{b:o,o:c,out:a}}function validatePCKS(t,e){if(!e)return t;const n=t.length;if(!n)throw new Error("aes/pcks5: empty ciphertext not allowed");const s=t[n-1];if(s<=0||s>16)throw new Error(`aes/pcks5: wrong padding byte: ${s}`);const r=t.subarray(0,-s);for(let o=0;o<s;o++)if(t[n-o-1]!==s)throw new Error("aes/pcks5: wrong padding");return r}function padPCKS(t){const e=new Uint8Array(16),n=u32(e);e.set(t);const s=BLOCK_SIZE-t.length;for(let r=BLOCK_SIZE-s;r<BLOCK_SIZE;r++)e[r]=s;return n}const cbc=wrapCipher({blockSize:16,nonceLength:16},function t(e,n,s={}){bytes(e),bytes(n,16);const r=!s.disablePadding;return{encrypt:(o,a)=>{const c=expandKeyLE(e),{b:l,o:u,out:f}=validateBlockEncrypt(o,r,a),h=u32(n);let p=h[0],y=h[1],b=h[2],m=h[3],w=0;for(;w+4<=l.length;)p^=l[w+0],y^=l[w+1],b^=l[w+2],m^=l[w+3],{s0:p,s1:y,s2:b,s3:m}=encrypt$3(c,p,y,b,m),u[w++]=p,u[w++]=y,u[w++]=b,u[w++]=m;if(r){const k=padPCKS(o.subarray(w*4));p^=k[0],y^=k[1],b^=k[2],m^=k[3],{s0:p,s1:y,s2:b,s3:m}=encrypt$3(c,p,y,b,m),u[w++]=p,u[w++]=y,u[w++]=b,u[w++]=m}return c.fill(0),f},decrypt:(o,a)=>{validateBlockDecrypt(o);const c=expandKeyDecLE(e),l=u32(n),u=getDst(o.length,a),f=u32(o),h=u32(u);let p=l[0],y=l[1],b=l[2],m=l[3];for(let w=0;w+4<=f.length;){const k=p,A=y,B=b,P=m;p=f[w+0],y=f[w+1],b=f[w+2],m=f[w+3];const{s0:O,s1:U,s2:M,s3:D}=decrypt$3(c,p,y,b,m);h[w++]=O^k,h[w++]=U^A,h[w++]=M^B,h[w++]=D^P}return c.fill(0),validatePCKS(u,r)}}}),u8to16=(t,e)=>t[e++]&255|(t[e++]&255)<<8;class Poly1305{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=toBytes$1(e),bytes(e,32);const n=u8to16(e,0),s=u8to16(e,2),r=u8to16(e,4),o=u8to16(e,6),a=u8to16(e,8),c=u8to16(e,10),l=u8to16(e,12),u=u8to16(e,14);this.r[0]=n&8191,this.r[1]=(n>>>13|s<<3)&8191,this.r[2]=(s>>>10|r<<6)&7939,this.r[3]=(r>>>7|o<<9)&8191,this.r[4]=(o>>>4|a<<12)&255,this.r[5]=a>>>1&8190,this.r[6]=(a>>>14|c<<2)&8191,this.r[7]=(c>>>11|l<<5)&8065,this.r[8]=(l>>>8|u<<8)&8191,this.r[9]=u>>>5&127;for(let f=0;f<8;f++)this.pad[f]=u8to16(e,16+2*f)}process(e,n,s=!1){const r=s?0:2048,{h:o,r:a}=this,c=a[0],l=a[1],u=a[2],f=a[3],h=a[4],p=a[5],y=a[6],b=a[7],m=a[8],w=a[9],k=u8to16(e,n+0),A=u8to16(e,n+2),B=u8to16(e,n+4),P=u8to16(e,n+6),O=u8to16(e,n+8),U=u8to16(e,n+10),M=u8to16(e,n+12),D=u8to16(e,n+14);let F=o[0]+(k&8191),H=o[1]+((k>>>13|A<<3)&8191),T=o[2]+((A>>>10|B<<6)&8191),$=o[3]+((B>>>7|P<<9)&8191),E=o[4]+((P>>>4|O<<12)&8191),x=o[5]+(O>>>1&8191),v=o[6]+((O>>>14|U<<2)&8191),_=o[7]+((U>>>11|M<<5)&8191),S=o[8]+((M>>>8|D<<8)&8191),I=o[9]+(D>>>5|r),R=0,N=R+F*c+H*(5*w)+T*(5*m)+$*(5*b)+E*(5*y);R=N>>>13,N&=8191,N+=x*(5*p)+v*(5*h)+_*(5*f)+S*(5*u)+I*(5*l),R+=N>>>13,N&=8191;let C=R+F*l+H*c+T*(5*w)+$*(5*m)+E*(5*b);R=C>>>13,C&=8191,C+=x*(5*y)+v*(5*p)+_*(5*h)+S*(5*f)+I*(5*u),R+=C>>>13,C&=8191;let L=R+F*u+H*l+T*c+$*(5*w)+E*(5*m);R=L>>>13,L&=8191,L+=x*(5*b)+v*(5*y)+_*(5*p)+S*(5*h)+I*(5*f),R+=L>>>13,L&=8191;let j=R+F*f+H*u+T*l+$*c+E*(5*w);R=j>>>13,j&=8191,j+=x*(5*m)+v*(5*b)+_*(5*y)+S*(5*p)+I*(5*h),R+=j>>>13,j&=8191;let V=R+F*h+H*f+T*u+$*l+E*c;R=V>>>13,V&=8191,V+=x*(5*w)+v*(5*m)+_*(5*b)+S*(5*y)+I*(5*p),R+=V>>>13,V&=8191;let z=R+F*p+H*h+T*f+$*u+E*l;R=z>>>13,z&=8191,z+=x*c+v*(5*w)+_*(5*m)+S*(5*b)+I*(5*y),R+=z>>>13,z&=8191;let q=R+F*y+H*p+T*h+$*f+E*u;R=q>>>13,q&=8191,q+=x*l+v*c+_*(5*w)+S*(5*m)+I*(5*b),R+=q>>>13,q&=8191;let G=R+F*b+H*y+T*p+$*h+E*f;R=G>>>13,G&=8191,G+=x*u+v*l+_*c+S*(5*w)+I*(5*m),R+=G>>>13,G&=8191;let K=R+F*m+H*b+T*y+$*p+E*h;R=K>>>13,K&=8191,K+=x*f+v*u+_*l+S*c+I*(5*w),R+=K>>>13,K&=8191;let W=R+F*w+H*m+T*b+$*y+E*p;R=W>>>13,W&=8191,W+=x*h+v*f+_*u+S*l+I*c,R+=W>>>13,W&=8191,R=(R<<2)+R|0,R=R+N|0,N=R&8191,R=R>>>13,C+=R,o[0]=N,o[1]=C,o[2]=L,o[3]=j,o[4]=V,o[5]=z,o[6]=q,o[7]=G,o[8]=K,o[9]=W}finalize(){const{h:e,pad:n}=this,s=new Uint16Array(10);let r=e[1]>>>13;e[1]&=8191;for(let c=2;c<10;c++)e[c]+=r,r=e[c]>>>13,e[c]&=8191;e[0]+=r*5,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,s[0]=e[0]+5,r=s[0]>>>13,s[0]&=8191;for(let c=1;c<10;c++)s[c]=e[c]+r,r=s[c]>>>13,s[c]&=8191;s[9]-=8192;let o=(r^1)-1;for(let c=0;c<10;c++)s[c]&=o;o=~o;for(let c=0;c<10;c++)e[c]=e[c]&o|s[c];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let a=e[0]+n[0];e[0]=a&65535;for(let c=1;c<8;c++)a=(e[c]+n[c]|0)+(a>>>16)|0,e[c]=a&65535}update(e){exists(this);const{buffer:n,blockLen:s}=this;e=toBytes$1(e);const r=e.length;for(let o=0;o<r;){const a=Math.min(s-this.pos,r-o);if(a===s){for(;s<=r-o;o+=s)this.process(e,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(n,0,!1),this.pos=0)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(e){exists(this),output(e,this),this.finished=!0;const{buffer:n,h:s}=this;let{pos:r}=this;if(r){for(n[r++]=1;r<16;r++)n[r]=0;this.process(n,0,!0)}this.finalize();let o=0;for(let a=0;a<8;a++)e[o++]=s[a]>>>0,e[o++]=s[a]>>>8;return e}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const s=e.slice(0,n);return this.destroy(),s}}function wrapConstructorWithKey(t){const e=(s,r)=>t(r).update(toBytes$1(s)).digest(),n=t(new Uint8Array(32));return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=s=>t(s),e}const poly1305=wrapConstructorWithKey(t=>new Poly1305(t)),_utf8ToBytes=t=>Uint8Array.from(t.split("").map(e=>e.charCodeAt(0))),sigma16=_utf8ToBytes("expand 16-byte k"),sigma32=_utf8ToBytes("expand 32-byte k"),sigma16_32=u32(sigma16),sigma32_32=u32(sigma32);sigma32_32.slice();function rotl$1(t,e){return t<<e|t>>>32-e}function isAligned32(t){return t.byteOffset%4===0}const BLOCK_LEN=64,BLOCK_LEN32=16,MAX_COUNTER=2**32-1,U32_EMPTY=new Uint32Array;function runCipher(t,e,n,s,r,o,a,c){const l=r.length,u=new Uint8Array(BLOCK_LEN),f=u32(u),h=isAligned32(r)&&isAligned32(o),p=h?u32(r):U32_EMPTY,y=h?u32(o):U32_EMPTY;for(let b=0;b<l;a++){if(t(e,n,s,f,a,c),a>=MAX_COUNTER)throw new Error("arx: counter overflow");const m=Math.min(BLOCK_LEN,l-b);if(h&&m===BLOCK_LEN){const w=b/4;if(b%4!==0)throw new Error("arx: invalid block position");for(let k=0,A;k<BLOCK_LEN32;k++)A=w+k,y[A]=p[A]^f[k];b+=BLOCK_LEN;continue}for(let w=0,k;w<m;w++)k=b+w,o[k]=r[k]^u[w];b+=m}}function createCipher(t,e){const{allowShortKeys:n,extendNonceFn:s,counterLength:r,counterRight:o,rounds:a}=checkOpts({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof t!="function")throw new Error("core must be a function");return number(r),number(a),bool(o),bool(n),(c,l,u,f,h=0)=>{bytes(c),bytes(l),bytes(u);const p=u.length;if(f||(f=new Uint8Array(p)),bytes(f),number(h),h<0||h>=MAX_COUNTER)throw new Error("arx: counter overflow");if(f.length<p)throw new Error(`arx: output (${f.length}) is shorter than data (${p})`);const y=[];let b=c.length,m,w;if(b===32)m=c.slice(),y.push(m),w=sigma32_32;else if(b===16&&n)m=new Uint8Array(32),m.set(c),m.set(c,16),w=sigma16_32,y.push(m);else throw new Error(`arx: invalid 32-byte key, got length=${b}`);isAligned32(l)||(l=l.slice(),y.push(l));const k=u32(m);if(s){if(l.length!==24)throw new Error("arx: extended nonce must be 24 bytes");s(w,k,u32(l.subarray(0,16)),k),l=l.subarray(16)}const A=16-r;if(A!==l.length)throw new Error(`arx: nonce must be ${A} or 16 bytes`);if(A!==12){const P=new Uint8Array(12);P.set(l,o?0:12-l.length),l=P,y.push(l)}const B=u32(l);for(runCipher(t,w,k,B,u,f,h,a);y.length>0;)y.pop().fill(0);return f}}function chachaCore(t,e,n,s,r,o=20){let a=t[0],c=t[1],l=t[2],u=t[3],f=e[0],h=e[1],p=e[2],y=e[3],b=e[4],m=e[5],w=e[6],k=e[7],A=r,B=n[0],P=n[1],O=n[2],U=a,M=c,D=l,F=u,H=f,T=h,$=p,E=y,x=b,v=m,_=w,S=k,I=A,R=B,N=P,C=O;for(let j=0;j<o;j+=2)U=U+H|0,I=rotl$1(I^U,16),x=x+I|0,H=rotl$1(H^x,12),U=U+H|0,I=rotl$1(I^U,8),x=x+I|0,H=rotl$1(H^x,7),M=M+T|0,R=rotl$1(R^M,16),v=v+R|0,T=rotl$1(T^v,12),M=M+T|0,R=rotl$1(R^M,8),v=v+R|0,T=rotl$1(T^v,7),D=D+$|0,N=rotl$1(N^D,16),_=_+N|0,$=rotl$1($^_,12),D=D+$|0,N=rotl$1(N^D,8),_=_+N|0,$=rotl$1($^_,7),F=F+E|0,C=rotl$1(C^F,16),S=S+C|0,E=rotl$1(E^S,12),F=F+E|0,C=rotl$1(C^F,8),S=S+C|0,E=rotl$1(E^S,7),U=U+T|0,C=rotl$1(C^U,16),_=_+C|0,T=rotl$1(T^_,12),U=U+T|0,C=rotl$1(C^U,8),_=_+C|0,T=rotl$1(T^_,7),M=M+$|0,I=rotl$1(I^M,16),S=S+I|0,$=rotl$1($^S,12),M=M+$|0,I=rotl$1(I^M,8),S=S+I|0,$=rotl$1($^S,7),D=D+E|0,R=rotl$1(R^D,16),x=x+R|0,E=rotl$1(E^x,12),D=D+E|0,R=rotl$1(R^D,8),x=x+R|0,E=rotl$1(E^x,7),F=F+H|0,N=rotl$1(N^F,16),v=v+N|0,H=rotl$1(H^v,12),F=F+H|0,N=rotl$1(N^F,8),v=v+N|0,H=rotl$1(H^v,7);let L=0;s[L++]=a+U|0,s[L++]=c+M|0,s[L++]=l+D|0,s[L++]=u+F|0,s[L++]=f+H|0,s[L++]=h+T|0,s[L++]=p+$|0,s[L++]=y+E|0,s[L++]=b+x|0,s[L++]=m+v|0,s[L++]=w+_|0,s[L++]=k+S|0,s[L++]=A+I|0,s[L++]=B+R|0,s[L++]=P+N|0,s[L++]=O+C|0}function hchacha(t,e,n,s){let r=t[0],o=t[1],a=t[2],c=t[3],l=e[0],u=e[1],f=e[2],h=e[3],p=e[4],y=e[5],b=e[6],m=e[7],w=n[0],k=n[1],A=n[2],B=n[3];for(let O=0;O<20;O+=2)r=r+l|0,w=rotl$1(w^r,16),p=p+w|0,l=rotl$1(l^p,12),r=r+l|0,w=rotl$1(w^r,8),p=p+w|0,l=rotl$1(l^p,7),o=o+u|0,k=rotl$1(k^o,16),y=y+k|0,u=rotl$1(u^y,12),o=o+u|0,k=rotl$1(k^o,8),y=y+k|0,u=rotl$1(u^y,7),a=a+f|0,A=rotl$1(A^a,16),b=b+A|0,f=rotl$1(f^b,12),a=a+f|0,A=rotl$1(A^a,8),b=b+A|0,f=rotl$1(f^b,7),c=c+h|0,B=rotl$1(B^c,16),m=m+B|0,h=rotl$1(h^m,12),c=c+h|0,B=rotl$1(B^c,8),m=m+B|0,h=rotl$1(h^m,7),r=r+u|0,B=rotl$1(B^r,16),b=b+B|0,u=rotl$1(u^b,12),r=r+u|0,B=rotl$1(B^r,8),b=b+B|0,u=rotl$1(u^b,7),o=o+f|0,w=rotl$1(w^o,16),m=m+w|0,f=rotl$1(f^m,12),o=o+f|0,w=rotl$1(w^o,8),m=m+w|0,f=rotl$1(f^m,7),a=a+h|0,k=rotl$1(k^a,16),p=p+k|0,h=rotl$1(h^p,12),a=a+h|0,k=rotl$1(k^a,8),p=p+k|0,h=rotl$1(h^p,7),c=c+l|0,A=rotl$1(A^c,16),y=y+A|0,l=rotl$1(l^y,12),c=c+l|0,A=rotl$1(A^c,8),y=y+A|0,l=rotl$1(l^y,7);let P=0;s[P++]=r,s[P++]=o,s[P++]=a,s[P++]=c,s[P++]=w,s[P++]=k,s[P++]=A,s[P++]=B}const chacha20=createCipher(chachaCore,{counterRight:!1,counterLength:4,allowShortKeys:!1}),xchacha20=createCipher(chachaCore,{counterRight:!1,counterLength:8,extendNonceFn:hchacha,allowShortKeys:!1}),ZEROS16=new Uint8Array(16),updatePadded=(t,e)=>{t.update(e);const n=e.length%16;n&&t.update(ZEROS16.subarray(n))},ZEROS32=new Uint8Array(32);function computeTag(t,e,n,s,r){const o=t(e,n,ZEROS32),a=poly1305.create(o);r&&updatePadded(a,r),updatePadded(a,s);const c=new Uint8Array(16),l=createView$1(c);setBigUint64$1(l,0,BigInt(r?r.length:0),!0),setBigUint64$1(l,8,BigInt(s.length),!0),a.update(c);const u=a.digest();return o.fill(0),u}const _poly1305_aead=t=>(e,n,s)=>(bytes(e,32),bytes(n),{encrypt:(o,a)=>{const c=o.length,l=c+16;a?bytes(a,l):a=new Uint8Array(l),t(e,n,o,a,1);const u=computeTag(t,e,n,a.subarray(0,-16),s);return a.set(u,c),a},decrypt:(o,a)=>{const c=o.length,l=c-16;if(c<16)throw new Error("encrypted data must be at least 16 bytes");a?bytes(a,l):a=new Uint8Array(l);const u=o.subarray(0,-16),f=o.subarray(-16),h=computeTag(t,e,n,u,s);if(!equalBytes(f,h))throw new Error("invalid tag");return t(e,n,u,a,1),a}}),xchacha20poly1305=wrapCipher({blockSize:64,nonceLength:24,tagLength:16},_poly1305_aead(xchacha20));let HMAC$1=class extends Hash$1{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,assert.hash(e);const s=toBytes$2(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,o=new Uint8Array(r);o.set(s.length>r?e.create().update(s).digest():s);for(let a=0;a<o.length;a++)o[a]^=54;this.iHash.update(o),this.oHash=e.create();for(let a=0;a<o.length;a++)o[a]^=106;this.oHash.update(o),o.fill(0)}update(e){return assert.exists(this),this.iHash.update(e),this}digestInto(e){assert.exists(this),assert.bytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:s,finished:r,destroyed:o,blockLen:a,outputLen:c}=this;return e=e,e.finished=r,e.destroyed=o,e.blockLen=a,e.outputLen=c,e.oHash=n._cloneInto(e.oHash),e.iHash=s._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const hmac$1=(t,e,n)=>new HMAC$1(t,e).update(n).digest();hmac$1.create=(t,e)=>new HMAC$1(t,e);function extract(t,e,n){return assert.hash(t),hmac$1(t,toBytes$2(n),toBytes$2(e))}const HKDF_COUNTER=new Uint8Array([0]),EMPTY_BUFFER=new Uint8Array;function expand(t,e,n,s=32){if(assert.hash(t),assert.number(s),s>255*t.outputLen)throw new Error("Length should be <= 255*HashLen");const r=Math.ceil(s/t.outputLen);n===void 0&&(n=EMPTY_BUFFER);const o=new Uint8Array(r*t.outputLen),a=hmac$1.create(t,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<r;u++)HKDF_COUNTER[0]=u+1,c.update(u===0?EMPTY_BUFFER:l).update(n).update(HKDF_COUNTER).digestInto(l),o.set(l,t.outputLen*u),a._cloneInto(c);return a.destroy(),c.destroy(),l.fill(0),HKDF_COUNTER.fill(0),o.slice(0,s)}var __defProp$1=Object.defineProperty,__export=(t,e)=>{for(var n in e)__defProp$1(t,n,{get:e[n],enumerable:!0})},verifiedSymbol=Symbol("verified"),isRecord=t=>t instanceof Object;function validateEvent(t){if(!isRecord(t)||typeof t.kind!="number"||typeof t.content!="string"||typeof t.created_at!="number"||typeof t.pubkey!="string"||!t.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){let n=t.tags[e];if(!Array.isArray(n))return!1;for(let s=0;s<n.length;s++)if(typeof n[s]!="string")return!1}return!0}var utils_exports={};__export(utils_exports,{Queue:()=>Queue$1,QueueNode:()=>QueueNode,binarySearch:()=>binarySearch,bytesToHex:()=>bytesToHex$2,hexToBytes:()=>hexToBytes$2,insertEventIntoAscendingList:()=>insertEventIntoAscendingList,insertEventIntoDescendingList:()=>insertEventIntoDescendingList,normalizeURL:()=>normalizeURL,utf8Decoder:()=>utf8Decoder$1,utf8Encoder:()=>utf8Encoder$1});var utf8Decoder$1=new TextDecoder("utf-8"),utf8Encoder$1=new TextEncoder;function normalizeURL(t){try{t.indexOf("://")===-1&&(t="wss://"+t);let e=new URL(t);return e.protocol==="http:"?e.protocol="ws:":e.protocol==="https:"&&(e.protocol="wss:"),e.pathname=e.pathname.replace(/\/+/g,"/"),e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),(e.port==="80"&&e.protocol==="ws:"||e.port==="443"&&e.protocol==="wss:")&&(e.port=""),e.searchParams.sort(),e.hash="",e.toString()}catch{throw new Error(`Invalid URL: ${t}`)}}function insertEventIntoDescendingList(t,e){const[n,s]=binarySearch(t,r=>e.id===r.id?0:e.created_at===r.created_at?-1:r.created_at-e.created_at);return s||t.splice(n,0,e),t}function insertEventIntoAscendingList(t,e){const[n,s]=binarySearch(t,r=>e.id===r.id?0:e.created_at===r.created_at?-1:e.created_at-r.created_at);return s||t.splice(n,0,e),t}function binarySearch(t,e){let n=0,s=t.length-1;for(;n<=s;){const r=Math.floor((n+s)/2),o=e(t[r]);if(o===0)return[r,!0];o<0?s=r-1:n=r+1}return[n,!1]}var QueueNode=class{constructor(t){g(this,"value");g(this,"next",null);g(this,"prev",null);this.value=t}},Queue$1=class{constructor(){g(this,"first");g(this,"last");this.first=null,this.last=null}enqueue(e){const n=new QueueNode(e);return this.last?this.last===this.first?(this.last=n,this.last.prev=this.first,this.first.next=n):(n.prev=this.last,this.last.next=n,this.last=n):(this.first=n,this.last=n),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const n=this.first;return this.first=null,this.last=null,n.value}const e=this.first;return this.first=e.next,this.first&&(this.first.prev=null),e.value}},JS=class{generateSecretKey(){return schnorr$1.utils.randomPrivateKey()}getPublicKey(t){return bytesToHex$2(schnorr$1.getPublicKey(t))}finalizeEvent(t,e){const n=t;return n.pubkey=bytesToHex$2(schnorr$1.getPublicKey(e)),n.id=getEventHash$1(n),n.sig=bytesToHex$2(schnorr$1.sign(getEventHash$1(n),e)),n[verifiedSymbol]=!0,n}verifyEvent(t){if(typeof t[verifiedSymbol]=="boolean")return t[verifiedSymbol];const e=getEventHash$1(t);if(e!==t.id)return t[verifiedSymbol]=!1,!1;try{const n=schnorr$1.verify(t.sig,e,t.pubkey);return t[verifiedSymbol]=n,n}catch{return t[verifiedSymbol]=!1,!1}}};function serializeEvent(t){if(!validateEvent(t))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content])}function getEventHash$1(t){let e=sha256$2(utf8Encoder$1.encode(serializeEvent(t)));return bytesToHex$2(e)}var i=new JS,generateSecretKey=i.generateSecretKey,getPublicKey=i.getPublicKey,finalizeEvent=i.finalizeEvent,verifyEvent=i.verifyEvent,kinds_exports={};__export(kinds_exports,{Application:()=>Application,BadgeAward:()=>BadgeAward,BadgeDefinition:()=>BadgeDefinition,BlockedRelaysList:()=>BlockedRelaysList,BlossomServerList:()=>BlossomServerList,BookmarkList:()=>BookmarkList,Bookmarksets:()=>Bookmarksets,Calendar:()=>Calendar,CalendarEventRSVP:()=>CalendarEventRSVP,ChannelCreation:()=>ChannelCreation,ChannelHideMessage:()=>ChannelHideMessage,ChannelMessage:()=>ChannelMessage,ChannelMetadata:()=>ChannelMetadata,ChannelMuteUser:()=>ChannelMuteUser,ChatMessage:()=>ChatMessage,ClassifiedListing:()=>ClassifiedListing,ClientAuth:()=>ClientAuth,Comment:()=>Comment,CommunitiesList:()=>CommunitiesList,CommunityDefinition:()=>CommunityDefinition,CommunityPostApproval:()=>CommunityPostApproval,Contacts:()=>Contacts,CreateOrUpdateProduct:()=>CreateOrUpdateProduct,CreateOrUpdateStall:()=>CreateOrUpdateStall,Curationsets:()=>Curationsets,Date:()=>Date2,DirectMessageRelaysList:()=>DirectMessageRelaysList,DraftClassifiedListing:()=>DraftClassifiedListing,DraftLong:()=>DraftLong,Emojisets:()=>Emojisets,EncryptedDirectMessage:()=>EncryptedDirectMessage,EventDeletion:()=>EventDeletion,FavoriteRelays:()=>FavoriteRelays,FileMessage:()=>FileMessage,FileMetadata:()=>FileMetadata,FileServerPreference:()=>FileServerPreference,Followsets:()=>Followsets,ForumThread:()=>ForumThread,GenericRepost:()=>GenericRepost,Genericlists:()=>Genericlists,GiftWrap:()=>GiftWrap,GroupMetadata:()=>GroupMetadata,HTTPAuth:()=>HTTPAuth,Handlerinformation:()=>Handlerinformation,Handlerrecommendation:()=>Handlerrecommendation,Highlights:()=>Highlights,InterestsList:()=>InterestsList,Interestsets:()=>Interestsets,JobFeedback:()=>JobFeedback,JobRequest:()=>JobRequest,JobResult:()=>JobResult,Label:()=>Label,LightningPubRPC:()=>LightningPubRPC,LiveChatMessage:()=>LiveChatMessage,LiveEvent:()=>LiveEvent,LongFormArticle:()=>LongFormArticle,Metadata:()=>Metadata,Mutelist:()=>Mutelist,NWCWalletInfo:()=>NWCWalletInfo,NWCWalletRequest:()=>NWCWalletRequest,NWCWalletResponse:()=>NWCWalletResponse,NormalVideo:()=>NormalVideo,NostrConnect:()=>NostrConnect,OpenTimestamps:()=>OpenTimestamps,Photo:()=>Photo,Pinlist:()=>Pinlist,Poll:()=>Poll,PollResponse:()=>PollResponse,PrivateDirectMessage:()=>PrivateDirectMessage,ProblemTracker:()=>ProblemTracker,ProfileBadges:()=>ProfileBadges,PublicChatsList:()=>PublicChatsList,Reaction:()=>Reaction,RecommendRelay:()=>RecommendRelay,RelayList:()=>RelayList,RelayReview:()=>RelayReview,Relaysets:()=>Relaysets,Report:()=>Report,Reporting:()=>Reporting,Repost:()=>Repost,Seal:()=>Seal,SearchRelaysList:()=>SearchRelaysList,ShortTextNote:()=>ShortTextNote,ShortVideo:()=>ShortVideo,Time:()=>Time,UserEmojiList:()=>UserEmojiList,UserStatuses:()=>UserStatuses,Voice:()=>Voice,VoiceComment:()=>VoiceComment,Zap:()=>Zap,ZapGoal:()=>ZapGoal,ZapRequest:()=>ZapRequest,classifyKind:()=>classifyKind,isAddressableKind:()=>isAddressableKind,isEphemeralKind:()=>isEphemeralKind,isKind:()=>isKind,isRegularKind:()=>isRegularKind,isReplaceableKind:()=>isReplaceableKind});function isRegularKind(t){return t<1e4&&t!==0&&t!==3}function isReplaceableKind(t){return t===0||t===3||1e4<=t&&t<2e4}function isEphemeralKind(t){return 2e4<=t&&t<3e4}function isAddressableKind(t){return 3e4<=t&&t<4e4}function classifyKind(t){return isRegularKind(t)?"regular":isReplaceableKind(t)?"replaceable":isEphemeralKind(t)?"ephemeral":isAddressableKind(t)?"parameterized":"unknown"}function isKind(t,e){const n=e instanceof Array?e:[e];return validateEvent(t)&&n.includes(t.kind)||!1}var Metadata=0,ShortTextNote=1,RecommendRelay=2,Contacts=3,EncryptedDirectMessage=4,EventDeletion=5,Repost=6,Reaction=7,BadgeAward=8,ChatMessage=9,ForumThread=11,Seal=13,PrivateDirectMessage=14,FileMessage=15,GenericRepost=16,Photo=20,NormalVideo=21,ShortVideo=22,ChannelCreation=40,ChannelMetadata=41,ChannelMessage=42,ChannelHideMessage=43,ChannelMuteUser=44,OpenTimestamps=1040,GiftWrap=1059,Poll=1068,FileMetadata=1063,Comment=1111,LiveChatMessage=1311,Voice=1222,VoiceComment=1244,ProblemTracker=1971,Report=1984,Reporting=1984,Label=1985,CommunityPostApproval=4550,JobRequest=5999,JobResult=6999,JobFeedback=7e3,ZapGoal=9041,ZapRequest=9734,Zap=9735,Highlights=9802,PollResponse=1018,Mutelist=1e4,Pinlist=10001,RelayList=10002,BookmarkList=10003,CommunitiesList=10004,PublicChatsList=10005,BlockedRelaysList=10006,SearchRelaysList=10007,FavoriteRelays=10012,InterestsList=10015,UserEmojiList=10030,DirectMessageRelaysList=10050,FileServerPreference=10096,BlossomServerList=10063,NWCWalletInfo=13194,LightningPubRPC=21e3,ClientAuth=22242,NWCWalletRequest=23194,NWCWalletResponse=23195,NostrConnect=24133,HTTPAuth=27235,Followsets=3e4,Genericlists=30001,Relaysets=30002,Bookmarksets=30003,Curationsets=30004,ProfileBadges=30008,BadgeDefinition=30009,Interestsets=30015,CreateOrUpdateStall=30017,CreateOrUpdateProduct=30018,LongFormArticle=30023,DraftLong=30024,Emojisets=30030,Application=30078,LiveEvent=30311,UserStatuses=30315,ClassifiedListing=30402,DraftClassifiedListing=30403,Date2=31922,Time=31923,Calendar=31924,CalendarEventRSVP=31925,RelayReview=31987,Handlerrecommendation=31989,Handlerinformation=31990,CommunityDefinition=34550,GroupMetadata=39e3;function matchFilter(t,e){if(t.ids&&t.ids.indexOf(e.id)===-1||t.kinds&&t.kinds.indexOf(e.kind)===-1||t.authors&&t.authors.indexOf(e.pubkey)===-1)return!1;for(let n in t)if(n[0]==="#"){let s=n.slice(1),r=t[`#${s}`];if(r&&!e.tags.find(([o,a])=>o===n.slice(1)&&r.indexOf(a)!==-1))return!1}return!(t.since&&e.created_at<t.since||t.until&&e.created_at>t.until)}function matchFilters(t,e){for(let n=0;n<t.length;n++)if(matchFilter(t[n],e))return!0;return!1}var fakejson_exports={};__export(fakejson_exports,{getHex64:()=>getHex64,getInt:()=>getInt,getSubscriptionId:()=>getSubscriptionId,matchEventId:()=>matchEventId,matchEventKind:()=>matchEventKind,matchEventPubkey:()=>matchEventPubkey});function getHex64(t,e){let n=e.length+3,s=t.indexOf(`"${e}":`)+n,r=t.slice(s).indexOf('"')+s+1;return t.slice(r,r+64)}function getInt(t,e){let n=e.length,s=t.indexOf(`"${e}":`)+n+3,r=t.slice(s),o=Math.min(r.indexOf(","),r.indexOf("}"));return parseInt(r.slice(0,o),10)}function getSubscriptionId(t){let e=t.slice(0,22).indexOf('"EVENT"');if(e===-1)return null;let n=t.slice(e+7+1).indexOf('"');if(n===-1)return null;let s=e+7+1+n,r=t.slice(s+1,80).indexOf('"');if(r===-1)return null;let o=s+1+r;return t.slice(s+1,o)}function matchEventId(t,e){return e===getHex64(t,"id")}function matchEventPubkey(t,e){return e===getHex64(t,"pubkey")}function matchEventKind(t,e){return e===getInt(t,"kind")}var nip42_exports={};__export(nip42_exports,{makeAuthEvent:()=>makeAuthEvent});function makeAuthEvent(t,e){return{kind:ClientAuth,created_at:Math.floor(Date.now()/1e3),tags:[["relay",t],["challenge",e]],content:""}}async function yieldThread(){return new Promise((t,e)=>{try{if(typeof MessageChannel<"u"){const n=new MessageChannel,s=()=>{n.port1.removeEventListener("message",s),t()};n.port1.addEventListener("message",s),n.port2.postMessage(0),n.port1.start()}else typeof setImmediate<"u"?setImmediate(t):typeof setTimeout<"u"?setTimeout(t,0):t()}catch(n){console.error("during yield: ",n),e(n)}})}var alwaysTrue=t=>(t[verifiedSymbol]=!0,!0),SendingOnClosedConnection=class extends Error{constructor(t,e){super(`Tried to send message '${t} on a closed connection to ${e}.`),this.name="SendingOnClosedConnection"}},AbstractRelay=class{constructor(t,e){g(this,"url");g(this,"_connected",!1);g(this,"onclose",null);g(this,"onnotice",t=>console.debug(`NOTICE from ${this.url}: ${t}`));g(this,"onauth");g(this,"baseEoseTimeout",4400);g(this,"connectionTimeout",4400);g(this,"publishTimeout",4400);g(this,"pingFrequency",29e3);g(this,"pingTimeout",2e4);g(this,"resubscribeBackoff",[1e4,1e4,1e4,2e4,2e4,3e4,6e4]);g(this,"openSubs",new Map);g(this,"enablePing");g(this,"enableReconnect");g(this,"connectionTimeoutHandle");g(this,"reconnectTimeoutHandle");g(this,"pingIntervalHandle");g(this,"reconnectAttempts",0);g(this,"closedIntentionally",!1);g(this,"connectionPromise");g(this,"openCountRequests",new Map);g(this,"openEventPublishes",new Map);g(this,"ws");g(this,"incomingMessageQueue",new Queue$1);g(this,"queueRunning",!1);g(this,"challenge");g(this,"authPromise");g(this,"serial",0);g(this,"verifyEvent");g(this,"_WebSocket");this.url=normalizeURL(t),this.verifyEvent=e.verifyEvent,this._WebSocket=e.websocketImplementation||WebSocket,this.enablePing=e.enablePing,this.enableReconnect=e.enableReconnect||!1}static async connect(t,e){const n=new AbstractRelay(t,e);return await n.connect(),n}closeAllSubscriptions(t){for(let[e,n]of this.openSubs)n.close(t);this.openSubs.clear();for(let[e,n]of this.openEventPublishes)n.reject(new Error(t));this.openEventPublishes.clear();for(let[e,n]of this.openCountRequests)n.reject(new Error(t));this.openCountRequests.clear()}get connected(){return this._connected}async reconnect(){const t=this.resubscribeBackoff[Math.min(this.reconnectAttempts,this.resubscribeBackoff.length-1)];this.reconnectAttempts++,this.reconnectTimeoutHandle=setTimeout(async()=>{try{await this.connect()}catch{}},t)}handleHardClose(t){var n;this.pingIntervalHandle&&(clearInterval(this.pingIntervalHandle),this.pingIntervalHandle=void 0),this._connected=!1,this.connectionPromise=void 0;const e=this.closedIntentionally;this.closedIntentionally=!1,(n=this.onclose)==null||n.call(this),this.enableReconnect&&!e?this.reconnect():this.closeAllSubscriptions(t)}async connect(){return this.connectionPromise?this.connectionPromise:(this.challenge=void 0,this.authPromise=void 0,this.connectionPromise=new Promise((t,e)=>{this.connectionTimeoutHandle=setTimeout(()=>{var n;e("connection timed out"),this.connectionPromise=void 0,(n=this.onclose)==null||n.call(this),this.closeAllSubscriptions("relay connection timed out")},this.connectionTimeout);try{this.ws=new this._WebSocket(this.url)}catch(n){clearTimeout(this.connectionTimeoutHandle),e(n);return}this.ws.onopen=()=>{this.reconnectTimeoutHandle&&(clearTimeout(this.reconnectTimeoutHandle),this.reconnectTimeoutHandle=void 0),clearTimeout(this.connectionTimeoutHandle),this._connected=!0;const n=this.reconnectAttempts>0;this.reconnectAttempts=0;for(const s of this.openSubs.values()){if(s.eosed=!1,n)for(let r=0;r<s.filters.length;r++)s.lastEmitted&&(s.filters[r].since=s.lastEmitted+1);s.fire()}this.enablePing&&(this.pingIntervalHandle=setInterval(()=>this.pingpong(),this.pingFrequency)),t()},this.ws.onerror=n=>{clearTimeout(this.connectionTimeoutHandle),e(n.message||"websocket error"),this.handleHardClose("relay connection errored")},this.ws.onclose=n=>{clearTimeout(this.connectionTimeoutHandle),e(n.message||"websocket closed"),this.handleHardClose("relay connection closed")},this.ws.onmessage=this._onmessage.bind(this)}),this.connectionPromise)}waitForPingPong(){return new Promise(t=>{this.ws.once("pong",()=>t(!0)),this.ws.ping()})}waitForDummyReq(){return new Promise((t,e)=>{if(!this.connectionPromise)return e(new Error(`no connection to ${this.url}, can't ping`));try{const n=this.subscribe([{ids:["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"],limit:0}],{label:"forced-ping",oneose:()=>{t(!0),n.close()},onclose(){t(!0)},eoseTimeout:this.pingTimeout+1e3})}catch(n){e(n)}})}async pingpong(){var t,e,n;((t=this.ws)==null?void 0:t.readyState)===1&&(await Promise.any([this.ws&&this.ws.ping&&this.ws.once?this.waitForPingPong():this.waitForDummyReq(),new Promise(r=>setTimeout(()=>r(!1),this.pingTimeout))])||((e=this.ws)==null?void 0:e.readyState)===this._WebSocket.OPEN&&((n=this.ws)==null||n.close()))}async runQueue(){for(this.queueRunning=!0;this.handleNext()!==!1;)await yieldThread();this.queueRunning=!1}handleNext(){var n,s,r;const t=this.incomingMessageQueue.dequeue();if(!t)return!1;const e=getSubscriptionId(t);if(e){const o=this.openSubs.get(e);if(!o)return;const a=getHex64(t,"id"),c=(n=o.alreadyHaveEvent)==null?void 0:n.call(o,a);if((s=o.receivedEvent)==null||s.call(o,this,a),c)return}try{let o=JSON.parse(t);switch(o[0]){case"EVENT":{const a=this.openSubs.get(o[1]),c=o[2];this.verifyEvent(c)&&matchFilters(a.filters,c)&&a.onevent(c),(!a.lastEmitted||a.lastEmitted<c.created_at)&&(a.lastEmitted=c.created_at);return}case"COUNT":{const a=o[1],c=o[2],l=this.openCountRequests.get(a);l&&(l.resolve(c.count),this.openCountRequests.delete(a));return}case"EOSE":{const a=this.openSubs.get(o[1]);if(!a)return;a.receivedEose();return}case"OK":{const a=o[1],c=o[2],l=o[3],u=this.openEventPublishes.get(a);u&&(clearTimeout(u.timeout),c?u.resolve(l):u.reject(new Error(l)),this.openEventPublishes.delete(a));return}case"CLOSED":{const a=o[1],c=this.openSubs.get(a);if(!c)return;c.closed=!0,c.close(o[2]);return}case"NOTICE":{this.onnotice(o[1]);return}case"AUTH":{this.challenge=o[1],this.onauth&&this.auth(this.onauth);return}default:{const a=this.openSubs.get(o[1]);(r=a==null?void 0:a.oncustom)==null||r.call(a,o);return}}}catch{return}}async send(t){if(!this.connectionPromise)throw new SendingOnClosedConnection(t,this.url);this.connectionPromise.then(()=>{var e;(e=this.ws)==null||e.send(t)})}async auth(t){const e=this.challenge;if(!e)throw new Error("can't perform auth, no challenge was received");return this.authPromise?this.authPromise:(this.authPromise=new Promise(async(n,s)=>{try{let r=await t(makeAuthEvent(this.url,e)),o=setTimeout(()=>{let a=this.openEventPublishes.get(r.id);a&&(a.reject(new Error("auth timed out")),this.openEventPublishes.delete(r.id))},this.publishTimeout);this.openEventPublishes.set(r.id,{resolve:n,reject:s,timeout:o}),this.send('["AUTH",'+JSON.stringify(r)+"]")}catch(r){console.warn("subscribe auth function failed:",r)}}),this.authPromise)}async publish(t){const e=new Promise((n,s)=>{const r=setTimeout(()=>{const o=this.openEventPublishes.get(t.id);o&&(o.reject(new Error("publish timed out")),this.openEventPublishes.delete(t.id))},this.publishTimeout);this.openEventPublishes.set(t.id,{resolve:n,reject:s,timeout:r})});return this.send('["EVENT",'+JSON.stringify(t)+"]"),e}async count(t,e){this.serial++;const n=(e==null?void 0:e.id)||"count:"+this.serial,s=new Promise((r,o)=>{this.openCountRequests.set(n,{resolve:r,reject:o})});return this.send('["COUNT","'+n+'",'+JSON.stringify(t).substring(1)),s}subscribe(t,e){const n=this.prepareSubscription(t,e);return n.fire(),n}prepareSubscription(t,e){this.serial++;const n=e.id||(e.label?e.label+":":"sub:")+this.serial,s=new Subscription(this,n,t,e);return this.openSubs.set(n,s),s}close(){var t,e,n;this.closedIntentionally=!0,this.reconnectTimeoutHandle&&(clearTimeout(this.reconnectTimeoutHandle),this.reconnectTimeoutHandle=void 0),this.pingIntervalHandle&&(clearInterval(this.pingIntervalHandle),this.pingIntervalHandle=void 0),this.closeAllSubscriptions("relay connection closed by us"),this._connected=!1,(t=this.onclose)==null||t.call(this),((e=this.ws)==null?void 0:e.readyState)===this._WebSocket.OPEN&&((n=this.ws)==null||n.close())}_onmessage(t){this.incomingMessageQueue.enqueue(t.data),this.queueRunning||this.runQueue()}},Subscription=class{constructor(t,e,n,s){g(this,"relay");g(this,"id");g(this,"lastEmitted");g(this,"closed",!1);g(this,"eosed",!1);g(this,"filters");g(this,"alreadyHaveEvent");g(this,"receivedEvent");g(this,"onevent");g(this,"oneose");g(this,"onclose");g(this,"oncustom");g(this,"eoseTimeout");g(this,"eoseTimeoutHandle");if(n.length===0)throw new Error("subscription can't be created with zero filters");this.relay=t,this.filters=n,this.id=e,this.alreadyHaveEvent=s.alreadyHaveEvent,this.receivedEvent=s.receivedEvent,this.eoseTimeout=s.eoseTimeout||t.baseEoseTimeout,this.oneose=s.oneose,this.onclose=s.onclose,this.onevent=s.onevent||(r=>{console.warn(`onevent() callback not defined for subscription '${this.id}' in relay ${this.relay.url}. event received:`,r)})}fire(){this.relay.send('["REQ","'+this.id+'",'+JSON.stringify(this.filters).substring(1)),this.eoseTimeoutHandle=setTimeout(this.receivedEose.bind(this),this.eoseTimeout)}receivedEose(){var t;this.eosed||(clearTimeout(this.eoseTimeoutHandle),this.eosed=!0,(t=this.oneose)==null||t.call(this))}close(t="closed by caller"){var e;if(!this.closed&&this.relay.connected){try{this.relay.send('["CLOSE",'+JSON.stringify(this.id)+"]")}catch(n){if(!(n instanceof SendingOnClosedConnection))throw n}this.closed=!0}this.relay.openSubs.delete(this.id),(e=this.onclose)==null||e.call(this,t)}},_WebSocket;try{_WebSocket=WebSocket}catch{}var AbstractSimplePool=class{constructor(t){g(this,"relays",new Map);g(this,"seenOn",new Map);g(this,"trackRelays",!1);g(this,"verifyEvent");g(this,"enablePing");g(this,"enableReconnect");g(this,"automaticallyAuth");g(this,"trustedRelayURLs",new Set);g(this,"_WebSocket");this.verifyEvent=t.verifyEvent,this._WebSocket=t.websocketImplementation,this.enablePing=t.enablePing,this.enableReconnect=t.enableReconnect||!1,this.automaticallyAuth=t.automaticallyAuth}async ensureRelay(t,e){t=normalizeURL(t);let n=this.relays.get(t);if(n||(n=new AbstractRelay(t,{verifyEvent:this.trustedRelayURLs.has(t)?alwaysTrue:this.verifyEvent,websocketImplementation:this._WebSocket,enablePing:this.enablePing,enableReconnect:this.enableReconnect}),n.onclose=()=>{n&&!n.enableReconnect&&this.relays.delete(t)},e!=null&&e.connectionTimeout&&(n.connectionTimeout=e.connectionTimeout),this.relays.set(t,n)),this.automaticallyAuth){const s=this.automaticallyAuth(t);s&&(n.onauth=s)}return await n.connect(),n}close(t){t.map(normalizeURL).forEach(e=>{var n;(n=this.relays.get(e))==null||n.close(),this.relays.delete(e)})}subscribe(t,e,n){const s=[];for(let r=0;r<t.length;r++){const o=normalizeURL(t[r]);s.find(a=>a.url===o)||s.push({url:o,filter:e})}return this.subscribeMap(s,n)}subscribeMany(t,e,n){const s=[],r=[];for(let o=0;o<t.length;o++){const a=normalizeURL(t[o]);r.indexOf(a)===-1&&(r.push(a),s.push({url:a,filter:e}))}return this.subscribeMap(s,n)}subscribeMap(t,e){const n=new Map;for(const p of t){const{url:y,filter:b}=p;n.has(y)||n.set(y,[]),n.get(y).push(b)}const s=Array.from(n.entries()).map(([p,y])=>({url:p,filters:y}));this.trackRelays&&(e.receivedEvent=(p,y)=>{let b=this.seenOn.get(y);b||(b=new Set,this.seenOn.set(y,b)),b.add(p)});const r=new Set,o=[],a=[];let c=p=>{var y;a[p]||(a[p]=!0,a.filter(b=>b).length===s.length&&((y=e.oneose)==null||y.call(e),c=()=>{}))};const l=[];let u=(p,y)=>{var b;l[p]||(c(p),l[p]=y,l.filter(m=>m).length===s.length&&((b=e.onclose)==null||b.call(e,l),u=()=>{}))};const f=p=>{var b;if((b=e.alreadyHaveEvent)!=null&&b.call(e,p))return!0;const y=r.has(p);return r.add(p),y},h=Promise.all(s.map(async({url:p,filters:y},b)=>{let m;try{m=await this.ensureRelay(p,{connectionTimeout:e.maxWait?Math.max(e.maxWait*.8,e.maxWait-1e3):void 0})}catch(k){u(b,(k==null?void 0:k.message)||String(k));return}let w=m.subscribe(y,{...e,oneose:()=>c(b),onclose:k=>{k.startsWith("auth-required: ")&&e.onauth?m.auth(e.onauth).then(()=>{m.subscribe(y,{...e,oneose:()=>c(b),onclose:A=>{u(b,A)},alreadyHaveEvent:f,eoseTimeout:e.maxWait})}).catch(A=>{u(b,`auth was required and attempted, but failed with: ${A}`)}):u(b,k)},alreadyHaveEvent:f,eoseTimeout:e.maxWait});o.push(w)}));return{async close(p){await h,o.forEach(y=>{y.close(p)})}}}subscribeEose(t,e,n){const s=this.subscribe(t,e,{...n,oneose(){s.close("closed automatically on eose")}});return s}subscribeManyEose(t,e,n){const s=this.subscribeMany(t,e,{...n,oneose(){s.close("closed automatically on eose")}});return s}async querySync(t,e,n){return new Promise(async s=>{const r=[];this.subscribeEose(t,e,{...n,onevent(o){r.push(o)},onclose(o){s(r)}})})}async get(t,e,n){e.limit=1;const s=await this.querySync(t,e,n);return s.sort((r,o)=>o.created_at-r.created_at),s[0]||null}publish(t,e,n){return t.map(normalizeURL).map(async(s,r,o)=>{if(o.indexOf(s)!==r)return Promise.reject("duplicate url");let a=await this.ensureRelay(s);return a.publish(e).catch(async c=>{if(c instanceof Error&&c.message.startsWith("auth-required: ")&&(n!=null&&n.onauth))return await a.auth(n.onauth),a.publish(e);throw c}).then(c=>{if(this.trackRelays){let l=this.seenOn.get(e.id);l||(l=new Set,this.seenOn.set(e.id,l)),l.add(a)}return c})})}listConnectionStatus(){const t=new Map;return this.relays.forEach((e,n)=>t.set(n,e.connected)),t}destroy(){this.relays.forEach(t=>t.close()),this.relays=new Map}},_WebSocket2;try{_WebSocket2=WebSocket}catch{}var SimplePool=class extends AbstractSimplePool{constructor(t){super({verifyEvent,websocketImplementation:_WebSocket2,...t})}},nip19_exports$1={};__export(nip19_exports$1,{BECH32_REGEX:()=>BECH32_REGEX$2,Bech32MaxSize:()=>Bech32MaxSize$2,NostrTypeGuard:()=>NostrTypeGuard$1,decode:()=>decode$1,decodeNostrURI:()=>decodeNostrURI$1,encodeBytes:()=>encodeBytes$2,naddrEncode:()=>naddrEncode$1,neventEncode:()=>neventEncode$1,noteEncode:()=>noteEncode$1,nprofileEncode:()=>nprofileEncode$1,npubEncode:()=>npubEncode$1,nsecEncode:()=>nsecEncode$1});var NostrTypeGuard$1={isNProfile:t=>/^nprofile1[a-z\d]+$/.test(t||""),isNEvent:t=>/^nevent1[a-z\d]+$/.test(t||""),isNAddr:t=>/^naddr1[a-z\d]+$/.test(t||""),isNSec:t=>/^nsec1[a-z\d]{58}$/.test(t||""),isNPub:t=>/^npub1[a-z\d]{58}$/.test(t||""),isNote:t=>/^note1[a-z\d]+$/.test(t||""),isNcryptsec:t=>/^ncryptsec1[a-z\d]+$/.test(t||"")},Bech32MaxSize$2=5e3,BECH32_REGEX$2=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array$1(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=t&255,e}function decodeNostrURI$1(t){try{return t.startsWith("nostr:")&&(t=t.substring(6)),decode$1(t)}catch{return{type:"invalid",data:null}}}function decode$1(t){var r,o,a,c,l,u,f;let{prefix:e,words:n}=bech32$1.decode(t,Bech32MaxSize$2),s=new Uint8Array(bech32$1.fromWords(n));switch(e){case"nprofile":{let h=parseTLV$1(s);if(!((r=h[0])!=null&&r[0]))throw new Error("missing TLV 0 for nprofile");if(h[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:bytesToHex$2(h[0][0]),relays:h[1]?h[1].map(p=>utf8Decoder$1.decode(p)):[]}}}case"nevent":{let h=parseTLV$1(s);if(!((o=h[0])!=null&&o[0]))throw new Error("missing TLV 0 for nevent");if(h[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(h[2]&&h[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(h[3]&&h[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:bytesToHex$2(h[0][0]),relays:h[1]?h[1].map(p=>utf8Decoder$1.decode(p)):[],author:(a=h[2])!=null&&a[0]?bytesToHex$2(h[2][0]):void 0,kind:(c=h[3])!=null&&c[0]?parseInt(bytesToHex$2(h[3][0]),16):void 0}}}case"naddr":{let h=parseTLV$1(s);if(!((l=h[0])!=null&&l[0]))throw new Error("missing TLV 0 for naddr");if(!((u=h[2])!=null&&u[0]))throw new Error("missing TLV 2 for naddr");if(h[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!((f=h[3])!=null&&f[0]))throw new Error("missing TLV 3 for naddr");if(h[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder$1.decode(h[0][0]),pubkey:bytesToHex$2(h[2][0]),kind:parseInt(bytesToHex$2(h[3][0]),16),relays:h[1]?h[1].map(p=>utf8Decoder$1.decode(p)):[]}}}case"nsec":return{type:e,data:s};case"npub":case"note":return{type:e,data:bytesToHex$2(s)};default:throw new Error(`unknown prefix ${e}`)}}function parseTLV$1(t){let e={},n=t;for(;n.length>0;){let s=n[0],r=n[1],o=n.slice(2,2+r);if(n=n.slice(2+r),o.length<r)throw new Error(`not enough data to read on TLV ${s}`);e[s]=e[s]||[],e[s].push(o)}return e}function nsecEncode$1(t){return encodeBytes$2("nsec",t)}function npubEncode$1(t){return encodeBytes$2("npub",hexToBytes$2(t))}function noteEncode$1(t){return encodeBytes$2("note",hexToBytes$2(t))}function encodeBech32$2(t,e){let n=bech32$1.toWords(e);return bech32$1.encode(t,n,Bech32MaxSize$2)}function encodeBytes$2(t,e){return encodeBech32$2(t,e)}function nprofileEncode$1(t){let e=encodeTLV$1({0:[hexToBytes$2(t.pubkey)],1:(t.relays||[]).map(n=>utf8Encoder$1.encode(n))});return encodeBech32$2("nprofile",e)}function neventEncode$1(t){let e;t.kind!==void 0&&(e=integerToUint8Array$1(t.kind));let n=encodeTLV$1({0:[hexToBytes$2(t.id)],1:(t.relays||[]).map(s=>utf8Encoder$1.encode(s)),2:t.author?[hexToBytes$2(t.author)]:[],3:e?[new Uint8Array(e)]:[]});return encodeBech32$2("nevent",n)}function naddrEncode$1(t){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,t.kind,!1);let n=encodeTLV$1({0:[utf8Encoder$1.encode(t.identifier)],1:(t.relays||[]).map(s=>utf8Encoder$1.encode(s)),2:[hexToBytes$2(t.pubkey)],3:[new Uint8Array(e)]});return encodeBech32$2("naddr",n)}function encodeTLV$1(t){let e=[];return Object.entries(t).reverse().forEach(([n,s])=>{s.forEach(r=>{let o=new Uint8Array(r.length+2);o.set([parseInt(n)],0),o.set([r.length],1),o.set(r,2),e.push(o)})}),concatBytes$1(...e)}var nip04_exports={};__export(nip04_exports,{decrypt:()=>decrypt$2,encrypt:()=>encrypt$2});function encrypt$2(t,e,n){const s=t instanceof Uint8Array?bytesToHex$2(t):t,r=secp256k1$1.getSharedSecret(s,"02"+e),o=getNormalizedX(r);let a=Uint8Array.from(randomBytes$1(16)),c=utf8Encoder$1.encode(n),l=cbc(o,a).encrypt(c),u=base64.encode(new Uint8Array(l)),f=base64.encode(new Uint8Array(a.buffer));return`${u}?iv=${f}`}function decrypt$2(t,e,n){const s=t instanceof Uint8Array?bytesToHex$2(t):t;let[r,o]=n.split("?iv="),a=secp256k1$1.getSharedSecret(s,"02"+e),c=getNormalizedX(a),l=base64.decode(o),u=base64.decode(r),f=cbc(c,l).decrypt(u);return utf8Decoder$1.decode(f)}function getNormalizedX(t){return t.slice(1,33)}var nip05_exports={};__export(nip05_exports,{NIP05_REGEX:()=>NIP05_REGEX$1,isNip05:()=>isNip05,isValid:()=>isValid,queryProfile:()=>queryProfile,searchDomain:()=>searchDomain,useFetchImplementation:()=>useFetchImplementation});var NIP05_REGEX$1=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,isNip05=t=>NIP05_REGEX$1.test(t||""),_fetch;try{_fetch=fetch}catch(t){}function useFetchImplementation(t){_fetch=t}async function searchDomain(t,e=""){try{const n=`https://${t}/.well-known/nostr.json?name=${e}`,s=await _fetch(n,{redirect:"manual"});if(s.status!==200)throw Error("Wrong response code");return(await s.json()).names}catch{return{}}}async function queryProfile(t){var r;const e=t.match(NIP05_REGEX$1);if(!e)return null;const[,n="_",s]=e;try{const o=`https://${s}/.well-known/nostr.json?name=${n}`,a=await _fetch(o,{redirect:"manual"});if(a.status!==200)throw Error("Wrong response code");const c=await a.json(),l=c.names[n];return l?{pubkey:l,relays:(r=c.relays)==null?void 0:r[l]}:null}catch{return null}}async function isValid(t,e){const n=await queryProfile(e);return n?n.pubkey===t:!1}var nip10_exports={};__export(nip10_exports,{parse:()=>parse});function parse(t){const e={reply:void 0,root:void 0,mentions:[],profiles:[],quotes:[]};let n,s;for(let r=t.tags.length-1;r>=0;r--){const o=t.tags[r];if(o[0]==="e"&&o[1]){const[a,c,l,u,f]=o,h={id:c,relays:l?[l]:[],author:f};if(u==="root"){e.root=h;continue}if(u==="reply"){e.reply=h;continue}if(u==="mention"){e.mentions.push(h);continue}n?s=h:n=h,e.mentions.push(h);continue}if(o[0]==="q"&&o[1]){const[a,c,l]=o;e.quotes.push({id:c,relays:l?[l]:[]})}if(o[0]==="p"&&o[1]){e.profiles.push({pubkey:o[1],relays:o[2]?[o[2]]:[]});continue}}return e.root||(e.root=s||n||e.reply),e.reply||(e.reply=n||e.root),[e.reply,e.root].forEach(r=>{if(!r)return;let o=e.mentions.indexOf(r);if(o!==-1&&e.mentions.splice(o,1),r.author){let a=e.profiles.find(c=>c.pubkey===r.author);a&&a.relays&&(r.relays||(r.relays=[]),a.relays.forEach(c=>{var l;((l=r.relays)==null?void 0:l.indexOf(c))===-1&&r.relays.push(c)}),a.relays=r.relays)}}),e.mentions.forEach(r=>{if(r.author){let o=e.profiles.find(a=>a.pubkey===r.author);o&&o.relays&&(r.relays||(r.relays=[]),o.relays.forEach(a=>{r.relays.indexOf(a)===-1&&r.relays.push(a)}),o.relays=r.relays)}}),e}var nip11_exports={};__export(nip11_exports,{fetchRelayInformation:()=>fetchRelayInformation$1,useFetchImplementation:()=>useFetchImplementation2});var _fetch2;try{_fetch2=fetch}catch{}function useFetchImplementation2(t){_fetch2=t}async function fetchRelayInformation$1(t){return await(await fetch(t.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var nip13_exports={};__export(nip13_exports,{fastEventHash:()=>fastEventHash,getPow:()=>getPow,minePow:()=>minePow});function getPow(t){let e=0;for(let n=0;n<64;n+=8){const s=parseInt(t.substring(n,n+8),16);if(s===0)e+=32;else{e+=Math.clz32(s);break}}return e}function minePow(t,e){let n=0;const s=t,r=["nonce",n.toString(),e.toString()];for(s.tags.push(r);;){const o=Math.floor(new Date().getTime()/1e3);if(o!==s.created_at&&(n=0,s.created_at=o),r[1]=(++n).toString(),s.id=fastEventHash(s),getPow(s.id)>=e)break}return s}function fastEventHash(t){return bytesToHex$2(sha256$2(utf8Encoder$1.encode(JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content]))))}var nip17_exports={};__export(nip17_exports,{unwrapEvent:()=>unwrapEvent2,unwrapManyEvents:()=>unwrapManyEvents2,wrapEvent:()=>wrapEvent2,wrapManyEvents:()=>wrapManyEvents2});var nip59_exports={};__export(nip59_exports,{createRumor:()=>createRumor,createSeal:()=>createSeal,createWrap:()=>createWrap,unwrapEvent:()=>unwrapEvent,unwrapManyEvents:()=>unwrapManyEvents,wrapEvent:()=>wrapEvent$1,wrapManyEvents:()=>wrapManyEvents});var nip44_exports={};__export(nip44_exports,{decrypt:()=>decrypt2,encrypt:()=>encrypt2,getConversationKey:()=>getConversationKey,v2:()=>v2});var minPlaintextSize=1,maxPlaintextSize=65535;function getConversationKey(t,e){const n=secp256k1$1.getSharedSecret(t,"02"+e).subarray(1,33);return extract(sha256$2,n,"nip44-v2")}function getMessageKeys(t,e){const n=expand(sha256$2,t,e,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function calcPaddedLen(t){if(!Number.isSafeInteger(t)||t<1)throw new Error("expected positive integer");if(t<=32)return 32;const e=1<<Math.floor(Math.log2(t-1))+1,n=e<=256?32:e/8;return n*(Math.floor((t-1)/n)+1)}function writeU16BE(t){if(!Number.isSafeInteger(t)||t<minPlaintextSize||t>maxPlaintextSize)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t,!1),e}function pad(t){const e=utf8Encoder$1.encode(t),n=e.length,s=writeU16BE(n),r=new Uint8Array(calcPaddedLen(n)-n);return concatBytes$1(s,e,r)}function unpad(t){const e=new DataView(t.buffer).getUint16(0),n=t.subarray(2,2+e);if(e<minPlaintextSize||e>maxPlaintextSize||n.length!==e||t.length!==2+calcPaddedLen(e))throw new Error("invalid padding");return utf8Decoder$1.decode(n)}function hmacAad(t,e,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");const s=concatBytes$1(n,e);return hmac$1(sha256$2,t,s)}function decodePayload(t){if(typeof t!="string")throw new Error("payload must be a valid string");const e=t.length;if(e<132||e>87472)throw new Error("invalid payload length: "+e);if(t[0]==="#")throw new Error("unknown encryption version");let n;try{n=base64.decode(t)}catch(o){throw new Error("invalid base64: "+o.message)}const s=n.length;if(s<99||s>65603)throw new Error("invalid data length: "+s);const r=n[0];if(r!==2)throw new Error("unknown encryption version "+r);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function encrypt2(t,e,n=randomBytes$1(32)){const{chacha_key:s,chacha_nonce:r,hmac_key:o}=getMessageKeys(e,n),a=pad(t),c=chacha20(s,r,a),l=hmacAad(o,c,n);return base64.encode(concatBytes$1(new Uint8Array([2]),n,c,l))}function decrypt2(t,e){const{nonce:n,ciphertext:s,mac:r}=decodePayload(t),{chacha_key:o,chacha_nonce:a,hmac_key:c}=getMessageKeys(e,n),l=hmacAad(c,s,n);if(!equalBytes(l,r))throw new Error("invalid MAC");const u=chacha20(o,a,s);return unpad(u)}var v2={utils:{getConversationKey,calcPaddedLen},encrypt:encrypt2,decrypt:decrypt2},TWO_DAYS=2*24*60*60,now=()=>Math.round(Date.now()/1e3),randomNow=()=>Math.round(now()-Math.random()*TWO_DAYS),nip44ConversationKey=(t,e)=>getConversationKey(t,e),nip44Encrypt=(t,e,n)=>encrypt2(JSON.stringify(t),nip44ConversationKey(e,n)),nip44Decrypt=(t,e)=>JSON.parse(decrypt2(t.content,nip44ConversationKey(e,t.pubkey)));function createRumor(t,e){const n={created_at:now(),content:"",tags:[],...t,pubkey:getPublicKey(e)};return n.id=getEventHash$1(n),n}function createSeal(t,e,n){return finalizeEvent({kind:Seal,content:nip44Encrypt(t,e,n),created_at:randomNow(),tags:[]},e)}function createWrap(t,e){const n=generateSecretKey();return finalizeEvent({kind:GiftWrap,content:nip44Encrypt(t,n,e),created_at:randomNow(),tags:[["p",e]]},n)}function wrapEvent$1(t,e,n){const s=createRumor(t,e),r=createSeal(s,e,n);return createWrap(r,n)}function wrapManyEvents(t,e,n){if(!n||n.length===0)throw new Error("At least one recipient is required.");const s=getPublicKey(e),r=[wrapEvent$1(t,e,s)];return n.forEach(o=>{r.push(wrapEvent$1(t,e,o))}),r}function unwrapEvent(t,e){const n=nip44Decrypt(t,e);return nip44Decrypt(n,e)}function unwrapManyEvents(t,e){let n=[];return t.forEach(s=>{n.push(unwrapEvent(s,e))}),n.sort((s,r)=>s.created_at-r.created_at),n}function createEvent(t,e,n,s){const r={created_at:Math.ceil(Date.now()/1e3),kind:PrivateDirectMessage,tags:[],content:e};return(Array.isArray(t)?t:[t]).forEach(({publicKey:a,relayUrl:c})=>{r.tags.push(c?["p",a,c]:["p",a])}),s&&r.tags.push(["e",s.eventId,s.relayUrl||"","reply"]),n&&r.tags.push(["subject",n]),r}function wrapEvent2(t,e,n,s,r){const o=createEvent(e,n,s,r);return wrapEvent$1(o,t,e.publicKey)}function wrapManyEvents2(t,e,n,s,r){if(!e||e.length===0)throw new Error("At least one recipient is required.");return[{publicKey:getPublicKey(t)},...e].map(a=>wrapEvent2(t,a,n,s,r))}var unwrapEvent2=unwrapEvent,unwrapManyEvents2=unwrapManyEvents,nip18_exports={};__export(nip18_exports,{finishRepostEvent:()=>finishRepostEvent,getRepostedEvent:()=>getRepostedEvent,getRepostedEventPointer:()=>getRepostedEventPointer});function finishRepostEvent(t,e,n,s){var a;let r;const o=[...t.tags??[],["e",e.id,n],["p",e.pubkey]];return e.kind===ShortTextNote?r=Repost:(r=GenericRepost,o.push(["k",String(e.kind)])),finalizeEvent({kind:r,tags:o,content:t.content===""||(a=e.tags)!=null&&a.find(c=>c[0]==="-")?"":JSON.stringify(e),created_at:t.created_at},s)}function getRepostedEventPointer(t){if(![Repost,GenericRepost].includes(t.kind))return;let e,n;for(let s=t.tags.length-1;s>=0&&(e===void 0||n===void 0);s--){const r=t.tags[s];r.length>=2&&(r[0]==="e"&&e===void 0?e=r:r[0]==="p"&&n===void 0&&(n=r))}if(e!==void 0)return{id:e[1],relays:[e[2],n==null?void 0:n[2]].filter(s=>typeof s=="string"),author:n==null?void 0:n[1]}}function getRepostedEvent(t,{skipVerification:e}={}){const n=getRepostedEventPointer(t);if(n===void 0||t.content==="")return;let s;try{s=JSON.parse(t.content)}catch{return}if(s.id===n.id&&!(!e&&!verifyEvent(s)))return s}var nip21_exports={};__export(nip21_exports,{NOSTR_URI_REGEX:()=>NOSTR_URI_REGEX,parse:()=>parse2,test:()=>test});var NOSTR_URI_REGEX=new RegExp(`nostr:(${BECH32_REGEX$2.source})`);function test(t){return typeof t=="string"&&new RegExp(`^${NOSTR_URI_REGEX.source}$`).test(t)}function parse2(t){const e=t.match(new RegExp(`^${NOSTR_URI_REGEX.source}$`));if(!e)throw new Error(`Invalid Nostr URI: ${t}`);return{uri:e[0],value:e[1],decoded:decode$1(e[1])}}var nip25_exports={};__export(nip25_exports,{finishReactionEvent:()=>finishReactionEvent,getReactedEventPointer:()=>getReactedEventPointer});function finishReactionEvent(t,e,n){const s=e.tags.filter(r=>r.length>=2&&(r[0]==="e"||r[0]==="p"));return finalizeEvent({...t,kind:Reaction,tags:[...t.tags??[],...s,["e",e.id],["p",e.pubkey]],content:t.content??"+"},n)}function getReactedEventPointer(t){if(t.kind!==Reaction)return;let e,n;for(let s=t.tags.length-1;s>=0&&(e===void 0||n===void 0);s--){const r=t.tags[s];r.length>=2&&(r[0]==="e"&&e===void 0?e=r:r[0]==="p"&&n===void 0&&(n=r))}if(!(e===void 0||n===void 0))return{id:e[1],relays:[e[2],n[2]].filter(s=>s!==void 0),author:n[1]}}var nip27_exports={};__export(nip27_exports,{parse:()=>parse3});var noCharacter=/\W/m,noURLCharacter=/[^\w\/] |[^\w\/]$|$|,| /m,MAX_HASHTAG_LENGTH=42;function*parse3(t){let e=[];if(typeof t!="string"){for(let o=0;o<t.tags.length;o++){const a=t.tags[o];a[0]==="emoji"&&a.length>=3&&e.push({type:"emoji",shortcode:a[1],url:a[2]})}t=t.content}const n=t.length;let s=0,r=0;e:for(;r<n;){const o=t.indexOf(":",r),a=t.indexOf("#",r);if(o===-1&&a===-1)break e;if(o===-1||a>=0&&a<o){if(a===0||t[a-1]===" "){const c=t.slice(a+1,a+MAX_HASHTAG_LENGTH).match(noCharacter),l=c?a+1+c.index:n;yield{type:"text",text:t.slice(s,a)},yield{type:"hashtag",value:t.slice(a+1,l)},r=l,s=r;continue e}r=a+1;continue e}if(t.slice(o-5,o)==="nostr"){const c=t.slice(o+60).match(noCharacter),l=c?o+60+c.index:n;try{let u,{data:f,type:h}=decode$1(t.slice(o+1,l));switch(h){case"npub":u={pubkey:f};break;case"note":u={id:f};break;case"nsec":r=l+1;continue;default:u=f}s!==o-5&&(yield{type:"text",text:t.slice(s,o-5)}),yield{type:"reference",pointer:u},r=l,s=r;continue e}catch{r=o+1;continue e}}else if(t.slice(o-5,o)==="https"||t.slice(o-4,o)==="http"){const c=t.slice(o+4).match(noURLCharacter),l=c?o+4+c.index:n,u=t[o-1]==="s"?5:4;try{let f=new URL(t.slice(o-u,l));if(f.hostname.indexOf(".")===-1)throw new Error("invalid url");if(s!==o-u&&(yield{type:"text",text:t.slice(s,o-u)}),/\.(png|jpe?g|gif|webp|heic|svg)$/i.test(f.pathname)){yield{type:"image",url:f.toString()},r=l,s=r;continue e}if(/\.(mp4|avi|webm|mkv|mov)$/i.test(f.pathname)){yield{type:"video",url:f.toString()},r=l,s=r;continue e}if(/\.(mp3|aac|ogg|opus|wav|flac)$/i.test(f.pathname)){yield{type:"audio",url:f.toString()},r=l,s=r;continue e}yield{type:"url",url:f.toString()},r=l,s=r;continue e}catch{r=l+1;continue e}}else if(t.slice(o-3,o)==="wss"||t.slice(o-2,o)==="ws"){const c=t.slice(o+4).match(noURLCharacter),l=c?o+4+c.index:n,u=t[o-1]==="s"?3:2;try{let f=new URL(t.slice(o-u,l));if(f.hostname.indexOf(".")===-1)throw new Error("invalid ws url");s!==o-u&&(yield{type:"text",text:t.slice(s,o-u)}),yield{type:"relay",url:f.toString()},r=l,s=r;continue e}catch{r=l+1;continue e}}else{for(let c=0;c<e.length;c++){const l=e[c];if(t[o+l.shortcode.length+1]===":"&&t.slice(o+1,o+l.shortcode.length+1)===l.shortcode){s!==o&&(yield{type:"text",text:t.slice(s,o)}),yield l,r=o+l.shortcode.length+2,s=r;continue e}}r=o+1;continue e}}s!==n&&(yield{type:"text",text:t.slice(s)})}var nip28_exports={};__export(nip28_exports,{channelCreateEvent:()=>channelCreateEvent,channelHideMessageEvent:()=>channelHideMessageEvent,channelMessageEvent:()=>channelMessageEvent,channelMetadataEvent:()=>channelMetadataEvent,channelMuteUserEvent:()=>channelMuteUserEvent});var channelCreateEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelCreation,tags:[...t.tags??[]],content:n,created_at:t.created_at},e)},channelMetadataEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelMetadata,tags:[["e",t.channel_create_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},channelMessageEvent=(t,e)=>{const n=[["e",t.channel_create_event_id,t.relay_url,"root"]];return t.reply_to_channel_message_event_id&&n.push(["e",t.reply_to_channel_message_event_id,t.relay_url,"reply"]),finalizeEvent({kind:ChannelMessage,tags:[...n,...t.tags??[]],content:t.content,created_at:t.created_at},e)},channelHideMessageEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelHideMessage,tags:[["e",t.channel_message_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},channelMuteUserEvent=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return finalizeEvent({kind:ChannelMuteUser,tags:[["p",t.pubkey_to_mute],...t.tags??[]],content:n,created_at:t.created_at},e)},nip30_exports={};__export(nip30_exports,{EMOJI_SHORTCODE_REGEX:()=>EMOJI_SHORTCODE_REGEX,matchAll:()=>matchAll,regex:()=>regex,replaceAll:()=>replaceAll});var EMOJI_SHORTCODE_REGEX=/:(\w+):/,regex=()=>new RegExp(`\\B${EMOJI_SHORTCODE_REGEX.source}\\B`,"g");function*matchAll(t){const e=t.matchAll(regex());for(const n of e)try{const[s,r]=n;yield{shortcode:s,name:r,start:n.index,end:n.index+s.length}}catch{}}function replaceAll(t,e){return t.replaceAll(regex(),(n,s)=>e({shortcode:n,name:s}))}var nip39_exports={};__export(nip39_exports,{useFetchImplementation:()=>useFetchImplementation3,validateGithub:()=>validateGithub});var _fetch3;try{_fetch3=fetch}catch{}function useFetchImplementation3(t){_fetch3=t}async function validateGithub(t,e,n){try{return await(await _fetch3(`https://gist.github.com/${e}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${t}`}catch{return!1}}var nip47_exports={};__export(nip47_exports,{makeNwcRequestEvent:()=>makeNwcRequestEvent,parseConnectionString:()=>parseConnectionString});function parseConnectionString(t){const{host:e,pathname:n,searchParams:s}=new URL(t),r=n||e,o=s.get("relay"),a=s.get("secret");if(!r||!o||!a)throw new Error("invalid connection string");return{pubkey:r,relay:o,secret:a}}async function makeNwcRequestEvent(t,e,n){const r=encrypt$2(e,t,JSON.stringify({method:"pay_invoice",params:{invoice:n}})),o={kind:NWCWalletRequest,created_at:Math.round(Date.now()/1e3),content:r,tags:[["p",t]]};return finalizeEvent(o,e)}var nip54_exports={};__export(nip54_exports,{normalizeIdentifier:()=>normalizeIdentifier});function normalizeIdentifier(t){return t=t.trim().toLowerCase(),t=t.normalize("NFKC"),Array.from(t).map(e=>new RegExp("\\p{Letter}","u").test(e)||new RegExp("\\p{Number}","u").test(e)?e:"-").join("")}var nip57_exports={};__export(nip57_exports,{getSatoshisAmountFromBolt11:()=>getSatoshisAmountFromBolt11,getZapEndpoint:()=>getZapEndpoint,makeZapReceipt:()=>makeZapReceipt,makeZapRequest:()=>makeZapRequest,useFetchImplementation:()=>useFetchImplementation4,validateZapRequest:()=>validateZapRequest});var _fetch4;try{_fetch4=fetch}catch{}function useFetchImplementation4(t){_fetch4=t}async function getZapEndpoint(t){try{let e="",{lud06:n,lud16:s}=JSON.parse(t.content);if(s){let[a,c]=s.split("@");e=new URL(`/.well-known/lnurlp/${a}`,`https://${c}`).toString()}else if(n){let{words:a}=bech32$1.decode(n,1e3),c=bech32$1.fromWords(a);e=utf8Decoder$1.decode(c)}else return null;let o=await(await _fetch4(e)).json();if(o.allowsNostr&&o.nostrPubkey)return o.callback}catch{}return null}function makeZapRequest(t){let e={kind:9734,created_at:Math.round(Date.now()/1e3),content:t.comment||"",tags:[["p","pubkey"in t?t.pubkey:t.event.pubkey],["amount",t.amount.toString()],["relays",...t.relays]]};if("event"in t){if(e.tags.push(["e",t.event.id]),isReplaceableKind(t.event.kind)){const n=["a",`${t.event.kind}:${t.event.pubkey}:`];e.tags.push(n)}else if(isAddressableKind(t.event.kind)){let n=t.event.tags.find(([r,o])=>r==="d"&&o);if(!n)throw new Error("d tag not found or is empty");const s=["a",`${t.event.kind}:${t.event.pubkey}:${n[1]}`];e.tags.push(s)}e.tags.push(["k",t.event.kind.toString()])}return e}function validateZapRequest(t){let e;try{e=JSON.parse(t)}catch{return"Invalid zap request JSON."}if(!validateEvent(e))return"Zap request is not a valid Nostr event.";if(!verifyEvent(e))return"Invalid signature on zap request.";let n=e.tags.find(([o,a])=>o==="p"&&a);if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let s=e.tags.find(([o,a])=>o==="e"&&a);return s&&!s[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":e.tags.find(([o,a])=>o==="relays"&&a)?null:"Zap request doesn't have a 'relays' tag."}function makeZapReceipt({zapRequest:t,preimage:e,bolt11:n,paidAt:s}){let r=JSON.parse(t),o=r.tags.filter(([c])=>c==="e"||c==="p"||c==="a"),a={kind:9735,created_at:Math.round(s.getTime()/1e3),content:"",tags:[...o,["P",r.pubkey],["bolt11",n],["description",t]]};return e&&a.tags.push(["preimage",e]),a}function getSatoshisAmountFromBolt11(t){if(t.length<50)return 0;t=t.substring(0,50);const e=t.lastIndexOf("1");if(e===-1)return 0;const n=t.substring(0,e);if(!n.startsWith("lnbc"))return 0;const s=n.substring(4);if(s.length<1)return 0;const r=s[s.length-1],o=r.charCodeAt(0)-48,a=o>=0&&o<=9;let c=s.length-1;if(a&&c++,c<1)return 0;const l=parseInt(s.substring(0,c));switch(r){case"m":return l*1e5;case"u":return l*100;case"n":return l/10;case"p":return l/1e4;default:return l*1e8}}var nip77_exports={};__export(nip77_exports,{Negentropy:()=>Negentropy,NegentropyStorageVector:()=>NegentropyStorageVector,NegentropySync:()=>NegentropySync});var PROTOCOL_VERSION=97,ID_SIZE=32,FINGERPRINT_SIZE=16,Mode={Skip:0,Fingerprint:1,IdList:2},WrappedBuffer=class{constructor(t){g(this,"_raw");g(this,"length");typeof t=="number"?(this._raw=new Uint8Array(t),this.length=0):t instanceof Uint8Array?(this._raw=new Uint8Array(t),this.length=t.length):(this._raw=new Uint8Array(512),this.length=0)}unwrap(){return this._raw.subarray(0,this.length)}get capacity(){return this._raw.byteLength}extend(t){if(t instanceof WrappedBuffer&&(t=t.unwrap()),typeof t.length!="number")throw Error("bad length");const e=t.length+this.length;if(this.capacity<e){const n=this._raw,s=Math.max(this.capacity*2,e);this._raw=new Uint8Array(s),this._raw.set(n)}this._raw.set(t,this.length),this.length+=t.length}shift(){const t=this._raw[0];return this._raw=this._raw.subarray(1),this.length--,t}shiftN(t=1){const e=this._raw.subarray(0,t);return this._raw=this._raw.subarray(t),this.length-=t,e}};function decodeVarInt(t){let e=0;for(;;){if(t.length===0)throw Error("parse ends prematurely");let n=t.shift();if(e=e<<7|n&127,!(n&128))break}return e}function encodeVarInt(t){if(t===0)return new WrappedBuffer(new Uint8Array([0]));let e=[];for(;t!==0;)e.push(t&127),t>>>=7;e.reverse();for(let n=0;n<e.length-1;n++)e[n]|=128;return new WrappedBuffer(new Uint8Array(e))}function getByte(t){return getBytes(t,1)[0]}function getBytes(t,e){if(t.length<e)throw Error("parse ends prematurely");return t.shiftN(e)}var Accumulator=class{constructor(){g(this,"buf");this.setToZero()}setToZero(){this.buf=new Uint8Array(ID_SIZE)}add(t){let e=0,n=0,s=new DataView(this.buf.buffer),r=new DataView(t.buffer);for(let o=0;o<8;o++){let a=o*4,c=s.getUint32(a,!0),l=r.getUint32(a,!0),u=c;u+=e,u+=l,u>4294967295&&(n=1),s.setUint32(a,u&4294967295,!0),e=n,n=0}}negate(){let t=new DataView(this.buf.buffer);for(let n=0;n<8;n++){let s=n*4;t.setUint32(s,~t.getUint32(s,!0))}let e=new Uint8Array(ID_SIZE);e[0]=1,this.add(e)}getFingerprint(t){let e=new WrappedBuffer;return e.extend(this.buf),e.extend(encodeVarInt(t)),sha256$2(e.unwrap()).subarray(0,FINGERPRINT_SIZE)}},NegentropyStorageVector=class{constructor(){g(this,"items");g(this,"sealed");this.items=[],this.sealed=!1}insert(t,e){if(this.sealed)throw Error("already sealed");const n=hexToBytes$1(e);if(n.byteLength!==ID_SIZE)throw Error("bad id size for added item");this.items.push({timestamp:t,id:n})}seal(){if(this.sealed)throw Error("already sealed");this.sealed=!0,this.items.sort(itemCompare);for(let t=1;t<this.items.length;t++)if(itemCompare(this.items[t-1],this.items[t])===0)throw Error("duplicate item inserted")}unseal(){this.sealed=!1}size(){return this._checkSealed(),this.items.length}getItem(t){if(this._checkSealed(),t>=this.items.length)throw Error("out of range");return this.items[t]}iterate(t,e,n){this._checkSealed(),this._checkBounds(t,e);for(let s=t;s<e&&n(this.items[s],s);++s);}findLowerBound(t,e,n){return this._checkSealed(),this._checkBounds(t,e),this._binarySearch(this.items,t,e,s=>itemCompare(s,n)<0)}fingerprint(t,e){let n=new Accumulator;return n.setToZero(),this.iterate(t,e,s=>(n.add(s.id),!0)),n.getFingerprint(e-t)}_checkSealed(){if(!this.sealed)throw Error("not sealed")}_checkBounds(t,e){if(t>e||e>this.items.length)throw Error("bad range")}_binarySearch(t,e,n,s){let r=n-e;for(;r>0;){let o=e,a=Math.floor(r/2);o+=a,s(t[o])?(e=++o,r-=a+1):r=a}return e}},Negentropy=class{constructor(t,e=6e4){g(this,"storage");g(this,"frameSizeLimit");g(this,"lastTimestampIn");g(this,"lastTimestampOut");if(e<4096)throw Error("frameSizeLimit too small");this.storage=t,this.frameSizeLimit=e,this.lastTimestampIn=0,this.lastTimestampOut=0}_bound(t,e){return{timestamp:t,id:e||new Uint8Array(0)}}initiate(){let t=new WrappedBuffer;return t.extend(new Uint8Array([PROTOCOL_VERSION])),this.splitRange(0,this.storage.size(),this._bound(Number.MAX_VALUE),t),bytesToHex$1(t.unwrap())}reconcile(t,e,n){const s=new WrappedBuffer(hexToBytes$1(t));this.lastTimestampIn=this.lastTimestampOut=0;let r=new WrappedBuffer;r.extend(new Uint8Array([PROTOCOL_VERSION]));let o=getByte(s);if(o<96||o>111)throw Error("invalid negentropy protocol version byte");if(o!==PROTOCOL_VERSION)throw Error("unsupported negentropy protocol version requested: "+(o-96));let a=this.storage.size(),c=this._bound(0),l=0,u=!1;for(;s.length!==0;){let f=new WrappedBuffer,h=()=>{u&&(u=!1,f.extend(this.encodeBound(c)),f.extend(encodeVarInt(Mode.Skip)))},p=this.decodeBound(s),y=decodeVarInt(s),b=l,m=this.storage.findLowerBound(l,a,p);if(y===Mode.Skip)u=!0;else if(y===Mode.Fingerprint){let w=getBytes(s,FINGERPRINT_SIZE),k=this.storage.fingerprint(b,m);compareUint8Array(w,k)!==0?(h(),this.splitRange(b,m,p,f)):u=!0}else if(y===Mode.IdList){let w=decodeVarInt(s),k={};for(let A=0;A<w;A++){let B=getBytes(s,ID_SIZE);k[bytesToHex$1(B)]=B}if(u=!0,this.storage.iterate(b,m,A=>{let B=A.id;const P=bytesToHex$1(B);return k[P]?delete k[bytesToHex$1(B)]:e==null||e(P),!0}),n)for(let A of Object.values(k))n(bytesToHex$1(A))}else throw Error("unexpected mode");if(this.exceededFrameSizeLimit(r.length+f.length)){let w=this.storage.fingerprint(m,a);r.extend(this.encodeBound(this._bound(Number.MAX_VALUE))),r.extend(encodeVarInt(Mode.Fingerprint)),r.extend(w);break}else r.extend(f);l=m,c=p}return r.length===1?null:bytesToHex$1(r.unwrap())}splitRange(t,e,n,s){let r=e-t,o=16;if(r<o*2)s.extend(this.encodeBound(n)),s.extend(encodeVarInt(Mode.IdList)),s.extend(encodeVarInt(r)),this.storage.iterate(t,e,a=>(s.extend(a.id),!0));else{let a=Math.floor(r/o),c=r%o,l=t;for(let u=0;u<o;u++){let f=a+(u<c?1:0),h=this.storage.fingerprint(l,l+f);l+=f;let p;if(l===e)p=n;else{let y,b;this.storage.iterate(l-1,l+1,(m,w)=>(w===l-1?y=m:b=m,!0)),p=this.getMinimalBound(y,b)}s.extend(this.encodeBound(p)),s.extend(encodeVarInt(Mode.Fingerprint)),s.extend(h)}}}exceededFrameSizeLimit(t){return t>this.frameSizeLimit-200}decodeTimestampIn(t){let e=decodeVarInt(t);return e=e===0?Number.MAX_VALUE:e-1,this.lastTimestampIn===Number.MAX_VALUE||e===Number.MAX_VALUE?(this.lastTimestampIn=Number.MAX_VALUE,Number.MAX_VALUE):(e+=this.lastTimestampIn,this.lastTimestampIn=e,e)}decodeBound(t){let e=this.decodeTimestampIn(t),n=decodeVarInt(t);if(n>ID_SIZE)throw Error("bound key too long");let s=getBytes(t,n);return{timestamp:e,id:s}}encodeTimestampOut(t){if(t===Number.MAX_VALUE)return this.lastTimestampOut=Number.MAX_VALUE,encodeVarInt(0);let e=t;return t-=this.lastTimestampOut,this.lastTimestampOut=e,encodeVarInt(t+1)}encodeBound(t){let e=new WrappedBuffer;return e.extend(this.encodeTimestampOut(t.timestamp)),e.extend(encodeVarInt(t.id.length)),e.extend(t.id),e}getMinimalBound(t,e){if(e.timestamp!==t.timestamp)return this._bound(e.timestamp);{let n=0,s=e.id,r=t.id;for(let o=0;o<ID_SIZE&&s[o]===r[o];o++)n++;return this._bound(e.timestamp,e.id.subarray(0,n+1))}}};function compareUint8Array(t,e){for(let n=0;n<t.byteLength;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return t.byteLength>e.byteLength?1:t.byteLength<e.byteLength?-1:0}function itemCompare(t,e){return t.timestamp===e.timestamp?compareUint8Array(t.id,e.id):t.timestamp-e.timestamp}var NegentropySync=class{constructor(t,e,n,s={}){g(this,"relay");g(this,"storage");g(this,"neg");g(this,"filter");g(this,"subscription");g(this,"onhave");g(this,"onneed");this.relay=t,this.storage=e,this.neg=new Negentropy(e),this.onhave=s.onhave,this.onneed=s.onneed,this.filter=n,this.subscription=this.relay.prepareSubscription([{}],{label:s.label||"negentropy"}),this.subscription.oncustom=r=>{var o,a,c,l;switch(r[0]){case"NEG-MSG":{r.length<3&&console.warn(`got invalid NEG-MSG from ${this.relay.url}: ${r}`);try{const u=this.neg.reconcile(r[2],this.onhave,this.onneed);u?this.relay.send(`["NEG-MSG", "${this.subscription.id}", "${u}"]`):(this.close(),(o=s.onclose)==null||o.call(s))}catch(u){console.error("negentropy reconcile error:",u),(a=s==null?void 0:s.onclose)==null||a.call(s,`reconcile error: ${u}`)}break}case"NEG-CLOSE":{const u=r[2];console.warn("negentropy error:",u),(c=s.onclose)==null||c.call(s,u);break}case"NEG-ERR":(l=s.onclose)==null||l.call(s)}}}async start(){const t=this.neg.initiate();this.relay.send(`["NEG-OPEN","${this.subscription.id}",${JSON.stringify(this.filter)},"${t}"]`)}close(){this.relay.send(`["NEG-CLOSE","${this.subscription.id}"]`),this.subscription.close()}},nip98_exports={};__export(nip98_exports,{getToken:()=>getToken,hashPayload:()=>hashPayload,unpackEventFromToken:()=>unpackEventFromToken,validateEvent:()=>validateEvent2,validateEventKind:()=>validateEventKind,validateEventMethodTag:()=>validateEventMethodTag,validateEventPayloadTag:()=>validateEventPayloadTag,validateEventTimestamp:()=>validateEventTimestamp,validateEventUrlTag:()=>validateEventUrlTag,validateToken:()=>validateToken});var _authorizationScheme="Nostr ";async function getToken(t,e,n,s=!1,r){const o={kind:HTTPAuth,tags:[["u",t],["method",e]],created_at:Math.round(new Date().getTime()/1e3),content:""};r&&o.tags.push(["payload",hashPayload(r)]);const a=await n(o);return(s?_authorizationScheme:"")+base64.encode(utf8Encoder$1.encode(JSON.stringify(a)))}async function validateToken(t,e,n){const s=await unpackEventFromToken(t).catch(o=>{throw o});return await validateEvent2(s,e,n).catch(o=>{throw o})}async function unpackEventFromToken(t){if(!t)throw new Error("Missing token");t=t.replace(_authorizationScheme,"");const e=utf8Decoder$1.decode(base64.decode(t));if(!e||e.length===0||!e.startsWith("{"))throw new Error("Invalid token");return JSON.parse(e)}function validateEventTimestamp(t){return t.created_at?Math.round(new Date().getTime()/1e3)-t.created_at<60:!1}function validateEventKind(t){return t.kind===HTTPAuth}function validateEventUrlTag(t,e){const n=t.tags.find(s=>s[0]==="u");return n?n.length>0&&n[1]===e:!1}function validateEventMethodTag(t,e){const n=t.tags.find(s=>s[0]==="method");return n?n.length>0&&n[1].toLowerCase()===e.toLowerCase():!1}function hashPayload(t){const e=sha256$2(utf8Encoder$1.encode(JSON.stringify(t)));return bytesToHex$2(e)}function validateEventPayloadTag(t,e){const n=t.tags.find(r=>r[0]==="payload");if(!n)return!1;const s=hashPayload(e);return n.length>0&&n[1]===s}async function validateEvent2(t,e,n,s){if(!verifyEvent(t))throw new Error("Invalid nostr event, signature invalid");if(!validateEventKind(t))throw new Error("Invalid nostr event, kind invalid");if(!validateEventTimestamp(t))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!validateEventUrlTag(t,e))throw new Error("Invalid nostr event, url tag invalid");if(!validateEventMethodTag(t,n))throw new Error("Invalid nostr event, method tag invalid");if(s&&typeof s=="object"&&Object.keys(s).length>0&&!validateEventPayloadTag(t,s))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}const index$1=Object.freeze(Object.defineProperty({__proto__:null,SimplePool,finalizeEvent,fj:fakejson_exports,generateSecretKey,getEventHash:getEventHash$1,getPublicKey,kinds:kinds_exports,matchFilter,matchFilters,nip04:nip04_exports,nip05:nip05_exports,nip10:nip10_exports,nip11:nip11_exports,nip13:nip13_exports,nip17:nip17_exports,nip18:nip18_exports,nip19:nip19_exports$1,nip21:nip21_exports,nip25:nip25_exports,nip27:nip27_exports,nip28:nip28_exports,nip30:nip30_exports,nip39:nip39_exports,nip42:nip42_exports,nip44:nip44_exports,nip47:nip47_exports,nip54:nip54_exports,nip57:nip57_exports,nip59:nip59_exports,nip77:nip77_exports,nip98:nip98_exports,serializeEvent,utils:utils_exports,validateEvent,verifiedSymbol,verifyEvent},Symbol.toStringTag,{value:"Module"})),crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function isBytes(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function anumber(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function abytes(t,...e){if(!isBytes(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function ahash(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");anumber(t.outputLen),anumber(t.blockLen)}function aexists(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function aoutput(t,e){abytes(t);const n=e.outputLen;if(t.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}function clean(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function createView(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function rotr(t,e){return t<<32-e|t>>>e}const hasHexBuiltin=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",hexes=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function bytesToHex(t){if(abytes(t),hasHexBuiltin)return t.toHex();let e="";for(let n=0;n<t.length;n++)e+=hexes[t[n]];return e}const asciis={_0:48,_9:57,A:65,F:70,a:97,f:102};function asciiToBase16(t){if(t>=asciis._0&&t<=asciis._9)return t-asciis._0;if(t>=asciis.A&&t<=asciis.F)return t-(asciis.A-10);if(t>=asciis.a&&t<=asciis.f)return t-(asciis.a-10)}function hexToBytes(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);if(hasHexBuiltin)return Uint8Array.fromHex(t);const e=t.length,n=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const s=new Uint8Array(n);for(let r=0,o=0;r<n;r++,o+=2){const a=asciiToBase16(t.charCodeAt(o)),c=asciiToBase16(t.charCodeAt(o+1));if(a===void 0||c===void 0){const l=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+o)}s[r]=a*16+c}return s}function utf8ToBytes(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function toBytes(t){return typeof t=="string"&&(t=utf8ToBytes(t)),abytes(t),t}function concatBytes(...t){let e=0;for(let s=0;s<t.length;s++){const r=t[s];abytes(r),e+=r.length}const n=new Uint8Array(e);for(let s=0,r=0;s<t.length;s++){const o=t[s];n.set(o,r),r+=o.length}return n}class Hash{}function createHasher(t){const e=s=>t().update(toBytes(s)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function randomBytes(t=32){if(crypto&&typeof crypto.getRandomValues=="function")return crypto.getRandomValues(new Uint8Array(t));if(crypto&&typeof crypto.randomBytes=="function")return Uint8Array.from(crypto.randomBytes(t));throw new Error("crypto.getRandomValues must be defined")}function setBigUint64(t,e,n,s){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,s);const r=BigInt(32),o=BigInt(4294967295),a=Number(n>>r&o),c=Number(n&o),l=s?4:0,u=s?0:4;t.setUint32(e+l,a,s),t.setUint32(e+u,c,s)}function Chi(t,e,n){return t&e^~t&n}function Maj(t,e,n){return t&e^t&n^e&n}class HashMD extends Hash{constructor(e,n,s,r){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=n,this.padOffset=s,this.isLE=r,this.buffer=new Uint8Array(e),this.view=createView(this.buffer)}update(e){aexists(this),e=toBytes(e),abytes(e);const{view:n,buffer:s,blockLen:r}=this,o=e.length;for(let a=0;a<o;){const c=Math.min(r-this.pos,o-a);if(c===r){const l=createView(e);for(;r<=o-a;a+=r)this.process(l,a);continue}s.set(e.subarray(a,a+c),this.pos),this.pos+=c,a+=c,this.pos===r&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){aexists(this),aoutput(e,this),this.finished=!0;const{buffer:n,view:s,blockLen:r,isLE:o}=this;let{pos:a}=this;n[a++]=128,clean(this.buffer.subarray(a)),this.padOffset>r-a&&(this.process(s,0),a=0);for(let h=a;h<r;h++)n[h]=0;setBigUint64(s,r-8,BigInt(this.length*8),o),this.process(s,0);const c=createView(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=l/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)c.setUint32(4*h,f[h],o)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const s=e.slice(0,n);return this.destroy(),s}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:s,length:r,finished:o,destroyed:a,pos:c}=this;return e.destroyed=a,e.finished=o,e.length=r,e.pos=c,r%n&&e.buffer.set(s),e}clone(){return this._cloneInto()}}const SHA256_IV=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_K=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),SHA256_W=new Uint32Array(64);class SHA256 extends HashMD{constructor(e=32){super(64,e,8,!1),this.A=SHA256_IV[0]|0,this.B=SHA256_IV[1]|0,this.C=SHA256_IV[2]|0,this.D=SHA256_IV[3]|0,this.E=SHA256_IV[4]|0,this.F=SHA256_IV[5]|0,this.G=SHA256_IV[6]|0,this.H=SHA256_IV[7]|0}get(){const{A:e,B:n,C:s,D:r,E:o,F:a,G:c,H:l}=this;return[e,n,s,r,o,a,c,l]}set(e,n,s,r,o,a,c,l){this.A=e|0,this.B=n|0,this.C=s|0,this.D=r|0,this.E=o|0,this.F=a|0,this.G=c|0,this.H=l|0}process(e,n){for(let h=0;h<16;h++,n+=4)SHA256_W[h]=e.getUint32(n,!1);for(let h=16;h<64;h++){const p=SHA256_W[h-15],y=SHA256_W[h-2],b=rotr(p,7)^rotr(p,18)^p>>>3,m=rotr(y,17)^rotr(y,19)^y>>>10;SHA256_W[h]=m+SHA256_W[h-7]+b+SHA256_W[h-16]|0}let{A:s,B:r,C:o,D:a,E:c,F:l,G:u,H:f}=this;for(let h=0;h<64;h++){const p=rotr(c,6)^rotr(c,11)^rotr(c,25),y=f+p+Chi(c,l,u)+SHA256_K[h]+SHA256_W[h]|0,m=(rotr(s,2)^rotr(s,13)^rotr(s,22))+Maj(s,r,o)|0;f=u,u=l,l=c,c=a+y|0,a=o,o=r,r=s,s=y+m|0}s=s+this.A|0,r=r+this.B|0,o=o+this.C|0,a=a+this.D|0,c=c+this.E|0,l=l+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(s,r,o,a,c,l,u,f)}roundClean(){clean(SHA256_W)}destroy(){this.set(0,0,0,0,0,0,0,0),clean(this.buffer)}}const sha256$1=createHasher(()=>new SHA256);class HMAC extends Hash{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,ahash(e);const s=toBytes(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,o=new Uint8Array(r);o.set(s.length>r?e.create().update(s).digest():s);for(let a=0;a<o.length;a++)o[a]^=54;this.iHash.update(o),this.oHash=e.create();for(let a=0;a<o.length;a++)o[a]^=106;this.oHash.update(o),clean(o)}update(e){return aexists(this),this.iHash.update(e),this}digestInto(e){aexists(this),abytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:s,finished:r,destroyed:o,blockLen:a,outputLen:c}=this;return e=e,e.finished=r,e.destroyed=o,e.blockLen=a,e.outputLen=c,e.oHash=n._cloneInto(e.oHash),e.iHash=s._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const hmac=(t,e,n)=>new HMAC(t,e).update(n).digest();hmac.create=(t,e)=>new HMAC(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$4=BigInt(0),_1n$4=BigInt(1);function _abool2(t,e=""){if(typeof t!="boolean"){const n=e&&`"${e}"`;throw new Error(n+"expected boolean, got type="+typeof t)}return t}function _abytes2(t,e,n=""){const s=isBytes(t),r=t==null?void 0:t.length,o=e!==void 0;if(!s||o&&r!==e){const a=n&&`"${n}" `,c=o?` of length ${e}`:"",l=s?`length=${r}`:`type=${typeof t}`;throw new Error(a+"expected Uint8Array"+c+", got "+l)}return t}function numberToHexUnpadded(t){const e=t.toString(16);return e.length&1?"0"+e:e}function hexToNumber(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?_0n$4:BigInt("0x"+t)}function bytesToNumberBE(t){return hexToNumber(bytesToHex(t))}function bytesToNumberLE(t){return abytes(t),hexToNumber(bytesToHex(Uint8Array.from(t).reverse()))}function numberToBytesBE(t,e){return hexToBytes(t.toString(16).padStart(e*2,"0"))}function numberToBytesLE(t,e){return numberToBytesBE(t,e).reverse()}function ensureBytes(t,e,n){let s;if(typeof e=="string")try{s=hexToBytes(e)}catch(o){throw new Error(t+" must be hex string or Uint8Array, cause: "+o)}else if(isBytes(e))s=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const r=s.length;if(typeof n=="number"&&r!==n)throw new Error(t+" of length "+n+" expected, got "+r);return s}const isPosBig=t=>typeof t=="bigint"&&_0n$4<=t;function inRange(t,e,n){return isPosBig(t)&&isPosBig(e)&&isPosBig(n)&&e<=t&&t<n}function aInRange(t,e,n,s){if(!inRange(e,n,s))throw new Error("expected valid "+t+": "+n+" <= n < "+s+", got "+e)}function bitLen(t){let e;for(e=0;t>_0n$4;t>>=_1n$4,e+=1);return e}const bitMask=t=>(_1n$4<<BigInt(t))-_1n$4;function createHmacDrbg(t,e,n){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");const s=y=>new Uint8Array(y),r=y=>Uint8Array.of(y);let o=s(t),a=s(t),c=0;const l=()=>{o.fill(1),a.fill(0),c=0},u=(...y)=>n(a,o,...y),f=(y=s(0))=>{a=u(r(0),y),o=u(),y.length!==0&&(a=u(r(1),y),o=u())},h=()=>{if(c++>=1e3)throw new Error("drbg: tried 1000 values");let y=0;const b=[];for(;y<e;){o=u();const m=o.slice();b.push(m),y+=o.length}return concatBytes(...b)};return(y,b)=>{l(),f(y);let m;for(;!(m=b(h()));)f();return l(),m}}function _validateObject(t,e,n={}){if(!t||typeof t!="object")throw new Error("expected valid options object");function s(r,o,a){const c=t[r];if(a&&c===void 0)return;const l=typeof c;if(l!==o||c===null)throw new Error(`param "${r}" is invalid: expected ${o}, got ${l}`)}Object.entries(e).forEach(([r,o])=>s(r,o,!1)),Object.entries(n).forEach(([r,o])=>s(r,o,!0))}function memoized(t){const e=new WeakMap;return(n,...s)=>{const r=e.get(n);if(r!==void 0)return r;const o=t(n,...s);return e.set(n,o),o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$3=BigInt(0),_1n$3=BigInt(1),_2n$2=BigInt(2),_3n$1=BigInt(3),_4n$1=BigInt(4),_5n=BigInt(5),_7n=BigInt(7),_8n=BigInt(8),_9n=BigInt(9),_16n=BigInt(16);function mod(t,e){const n=t%e;return n>=_0n$3?n:e+n}function pow2(t,e,n){let s=t;for(;e-- >_0n$3;)s*=s,s%=n;return s}function invert(t,e){if(t===_0n$3)throw new Error("invert: expected non-zero number");if(e<=_0n$3)throw new Error("invert: expected positive modulus, got "+e);let n=mod(t,e),s=e,r=_0n$3,o=_1n$3;for(;n!==_0n$3;){const c=s/n,l=s%n,u=r-o*c;s=n,n=l,r=o,o=u}if(s!==_1n$3)throw new Error("invert: does not exist");return mod(r,e)}function assertIsSquare(t,e,n){if(!t.eql(t.sqr(e),n))throw new Error("Cannot find square root")}function sqrt3mod4(t,e){const n=(t.ORDER+_1n$3)/_4n$1,s=t.pow(e,n);return assertIsSquare(t,s,e),s}function sqrt5mod8(t,e){const n=(t.ORDER-_5n)/_8n,s=t.mul(e,_2n$2),r=t.pow(s,n),o=t.mul(e,r),a=t.mul(t.mul(o,_2n$2),r),c=t.mul(o,t.sub(a,t.ONE));return assertIsSquare(t,c,e),c}function sqrt9mod16(t){const e=Field(t),n=tonelliShanks(t),s=n(e,e.neg(e.ONE)),r=n(e,s),o=n(e,e.neg(s)),a=(t+_7n)/_16n;return(c,l)=>{let u=c.pow(l,a),f=c.mul(u,s);const h=c.mul(u,r),p=c.mul(u,o),y=c.eql(c.sqr(f),l),b=c.eql(c.sqr(h),l);u=c.cmov(u,f,y),f=c.cmov(p,h,b);const m=c.eql(c.sqr(f),l),w=c.cmov(u,f,m);return assertIsSquare(c,w,l),w}}function tonelliShanks(t){if(t<_3n$1)throw new Error("sqrt is not defined for small field");let e=t-_1n$3,n=0;for(;e%_2n$2===_0n$3;)e/=_2n$2,n++;let s=_2n$2;const r=Field(t);for(;FpLegendre(r,s)===1;)if(s++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(n===1)return sqrt3mod4;let o=r.pow(s,e);const a=(e+_1n$3)/_2n$2;return function(l,u){if(l.is0(u))return u;if(FpLegendre(l,u)!==1)throw new Error("Cannot find square root");let f=n,h=l.mul(l.ONE,o),p=l.pow(u,e),y=l.pow(u,a);for(;!l.eql(p,l.ONE);){if(l.is0(p))return l.ZERO;let b=1,m=l.sqr(p);for(;!l.eql(m,l.ONE);)if(b++,m=l.sqr(m),b===f)throw new Error("Cannot find square root");const w=_1n$3<<BigInt(f-b-1),k=l.pow(h,w);f=b,h=l.sqr(k),p=l.mul(p,h),y=l.mul(y,k)}return y}}function FpSqrt(t){return t%_4n$1===_3n$1?sqrt3mod4:t%_8n===_5n?sqrt5mod8:t%_16n===_9n?sqrt9mod16(t):tonelliShanks(t)}const FIELD_FIELDS=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},n=FIELD_FIELDS.reduce((s,r)=>(s[r]="function",s),e);return _validateObject(t,n),t}function FpPow(t,e,n){if(n<_0n$3)throw new Error("invalid exponent, negatives unsupported");if(n===_0n$3)return t.ONE;if(n===_1n$3)return e;let s=t.ONE,r=e;for(;n>_0n$3;)n&_1n$3&&(s=t.mul(s,r)),r=t.sqr(r),n>>=_1n$3;return s}function FpInvertBatch(t,e,n=!1){const s=new Array(e.length).fill(n?t.ZERO:void 0),r=e.reduce((a,c,l)=>t.is0(c)?a:(s[l]=a,t.mul(a,c)),t.ONE),o=t.inv(r);return e.reduceRight((a,c,l)=>t.is0(c)?a:(s[l]=t.mul(a,s[l]),t.mul(a,c)),o),s}function FpLegendre(t,e){const n=(t.ORDER-_1n$3)/_2n$2,s=t.pow(e,n),r=t.eql(s,t.ONE),o=t.eql(s,t.ZERO),a=t.eql(s,t.neg(t.ONE));if(!r&&!o&&!a)throw new Error("invalid Legendre symbol result");return r?1:o?0:-1}function nLength(t,e){e!==void 0&&anumber(e);const n=e!==void 0?e:t.toString(2).length,s=Math.ceil(n/8);return{nBitLength:n,nByteLength:s}}function Field(t,e,n=!1,s={}){if(t<=_0n$3)throw new Error("invalid field: expected ORDER > 0, got "+t);let r,o,a=!1,c;if(typeof e=="object"&&e!=null){if(s.sqrt||n)throw new Error("cannot specify opts in two arguments");const p=e;p.BITS&&(r=p.BITS),p.sqrt&&(o=p.sqrt),typeof p.isLE=="boolean"&&(n=p.isLE),typeof p.modFromBytes=="boolean"&&(a=p.modFromBytes),c=p.allowedLengths}else typeof e=="number"&&(r=e),s.sqrt&&(o=s.sqrt);const{nBitLength:l,nByteLength:u}=nLength(t,r);if(u>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let f;const h=Object.freeze({ORDER:t,isLE:n,BITS:l,BYTES:u,MASK:bitMask(l),ZERO:_0n$3,ONE:_1n$3,allowedLengths:c,create:p=>mod(p,t),isValid:p=>{if(typeof p!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof p);return _0n$3<=p&&p<t},is0:p=>p===_0n$3,isValidNot0:p=>!h.is0(p)&&h.isValid(p),isOdd:p=>(p&_1n$3)===_1n$3,neg:p=>mod(-p,t),eql:(p,y)=>p===y,sqr:p=>mod(p*p,t),add:(p,y)=>mod(p+y,t),sub:(p,y)=>mod(p-y,t),mul:(p,y)=>mod(p*y,t),pow:(p,y)=>FpPow(h,p,y),div:(p,y)=>mod(p*invert(y,t),t),sqrN:p=>p*p,addN:(p,y)=>p+y,subN:(p,y)=>p-y,mulN:(p,y)=>p*y,inv:p=>invert(p,t),sqrt:o||(p=>(f||(f=FpSqrt(t)),f(h,p))),toBytes:p=>n?numberToBytesLE(p,u):numberToBytesBE(p,u),fromBytes:(p,y=!0)=>{if(c){if(!c.includes(p.length)||p.length>u)throw new Error("Field.fromBytes: expected "+c+" bytes, got "+p.length);const m=new Uint8Array(u);m.set(p,n?0:m.length-p.length),p=m}if(p.length!==u)throw new Error("Field.fromBytes: expected "+u+" bytes, got "+p.length);let b=n?bytesToNumberLE(p):bytesToNumberBE(p);if(a&&(b=mod(b,t)),!y&&!h.isValid(b))throw new Error("invalid field element: outside of range 0..ORDER");return b},invertBatch:p=>FpInvertBatch(h,p),cmov:(p,y,b)=>b?y:p});return Object.freeze(h)}function getFieldBytesLength(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function getMinHashLength(t){const e=getFieldBytesLength(t);return e+Math.ceil(e/2)}function mapHashToField(t,e,n=!1){const s=t.length,r=getFieldBytesLength(e),o=getMinHashLength(e);if(s<16||s<o||s>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+s);const a=n?bytesToNumberLE(t):bytesToNumberBE(t),c=mod(a,e-_1n$3)+_1n$3;return n?numberToBytesLE(c,r):numberToBytesBE(c,r)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$2=BigInt(0),_1n$2=BigInt(1);function negateCt(t,e){const n=e.negate();return t?n:e}function normalizeZ(t,e){const n=FpInvertBatch(t.Fp,e.map(s=>s.Z));return e.map((s,r)=>t.fromAffine(s.toAffine(n[r])))}function validateW(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function calcWOpts(t,e){validateW(t,e);const n=Math.ceil(e/t)+1,s=2**(t-1),r=2**t,o=bitMask(t),a=BigInt(t);return{windows:n,windowSize:s,mask:o,maxNumber:r,shiftBy:a}}function calcOffsets(t,e,n){const{windowSize:s,mask:r,maxNumber:o,shiftBy:a}=n;let c=Number(t&r),l=t>>a;c>s&&(c-=o,l+=_1n$2);const u=e*s,f=u+Math.abs(c)-1,h=c===0,p=c<0,y=e%2!==0;return{nextN:l,offset:f,isZero:h,isNeg:p,isNegF:y,offsetF:u}}function validateMSMPoints(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((n,s)=>{if(!(n instanceof e))throw new Error("invalid point at index "+s)})}function validateMSMScalars(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((n,s)=>{if(!e.isValid(n))throw new Error("invalid scalar at index "+s)})}const pointPrecomputes=new WeakMap,pointWindowSizes=new WeakMap;function getW(t){return pointWindowSizes.get(t)||1}function assert0(t){if(t!==_0n$2)throw new Error("invalid wNAF")}class wNAF{constructor(e,n){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=n}_unsafeLadder(e,n,s=this.ZERO){let r=e;for(;n>_0n$2;)n&_1n$2&&(s=s.add(r)),r=r.double(),n>>=_1n$2;return s}precomputeWindow(e,n){const{windows:s,windowSize:r}=calcWOpts(n,this.bits),o=[];let a=e,c=a;for(let l=0;l<s;l++){c=a,o.push(c);for(let u=1;u<r;u++)c=c.add(a),o.push(c);a=c.double()}return o}wNAF(e,n,s){if(!this.Fn.isValid(s))throw new Error("invalid scalar");let r=this.ZERO,o=this.BASE;const a=calcWOpts(e,this.bits);for(let c=0;c<a.windows;c++){const{nextN:l,offset:u,isZero:f,isNeg:h,isNegF:p,offsetF:y}=calcOffsets(s,c,a);s=l,f?o=o.add(negateCt(p,n[y])):r=r.add(negateCt(h,n[u]))}return assert0(s),{p:r,f:o}}wNAFUnsafe(e,n,s,r=this.ZERO){const o=calcWOpts(e,this.bits);for(let a=0;a<o.windows&&s!==_0n$2;a++){const{nextN:c,offset:l,isZero:u,isNeg:f}=calcOffsets(s,a,o);if(s=c,!u){const h=n[l];r=r.add(f?h.negate():h)}}return assert0(s),r}getPrecomputes(e,n,s){let r=pointPrecomputes.get(n);return r||(r=this.precomputeWindow(n,e),e!==1&&(typeof s=="function"&&(r=s(r)),pointPrecomputes.set(n,r))),r}cached(e,n,s){const r=getW(e);return this.wNAF(r,this.getPrecomputes(r,e,s),n)}unsafe(e,n,s,r){const o=getW(e);return o===1?this._unsafeLadder(e,n,r):this.wNAFUnsafe(o,this.getPrecomputes(o,e,s),n,r)}createCache(e,n){validateW(n,this.bits),pointWindowSizes.set(e,n),pointPrecomputes.delete(e)}hasCache(e){return getW(e)!==1}}function mulEndoUnsafe(t,e,n,s){let r=e,o=t.ZERO,a=t.ZERO;for(;n>_0n$2||s>_0n$2;)n&_1n$2&&(o=o.add(r)),s&_1n$2&&(a=a.add(r)),r=r.double(),n>>=_1n$2,s>>=_1n$2;return{p1:o,p2:a}}function pippenger(t,e,n,s){validateMSMPoints(n,t),validateMSMScalars(s,e);const r=n.length,o=s.length;if(r!==o)throw new Error("arrays of points and scalars must have equal length");const a=t.ZERO,c=bitLen(BigInt(r));let l=1;c>12?l=c-3:c>4?l=c-2:c>0&&(l=2);const u=bitMask(l),f=new Array(Number(u)+1).fill(a),h=Math.floor((e.BITS-1)/l)*l;let p=a;for(let y=h;y>=0;y-=l){f.fill(a);for(let m=0;m<o;m++){const w=s[m],k=Number(w>>BigInt(y)&u);f[k]=f[k].add(n[m])}let b=a;for(let m=f.length-1,w=a;m>0;m--)w=w.add(f[m]),b=b.add(w);if(p=p.add(b),y!==0)for(let m=0;m<l;m++)p=p.double()}return p}function createField(t,e,n){if(e){if(e.ORDER!==t)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return validateField(e),e}else return Field(t,{isLE:n})}function _createCurveFields(t,e,n={},s){if(s===void 0&&(s=t==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${t} CURVE object`);for(const l of["p","n","h"]){const u=e[l];if(!(typeof u=="bigint"&&u>_0n$2))throw new Error(`CURVE.${l} must be positive bigint`)}const r=createField(e.p,n.Fp,s),o=createField(e.n,n.Fn,s),c=["Gx","Gy","a","b"];for(const l of c)if(!r.isValid(e[l]))throw new Error(`CURVE.${l} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:r,Fn:o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const divNearest=(t,e)=>(t+(t>=0?e:-e)/_2n$1)/e;function _splitEndoScalar(t,e,n){const[[s,r],[o,a]]=e,c=divNearest(a*t,n),l=divNearest(-r*t,n);let u=t-c*s-l*o,f=-c*r-l*a;const h=u<_0n$1,p=f<_0n$1;h&&(u=-u),p&&(f=-f);const y=bitMask(Math.ceil(bitLen(n)/2))+_1n$1;if(u<_0n$1||u>=y||f<_0n$1||f>=y)throw new Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:h,k1:u,k2neg:p,k2:f}}function validateSigFormat(t){if(!["compact","recovered","der"].includes(t))throw new Error('Signature format must be "compact", "recovered", or "der"');return t}function validateSigOpts(t,e){const n={};for(let s of Object.keys(e))n[s]=t[s]===void 0?e[s]:t[s];return _abool2(n.lowS,"lowS"),_abool2(n.prehash,"prehash"),n.format!==void 0&&validateSigFormat(n.format),n}class DERErr extends Error{constructor(e=""){super(e)}}const DER={Err:DERErr,_tlv:{encode:(t,e)=>{const{Err:n}=DER;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(e.length&1)throw new n("tlv.encode: unpadded data");const s=e.length/2,r=numberToHexUnpadded(s);if(r.length/2&128)throw new n("tlv.encode: long form length too big");const o=s>127?numberToHexUnpadded(r.length/2|128):"";return numberToHexUnpadded(t)+o+r+e},decode(t,e){const{Err:n}=DER;let s=0;if(t<0||t>256)throw new n("tlv.encode: wrong tag");if(e.length<2||e[s++]!==t)throw new n("tlv.decode: wrong tlv");const r=e[s++],o=!!(r&128);let a=0;if(!o)a=r;else{const l=r&127;if(!l)throw new n("tlv.decode(long): indefinite length not supported");if(l>4)throw new n("tlv.decode(long): byte length is too big");const u=e.subarray(s,s+l);if(u.length!==l)throw new n("tlv.decode: length bytes not complete");if(u[0]===0)throw new n("tlv.decode(long): zero leftmost byte");for(const f of u)a=a<<8|f;if(s+=l,a<128)throw new n("tlv.decode(long): not minimal encoding")}const c=e.subarray(s,s+a);if(c.length!==a)throw new n("tlv.decode: wrong value length");return{v:c,l:e.subarray(s+a)}}},_int:{encode(t){const{Err:e}=DER;if(t<_0n$1)throw new e("integer: negative integers are not allowed");let n=numberToHexUnpadded(t);if(Number.parseInt(n[0],16)&8&&(n="00"+n),n.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return n},decode(t){const{Err:e}=DER;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return bytesToNumberBE(t)}},toSig(t){const{Err:e,_int:n,_tlv:s}=DER,r=ensureBytes("signature",t),{v:o,l:a}=s.decode(48,r);if(a.length)throw new e("invalid signature: left bytes after parsing");const{v:c,l}=s.decode(2,o),{v:u,l:f}=s.decode(2,l);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:n.decode(c),s:n.decode(u)}},hexFromSig(t){const{_tlv:e,_int:n}=DER,s=e.encode(2,n.encode(t.r)),r=e.encode(2,n.encode(t.s)),o=s+r;return e.encode(48,o)}},_0n$1=BigInt(0),_1n$1=BigInt(1),_2n$1=BigInt(2),_3n=BigInt(3),_4n=BigInt(4);function _normFnElement(t,e){const{BYTES:n}=t;let s;if(typeof e=="bigint")s=e;else{let r=ensureBytes("private key",e);try{s=t.fromBytes(r)}catch{throw new Error(`invalid private key: expected ui8a of size ${n}, got ${typeof e}`)}}if(!t.isValidNot0(s))throw new Error("invalid private key: out of range [1..N-1]");return s}function weierstrassN(t,e={}){const n=_createCurveFields("weierstrass",t,e),{Fp:s,Fn:r}=n;let o=n.CURVE;const{h:a,n:c}=o;_validateObject(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=e;if(l&&(!s.is0(o.a)||typeof l.beta!="bigint"||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const u=getWLengths(s,r);function f(){if(!s.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function h($,E,x){const{x:v,y:_}=E.toAffine(),S=s.toBytes(v);if(_abool2(x,"isCompressed"),x){f();const I=!s.isOdd(_);return concatBytes(pprefix(I),S)}else return concatBytes(Uint8Array.of(4),S,s.toBytes(_))}function p($){_abytes2($,void 0,"Point");const{publicKey:E,publicKeyUncompressed:x}=u,v=$.length,_=$[0],S=$.subarray(1);if(v===E&&(_===2||_===3)){const I=s.fromBytes(S);if(!s.isValid(I))throw new Error("bad point: is not on curve, wrong x");const R=m(I);let N;try{N=s.sqrt(R)}catch(j){const V=j instanceof Error?": "+j.message:"";throw new Error("bad point: is not on curve, sqrt error"+V)}f();const C=s.isOdd(N);return(_&1)===1!==C&&(N=s.neg(N)),{x:I,y:N}}else if(v===x&&_===4){const I=s.BYTES,R=s.fromBytes(S.subarray(0,I)),N=s.fromBytes(S.subarray(I,I*2));if(!w(R,N))throw new Error("bad point: is not on curve");return{x:R,y:N}}else throw new Error(`bad point: got length ${v}, expected compressed=${E} or uncompressed=${x}`)}const y=e.toBytes||h,b=e.fromBytes||p;function m($){const E=s.sqr($),x=s.mul(E,$);return s.add(s.add(x,s.mul($,o.a)),o.b)}function w($,E){const x=s.sqr(E),v=m($);return s.eql(x,v)}if(!w(o.Gx,o.Gy))throw new Error("bad curve params: generator point");const k=s.mul(s.pow(o.a,_3n),_4n),A=s.mul(s.sqr(o.b),BigInt(27));if(s.is0(s.add(k,A)))throw new Error("bad curve params: a or b");function B($,E,x=!1){if(!s.isValid(E)||x&&s.is0(E))throw new Error(`bad point coordinate ${$}`);return E}function P($){if(!($ instanceof F))throw new Error("ProjectivePoint expected")}function O($){if(!l||!l.basises)throw new Error("no endo");return _splitEndoScalar($,l.basises,r.ORDER)}const U=memoized(($,E)=>{const{X:x,Y:v,Z:_}=$;if(s.eql(_,s.ONE))return{x,y:v};const S=$.is0();E==null&&(E=S?s.ONE:s.inv(_));const I=s.mul(x,E),R=s.mul(v,E),N=s.mul(_,E);if(S)return{x:s.ZERO,y:s.ZERO};if(!s.eql(N,s.ONE))throw new Error("invZ was invalid");return{x:I,y:R}}),M=memoized($=>{if($.is0()){if(e.allowInfinityPoint&&!s.is0($.Y))return;throw new Error("bad point: ZERO")}const{x:E,y:x}=$.toAffine();if(!s.isValid(E)||!s.isValid(x))throw new Error("bad point: x or y not field elements");if(!w(E,x))throw new Error("bad point: equation left != right");if(!$.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function D($,E,x,v,_){return x=new F(s.mul(x.X,$),x.Y,x.Z),E=negateCt(v,E),x=negateCt(_,x),E.add(x)}class F{constructor(E,x,v){this.X=B("x",E),this.Y=B("y",x,!0),this.Z=B("z",v),Object.freeze(this)}static CURVE(){return o}static fromAffine(E){const{x,y:v}=E||{};if(!E||!s.isValid(x)||!s.isValid(v))throw new Error("invalid affine point");if(E instanceof F)throw new Error("projective point not allowed");return s.is0(x)&&s.is0(v)?F.ZERO:new F(x,v,s.ONE)}static fromBytes(E){const x=F.fromAffine(b(_abytes2(E,void 0,"point")));return x.assertValidity(),x}static fromHex(E){return F.fromBytes(ensureBytes("pointHex",E))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(E=8,x=!0){return T.createCache(this,E),x||this.multiply(_3n),this}assertValidity(){M(this)}hasEvenY(){const{y:E}=this.toAffine();if(!s.isOdd)throw new Error("Field doesn't support isOdd");return!s.isOdd(E)}equals(E){P(E);const{X:x,Y:v,Z:_}=this,{X:S,Y:I,Z:R}=E,N=s.eql(s.mul(x,R),s.mul(S,_)),C=s.eql(s.mul(v,R),s.mul(I,_));return N&&C}negate(){return new F(this.X,s.neg(this.Y),this.Z)}double(){const{a:E,b:x}=o,v=s.mul(x,_3n),{X:_,Y:S,Z:I}=this;let R=s.ZERO,N=s.ZERO,C=s.ZERO,L=s.mul(_,_),j=s.mul(S,S),V=s.mul(I,I),z=s.mul(_,S);return z=s.add(z,z),C=s.mul(_,I),C=s.add(C,C),R=s.mul(E,C),N=s.mul(v,V),N=s.add(R,N),R=s.sub(j,N),N=s.add(j,N),N=s.mul(R,N),R=s.mul(z,R),C=s.mul(v,C),V=s.mul(E,V),z=s.sub(L,V),z=s.mul(E,z),z=s.add(z,C),C=s.add(L,L),L=s.add(C,L),L=s.add(L,V),L=s.mul(L,z),N=s.add(N,L),V=s.mul(S,I),V=s.add(V,V),L=s.mul(V,z),R=s.sub(R,L),C=s.mul(V,j),C=s.add(C,C),C=s.add(C,C),new F(R,N,C)}add(E){P(E);const{X:x,Y:v,Z:_}=this,{X:S,Y:I,Z:R}=E;let N=s.ZERO,C=s.ZERO,L=s.ZERO;const j=o.a,V=s.mul(o.b,_3n);let z=s.mul(x,S),q=s.mul(v,I),G=s.mul(_,R),K=s.add(x,v),W=s.add(S,I);K=s.mul(K,W),W=s.add(z,q),K=s.sub(K,W),W=s.add(x,_);let Z=s.add(S,R);return W=s.mul(W,Z),Z=s.add(z,G),W=s.sub(W,Z),Z=s.add(v,_),N=s.add(I,R),Z=s.mul(Z,N),N=s.add(q,G),Z=s.sub(Z,N),L=s.mul(j,W),N=s.mul(V,G),L=s.add(N,L),N=s.sub(q,L),L=s.add(q,L),C=s.mul(N,L),q=s.add(z,z),q=s.add(q,z),G=s.mul(j,G),W=s.mul(V,W),q=s.add(q,G),G=s.sub(z,G),G=s.mul(j,G),W=s.add(W,G),z=s.mul(q,W),C=s.add(C,z),z=s.mul(Z,W),N=s.mul(K,N),N=s.sub(N,z),z=s.mul(K,q),L=s.mul(Z,L),L=s.add(L,z),new F(N,C,L)}subtract(E){return this.add(E.negate())}is0(){return this.equals(F.ZERO)}multiply(E){const{endo:x}=e;if(!r.isValidNot0(E))throw new Error("invalid scalar: out of range");let v,_;const S=I=>T.cached(this,I,R=>normalizeZ(F,R));if(x){const{k1neg:I,k1:R,k2neg:N,k2:C}=O(E),{p:L,f:j}=S(R),{p:V,f:z}=S(C);_=j.add(z),v=D(x.beta,L,V,I,N)}else{const{p:I,f:R}=S(E);v=I,_=R}return normalizeZ(F,[v,_])[0]}multiplyUnsafe(E){const{endo:x}=e,v=this;if(!r.isValid(E))throw new Error("invalid scalar: out of range");if(E===_0n$1||v.is0())return F.ZERO;if(E===_1n$1)return v;if(T.hasCache(this))return this.multiply(E);if(x){const{k1neg:_,k1:S,k2neg:I,k2:R}=O(E),{p1:N,p2:C}=mulEndoUnsafe(F,v,S,R);return D(x.beta,N,C,_,I)}else return T.unsafe(v,E)}multiplyAndAddUnsafe(E,x,v){const _=this.multiplyUnsafe(x).add(E.multiplyUnsafe(v));return _.is0()?void 0:_}toAffine(E){return U(this,E)}isTorsionFree(){const{isTorsionFree:E}=e;return a===_1n$1?!0:E?E(F,this):T.unsafe(this,c).is0()}clearCofactor(){const{clearCofactor:E}=e;return a===_1n$1?this:E?E(F,this):this.multiplyUnsafe(a)}isSmallOrder(){return this.multiplyUnsafe(a).is0()}toBytes(E=!0){return _abool2(E,"isCompressed"),this.assertValidity(),y(F,this,E)}toHex(E=!0){return bytesToHex(this.toBytes(E))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(E=!0){return this.toBytes(E)}_setWindowSize(E){this.precompute(E)}static normalizeZ(E){return normalizeZ(F,E)}static msm(E,x){return pippenger(F,r,E,x)}static fromPrivateKey(E){return F.BASE.multiply(_normFnElement(r,E))}}F.BASE=new F(o.Gx,o.Gy,s.ONE),F.ZERO=new F(s.ZERO,s.ONE,s.ZERO),F.Fp=s,F.Fn=r;const H=r.BITS,T=new wNAF(F,e.endo?Math.ceil(H/2):H);return F.BASE.precompute(8),F}function pprefix(t){return Uint8Array.of(t?2:3)}function getWLengths(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function ecdh(t,e={}){const{Fn:n}=t,s=e.randomBytes||randomBytes,r=Object.assign(getWLengths(t.Fp,n),{seed:getMinHashLength(n.ORDER)});function o(y){try{return!!_normFnElement(n,y)}catch{return!1}}function a(y,b){const{publicKey:m,publicKeyUncompressed:w}=r;try{const k=y.length;return b===!0&&k!==m||b===!1&&k!==w?!1:!!t.fromBytes(y)}catch{return!1}}function c(y=s(r.seed)){return mapHashToField(_abytes2(y,r.seed,"seed"),n.ORDER)}function l(y,b=!0){return t.BASE.multiply(_normFnElement(n,y)).toBytes(b)}function u(y){const b=c(y);return{secretKey:b,publicKey:l(b)}}function f(y){if(typeof y=="bigint")return!1;if(y instanceof t)return!0;const{secretKey:b,publicKey:m,publicKeyUncompressed:w}=r;if(n.allowedLengths||b===m)return;const k=ensureBytes("key",y).length;return k===m||k===w}function h(y,b,m=!0){if(f(y)===!0)throw new Error("first arg must be private key");if(f(b)===!1)throw new Error("second arg must be public key");const w=_normFnElement(n,y);return t.fromHex(b).multiply(w).toBytes(m)}return Object.freeze({getPublicKey:l,getSharedSecret:h,keygen:u,Point:t,utils:{isValidSecretKey:o,isValidPublicKey:a,randomSecretKey:c,isValidPrivateKey:o,randomPrivateKey:c,normPrivateKeyToScalar:y=>_normFnElement(n,y),precompute(y=8,b=t.BASE){return b.precompute(y,!1)}},lengths:r})}function ecdsa(t,e,n={}){ahash(e),_validateObject(n,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const s=n.randomBytes||randomBytes,r=n.hmac||((x,...v)=>hmac(e,x,concatBytes(...v))),{Fp:o,Fn:a}=t,{ORDER:c,BITS:l}=a,{keygen:u,getPublicKey:f,getSharedSecret:h,utils:p,lengths:y}=ecdh(t,n),b={prehash:!1,lowS:typeof n.lowS=="boolean"?n.lowS:!1,format:void 0,extraEntropy:!1},m="compact";function w(x){const v=c>>_1n$1;return x>v}function k(x,v){if(!a.isValidNot0(v))throw new Error(`invalid signature ${x}: out of range 1..Point.Fn.ORDER`);return v}function A(x,v){validateSigFormat(v);const _=y.signature,S=v==="compact"?_:v==="recovered"?_+1:void 0;return _abytes2(x,S,`${v} signature`)}class B{constructor(v,_,S){this.r=k("r",v),this.s=k("s",_),S!=null&&(this.recovery=S),Object.freeze(this)}static fromBytes(v,_=m){A(v,_);let S;if(_==="der"){const{r:C,s:L}=DER.toSig(_abytes2(v));return new B(C,L)}_==="recovered"&&(S=v[0],_="compact",v=v.subarray(1));const I=a.BYTES,R=v.subarray(0,I),N=v.subarray(I,I*2);return new B(a.fromBytes(R),a.fromBytes(N),S)}static fromHex(v,_){return this.fromBytes(hexToBytes(v),_)}addRecoveryBit(v){return new B(this.r,this.s,v)}recoverPublicKey(v){const _=o.ORDER,{r:S,s:I,recovery:R}=this;if(R==null||![0,1,2,3].includes(R))throw new Error("recovery id invalid");if(c*_2n$1<_&&R>1)throw new Error("recovery id is ambiguous for h>1 curve");const C=R===2||R===3?S+c:S;if(!o.isValid(C))throw new Error("recovery id 2 or 3 invalid");const L=o.toBytes(C),j=t.fromBytes(concatBytes(pprefix((R&1)===0),L)),V=a.inv(C),z=O(ensureBytes("msgHash",v)),q=a.create(-z*V),G=a.create(I*V),K=t.BASE.multiplyUnsafe(q).add(j.multiplyUnsafe(G));if(K.is0())throw new Error("point at infinify");return K.assertValidity(),K}hasHighS(){return w(this.s)}toBytes(v=m){if(validateSigFormat(v),v==="der")return hexToBytes(DER.hexFromSig(this));const _=a.toBytes(this.r),S=a.toBytes(this.s);if(v==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return concatBytes(Uint8Array.of(this.recovery),_,S)}return concatBytes(_,S)}toHex(v){return bytesToHex(this.toBytes(v))}assertValidity(){}static fromCompact(v){return B.fromBytes(ensureBytes("sig",v),"compact")}static fromDER(v){return B.fromBytes(ensureBytes("sig",v),"der")}normalizeS(){return this.hasHighS()?new B(this.r,a.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return bytesToHex(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return bytesToHex(this.toBytes("compact"))}}const P=n.bits2int||function(v){if(v.length>8192)throw new Error("input is too large");const _=bytesToNumberBE(v),S=v.length*8-l;return S>0?_>>BigInt(S):_},O=n.bits2int_modN||function(v){return a.create(P(v))},U=bitMask(l);function M(x){return aInRange("num < 2^"+l,x,_0n$1,U),a.toBytes(x)}function D(x,v){return _abytes2(x,void 0,"message"),v?_abytes2(e(x),void 0,"prehashed message"):x}function F(x,v,_){if(["recovered","canonical"].some(q=>q in _))throw new Error("sign() legacy options not supported");const{lowS:S,prehash:I,extraEntropy:R}=validateSigOpts(_,b);x=D(x,I);const N=O(x),C=_normFnElement(a,v),L=[M(C),M(N)];if(R!=null&&R!==!1){const q=R===!0?s(y.secretKey):R;L.push(ensureBytes("extraEntropy",q))}const j=concatBytes(...L),V=N;function z(q){const G=P(q);if(!a.isValidNot0(G))return;const K=a.inv(G),W=t.BASE.multiply(G).toAffine(),Z=a.create(W.x);if(Z===_0n$1)return;const _e=a.create(K*a.create(V+Z*C));if(_e===_0n$1)return;let X=(W.x===Z?0:2)|Number(W.y&_1n$1),Y=_e;return S&&w(_e)&&(Y=a.neg(_e),X^=1),new B(Z,Y,X)}return{seed:j,k2sig:z}}function H(x,v,_={}){x=ensureBytes("message",x);const{seed:S,k2sig:I}=F(x,v,_);return createHmacDrbg(e.outputLen,a.BYTES,r)(S,I)}function T(x){let v;const _=typeof x=="string"||isBytes(x),S=!_&&x!==null&&typeof x=="object"&&typeof x.r=="bigint"&&typeof x.s=="bigint";if(!_&&!S)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(S)v=new B(x.r,x.s);else if(_){try{v=B.fromBytes(ensureBytes("sig",x),"der")}catch(I){if(!(I instanceof DER.Err))throw I}if(!v)try{v=B.fromBytes(ensureBytes("sig",x),"compact")}catch{return!1}}return v||!1}function $(x,v,_,S={}){const{lowS:I,prehash:R,format:N}=validateSigOpts(S,b);if(_=ensureBytes("publicKey",_),v=D(ensureBytes("message",v),R),"strict"in S)throw new Error("options.strict was renamed to lowS");const C=N===void 0?T(x):B.fromBytes(ensureBytes("sig",x),N);if(C===!1)return!1;try{const L=t.fromBytes(_);if(I&&C.hasHighS())return!1;const{r:j,s:V}=C,z=O(v),q=a.inv(V),G=a.create(z*q),K=a.create(j*q),W=t.BASE.multiplyUnsafe(G).add(L.multiplyUnsafe(K));return W.is0()?!1:a.create(W.x)===j}catch{return!1}}function E(x,v,_={}){const{prehash:S}=validateSigOpts(_,b);return v=D(v,S),B.fromBytes(x,"recovered").recoverPublicKey(v).toBytes()}return Object.freeze({keygen:u,getPublicKey:f,getSharedSecret:h,utils:p,lengths:y,Point:t,sign:H,verify:$,recoverPublicKey:E,Signature:B,hash:e})}function _weierstrass_legacy_opts_to_new(t){const e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},n=t.Fp;let s=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(a=>Math.ceil(a/2)))):void 0;const r=Field(e.n,{BITS:t.nBitLength,allowedLengths:s,modFromBytes:t.wrapPrivateKey}),o={Fp:n,Fn:r,allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:o}}function _ecdsa_legacy_opts_to_new(t){const{CURVE:e,curveOpts:n}=_weierstrass_legacy_opts_to_new(t),s={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:n,hash:t.hash,ecdsaOpts:s}}function _ecdsa_new_output_to_legacy(t,e){const n=e.Point;return Object.assign({},e,{ProjectivePoint:n,CURVE:Object.assign({},t,nLength(n.Fn.ORDER,n.Fn.BITS))})}function weierstrass(t){const{CURVE:e,curveOpts:n,hash:s,ecdsaOpts:r}=_ecdsa_legacy_opts_to_new(t),o=weierstrassN(e,n),a=ecdsa(o,s,r);return _ecdsa_new_output_to_legacy(t,a)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function createCurve(t,e){const n=s=>weierstrass({...t,hash:s});return{...n(e),create:n}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1_CURVE={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},secp256k1_ENDO={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},_0n=BigInt(0),_1n=BigInt(1),_2n=BigInt(2);function sqrtMod(t){const e=secp256k1_CURVE.p,n=BigInt(3),s=BigInt(6),r=BigInt(11),o=BigInt(22),a=BigInt(23),c=BigInt(44),l=BigInt(88),u=t*t*t%e,f=u*u*t%e,h=pow2(f,n,e)*f%e,p=pow2(h,n,e)*f%e,y=pow2(p,_2n,e)*u%e,b=pow2(y,r,e)*y%e,m=pow2(b,o,e)*b%e,w=pow2(m,c,e)*m%e,k=pow2(w,l,e)*w%e,A=pow2(k,c,e)*m%e,B=pow2(A,n,e)*f%e,P=pow2(B,a,e)*b%e,O=pow2(P,s,e)*u%e,U=pow2(O,_2n,e);if(!Fpk1.eql(Fpk1.sqr(U),t))throw new Error("Cannot find square root");return U}const Fpk1=Field(secp256k1_CURVE.p,{sqrt:sqrtMod}),secp256k1=createCurve({...secp256k1_CURVE,Fp:Fpk1,lowS:!0,endo:secp256k1_ENDO},sha256$1),TAGGED_HASH_PREFIXES={};function taggedHash(t,...e){let n=TAGGED_HASH_PREFIXES[t];if(n===void 0){const s=sha256$1(utf8ToBytes(t));n=concatBytes(s,s),TAGGED_HASH_PREFIXES[t]=n}return sha256$1(concatBytes(n,...e))}const pointToBytes=t=>t.toBytes(!0).slice(1),Pointk1=secp256k1.Point,hasEven=t=>t%_2n===_0n;function schnorrGetExtPubKey(t){const{Fn:e,BASE:n}=Pointk1,s=_normFnElement(e,t),r=n.multiply(s);return{scalar:hasEven(r.y)?s:e.neg(s),bytes:pointToBytes(r)}}function lift_x(t){const e=Fpk1;if(!e.isValidNot0(t))throw new Error("invalid x: Fail if x  p");const n=e.create(t*t),s=e.create(n*t+BigInt(7));let r=e.sqrt(s);hasEven(r)||(r=e.neg(r));const o=Pointk1.fromAffine({x:t,y:r});return o.assertValidity(),o}const num=bytesToNumberBE;function challenge(...t){return Pointk1.Fn.create(num(taggedHash("BIP0340/challenge",...t)))}function schnorrGetPublicKey(t){return schnorrGetExtPubKey(t).bytes}function schnorrSign(t,e,n=randomBytes(32)){const{Fn:s}=Pointk1,r=ensureBytes("message",t),{bytes:o,scalar:a}=schnorrGetExtPubKey(e),c=ensureBytes("auxRand",n,32),l=s.toBytes(a^num(taggedHash("BIP0340/aux",c))),u=taggedHash("BIP0340/nonce",l,o,r),{bytes:f,scalar:h}=schnorrGetExtPubKey(u),p=challenge(f,o,r),y=new Uint8Array(64);if(y.set(f,0),y.set(s.toBytes(s.create(h+p*a)),32),!schnorrVerify(y,r,o))throw new Error("sign: Invalid signature produced");return y}function schnorrVerify(t,e,n){const{Fn:s,BASE:r}=Pointk1,o=ensureBytes("signature",t,64),a=ensureBytes("message",e),c=ensureBytes("publicKey",n,32);try{const l=lift_x(num(c)),u=num(o.subarray(0,32));if(!inRange(u,_1n,secp256k1_CURVE.p))return!1;const f=num(o.subarray(32,64));if(!inRange(f,_1n,secp256k1_CURVE.n))return!1;const h=challenge(s.toBytes(u),pointToBytes(l),a),p=r.multiplyUnsafe(f).add(l.multiplyUnsafe(s.neg(h))),{x:y,y:b}=p.toAffine();return!(p.is0()||!hasEven(b)||y!==u)}catch{return!1}}const schnorr=(()=>{const n=(r=randomBytes(48))=>mapHashToField(r,secp256k1_CURVE.n);secp256k1.utils.randomSecretKey;function s(r){const o=n(r);return{secretKey:o,publicKey:schnorrGetPublicKey(o)}}return{keygen:s,getPublicKey:schnorrGetPublicKey,sign:schnorrSign,verify:schnorrVerify,Point:Pointk1,utils:{randomSecretKey:n,randomPrivateKey:n,taggedHash,lift_x,pointToBytes,numberToBytesBE,bytesToNumberBE,mod},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),sha256=sha256$1;var dist={},LRUCache$1={},LRUCacheNode$1={};Object.defineProperty(LRUCacheNode$1,"__esModule",{value:!0});LRUCacheNode$1.LRUCacheNode=void 0;class LRUCacheNode{constructor(e,n,s){const{entryExpirationTimeInMS:r=null,next:o=null,prev:a=null,onEntryEvicted:c,onEntryMarkedAsMostRecentlyUsed:l,clone:u,cloneFn:f}=s??{};if(typeof r=="number"&&(r<=0||Number.isNaN(r)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.clone=u??!1,this.cloneFn=f??this.defaultClone,this.key=e,this.internalValue=this.clone?this.cloneFn(n):n,this.created=Date.now(),this.entryExpirationTimeInMS=r,this.next=o,this.prev=a,this.onEntryEvicted=c,this.onEntryMarkedAsMostRecentlyUsed=l}get value(){return this.clone?this.cloneFn(this.internalValue):this.internalValue}get isExpired(){return typeof this.entryExpirationTimeInMS=="number"&&Date.now()-this.created>this.entryExpirationTimeInMS}invokeOnEvicted(){if(this.onEntryEvicted){const{key:e,value:n,isExpired:s}=this;this.onEntryEvicted({key:e,value:n,isExpired:s})}}invokeOnEntryMarkedAsMostRecentlyUsed(){if(this.onEntryMarkedAsMostRecentlyUsed){const{key:e,value:n}=this;this.onEntryMarkedAsMostRecentlyUsed({key:e,value:n})}}defaultClone(e){return typeof e=="boolean"||typeof e=="string"||typeof e=="number"?e:JSON.parse(JSON.stringify(e))}}LRUCacheNode$1.LRUCacheNode=LRUCacheNode;Object.defineProperty(LRUCache$1,"__esModule",{value:!0});LRUCache$1.LRUCache=void 0;const LRUCacheNode_1=LRUCacheNode$1;class LRUCache{constructor(e){this.lookupTable=new Map,this.head=null,this.tail=null;const{maxSize:n=25,entryExpirationTimeInMS:s=null,onEntryEvicted:r,onEntryMarkedAsMostRecentlyUsed:o,cloneFn:a,clone:c}=e??{};if(Number.isNaN(n)||n<=0)throw new Error("maxSize must be greater than 0.");if(typeof s=="number"&&(s<=0||Number.isNaN(s)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.maxSizeInternal=n,this.entryExpirationTimeInMS=s,this.onEntryEvicted=r,this.onEntryMarkedAsMostRecentlyUsed=o,this.clone=c,this.cloneFn=a}get size(){return this.cleanCache(),this.lookupTable.size}get remainingSize(){return this.maxSizeInternal-this.size}get newest(){return this.head?this.head.isExpired?(this.removeNodeFromListAndLookupTable(this.head),this.newest):this.mapNodeToEntry(this.head):null}get oldest(){return this.tail?this.tail.isExpired?(this.removeNodeFromListAndLookupTable(this.tail),this.oldest):this.mapNodeToEntry(this.tail):null}get maxSize(){return this.maxSizeInternal}set maxSize(e){if(Number.isNaN(e)||e<=0)throw new Error("maxSize must be greater than 0.");this.maxSizeInternal=e,this.enforceSizeLimit()}set(e,n,s){const r=this.lookupTable.get(e);r&&this.removeNodeFromListAndLookupTable(r);const o=new LRUCacheNode_1.LRUCacheNode(e,n,{entryExpirationTimeInMS:this.entryExpirationTimeInMS,onEntryEvicted:this.onEntryEvicted,onEntryMarkedAsMostRecentlyUsed:this.onEntryMarkedAsMostRecentlyUsed,clone:this.clone,cloneFn:this.cloneFn,...s});return this.setNodeAsHead(o),this.lookupTable.set(e,o),this.enforceSizeLimit(),this}get(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):(this.setNodeAsHead(n),n.value):null}peek(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):n.value:null}delete(e){const n=this.lookupTable.get(e);return n?this.removeNodeFromListAndLookupTable(n):!1}has(e){const n=this.lookupTable.get(e);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),!1):!0:!1}clear(){this.head=null,this.tail=null,this.lookupTable.clear()}find(e){let n=this.head;for(;n;){if(n.isExpired){const r=n.next;this.removeNodeFromListAndLookupTable(n),n=r;continue}const s=this.mapNodeToEntry(n);if(e(s))return this.setNodeAsHead(n),s;n=n.next}return null}forEach(e){let n=this.head,s=0;for(;n;){if(n.isExpired){const r=n.next;this.removeNodeFromListAndLookupTable(n),n=r;continue}e(n.value,n.key,s),n=n.next,s++}}*values(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield e.value,e=e.next}}*keys(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield e.key,e=e.next}}*entries(){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield this.mapNodeToEntry(e),e=e.next}}*[Symbol.iterator](){let e=this.head;for(;e;){if(e.isExpired){const n=e.next;this.removeNodeFromListAndLookupTable(e),e=n;continue}yield this.mapNodeToEntry(e),e=e.next}}enforceSizeLimit(){let e=this.tail;for(;e!==null&&this.size>this.maxSizeInternal;){const n=e.prev;this.removeNodeFromListAndLookupTable(e),e=n}}mapNodeToEntry({key:e,value:n}){return{key:e,value:n}}setNodeAsHead(e){this.removeNodeFromList(e),this.head?(e.next=this.head,this.head.prev=e,this.head=e):(this.head=e,this.tail=e),e.invokeOnEntryMarkedAsMostRecentlyUsed()}removeNodeFromList(e){e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.head===e&&(this.head=e.next),this.tail===e&&(this.tail=e.prev),e.next=null,e.prev=null}removeNodeFromListAndLookupTable(e){return e.invokeOnEvicted(),this.removeNodeFromList(e),this.lookupTable.delete(e.key)}cleanCache(){if(!this.entryExpirationTimeInMS)return;const e=[];for(const n of this.lookupTable.values())n.isExpired&&e.push(n);e.forEach(n=>this.removeNodeFromListAndLookupTable(n))}}LRUCache$1.LRUCache=LRUCache;(function(t){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(s,r,o,a){a===void 0&&(a=o);var c=Object.getOwnPropertyDescriptor(r,o);(!c||("get"in c?!r.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return r[o]}}),Object.defineProperty(s,a,c)}:function(s,r,o,a){a===void 0&&(a=o),s[a]=r[o]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(s,r){for(var o in s)o!=="default"&&!Object.prototype.hasOwnProperty.call(r,o)&&e(r,s,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(LRUCache$1,t)})(dist);function pbkdf2Init(t,e,n,s){assert.hash(t);const r=checkOpts$1({dkLen:32,asyncTick:10},s),{c:o,dkLen:a,asyncTick:c}=r;if(assert.number(o),assert.number(a),assert.number(c),o<1)throw new Error("PBKDF2: iterations (c) should be >= 1");const l=toBytes$2(e),u=toBytes$2(n),f=new Uint8Array(a),h=hmac$1.create(t,l),p=h._cloneInto().update(u);return{c:o,dkLen:a,asyncTick:c,DK:f,PRF:h,PRFSalt:p}}function pbkdf2Output(t,e,n,s,r){return t.destroy(),e.destroy(),s&&s.destroy(),r.fill(0),n}function pbkdf2(t,e,n,s){const{c:r,dkLen:o,DK:a,PRF:c,PRFSalt:l}=pbkdf2Init(t,e,n,s);let u;const f=new Uint8Array(4),h=createView$2(f),p=new Uint8Array(c.outputLen);for(let y=1,b=0;b<o;y++,b+=c.outputLen){const m=a.subarray(b,b+c.outputLen);h.setInt32(0,y,!1),(u=l._cloneInto(u)).update(f).digestInto(p),m.set(p.subarray(0,m.length));for(let w=1;w<r;w++){c._cloneInto(u).update(p).digestInto(p);for(let k=0;k<m.length;k++)m[k]^=p[k]}}return pbkdf2Output(c,l,a,u,p)}const rotl=(t,e)=>t<<e|t>>>32-e;function XorAndSalsa(t,e,n,s,r,o){let a=t[e++]^n[s++],c=t[e++]^n[s++],l=t[e++]^n[s++],u=t[e++]^n[s++],f=t[e++]^n[s++],h=t[e++]^n[s++],p=t[e++]^n[s++],y=t[e++]^n[s++],b=t[e++]^n[s++],m=t[e++]^n[s++],w=t[e++]^n[s++],k=t[e++]^n[s++],A=t[e++]^n[s++],B=t[e++]^n[s++],P=t[e++]^n[s++],O=t[e++]^n[s++],U=a,M=c,D=l,F=u,H=f,T=h,$=p,E=y,x=b,v=m,_=w,S=k,I=A,R=B,N=P,C=O;for(let L=0;L<8;L+=2)H^=rotl(U+I|0,7),x^=rotl(H+U|0,9),I^=rotl(x+H|0,13),U^=rotl(I+x|0,18),v^=rotl(T+M|0,7),R^=rotl(v+T|0,9),M^=rotl(R+v|0,13),T^=rotl(M+R|0,18),N^=rotl(_+$|0,7),D^=rotl(N+_|0,9),$^=rotl(D+N|0,13),_^=rotl($+D|0,18),F^=rotl(C+S|0,7),E^=rotl(F+C|0,9),S^=rotl(E+F|0,13),C^=rotl(S+E|0,18),M^=rotl(U+F|0,7),D^=rotl(M+U|0,9),F^=rotl(D+M|0,13),U^=rotl(F+D|0,18),$^=rotl(T+H|0,7),E^=rotl($+T|0,9),H^=rotl(E+$|0,13),T^=rotl(H+E|0,18),S^=rotl(_+v|0,7),x^=rotl(S+_|0,9),v^=rotl(x+S|0,13),_^=rotl(v+x|0,18),I^=rotl(C+N|0,7),R^=rotl(I+C|0,9),N^=rotl(R+I|0,13),C^=rotl(N+R|0,18);r[o++]=a+U|0,r[o++]=c+M|0,r[o++]=l+D|0,r[o++]=u+F|0,r[o++]=f+H|0,r[o++]=h+T|0,r[o++]=p+$|0,r[o++]=y+E|0,r[o++]=b+x|0,r[o++]=m+v|0,r[o++]=w+_|0,r[o++]=k+S|0,r[o++]=A+I|0,r[o++]=B+R|0,r[o++]=P+N|0,r[o++]=O+C|0}function BlockMix(t,e,n,s,r){let o=s+0,a=s+16*r;for(let c=0;c<16;c++)n[a+c]=t[e+(2*r-1)*16+c];for(let c=0;c<r;c++,o+=16,e+=16)XorAndSalsa(n,a,t,e,n,o),c>0&&(a+=16),XorAndSalsa(n,o,t,e+=16,n,a)}function scryptInit(t,e,n){const s=checkOpts$1({dkLen:32,asyncTick:10,maxmem:1073742848},n),{N:r,r:o,p:a,dkLen:c,asyncTick:l,maxmem:u,onProgress:f}=s;if(assert.number(r),assert.number(o),assert.number(a),assert.number(c),assert.number(l),assert.number(u),f!==void 0&&typeof f!="function")throw new Error("progressCb should be function");const h=128*o,p=h/4;if(r<=1||r&r-1||r>=2**(h/8)||r>2**32)throw new Error("Scrypt: N must be larger than 1, a power of 2, less than 2^(128 * r / 8) and less than 2^32");if(a<0||a>(2**32-1)*32/h)throw new Error("Scrypt: p must be a positive integer less than or equal to ((2^32 - 1) * 32) / (128 * r)");if(c<0||c>(2**32-1)*32)throw new Error("Scrypt: dkLen should be positive integer less than or equal to (2^32 - 1) * 32");const y=h*(r+a);if(y>u)throw new Error(`Scrypt: parameters too large, ${y} (128 * r * (N + p)) > ${u} (maxmem)`);const b=pbkdf2(sha256$2,t,e,{c:1,dkLen:h*a}),m=u32$1(b),w=u32$1(new Uint8Array(h*r)),k=u32$1(new Uint8Array(h));let A=()=>{};if(f){const B=2*r*a,P=Math.max(Math.floor(B/1e4),1);let O=0;A=()=>{O++,f&&(!(O%P)||O===B)&&f(O/B)}}return{N:r,r:o,p:a,dkLen:c,blockSize32:p,V:w,B32:m,B:b,tmp:k,blockMixCb:A,asyncTick:l}}function scryptOutput(t,e,n,s,r){const o=pbkdf2(sha256$2,t,n,{c:1,dkLen:e});return n.fill(0),s.fill(0),r.fill(0),o}function scrypt(t,e,n){const{N:s,r,p:o,dkLen:a,blockSize32:c,V:l,B32:u,B:f,tmp:h,blockMixCb:p}=scryptInit(t,e,n);for(let y=0;y<o;y++){const b=c*y;for(let m=0;m<c;m++)l[m]=u[b+m];for(let m=0,w=0;m<s-1;m++)BlockMix(l,w,l,w+=c,r),p();BlockMix(l,(s-1)*c,u,b,r),p();for(let m=0;m<s;m++){const w=u[b+c-16]%s;for(let k=0;k<c;k++)h[k]=u[b+k]^l[w*c+k];BlockMix(h,0,u,b,r),p()}}return scryptOutput(t,a,f,l,h)}var Bech32MaxSize$1=5e3;function encodeBech32$1(t,e){let n=bech32$1.toWords(e);return bech32$1.encode(t,n,Bech32MaxSize$1)}function encodeBytes$1(t,e){return encodeBech32$1(t,e)}function encrypt$1(t,e,n=16,s=2){let r=randomBytes$1(16),o=2**n,a=scrypt(e.normalize("NFKC"),r,{N:o,r:8,p:1,dkLen:32}),c=randomBytes$1(24),l=Uint8Array.from([s]),f=xchacha20poly1305(a,c,l).encrypt(t),h=concatBytes$1(Uint8Array.from([2]),Uint8Array.from([n]),r,c,l,f);return encodeBytes$1("ncryptsec",h)}function decrypt$1(t,e){let{prefix:n,words:s}=bech32$1.decode(t,Bech32MaxSize$1);if(n!=="ncryptsec")throw new Error(`invalid prefix ${n}, expected 'ncryptsec'`);let r=new Uint8Array(bech32$1.fromWords(s)),o=r[0];if(o!==2)throw new Error(`invalid version ${o}, expected 0x02`);let c=2**r[1],l=r.slice(2,18),u=r.slice(18,42),f=r[42],h=Uint8Array.from([f]),p=r.slice(43),y=scrypt(e.normalize("NFKC"),l,{N:c,r:8,p:1,dkLen:32});return xchacha20poly1305(y,u,h).decrypt(p)}const nip49_star=Object.freeze(Object.defineProperty({__proto__:null,decrypt:decrypt$1,encrypt:encrypt$1},Symbol.toStringTag,{value:"Module"}));var utf8Decoder=new TextDecoder("utf-8"),utf8Encoder=new TextEncoder,NostrTypeGuard={isNProfile:t=>/^nprofile1[a-z\d]+$/.test(t||""),isNEvent:t=>/^nevent1[a-z\d]+$/.test(t||""),isNAddr:t=>/^naddr1[a-z\d]+$/.test(t||""),isNSec:t=>/^nsec1[a-z\d]{58}$/.test(t||""),isNPub:t=>/^npub1[a-z\d]{58}$/.test(t||""),isNote:t=>/^note1[a-z\d]+$/.test(t||""),isNcryptsec:t=>/^ncryptsec1[a-z\d]+$/.test(t||"")},Bech32MaxSize=5e3,BECH32_REGEX$1=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=t&255,e}function decodeNostrURI(t){try{return t.startsWith("nostr:")&&(t=t.substring(6)),decode(t)}catch{return{type:"invalid",data:null}}}function decode(t){var r,o,a,c,l,u,f;let{prefix:e,words:n}=bech32$1.decode(t,Bech32MaxSize),s=new Uint8Array(bech32$1.fromWords(n));switch(e){case"nprofile":{let h=parseTLV(s);if(!((r=h[0])!=null&&r[0]))throw new Error("missing TLV 0 for nprofile");if(h[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:bytesToHex$2(h[0][0]),relays:h[1]?h[1].map(p=>utf8Decoder.decode(p)):[]}}}case"nevent":{let h=parseTLV(s);if(!((o=h[0])!=null&&o[0]))throw new Error("missing TLV 0 for nevent");if(h[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(h[2]&&h[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(h[3]&&h[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:bytesToHex$2(h[0][0]),relays:h[1]?h[1].map(p=>utf8Decoder.decode(p)):[],author:(a=h[2])!=null&&a[0]?bytesToHex$2(h[2][0]):void 0,kind:(c=h[3])!=null&&c[0]?parseInt(bytesToHex$2(h[3][0]),16):void 0}}}case"naddr":{let h=parseTLV(s);if(!((l=h[0])!=null&&l[0]))throw new Error("missing TLV 0 for naddr");if(!((u=h[2])!=null&&u[0]))throw new Error("missing TLV 2 for naddr");if(h[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!((f=h[3])!=null&&f[0]))throw new Error("missing TLV 3 for naddr");if(h[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder.decode(h[0][0]),pubkey:bytesToHex$2(h[2][0]),kind:parseInt(bytesToHex$2(h[3][0]),16),relays:h[1]?h[1].map(p=>utf8Decoder.decode(p)):[]}}}case"nsec":return{type:e,data:s};case"npub":case"note":return{type:e,data:bytesToHex$2(s)};default:throw new Error(`unknown prefix ${e}`)}}function parseTLV(t){let e={},n=t;for(;n.length>0;){let s=n[0],r=n[1],o=n.slice(2,2+r);if(n=n.slice(2+r),o.length<r)throw new Error(`not enough data to read on TLV ${s}`);e[s]=e[s]||[],e[s].push(o)}return e}function nsecEncode(t){return encodeBytes("nsec",t)}function npubEncode(t){return encodeBytes("npub",hexToBytes$2(t))}function noteEncode(t){return encodeBytes("note",hexToBytes$2(t))}function encodeBech32(t,e){let n=bech32$1.toWords(e);return bech32$1.encode(t,n,Bech32MaxSize)}function encodeBytes(t,e){return encodeBech32(t,e)}function nprofileEncode(t){let e=encodeTLV({0:[hexToBytes$2(t.pubkey)],1:(t.relays||[]).map(n=>utf8Encoder.encode(n))});return encodeBech32("nprofile",e)}function neventEncode(t){let e;t.kind!==void 0&&(e=integerToUint8Array(t.kind));let n=encodeTLV({0:[hexToBytes$2(t.id)],1:(t.relays||[]).map(s=>utf8Encoder.encode(s)),2:t.author?[hexToBytes$2(t.author)]:[],3:e?[new Uint8Array(e)]:[]});return encodeBech32("nevent",n)}function naddrEncode(t){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,t.kind,!1);let n=encodeTLV({0:[utf8Encoder.encode(t.identifier)],1:(t.relays||[]).map(s=>utf8Encoder.encode(s)),2:[hexToBytes$2(t.pubkey)],3:[new Uint8Array(e)]});return encodeBech32("naddr",n)}function encodeTLV(t){let e=[];return Object.entries(t).reverse().forEach(([n,s])=>{s.forEach(r=>{let o=new Uint8Array(r.length+2);o.set([parseInt(n)],0),o.set([r.length],1),o.set(r,2),e.push(o)})}),concatBytes$1(...e)}const nip19_star=Object.freeze(Object.defineProperty({__proto__:null,BECH32_REGEX:BECH32_REGEX$1,Bech32MaxSize,NostrTypeGuard,decode,decodeNostrURI,encodeBytes,naddrEncode,neventEncode,noteEncode,nprofileEncode,npubEncode,nsecEncode},Symbol.toStringTag,{value:"Module"}));var lib={};(function(t){/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(t,"__esModule",{value:!0}),t.bytes=t.stringToBytes=t.str=t.bytesToString=t.hex=t.utf8=t.bech32m=t.bech32=t.base58check=t.base58xmr=t.base58xrp=t.base58flickr=t.base58=t.base64url=t.base64=t.base32crockford=t.base32hex=t.base32=t.base16=t.utils=t.assertNumber=void 0;function e(T){if(!Number.isSafeInteger(T))throw new Error(`Wrong integer: ${T}`)}t.assertNumber=e;function n(...T){const $=(v,_)=>S=>v(_(S)),E=Array.from(T).reverse().reduce((v,_)=>v?$(v,_.encode):_.encode,void 0),x=T.reduce((v,_)=>v?$(v,_.decode):_.decode,void 0);return{encode:E,decode:x}}function s(T){return{encode:$=>{if(!Array.isArray($)||$.length&&typeof $[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return $.map(E=>{if(e(E),E<0||E>=T.length)throw new Error(`Digit index outside alphabet: ${E} (alphabet: ${T.length})`);return T[E]})},decode:$=>{if(!Array.isArray($)||$.length&&typeof $[0]!="string")throw new Error("alphabet.decode input should be array of strings");return $.map(E=>{if(typeof E!="string")throw new Error(`alphabet.decode: not string element=${E}`);const x=T.indexOf(E);if(x===-1)throw new Error(`Unknown letter: "${E}". Allowed: ${T}`);return x})}}}function r(T=""){if(typeof T!="string")throw new Error("join separator should be string");return{encode:$=>{if(!Array.isArray($)||$.length&&typeof $[0]!="string")throw new Error("join.encode input should be array of strings");for(let E of $)if(typeof E!="string")throw new Error(`join.encode: non-string input=${E}`);return $.join(T)},decode:$=>{if(typeof $!="string")throw new Error("join.decode input should be string");return $.split(T)}}}function o(T,$="="){if(e(T),typeof $!="string")throw new Error("padding chr should be string");return{encode(E){if(!Array.isArray(E)||E.length&&typeof E[0]!="string")throw new Error("padding.encode input should be array of strings");for(let x of E)if(typeof x!="string")throw new Error(`padding.encode: non-string input=${x}`);for(;E.length*T%8;)E.push($);return E},decode(E){if(!Array.isArray(E)||E.length&&typeof E[0]!="string")throw new Error("padding.encode input should be array of strings");for(let v of E)if(typeof v!="string")throw new Error(`padding.decode: non-string input=${v}`);let x=E.length;if(x*T%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;x>0&&E[x-1]===$;x--)if(!((x-1)*T%8))throw new Error("Invalid padding: string has too much padding");return E.slice(0,x)}}}function a(T){if(typeof T!="function")throw new Error("normalize fn should be function");return{encode:$=>$,decode:$=>T($)}}function c(T,$,E){if($<2)throw new Error(`convertRadix: wrong from=${$}, base cannot be less than 2`);if(E<2)throw new Error(`convertRadix: wrong to=${E}, base cannot be less than 2`);if(!Array.isArray(T))throw new Error("convertRadix: data should be array");if(!T.length)return[];let x=0;const v=[],_=Array.from(T);for(_.forEach(S=>{if(e(S),S<0||S>=$)throw new Error(`Wrong integer: ${S}`)});;){let S=0,I=!0;for(let R=x;R<_.length;R++){const N=_[R],C=$*S+N;if(!Number.isSafeInteger(C)||$*S/$!==S||C-N!==$*S)throw new Error("convertRadix: carry overflow");if(S=C%E,_[R]=Math.floor(C/E),!Number.isSafeInteger(_[R])||_[R]*E+S!==C)throw new Error("convertRadix: carry overflow");if(I)_[R]?I=!1:x=R;else continue}if(v.push(S),I)break}for(let S=0;S<T.length-1&&T[S]===0;S++)v.push(0);return v.reverse()}const l=(T,$)=>$?l($,T%$):T,u=(T,$)=>T+($-l(T,$));function f(T,$,E,x){if(!Array.isArray(T))throw new Error("convertRadix2: data should be array");if($<=0||$>32)throw new Error(`convertRadix2: wrong from=${$}`);if(E<=0||E>32)throw new Error(`convertRadix2: wrong to=${E}`);if(u($,E)>32)throw new Error(`convertRadix2: carry overflow from=${$} to=${E} carryBits=${u($,E)}`);let v=0,_=0;const S=2**E-1,I=[];for(const R of T){if(e(R),R>=2**$)throw new Error(`convertRadix2: invalid data word=${R} from=${$}`);if(v=v<<$|R,_+$>32)throw new Error(`convertRadix2: carry overflow pos=${_} from=${$}`);for(_+=$;_>=E;_-=E)I.push((v>>_-E&S)>>>0);v&=2**_-1}if(v=v<<E-_&S,!x&&_>=$)throw new Error("Excess padding");if(!x&&v)throw new Error(`Non-zero padding: ${v}`);return x&&_>0&&I.push(v>>>0),I}function h(T){return e(T),{encode:$=>{if(!($ instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return c(Array.from($),2**8,T)},decode:$=>{if(!Array.isArray($)||$.length&&typeof $[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(c($,T,2**8))}}}function p(T,$=!1){if(e(T),T<=0||T>32)throw new Error("radix2: bits should be in (0..32]");if(u(8,T)>32||u(T,8)>32)throw new Error("radix2: carry overflow");return{encode:E=>{if(!(E instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return f(Array.from(E),8,T,!$)},decode:E=>{if(!Array.isArray(E)||E.length&&typeof E[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(f(E,T,8,$))}}}function y(T){if(typeof T!="function")throw new Error("unsafeWrapper fn should be function");return function(...$){try{return T.apply(null,$)}catch{}}}function b(T,$){if(e(T),typeof $!="function")throw new Error("checksum fn should be function");return{encode(E){if(!(E instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const x=$(E).slice(0,T),v=new Uint8Array(E.length+T);return v.set(E),v.set(x,E.length),v},decode(E){if(!(E instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const x=E.slice(0,-T),v=$(x).slice(0,T),_=E.slice(-T);for(let S=0;S<T;S++)if(v[S]!==_[S])throw new Error("Invalid checksum");return x}}}t.utils={alphabet:s,chain:n,checksum:b,radix:h,radix2:p,join:r,padding:o},t.base16=n(p(4),s("0123456789ABCDEF"),r("")),t.base32=n(p(5),s("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),o(5),r("")),t.base32hex=n(p(5),s("0123456789ABCDEFGHIJKLMNOPQRSTUV"),o(5),r("")),t.base32crockford=n(p(5),s("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),r(""),a(T=>T.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),t.base64=n(p(6),s("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),o(6),r("")),t.base64url=n(p(6),s("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),o(6),r(""));const m=T=>n(h(58),s(T),r(""));t.base58=m("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),t.base58flickr=m("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),t.base58xrp=m("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const w=[0,2,3,5,6,7,9,10,11];t.base58xmr={encode(T){let $="";for(let E=0;E<T.length;E+=8){const x=T.subarray(E,E+8);$+=t.base58.encode(x).padStart(w[x.length],"1")}return $},decode(T){let $=[];for(let E=0;E<T.length;E+=11){const x=T.slice(E,E+11),v=w.indexOf(x.length),_=t.base58.decode(x);for(let S=0;S<_.length-v;S++)if(_[S]!==0)throw new Error("base58xmr: wrong padding");$=$.concat(Array.from(_.slice(_.length-v)))}return Uint8Array.from($)}};const k=T=>n(b(4,$=>T(T($))),t.base58);t.base58check=k;const A=n(s("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),r("")),B=[996825010,642813549,513874426,1027748829,705979059];function P(T){const $=T>>25;let E=(T&33554431)<<5;for(let x=0;x<B.length;x++)($>>x&1)===1&&(E^=B[x]);return E}function O(T,$,E=1){const x=T.length;let v=1;for(let _=0;_<x;_++){const S=T.charCodeAt(_);if(S<33||S>126)throw new Error(`Invalid prefix (${T})`);v=P(v)^S>>5}v=P(v);for(let _=0;_<x;_++)v=P(v)^T.charCodeAt(_)&31;for(let _ of $)v=P(v)^_;for(let _=0;_<6;_++)v=P(v);return v^=E,A.encode(f([v%2**30],30,5,!1))}function U(T){const $=T==="bech32"?1:734539939,E=p(5),x=E.decode,v=E.encode,_=y(x);function S(C,L,j=90){if(typeof C!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof C}`);if(!Array.isArray(L)||L.length&&typeof L[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof L}`);const V=C.length+7+L.length;if(j!==!1&&V>j)throw new TypeError(`Length ${V} exceeds limit ${j}`);return C=C.toLowerCase(),`${C}1${A.encode(L)}${O(C,L,$)}`}function I(C,L=90){if(typeof C!="string")throw new Error(`bech32.decode input should be string, not ${typeof C}`);if(C.length<8||L!==!1&&C.length>L)throw new TypeError(`Wrong string length: ${C.length} (${C}). Expected (8..${L})`);const j=C.toLowerCase();if(C!==j&&C!==C.toUpperCase())throw new Error("String must be lowercase or uppercase");C=j;const V=C.lastIndexOf("1");if(V===0||V===-1)throw new Error('Letter "1" must be present between prefix and data only');const z=C.slice(0,V),q=C.slice(V+1);if(q.length<6)throw new Error("Data must be at least 6 characters long");const G=A.decode(q).slice(0,-6),K=O(z,G,$);if(!q.endsWith(K))throw new Error(`Invalid checksum in ${C}: expected "${K}"`);return{prefix:z,words:G}}const R=y(I);function N(C){const{prefix:L,words:j}=I(C,!1);return{prefix:L,words:j,bytes:x(j)}}return{encode:S,decode:I,decodeToBytes:N,decodeUnsafe:R,fromWords:x,fromWordsUnsafe:_,toWords:v}}t.bech32=U("bech32"),t.bech32m=U("bech32m"),t.utf8={encode:T=>new TextDecoder().decode(T),decode:T=>new TextEncoder().encode(T)},t.hex=n(p(4),s("0123456789abcdef"),r(""),a(T=>{if(typeof T!="string"||T.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof T} with length ${T.length}`);return T.toLowerCase()}));const M={utf8:t.utf8,hex:t.hex,base16:t.base16,base32:t.base32,base64:t.base64,base64url:t.base64url,base58:t.base58,base58xmr:t.base58xmr},D=`Invalid encoding type. Available types: ${Object.keys(M).join(", ")}`,F=(T,$)=>{if(typeof T!="string"||!M.hasOwnProperty(T))throw new TypeError(D);if(!($ instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return M[T].encode($)};t.bytesToString=F,t.str=t.bytesToString;const H=(T,$)=>{if(!M.hasOwnProperty(T))throw new TypeError(D);if(typeof $!="string")throw new TypeError("stringToBytes() expects string");return M[T].decode($)};t.stringToBytes=H,t.bytes=t.stringToBytes})(lib);const{bech32,hex,utf8}=lib;BigInt(1e3),BigInt(1e6),BigInt(1e9),BigInt(1e12);BigInt("2100000000000000000");BigInt(1e11);const TAGCODES={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27};for(let t=0,e=Object.keys(TAGCODES);t<e.length;t++)e[t],TAGCODES[e[t]].toString();var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__copyProps=(t,e,n,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of __getOwnPropNames(e))!__hasOwnProp.call(t,r)&&r!==n&&__defProp(t,r,{get:()=>e[r],enumerable:!(s=__getOwnPropDesc(e,r))||s.enumerable});return t},__reExport=(t,e,n)=>(__copyProps(t,e,"default"),n),NDKKind=(t=>(t[t.Metadata=0]="Metadata",t[t.Text=1]="Text",t[t.RecommendRelay=2]="RecommendRelay",t[t.Contacts=3]="Contacts",t[t.EncryptedDirectMessage=4]="EncryptedDirectMessage",t[t.EventDeletion=5]="EventDeletion",t[t.Repost=6]="Repost",t[t.Reaction=7]="Reaction",t[t.BadgeAward=8]="BadgeAward",t[t.GroupChat=9]="GroupChat",t[t.Thread=11]="Thread",t[t.GroupReply=12]="GroupReply",t[t.GiftWrapSeal=13]="GiftWrapSeal",t[t.PrivateDirectMessage=14]="PrivateDirectMessage",t[t.Image=20]="Image",t[t.Video=21]="Video",t[t.ShortVideo=22]="ShortVideo",t[t.Story=23]="Story",t[t.Vanish=62]="Vanish",t[t.CashuWalletBackup=375]="CashuWalletBackup",t[t.GiftWrap=1059]="GiftWrap",t[t.GenericRepost=16]="GenericRepost",t[t.ChannelCreation=40]="ChannelCreation",t[t.ChannelMetadata=41]="ChannelMetadata",t[t.ChannelMessage=42]="ChannelMessage",t[t.ChannelHideMessage=43]="ChannelHideMessage",t[t.ChannelMuteUser=44]="ChannelMuteUser",t[t.WikiMergeRequest=818]="WikiMergeRequest",t[t.GenericReply=1111]="GenericReply",t[t.Media=1063]="Media",t[t.DraftCheckpoint=1234]="DraftCheckpoint",t[t.Task=1934]="Task",t[t.Report=1984]="Report",t[t.Label=1985]="Label",t[t.DVMReqTextExtraction=5e3]="DVMReqTextExtraction",t[t.DVMReqTextSummarization=5001]="DVMReqTextSummarization",t[t.DVMReqTextTranslation=5002]="DVMReqTextTranslation",t[t.DVMReqTextGeneration=5050]="DVMReqTextGeneration",t[t.DVMReqImageGeneration=5100]="DVMReqImageGeneration",t[t.DVMReqTextToSpeech=5250]="DVMReqTextToSpeech",t[t.DVMReqDiscoveryNostrContent=5300]="DVMReqDiscoveryNostrContent",t[t.DVMReqDiscoveryNostrPeople=5301]="DVMReqDiscoveryNostrPeople",t[t.DVMReqTimestamping=5900]="DVMReqTimestamping",t[t.DVMEventSchedule=5905]="DVMEventSchedule",t[t.DVMJobFeedback=7e3]="DVMJobFeedback",t[t.Subscribe=7001]="Subscribe",t[t.Unsubscribe=7002]="Unsubscribe",t[t.SubscriptionReceipt=7003]="SubscriptionReceipt",t[t.CashuReserve=7373]="CashuReserve",t[t.CashuQuote=7374]="CashuQuote",t[t.CashuToken=7375]="CashuToken",t[t.CashuWalletTx=7376]="CashuWalletTx",t[t.GroupAdminAddUser=9e3]="GroupAdminAddUser",t[t.GroupAdminRemoveUser=9001]="GroupAdminRemoveUser",t[t.GroupAdminEditMetadata=9002]="GroupAdminEditMetadata",t[t.GroupAdminEditStatus=9006]="GroupAdminEditStatus",t[t.GroupAdminCreateGroup=9007]="GroupAdminCreateGroup",t[t.GroupAdminRequestJoin=9021]="GroupAdminRequestJoin",t[t.MuteList=1e4]="MuteList",t[t.PinList=10001]="PinList",t[t.RelayList=10002]="RelayList",t[t.BookmarkList=10003]="BookmarkList",t[t.CommunityList=10004]="CommunityList",t[t.PublicChatList=10005]="PublicChatList",t[t.BlockRelayList=10006]="BlockRelayList",t[t.SearchRelayList=10007]="SearchRelayList",t[t.SimpleGroupList=10009]="SimpleGroupList",t[t.InterestList=10015]="InterestList",t[t.CashuMintList=10019]="CashuMintList",t[t.EmojiList=10030]="EmojiList",t[t.DirectMessageReceiveRelayList=10050]="DirectMessageReceiveRelayList",t[t.BlossomList=10063]="BlossomList",t[t.NostrWaletConnectInfo=13194]="NostrWaletConnectInfo",t[t.TierList=17e3]="TierList",t[t.CashuWallet=17375]="CashuWallet",t[t.FollowSet=3e4]="FollowSet",t[t.CategorizedPeopleList=3e4]="CategorizedPeopleList",t[t.CategorizedBookmarkList=30001]="CategorizedBookmarkList",t[t.RelaySet=30002]="RelaySet",t[t.CategorizedRelayList=30002]="CategorizedRelayList",t[t.BookmarkSet=30003]="BookmarkSet",t[t.CurationSet=30004]="CurationSet",t[t.ArticleCurationSet=30004]="ArticleCurationSet",t[t.VideoCurationSet=30005]="VideoCurationSet",t[t.ImageCurationSet=30006]="ImageCurationSet",t[t.InterestSet=30015]="InterestSet",t[t.InterestsList=30015]="InterestsList",t[t.ProjectTemplate=30717]="ProjectTemplate",t[t.EmojiSet=30030]="EmojiSet",t[t.ModularArticle=30040]="ModularArticle",t[t.ModularArticleItem=30041]="ModularArticleItem",t[t.Wiki=30818]="Wiki",t[t.Draft=31234]="Draft",t[t.Project=31933]="Project",t[t.SubscriptionTier=37001]="SubscriptionTier",t[t.EcashMintRecommendation=38e3]="EcashMintRecommendation",t[t.CashuMintAnnouncement=38172]="CashuMintAnnouncement",t[t.FedimintMintAnnouncement=38173]="FedimintMintAnnouncement",t[t.HighlightSet=39802]="HighlightSet",t[t.CategorizedHighlightList=39802]="CategorizedHighlightList",t[t.Nutzap=9321]="Nutzap",t[t.ZapRequest=9734]="ZapRequest",t[t.Zap=9735]="Zap",t[t.Highlight=9802]="Highlight",t[t.ClientAuth=22242]="ClientAuth",t[t.NostrWalletConnectReq=23194]="NostrWalletConnectReq",t[t.NostrWalletConnectRes=23195]="NostrWalletConnectRes",t[t.NostrConnect=24133]="NostrConnect",t[t.BlossomUpload=24242]="BlossomUpload",t[t.HttpAuth=27235]="HttpAuth",t[t.ProfileBadge=30008]="ProfileBadge",t[t.BadgeDefinition=30009]="BadgeDefinition",t[t.MarketStall=30017]="MarketStall",t[t.MarketProduct=30018]="MarketProduct",t[t.Article=30023]="Article",t[t.AppSpecificData=30078]="AppSpecificData",t[t.Classified=30402]="Classified",t[t.HorizontalVideo=34235]="HorizontalVideo",t[t.VerticalVideo=34236]="VerticalVideo",t[t.GroupMetadata=39e3]="GroupMetadata",t[t.GroupAdmins=39001]="GroupAdmins",t[t.GroupMembers=39002]="GroupMembers",t[t.FollowPack=39089]="FollowPack",t[t.MediaFollowPack=39092]="MediaFollowPack",t[t.AppRecommendation=31989]="AppRecommendation",t[t.AppHandler=31990]="AppHandler",t))(NDKKind||{});function getRelaysForSync(t,e,n="write"){if(!t.outboxTracker)return;const s=t.outboxTracker.data.get(e);if(s)return n==="write"?s.writeRelays:s.readRelays}async function getWriteRelaysFor(t,e,n="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),getRelaysForSync(t,e,n)}function getTopRelaysForAuthors(t,e){const n=new Map;return e.forEach(r=>{const o=getRelaysForSync(t,r);o&&o.forEach(a=>{const c=n.get(a)||0;n.set(a,c+1)})}),Array.from(n.entries()).sort((r,o)=>o[1]-r[1]).map(r=>r[0])}function getAllRelaysForAllPubkeys(t,e,n="read"){const s=new Map,r=new Set;return e.forEach(o=>{const a=getRelaysForSync(t,o,n);a&&a.size>0?(a.forEach(c=>{(s.get(c)||new Set).add(o)}),s.set(o,a)):r.add(o)}),{pubkeysToRelays:s,authorsMissingRelays:r}}function chooseRelayCombinationForPubkeys(t,e,n,{count:s,preferredRelays:r}={}){s??(s=2),r??(r=new Set);const o=t.pool,a=o.connectedRelays();a.forEach(p=>{r==null||r.add(p.url)});const c=new Map,{pubkeysToRelays:l,authorsMissingRelays:u}=getAllRelaysForAllPubkeys(t,e,n),f=getTopRelaysForAuthors(t,e),h=(p,y)=>{const b=c.get(y)||[];b.push(p),c.set(y,b)};for(const[p,y]of l.entries()){let b=s;const m=new Set;for(const w of a)y.has(w.url)&&(h(p,w.url),m.add(w.url),b--);for(const w of y)m.has(w)||c.has(w)&&(h(p,w),m.add(w),b--);if(!(b<=0))for(const w of f){if(b<=0)break;m.has(w)||y.has(w)&&(h(p,w),m.add(w),b--)}}for(const p of u)o.permanentAndConnectedRelays().forEach(y=>{const b=c.get(y.url)||[];b.push(p),c.set(y.url,b)});return c}function getRelaysForFilterWithAuthors(t,e,n=2){return chooseRelayCombinationForPubkeys(t,e,"write",{count:n})}function tryNormalizeRelayUrl(t){try{return normalizeRelayUrl(t)}catch{return}}function normalizeRelayUrl(t){let e=normalizeUrl(t,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}function normalize(t){const e=new Set;for(const n of t)try{e.add(normalizeRelayUrl(n))}catch{}return Array.from(e)}var DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(t,e)=>e.some(n=>n instanceof RegExp?n.test(t):n===t),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=t=>{try{const{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!supportedProtocols.has(e)}catch{return!1}},normalizeDataURL=(t,{stripHash:e})=>{var h,p,y,b;const n=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!n)throw new Error(`Invalid URL: ${t}`);const s=((h=n.groups)==null?void 0:h.type)??"",r=((p=n.groups)==null?void 0:p.data)??"";let o=((y=n.groups)==null?void 0:y.hash)??"";const a=s.split(";");o=e?"":o;let c=!1;a[a.length-1]==="base64"&&(a.pop(),c=!0);const l=((b=a.shift())==null?void 0:b.toLowerCase())??"",f=[...a.map(m=>{let[w,k=""]=m.split("=").map(A=>A.trim());return w==="charset"&&(k=k.toLowerCase(),k===DATA_URL_DEFAULT_CHARSET)?"":`${w}${k?`=${k}`:""}`}).filter(Boolean)];return c&&f.push("base64"),(f.length>0||l&&l!==DATA_URL_DEFAULT_MIME_TYPE)&&f.unshift(l),`data:${f.join(";")},${c?r.trim():r}${o?`#${o}`:""}`};function normalizeUrl(t,e={}){if(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e},typeof e.defaultProtocol=="string"&&!e.defaultProtocol.endsWith(":")&&(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return normalizeDataURL(t,e);if(hasCustomProtocol(t))return t;const n=t.startsWith("//");!n&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));const r=new URL(t);if(r.hostname=r.hostname.toLowerCase(),e.forceHttp&&e.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&r.protocol==="https:"&&(r.protocol="http:"),e.forceHttps&&r.protocol==="http:"&&(r.protocol="https:"),e.stripAuthentication&&(r.username="",r.password=""),e.stripHash?r.hash="":e.stripTextFragment&&(r.hash=r.hash.replace(/#?:~:text.*?$/i,"")),r.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let c=0,l="";for(;;){const f=a.exec(r.pathname);if(!f)break;const h=f[0],p=f.index,y=r.pathname.slice(c,p);l+=y.replace(/\/{2,}/g,"/"),l+=h,c=p+h.length}const u=r.pathname.slice(c,r.pathname.length);l+=u.replace(/\/{2,}/g,"/"),r.pathname=l}if(r.pathname)try{r.pathname=decodeURI(r.pathname)}catch{}if(e.removeDirectoryIndex===!0&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let a=r.pathname.split("/");const c=a[a.length-1];testParameter(c,e.removeDirectoryIndex)&&(a=a.slice(0,-1),r.pathname=`${a.slice(1).join("/")}/`)}if(r.hostname&&(r.hostname=r.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(r.hostname)&&(r.hostname=r.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(const a of[...r.searchParams.keys()])testParameter(a,e.removeQueryParameters)&&r.searchParams.delete(a);if(!Array.isArray(e.keepQueryParameters)&&e.removeQueryParameters===!0&&(r.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(const a of[...r.searchParams.keys()])testParameter(a,e.keepQueryParameters)||r.searchParams.delete(a);if(e.sortQueryParameters){r.searchParams.sort();try{r.search=decodeURIComponent(r.search)}catch{}}e.removeTrailingSlash&&(r.pathname=r.pathname.replace(/\/$/,"")),e.removeExplicitPort&&r.port&&(r.port="");const o=t;return t=r.toString(),!e.removeSingleSlash&&r.pathname==="/"&&!o.endsWith("/")&&r.hash===""&&(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||r.pathname==="/")&&r.hash===""&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),n&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}var NDKRelayKeepalive=class{constructor(t=3e4,e){g(this,"lastActivity",Date.now());g(this,"timer");g(this,"timeout");g(this,"isRunning",!1);this.onSilenceDetected=e,this.timeout=t}recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const t=Date.now()-this.lastActivity;if(t>=this.timeout)this.onSilenceDetected();else{const e=this.timeout-t;this.timer=setTimeout(()=>{this.onSilenceDetected()},e)}},this.timeout)}};async function probeRelayConnection(t){const e=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(n=>{let s=!1;const r=setTimeout(()=>{s||(s=!0,t.send(["CLOSE",e]),n(!1))},5e3),o=()=>{s||(s=!0,clearTimeout(r),t.send(["CLOSE",e]),n(!0))};t.once("message",o),t.send(["REQ",e,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS=5,FLAPPING_THRESHOLD_MS=1e3,NDKRelayConnectivity=class{constructor(t,e){g(this,"ndkRelay");g(this,"ws");g(this,"_status");g(this,"timeoutMs");g(this,"connectedAt");g(this,"_connectionStats",{attempts:0,success:0,durations:[]});g(this,"debug");g(this,"netDebug");g(this,"connectTimeout");g(this,"reconnectTimeout");g(this,"ndk");g(this,"openSubs",new Map);g(this,"openCountRequests",new Map);g(this,"openEventPublishes",new Map);g(this,"pendingAuthPublishes",new Map);g(this,"serial",0);g(this,"baseEoseTimeout",4400);g(this,"keepalive");g(this,"wsStateMonitor");g(this,"sleepDetector");g(this,"lastSleepCheck",Date.now());g(this,"lastMessageSent",Date.now());g(this,"wasIdle",!1);g(this,"updateConnectionStats",{connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}});this.ndkRelay=t,this._status=1;const n=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${n}`),this.ndk=e,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive(12e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection({send:e=>this.send(JSON.stringify(e)),once:(e,n)=>{var r;const s=o=>{var a;try{const c=JSON.parse(o.data);(c[0]==="EOSE"||c[0]==="EVENT"||c[0]==="NOTICE")&&(n(),(a=this.ws)==null||a.removeEventListener("message",s))}catch{}};(r=this.ws)==null||r.addEventListener("message",s)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const t=Date.now(),e=t-this.lastSleepCheck;e>15e3&&(this.debug(`Detected possible sleep/wake (${e}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=t},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection({send:t=>this.send(JSON.stringify(t)),once:(t,e)=>{var s;const n=r=>{var o;try{const a=JSON.parse(r.data);(a[0]==="EOSE"||a[0]==="EVENT"||a[0]==="NOTICE")&&(e(),(o=this.ws)==null||o.removeEventListener("message",n))}catch{}};(s=this.ws)==null||s.addEventListener("message",n)}}).then(t=>{t||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(t,e=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??(t=this.timeoutMs),!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(n){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,n),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),n}}disconnect(){var t,e;this._status=0,(t=this.keepalive)==null||t.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{(e=this.ws)==null||e.close()}catch(n){this.debug("Failed to disconnect",n),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){var t,e;(t=this.netDebug)==null||t.call(this,"connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,(e=this.keepalive)==null||e.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){var t,e;(t=this.netDebug)==null||t.call(this,"disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),(e=this.keepalive)==null||e.stop(),this.clearPendingPublishes(new Error(`Relay ${this.ndkRelay.url} disconnected`)),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(t){var e,n;(e=this.netDebug)==null||e.call(this,t.data,this.ndkRelay,"recv"),(n=this.keepalive)==null||n.recordActivity();try{const s=JSON.parse(t.data),[r,o,...a]=s,c=this.ndkRelay.getProtocolHandler(r);if(c){c(this.ndkRelay,s);return}switch(r){case"EVENT":{const l=this.openSubs.get(o),u=s[2];if(!l){this.debug(`Received event for unknown subscription ${o}`);return}l.onevent(u);return}case"COUNT":{const l=s[2],u=this.openCountRequests.get(o);u&&(u.resolve(l.count),this.openCountRequests.delete(o));return}case"EOSE":{const l=this.openSubs.get(o);if(!l)return;l.oneose(o);return}case"OK":{const l=s[2],u=s[3],f=this.openEventPublishes.get(o),h=f==null?void 0:f.pop();if(!f||!h){this.debug("Received OK for unknown event publish",o);return}l?(h.resolve(u),this.pendingAuthPublishes.delete(o)):u&&(u.toLowerCase().includes("auth-required")||u.toLowerCase().includes("not authorized")||u.toLowerCase().includes("blocked: not authorized"))?this.pendingAuthPublishes.get(o)?(this.debug("Publish failed due to auth-required, will retry after auth",o),f.push(h),this.openEventPublishes.set(o,f)):h.reject(new Error(u)):(h.reject(new Error(u)),this.pendingAuthPublishes.delete(o)),f.length===0?this.openEventPublishes.delete(o):!l&&!(u!=null&&u.toLowerCase().includes("auth-required")||u!=null&&u.toLowerCase().includes("not authorized")||u!=null&&u.toLowerCase().includes("blocked: not authorized"))&&this.openEventPublishes.set(o,f);return}case"CLOSED":{const l=this.openSubs.get(o);if(!l)return;l.onclosed(s[2]);return}case"NOTICE":this.onNotice(s[1]);return;case"AUTH":{this.onAuthRequested(s[1]);return}}}catch(s){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${s.message}`,s==null?void 0:s.stack);return}}async onAuthRequested(t){var n,s,r;const e=this.ndkRelay.authPolicy??((n=this.ndk)==null?void 0:n.relayAuthDefaultPolicy);if(this.debug("Relay requested authentication",{havePolicy:!!e}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){this._status=7;let o;try{o=await e(this.ndkRelay,t)}catch(a){this.debug("Authentication policy threw an error",a),o=!1}if(this.debug("Authentication policy returned",!!o),o instanceof NDKEvent||o===!0){o instanceof NDKEvent&&await this.auth(o);const a=async()=>{if(this._status>=5&&this._status<8){const c=new NDKEvent(this.ndk);c.kind=22242,c.tags=[["relay",this.ndkRelay.url],["challenge",t]],await c.sign(),this.auth(c).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful"),this.retryPendingAuthPublishes()}).catch(l=>{this._status=6,this.ndkRelay.emit("auth:failed",l),this.debug("Authentication failed",l),this.rejectPendingAuthPublishes(l)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};o===!0&&((s=this.ndk)!=null&&s.signer?a().catch(c=>{console.error("Error authenticating",c)}):(this.debug("No signer available for authentication localhost"),(r=this.ndk)==null||r.once("signer:ready",a))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t)}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const t=this._connectionStats.durations;if(t.length%3!==0)return!1;const n=t.reduce((a,c)=>a+c,0)/t.length,s=t.map(a=>(a-n)**2).reduce((a,c)=>a+c,0)/t.length;return Math.sqrt(s)<FLAPPING_THRESHOLD_MS}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let e;if(this.wasIdle){const n=[0,1e3,2e3,5e3,1e4,3e4];e=n[Math.min(t,n.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${t}, delay ${e}ms`)}else this.connectedAt?e=Math.max(0,6e4-(Date.now()-this.connectedAt)):(e=Math.min(1e3*2**t,3e4),this.debug(`Using standard backoff, attempt ${t}, delay ${e}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(n=>{t<MAX_RECONNECT_ATTEMPTS?this.handleReconnection(t+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){var n,s,r,o,a;Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&((n=this.ws)==null?void 0:n.readyState)===WebSocket.OPEN?((s=this.ws)==null||s.send(t),(r=this.netDebug)==null||r.call(this,t,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status),this._status>=5&&((o=this.ws)==null?void 0:o.readyState)!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${(a=this.ws)==null?void 0:a.readyState}`),this.handleStaleConnection()))}async auth(t){const e=new Promise((n,s)=>{const r=this.openEventPublishes.get(t.id)??[];r.push({resolve:n,reject:s}),this.openEventPublishes.set(t.id,r)});return this.send(`["AUTH",${JSON.stringify(t.rawEvent())}]`),e}clearPendingPublishes(t){this.rejectPendingAuthPublishes(t);for(const[e,n]of this.openEventPublishes.entries()){for(;n.length>0;){const s=n.shift();s&&s.reject(t)}this.openEventPublishes.delete(e)}}retryPendingAuthPublishes(){if(this.pendingAuthPublishes.size!==0){this.debug(`Retrying ${this.pendingAuthPublishes.size} pending publishes after auth`);for(const[t,e]of this.pendingAuthPublishes.entries())this.debug(`Retrying publish for event ${t}`),this.send(`["EVENT",${JSON.stringify(e)}]`);this.pendingAuthPublishes.clear()}}rejectPendingAuthPublishes(t){if(this.pendingAuthPublishes.size!==0){this.debug(`Rejecting ${this.pendingAuthPublishes.size} pending publishes due to auth failure`);for(const[e]of this.pendingAuthPublishes.entries()){const n=this.openEventPublishes.get(e);if(n&&n.length>0){const s=n.pop();s&&s.reject(new Error(`Authentication failed: ${t.message}`)),n.length===0&&this.openEventPublishes.delete(e)}}this.pendingAuthPublishes.clear()}}async publish(t){const e=new Promise((n,s)=>{const r=this.openEventPublishes.get(t.id)??[];r.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${t.id} twice`),r.push({resolve:n,reject:s}),this.openEventPublishes.set(t.id,r)});return this.pendingAuthPublishes.set(t.id,t),this.send(`["EVENT",${JSON.stringify(t)}]`),e}async count(t,e){this.serial++;const n=(e==null?void 0:e.id)||`count:${this.serial}`,s=new Promise((r,o)=>{this.openCountRequests.set(n,{resolve:r,reject:o})});return this.send(`["COUNT","${n}",${JSON.stringify(t).substring(1)}`),s}close(t,e){this.send(`["CLOSE","${t}"]`);const n=this.openSubs.get(t);this.openSubs.delete(t),n&&n.onclose(e)}req(t){`${this.send(`["REQ","${t.subId}",${JSON.stringify(t.executeFilters).substring(1)}`)}`,this.openSubs.set(t.subId,t)}get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){var t;return this._status>=5&&((t=this.ws)==null?void 0:t.readyState)===WebSocket.OPEN}};async function fetchRelayInformation(t){const e=t.replace(/^wss:\/\//,"https://").replace(/^ws:\/\//,"http://"),n=await fetch(e,{headers:{Accept:"application/nostr+json"}});if(!n.ok)throw new Error(`Failed to fetch relay information: ${n.status} ${n.statusText}`);return await n.json()}var NDKRelayPublisher=class{constructor(t){g(this,"ndkRelay");g(this,"debug");this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let n;const s=()=>new Promise((f,h)=>{try{this.publishEvent(t).then(p=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),f(!0)}).catch(h)}catch(p){h(p)}}),r=new Promise((f,h)=>{n=setTimeout(()=>{n=void 0,h(new Error(`Timeout: ${e}ms`))},e)}),o=()=>{s().then(f=>a(f)).catch(f=>c(f))};let a,c;const l=f=>{throw this.ndkRelay.debug("Publish failed",f,t.id),this.ndkRelay.emit("publish:failed",t,f),t.emit("relay:publish:failed",this.ndkRelay,f),f},u=()=>{n&&clearTimeout(n),this.ndkRelay.removeListener("connect",o)};return this.ndkRelay.status>=5?Promise.race([s(),r]).catch(l).finally(u):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((f,h)=>{a=f,c=h,this.ndkRelay.on("connect",o)}),r]).catch(l).finally(u))}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}};function filterFingerprint(t,e){const n=[];for(const r of t){const o=Object.entries(r||{}).map(([a,c])=>["since","until"].includes(a)?`${a}:${c}`:a).sort().join("-");n.push(o)}let s=e?"+":"";return s+=n.join("|"),s}function mergeFilters(t){const e=[],n={};return t.filter(s=>!!s.limit).forEach(s=>e.push(s)),t=t.filter(s=>!s.limit),t.length===0?e:(t.forEach(s=>{Object.entries(s).forEach(([r,o])=>{Array.isArray(o)?n[r]===void 0?n[r]=[...o]:n[r]=Array.from(new Set([...n[r],...o])):n[r]=o})}),[...e,n])}var MAX_ITEMS=3;function formatArray(t,e){const s=(e?t.slice(0,MAX_ITEMS).map(e):t.slice(0,MAX_ITEMS)).join(",");return t.length>MAX_ITEMS?`${s}+${t.length-MAX_ITEMS}`:s}function formatFilters(t){return t.map(e=>{var s,r,o;const n=[];(s=e.ids)!=null&&s.length&&n.push(`ids:[${formatArray(e.ids,a=>String(a).slice(0,8))}]`),(r=e.kinds)!=null&&r.length&&n.push(`kinds:[${formatArray(e.kinds)}]`),(o=e.authors)!=null&&o.length&&n.push(`authors:[${formatArray(e.authors,a=>String(a).slice(0,8))}]`),e.since&&n.push(`since:${e.since}`),e.until&&n.push(`until:${e.until}`),e.limit&&n.push(`limit:${e.limit}`),e.search&&n.push(`search:"${String(e.search).slice(0,20)}"`);for(const[a,c]of Object.entries(e))a.startsWith("#")&&Array.isArray(c)&&c.length>0&&n.push(`${a}:[${formatArray(c,l=>String(l).slice(0,8))}]`);return`{${n.join(" ")}}`}).join(", ")}var NDKRelaySubscription=class{constructor(t,e,n){g(this,"fingerprint");g(this,"items",new Map);g(this,"topSubManager");g(this,"debug");g(this,"status",0);g(this,"onClose");g(this,"relay");g(this,"eosed",!1);g(this,"executionTimer");g(this,"fireTime");g(this,"delayType");g(this,"executeFilters");g(this,"id",Math.random().toString(36).substring(7));g(this,"_subId");g(this,"subIdParts",new Set);g(this,"executeOnRelayReady",()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size,filters:formatFilters(this.compileFilters())}),this.status=1,this.execute()}});g(this,"reExecuteAfterAuth",(()=>{const t=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:t}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",t,this.subId)}).bind(this));this.relay=t,this.topSubManager=n,this.debug=t.debug.extend(`sub[${this.id}]`),this.fingerprint=e||Math.random().toString(36).substring(7)}get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(this.debug("Adding item",{filters:formatFilters(e),internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,itemsSize:this.items.size}),!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),this.status!==3&&t.subId&&(!this._subId||this._subId.length<25)&&(this.status===0||this.status===1)&&this.addSubIdPart(t.subId),this.status){case 0:this.evaluateExecutionPlan(t);break;case 3:break;case 1:this.evaluateExecutionPlan(t);break;case 4:throw this.debug("Subscription is closed, cannot add new items",{filters:formatFilters(e),subId:t.subId,internalId:t.internalId}),new Error("Cannot add new items to a closed subscription")}}removeItem(t){if(this.items.delete(t.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const t=this.status;if(this.status=4,t===3)try{this.relay.close(this.subId)}catch(e){this.debug("Error closing subscription",e,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(t){if(!t.isGroupable()){this.status=1,this.execute();return}if(t.filters.find(s=>!!s.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const e=t.groupableDelay,n=t.groupableDelayType;if(!e)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(e,n);else{const s=this.delayType,r=this.fireTime-Date.now();if(s==="at-least"&&n==="at-least")r<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(s==="at-least"&&n==="at-most")r>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(s==="at-most"&&n==="at-most")r>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else if(s==="at-most"&&n==="at-least")r>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,n));else throw new Error(`Unknown delay type combination ${s} ${n}`)}}schedule(t,e){this.status=1;const n=Date.now();this.fireTime=n+t,this.delayType=e;const s=setTimeout(this.execute.bind(this),t);e==="at-least"&&(this.executionTimer=s)}finalizeSubId(){if(this.subIdParts.size>0){let e=Array.from(this.subIdParts).map(n=>n.substring(0,10)).join("-");e.length>20&&(e=e.substring(0,20)),this._subId=e}else this._subId=this.fingerprint.slice(0,15);this._subId+=`-${Math.random().toString(36).substring(2,7)}`}execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){this.topSubManager.dispatchEvent(t,this.relay)}oneose(t){if(this.eosed=!0,t!==this.subId){this.debug("Received EOSE for an abandoned subscription",t,this.subId),this.relay.close(t);return}this.items.size===0&&this.close();for(const{subscription:e}of this.items.values())e.eoseReceived(this.relay),e.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:formatFilters(e.filters),internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.removeItem(e))}onclose(t){this.status=4}onclosed(t){if(t)for(const{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){const t=[],e=Array.from(this.items.values()).map(s=>s.filters);if(!e[0])return this.debug(" No filters to merge",{itemsSize:this.items.size}),[];const n=e[0].length;for(let s=0;s<n;s++){const r=e.map(a=>a[s]),o=mergeFilters(r);t.push(...o)}return t}},NDKRelaySubscriptionManager=class{constructor(t,e){g(this,"relay");g(this,"subscriptions");g(this,"generalSubManager");this.relay=t,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(t,e){let n;if(!t.isGroupable())n=this.createSubscription(t,e);else{const s=filterFingerprint(e,t.closeOnEose);s&&(n=(this.subscriptions.get(s)||[]).find(o=>o.status<3)),n??(n=this.createSubscription(t,e,s))}n.addItem(t,e)}createSubscription(t,e,n){const s=new NDKRelaySubscription(this.relay,n||null,this.generalSubManager);s.onClose=this.onRelaySubscriptionClose.bind(this);const r=this.subscriptions.get(s.fingerprint)??[];return this.subscriptions.set(s.fingerprint,[...r,s]),s}onRelaySubscriptionClose(t){let e=this.subscriptions.get(t.fingerprint)??[];e?e.length===1?this.subscriptions.delete(t.fingerprint):(e=e.filter(n=>n.id!==t.id),this.subscriptions.set(t.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",t.fingerprint)}},$e,NDKRelay=($e=class extends lib$1.EventEmitter{constructor(n,s,r){super();g(this,"url");g(this,"scores");g(this,"connectivity");g(this,"subs");g(this,"publisher");g(this,"authPolicy");g(this,"protocolHandlers",new Map);g(this,"_relayInfo");g(this,"lowestValidationRatio");g(this,"targetValidationRatio");g(this,"validationRatioFn");g(this,"validatedEventCount",0);g(this,"nonValidatedEventCount",0);g(this,"trusted",!1);g(this,"complaining",!1);g(this,"debug");g(this,"req");g(this,"close");this.url=normalizeRelayUrl(n),this.scores=new Map,this.debug=createDebug5(`ndk:relay:${n}`),this.connectivity=new NDKRelayConnectivity(this,r),this.connectivity.netDebug=r==null?void 0:r.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager(this,r.subManager),this.publisher=new NDKRelayPublisher(this),this.authPolicy=s,this.targetValidationRatio=r==null?void 0:r.initialValidationRatio,this.lowestValidationRatio=r==null?void 0:r.lowestValidationRatio,this.validationRatioFn=((r==null?void 0:r.validationRatioFn)??$e.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),r||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const n=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=n}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(n,s=!0){return this.connectivity.connect(n,s)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(n,s){this.subs.addSubscription(n,s)}async publish(n,s=2500){return this.publisher.publish(n,s)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}registerProtocolHandler(n,s){this.protocolHandlers.set(n,s)}unregisterProtocolHandler(n){this.protocolHandlers.delete(n)}getProtocolHandler(n){return this.protocolHandlers.get(n)}async fetchInfo(n=!1){var o,a;const r=this.connectivity.ndk;if(!n&&((o=r==null?void 0:r.cacheAdapter)!=null&&o.getRelayStatus)){const c=await r.cacheAdapter.getRelayStatus(this.url);if(c!=null&&c.nip11&&Date.now()-c.nip11.fetchedAt<864e5)return this._relayInfo=c.nip11.data,c.nip11.data}return!n&&this._relayInfo?this._relayInfo:(this._relayInfo=await fetchRelayInformation(this.url),(a=r==null?void 0:r.cacheAdapter)!=null&&a.updateRelayStatus&&await r.cacheAdapter.updateRelayStatus(this.url,{nip11:{data:this._relayInfo,fetchedAt:Date.now()}}),this._relayInfo)}get info(){return this._relayInfo}},g($e,"defaultValidationRatioUpdateFn",(n,s,r)=>{if(n.lowestValidationRatio===void 0||n.targetValidationRatio===void 0)return 1;let o=n.validationRatio;if(n.validationRatio>n.targetValidationRatio){const a=s/100;o=Math.max(n.lowestValidationRatio,n.validationRatio-a)}return o<n.validationRatio?o:n.validationRatio}),$e),NDKPublishError=class extends Error{constructor(e,n,s,r){super(e);g(this,"errors");g(this,"publishedToRelays");g(this,"intendedRelaySet");this.errors=n,this.publishedToRelays=s,this.intendedRelaySet=r}get relayErrors(){const e=[];for(const[n,s]of this.errors)e.push(`${n.url}: ${s}`);return e.join(`
`)}},NDKRelaySet=class He{constructor(e,n,s){g(this,"relays");g(this,"debug");g(this,"ndk");g(this,"pool");this.relays=e,this.ndk=n,this.pool=s??n.pool,this.debug=n.debug.extend("relayset")}addRelay(e){this.relays.add(e)}get relayUrls(){return Array.from(this.relays).map(e=>e.url)}static fromRelayUrls(e,n,s=!0,r){if(r=r??n.pool,!r)throw new Error("No pool provided");const o=new Set;for(const a of e){const c=r.relays.get(normalizeRelayUrl(a));if(c)c.status<5&&s&&c.connect(),o.add(c);else{const l=new NDKRelay(normalizeRelayUrl(a),n==null?void 0:n.relayAuthDefaultPolicy,n);r.useTemporaryRelay(l,void 0,`requested from fromRelayUrls ${e}`),o.add(l)}}return new He(new Set(o),n,r)}async publish(e,n,s=1){var l;const r=new Set,o=new Map,a=e.isEphemeral();e.publishStatus="pending";const c=u=>{r.add(u)};e.on("relay:published",c);try{const u=Array.from(this.relays).map(f=>new Promise(h=>{const p=n?setTimeout(()=>{r.has(f)||(o.set(f,new Error(`Publish timeout after ${n}ms`)),h(!1))},n):null;f.publish(e,n).then(y=>{p&&clearTimeout(p),y?(r.add(f),h(!0)):h(!1)}).catch(y=>{p&&clearTimeout(p),a||o.set(f,y),h(!1)})}));if(await Promise.all(u),r.size<s){if(!a){const f=new NDKPublishError("Not enough relays received the event ("+r.size+" published, "+s+" required)",o,r,this);throw e.publishStatus="error",e.publishError=f,(l=this.ndk)==null||l.emit("event:publish-failed",e,f,this.relayUrls),f}}else e.publishStatus="success",e.emit("published",{relaySet:this,publishedToRelays:r});return r}finally{e.off("relay:published",c)}}get size(){return this.relays.size}},d=createDebug5("ndk:outbox:calculate");async function calculateRelaySetFromEvent(t,e,n){var c,l;const s=new Set,r=await getWriteRelaysFor(t,e.pubkey);r&&r.forEach(u=>{var h;const f=(h=t.pool)==null?void 0:h.getRelay(u);f&&s.add(f)});let o=e.tags.filter(u=>["a","e"].includes(u[0])).map(u=>u[2]).filter(u=>u==null?void 0:u.startsWith("wss://")).filter(u=>{try{return new URL(u),!0}catch{return!1}}).map(u=>normalizeRelayUrl(u));o=Array.from(new Set(o)).slice(0,5),o.forEach(u=>{var h;const f=(h=t.pool)==null?void 0:h.getRelay(u,!0,!0);f&&(d("Adding relay hint %s",u),s.add(f))});const a=e.getMatchingTags("p").map(u=>u[1]);if(a.length<5?Array.from(chooseRelayCombinationForPubkeys(t,a,"read",{preferredRelays:new Set(r)}).keys()).forEach(f=>{var p;const h=(p=t.pool)==null?void 0:p.getRelay(f,!1,!0);h&&(d("Adding p-tagged relay %s",f),s.add(h))}):d("Too many p-tags to consider %d",a.length),(c=t.pool)==null||c.permanentAndConnectedRelays().forEach(u=>s.add(u)),n&&s.size<n){const u=(l=t.explicitRelayUrls)==null?void 0:l.filter(f=>!Array.from(s).some(h=>h.url===f)).slice(0,n-s.size);u==null||u.forEach(f=>{var p;const h=(p=t.pool)==null?void 0:p.getRelay(f,!1,!0);h&&(d("Adding explicit relay %s",f),s.add(h))})}return new NDKRelaySet(s,t)}function calculateRelaySetsFromFilter(t,e,n,s){const r=new Map,o=new Set;if(e.forEach(a=>{a.authors&&a.authors.forEach(c=>o.add(c))}),o.size>0){const a=getRelaysForFilterWithAuthors(t,Array.from(o),s);for(const c of a.keys())r.set(c,[]);for(const c of e)if(c.authors)for(const[l,u]of a.entries()){const f=c.authors.filter(h=>u.includes(h));r.set(l,[...r.get(l),{...c,authors:f}])}else for(const l of a.keys())r.set(l,[...r.get(l),c])}else t.explicitRelayUrls&&t.explicitRelayUrls.forEach(a=>{r.set(a,e)});return r.size===0&&n.permanentAndConnectedRelays().slice(0,5).forEach(a=>{r.set(a.url,e)}),r}function calculateRelaySetsFromFilters(t,e,n,s){return calculateRelaySetsFromFilter(t,e,n,s)}function isValidHex64(t){if(typeof t!="string"||t.length!==64)return!1;for(let e=0;e<64;e++){const n=t.charCodeAt(e);if(!(n>=48&&n<=57||n>=97&&n<=102||n>=65&&n<=70))return!1}return!0}function isValidPubkey(t){return isValidHex64(t)}function isValidNip05(t){if(typeof t!="string")return!1;for(let e=0;e<t.length;e++)if(t.charCodeAt(e)===46)return!0;return!1}function mergeTags(t,e){const n=new Map,s=a=>a.join(","),r=(a,c)=>a.every((l,u)=>l===c[u]),o=a=>{for(const[c,l]of n)if(r(l,a)||r(a,l)){a.length>=l.length&&n.set(c,a);return}n.set(s(a),a)};return t.concat(e).forEach(o),Array.from(n.values())}var hashtagRegex=new RegExp(`(?<=\\s|^)(#[^\\s!@#$%^&*()=+./,[{\\]};:'"?><]+)`,"g");function generateHashtags(t){const e=t.match(hashtagRegex),n=new Set,s=new Set;if(e)for(const r of e)n.has(r.slice(1))||(s.add(r.slice(1)),n.add(r.slice(1)));return Array.from(s)}async function generateContentTags(t,e=[],n,s){var c,l;if(n!=null&&n.skipContentTagging)return{content:t,tags:e};const r=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,o=[],a=u=>{e.find(f=>["q",u[0]].includes(f[0])&&f[1]===u[1])||e.push(u)};if(t=t.replace(r,u=>{var f;try{const h=u.split(/(@|nostr:)/)[2],{type:p,data:y}=nip19_exports$1.decode(h);let b;if(n!=null&&n.filters){const m=!n.filters.includeTypes||n.filters.includeTypes.includes(p),w=(f=n.filters.excludeTypes)==null?void 0:f.includes(p);if(!m||w)return u}switch(p){case"npub":(n==null?void 0:n.pTags)!==!1&&(b=["p",y]);break;case"nprofile":(n==null?void 0:n.pTags)!==!1&&(b=["p",y.pubkey]);break;case"note":o.push(new Promise(async m=>{const w=await maybeGetEventRelayUrl(h);a(["q",y,w]),m()}));break;case"nevent":o.push(new Promise(async m=>{const{id:w,author:k}=y;let{relays:A}=y;(!A||A.length===0)&&(A=[await maybeGetEventRelayUrl(h)]),a(["q",w,A[0]]),k&&(n==null?void 0:n.pTags)!==!1&&(n==null?void 0:n.pTagOnQTags)!==!1&&a(["p",k]),m()}));break;case"naddr":o.push(new Promise(async m=>{const w=[y.kind,y.pubkey,y.identifier].join(":");let k=y.relays??[];k.length===0&&(k=[await maybeGetEventRelayUrl(h)]),a(["q",w,k[0]]),(n==null?void 0:n.pTags)!==!1&&(n==null?void 0:n.pTagOnQTags)!==!1&&(n==null?void 0:n.pTagOnATags)!==!1&&a(["p",y.pubkey]),m()}));break;default:return u}return b&&a(b),`nostr:${h}`}catch{return u}}),await Promise.all(o),!((l=(c=n==null?void 0:n.filters)==null?void 0:c.excludeTypes)!=null&&l.includes("hashtag"))){const u=generateHashtags(t).map(f=>["t",f]);e=mergeTags(e,u)}if((n==null?void 0:n.pTags)!==!1&&(n!=null&&n.copyPTagsFromTarget)&&s){const u=s.getMatchingTags("p");for(const f of u)!f[1]||!isValidPubkey(f[1])||e.find(h=>h[0]==="p"&&h[1]===f[1])||e.push(f)}return{content:t,tags:e}}async function maybeGetEventRelayUrl(t){return""}async function encrypt(t,e,n="nip44"){let s;if(!this.ndk)throw new Error("No NDK instance found!");let r=e;if(r||(this.ndk.assertSigner(),r=this.ndk.signer),!r)throw new Error("no NDK signer");const o=t||(()=>{const a=this.getMatchingTags("p");if(a.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:a[0][1]})})();if(n==="nip44"&&await isEncryptionEnabled(r,"nip44")&&(s=await r.encrypt(o,this.content,"nip44")),(!s||n==="nip04")&&await isEncryptionEnabled(r,"nip04")&&(s=await r.encrypt(o,this.content,"nip04")),!s)throw new Error("Failed to encrypt event.");this.content=s}async function decrypt(t,e,n){var c,l,u,f;if((l=(c=this.ndk)==null?void 0:c.cacheAdapter)!=null&&l.getDecryptedEvent){const h=await this.ndk.cacheAdapter.getDecryptedEvent(this.id);if(h){this.content=h.content;return}}let s;if(!this.ndk)throw new Error("No NDK instance found!");let r=e;if(r||(this.ndk.assertSigner(),r=this.ndk.signer),!r)throw new Error("no NDK signer");const o=t||this.author;if(!o)throw new Error("No sender provided and no author available");const a=n||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((a==="nip04"||this.kind===4)&&await isEncryptionEnabled(r,"nip04")&&this.content.search("\\?iv=")&&(s=await r.decrypt(o,this.content,"nip04")),!s&&a==="nip44"&&await isEncryptionEnabled(r,"nip44")&&(s=await r.decrypt(o,this.content,"nip44")),!s)throw new Error("Failed to decrypt event.");this.content=s,(f=(u=this.ndk)==null?void 0:u.cacheAdapter)!=null&&f.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this.id,this)}async function isEncryptionEnabled(t,e){return t.encryptionEnabled?e?!!await t.encryptionEnabled(e):!0:!1}function eventHasETagMarkers(t){for(const e of t.tags)if(e[0]==="e"&&(e[3]??"").length>0)return!0;return!1}function getRootTag(t,e){e??(e=t.tagType());const n=t.tags.find(isTagRootTag);if(!n){if(eventHasETagMarkers(t))return;const s=t.getMatchingTags(e);if(s.length<3)return s[0]}return n}var nip22RootTags=new Set(["A","E","I"]),nip22ReplyTags=new Set(["a","e","i"]);function getReplyTag(t,e){if(t.kind===1111){let r;for(const o of t.tags)if(nip22RootTags.has(o[0]))r=o;else if(nip22ReplyTags.has(o[0])){r=o;break}return r}e??(e=t.tagType());let n=!1,s;for(const r of t.tags)if(r[0]===e){if((r[3]??"").length>0&&(n=!0),n&&r[3]==="reply")return r;n&&r[3]==="root"&&(s=r),n||(s=r)}return s}function isTagRootTag(t){return t[0]==="E"||t[3]==="root"}async function fetchTaggedEvent(t,e){if(!this.ndk)throw new Error("NDK instance not found");const n=this.getMatchingTags(t,e);if(n.length===0)return;const[s,r,o]=n[0],a=o!==""?this.ndk.pool.getRelay(o):void 0;return await this.ndk.fetchEvent(r,{},a)}async function fetchRootEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getRootTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function fetchReplyEvent(t){if(!this.ndk)throw new Error("NDK instance not found");const e=getReplyTag(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function isReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT=2;function encode(t=DEFAULT_RELAY_COUNT){let e=[];return this.onRelays.length>0?e=this.onRelays.map(n=>n.url):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable()?nip19_exports$1.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?nip19_exports$1.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):nip19_exports$1.noteEncode(this.tagId())}async function repost(t=!0,e){if(!e&&t){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}const n=new NDKEvent(this.ndk,{kind:getKind(this)});return this.isProtected||(n.content=JSON.stringify(this.rawEvent())),n.tag(this),this.kind!==1&&n.tags.push(["k",`${this.kind}`]),e&&await n.sign(e),t&&await n.publish(),n}function getKind(t){return t.kind===1?6:16}function getEventDetails(t){return"inspect"in t&&typeof t.inspect=="string"?t.inspect:JSON.stringify(t)}function validateForSerialization(t){if(typeof t.kind!="number")throw new Error(`Can't serialize event with invalid properties: kind (must be number, got ${typeof t.kind}). Event: ${getEventDetails(t)}`);if(typeof t.content!="string")throw new Error(`Can't serialize event with invalid properties: content (must be string, got ${typeof t.content}). Event: ${getEventDetails(t)}`);if(typeof t.created_at!="number")throw new Error(`Can't serialize event with invalid properties: created_at (must be number, got ${typeof t.created_at}). Event: ${getEventDetails(t)}`);if(typeof t.pubkey!="string")throw new Error(`Can't serialize event with invalid properties: pubkey (must be string, got ${typeof t.pubkey}). Event: ${getEventDetails(t)}`);if(!Array.isArray(t.tags))throw new Error(`Can't serialize event with invalid properties: tags (must be array, got ${typeof t.tags}). Event: ${getEventDetails(t)}`);for(let e=0;e<t.tags.length;e++){const n=t.tags[e];if(!Array.isArray(n))throw new Error(`Can't serialize event with invalid properties: tags[${e}] (must be array, got ${typeof n}). Event: ${getEventDetails(t)}`);for(let s=0;s<n.length;s++)if(typeof n[s]!="string")throw new Error(`Can't serialize event with invalid properties: tags[${e}][${s}] (must be string, got ${typeof n[s]}). Event: ${getEventDetails(t)}`)}}function serialize(t=!1,e=!1){validateForSerialization(this);const n=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&n.push(this.sig),e&&n.push(this.id),JSON.stringify(n)}function deserialize(t){const e=JSON.parse(t),n={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};if(e.length>=7){const s=e[6],r=e[7];s&&s.length===128?(n.sig=s,r&&r.length===64&&(n.id=r)):s&&s.length===64&&(n.id=s,r&&r.length===128&&(n.sig=r))}return n}var worker,processingQueue={};function signatureVerificationInit(t){worker=t,worker.onmessage=e=>{if(!Array.isArray(e.data)||e.data.length!==2){console.error("[NDK]  Signature verification worker received incompatible message format.",`

 Expected format: [eventId, boolean]`,`
 Received:`,e.data,`

 This likely means:`,`
  1. You have a STALE worker.js file that needs updating`,`
  2. Version mismatch between @nostr-dev-kit/ndk and deployed worker`,`
  3. Wrong worker is being used for signature verification`,`

 Solution: Update your worker files:`,`
  cp node_modules/@nostr-dev-kit/ndk/dist/workers/sig-verification.js public/`,`
  cp node_modules/@nostr-dev-kit/cache-sqlite-wasm/dist/worker.js public/`,`

 Or use Vite/bundler imports instead of static files:`,`
  import SigWorker from "@nostr-dev-kit/ndk/workers/sig-verification?worker"`);return}const[n,s]=e.data,r=processingQueue[n];if(!r){console.error("No record found for event",n);return}delete processingQueue[n];for(const o of r.resolves)o(s)}}async function verifySignatureAsync(t,e,n){const s=t.ndk,r=Date.now();let o;return s.signatureVerificationFunction?o=await s.signatureVerificationFunction(t):o=await new Promise(a=>{const c=t.serialize();let l=!1;processingQueue[t.id]||(processingQueue[t.id]={event:t,resolves:[],relay:n},l=!0),processingQueue[t.id].resolves.push(a),l&&(worker==null||worker.postMessage({serialized:c,id:t.id,sig:t.sig,pubkey:t.pubkey}))}),s.signatureVerificationTimeMs+=Date.now()-r,o}var PUBKEY_REGEX=/^[a-f0-9]{64}$/;function validate(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){const e=this.tags[t];if(!Array.isArray(e))return!1;for(let n=0;n<e.length;n++)if(typeof e[n]=="object")return!1}return!0}var verifiedSignatures=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature(t){var n;if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const e=verifiedSignatures.get(this.id);if(e!==null)return this.signatureVerified=!!e,this.signatureVerified;try{if((n=this.ndk)!=null&&n.asyncSigVerification){const s=this.relay;verifySignatureAsync(this,t,s).then(r=>{var o,a;t&&(this.signatureVerified=r,r&&verifiedSignatures.set(this.id,this.sig)),r?s&&s.addValidatedEvent():(s?(o=this.ndk)==null||o.reportInvalidSignature(this,s):(a=this.ndk)==null||a.reportInvalidSignature(this),verifiedSignatures.set(this.id,!1))}).catch(r=>{console.error("signature verification error",this.id,r)})}else{const s=sha256(new TextEncoder().encode(this.serialize())),r=schnorr.verify(this.sig,s,this.pubkey);return r?verifiedSignatures.set(this.id,this.sig):verifiedSignatures.set(this.id,!1),this.signatureVerified=r,r}}catch{return this.signatureVerified=!1,!1}}function getEventHash(){return getEventHashFromSerializedEvent(this.serialize())}function getEventHashFromSerializedEvent(t){const e=sha256(new TextEncoder().encode(t));return bytesToHex(e)}var skipClientTagOnKinds=new Set([0,4,1059,13,3,9734,5]),NDKEvent=class ke extends lib$1.EventEmitter{constructor(n,s){var r;super();g(this,"ndk");g(this,"created_at");g(this,"content","");g(this,"tags",[]);g(this,"kind");g(this,"id","");g(this,"sig");g(this,"pubkey","");g(this,"signatureVerified");g(this,"_author");g(this,"relay");g(this,"publishStatus","success");g(this,"publishError");g(this,"serialize",serialize.bind(this));g(this,"getEventHash",getEventHash.bind(this));g(this,"validate",validate.bind(this));g(this,"verifySignature",verifySignature.bind(this));g(this,"isReplaceable",isReplaceable.bind(this));g(this,"isEphemeral",isEphemeral.bind(this));g(this,"isDvm",()=>this.kind&&this.kind>=5e3&&this.kind<=7e3);g(this,"isParamReplaceable",isParamReplaceable.bind(this));g(this,"encode",encode.bind(this));g(this,"encrypt",encrypt.bind(this));g(this,"decrypt",decrypt.bind(this));g(this,"fetchTaggedEvent",fetchTaggedEvent.bind(this));g(this,"fetchRootEvent",fetchRootEvent.bind(this));g(this,"fetchReplyEvent",fetchReplyEvent.bind(this));g(this,"repost",repost.bind(this));this.ndk=n,this.created_at=s==null?void 0:s.created_at,this.content=(s==null?void 0:s.content)||"",this.tags=(s==null?void 0:s.tags)||[],this.id=(s==null?void 0:s.id)||"",this.sig=s==null?void 0:s.sig,this.pubkey=(s==null?void 0:s.pubkey)||"",this.kind=s==null?void 0:s.kind,s instanceof ke&&(this.relay&&(this.relay=s.relay,(r=this.ndk)==null||r.subManager.seenEvent(s.id,this.relay)),this.publishStatus=s.publishStatus,this.publishError=s.publishError)}get onRelays(){let n=[];return this.ndk?n=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&n.push(this.relay),n}static deserialize(n,s){return new ke(n,deserialize(s))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(n){var s;this.pubkey=n.pubkey,this._author=n,(s=this._author).ndk??(s.ndk=this.ndk)}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const n=this.ndk.getUser({pubkey:this.pubkey});return this._author=n,n}tagExternal(n,s,r){const o=["i"],a=["k"];switch(s){case"url":{const c=new URL(n);c.hash="",o.push(c.toString()),a.push(`${c.protocol}//${c.host}`);break}case"hashtag":o.push(`#${n.toLowerCase()}`),a.push("#");break;case"geohash":o.push(`geo:${n.toLowerCase()}`),a.push("geo");break;case"isbn":o.push(`isbn:${n.replace(/-/g,"")}`),a.push("isbn");break;case"podcast:guid":o.push(`podcast:guid:${n}`),a.push("podcast:guid");break;case"podcast:item:guid":o.push(`podcast:item:guid:${n}`),a.push("podcast:item:guid");break;case"podcast:publisher:guid":o.push(`podcast:publisher:guid:${n}`),a.push("podcast:publisher:guid");break;case"isan":o.push(`isan:${n.split("-").slice(0,4).join("-")}`),a.push("isan");break;case"doi":o.push(`doi:${n.toLowerCase()}`),a.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${s}`)}r&&o.push(r),this.tags.push(o),this.tags.push(a)}tag(n,s,r,o,a){let c=[];if(n.fetchProfile!==void 0){if(o??(o="p"),o==="p"&&(a==null?void 0:a.pTags)===!1)return;const u=[o,n.pubkey];s&&u.push("",s),c.push(u)}else if(n instanceof ke){const u=n;if(r??(r=(u==null?void 0:u.pubkey)===this.pubkey),c=u.referenceTags(s,r,o,a),(a==null?void 0:a.pTags)!==!1)for(const f of u.getMatchingTags("p"))!f[1]||!isValidPubkey(f[1])||f[1]!==this.pubkey&&(this.tags.find(h=>h[0]==="p"&&h[1]===f[1])||this.tags.push(["p",f[1]]))}else if(Array.isArray(n))c=[n];else throw new Error("Invalid argument",n);this.tags=mergeTags(this.tags,c)}async toNostrEvent(n,s){var a,c;if(!n&&this.pubkey===""){const l=await((c=(a=this.ndk)==null?void 0:a.signer)==null?void 0:c.user());this.pubkey=(l==null?void 0:l.pubkey)||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:o}=await this.generateTags(s);this.content=r||"",this.tags=o;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}getMatchingTags(n,s){const r=this.tags.filter(o=>o[0]===n);return s===void 0?r:r.filter(o=>o[3]===s)}hasTag(n,s){return this.tags.some(r=>r[0]===n&&(!s||r[3]===s))}tagValue(n,s){const r=this.getMatchingTags(n,s);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(n){this.removeTag("alt"),n&&this.tags.push(["alt",n])}get dTag(){return this.tagValue("d")}set dTag(n){this.removeTag("d"),n&&this.tags.push(["d",n])}removeTag(n,s){const r=Array.isArray(n)?n:[n];this.tags=this.tags.filter(o=>{const a=r.includes(o[0]),c=s?o[3]===s:!0;return!(a&&c)})}replaceTag(n){this.removeTag(n[0]),this.tags.push(n)}async sign(n,s){var o,a,c,l,u;(c=(a=(o=this.ndk)==null?void 0:o.aiGuardrails)==null?void 0:a.event)==null||c.signing(this),n?this.author=await n.user():((l=this.ndk)==null||l.assertSigner(),n=(u=this.ndk)==null?void 0:u.signer);const r=await this.toNostrEvent(void 0,s);return this.sig=await n.sign(r),this.sig}async publishReplaceable(n,s,r){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(n,s,r)}async publish(n,s,r,o){var l,u,f,h,p;if(r||(r=1),this.sig||await this.sign(void 0,o),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if((u=(l=this.ndk.aiGuardrails)==null?void 0:l.event)==null||u.publishing(this),(!n||n.size===0)&&(n=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent(this.ndk,this,r)),this.kind===5&&((f=this.ndk.cacheAdapter)!=null&&f.deleteEventIds)){const y=this.getMatchingTags("e").map(b=>b[1]);this.ndk.cacheAdapter.deleteEventIds(y)}const a=this.rawEvent();if((h=this.ndk.cacheAdapter)!=null&&h.addUnpublishedEvent&&shouldTrackUnpublishedEvent(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,n.relayUrls)}catch(y){console.error("Error adding unpublished event to cache",y)}this.kind===5&&((p=this.ndk.cacheAdapter)!=null&&p.deleteEventIds)&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(y=>y[1])),this.ndk.subManager.dispatchEvent(a,void 0,!0);const c=await n.publish(this,s,r);return c.forEach(y=>{var b;return(b=this.ndk)==null?void 0:b.subManager.seenEvent(this.id,y)}),c}async generateTags(n){var a,c,l;let s=[];const r=await generateContentTags(this.content,this.tags,n,this),o=r.content;if(s=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const f=this.tagValue("title");let p=[...Array(f?6:16)].map(()=>Math.random().toString(36)[2]).join("");f&&f.length>0&&(p=`${f.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${p}`),s.push(["d",p])}if(this.shouldAddClientTag){const u=["client",((a=this.ndk)==null?void 0:a.clientName)??""];(c=this.ndk)!=null&&c.clientNip89&&u.push((l=this.ndk)==null?void 0:l.clientNip89),s.push(u)}else this.shouldStripClientTag&&(s=s.filter(u=>u[0]!=="client"));return{content:o||"",tags:s}}get shouldAddClientTag(){var n,s;return!(!((n=this.ndk)!=null&&n.clientName)&&!((s=this.ndk)!=null&&s.clientNip89)||skipClientTagOnKinds.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds.has(this.kind)}muted(){var n;return(n=this.ndk)!=null&&n.muteFilter&&this.ndk.muteFilter(this)?"muted":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const n=this.getMatchingTags("d")[0];return n?n[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const n=this.dTag??"";return`${this.kind}:${this.pubkey}:${n}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(n){let s;return this.isParamReplaceable()?s=["a",this.tagAddress()]:s=["e",this.tagId()],this.relay?s.push(this.relay.url):s.push(""),s.push(n??""),this.isParamReplaceable()||s.push(this.pubkey),s}referenceTags(n,s,r,o){let a=[];return this.isParamReplaceable()?a=[[r??"a",this.tagAddress()],[r??"e",this.id]]:a=[[r??"e",this.id]],a=a.map(c=>{var l,u,f;return c[0]==="e"||n?c.push(((l=this.relay)==null?void 0:l.url)??""):(u=this.relay)!=null&&u.url&&c.push((f=this.relay)==null?void 0:f.url),c}),a.forEach(c=>{c[0]==="e"?(c.push(n??""),c.push(this.pubkey)):n&&c.push(n)}),a=[...a,...this.getMatchingTags("h")],!s&&(o==null?void 0:o.pTags)!==!1&&a.push(...this.author.referenceTags()),a}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(n,s=!0){var o;if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new ke(this.ndk,{kind:5,content:n||""});return r.tag(this,void 0,!0),r.tags.push(["k",(o=this.kind)==null?void 0:o.toString()]),s&&(this.emit("deleted"),await r.publish()),r}set isProtected(n){this.removeTag("-"),n&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}async react(n,s=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const r=new ke(this.ndk,{kind:7,content:n});return r.tag(this),this.kind!==1&&r.tags.push(["k",`${this.kind}`]),s&&await r.publish(),r}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(n=>n.url).join(", "))}reply(n,s){var o,a,c,l,u,f,h,p;const r=new ke(this.ndk);if((c=(a=(o=this.ndk)==null?void 0:o.aiGuardrails)==null?void 0:a.event)==null||c.creatingReply(r),this.kind===1&&!n)r.kind=1,this.hasTag("e")?r.tags=[...r.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,s)]:r.tag(this,"root",!1,void 0,s);else{r.kind=1111;const y=["A","E","I","P"],b=this.tags.filter(m=>y.includes(m[0]));if(b.length>0){const m=this.tagValue("K");r.tags.push(...b),m&&r.tags.push(["K",m]);let w;if(this.isParamReplaceable()){w=["a",this.tagAddress()];const k=((l=this.relay)==null?void 0:l.url)??"";k&&w.push(k)}else{w=["e",this.tagId()];const k=((u=this.relay)==null?void 0:u.url)??"";w.push(k),w.push(this.pubkey)}r.tags.push(w)}else{let m,w;const k=((f=this.relay)==null?void 0:f.url)??"";this.isParamReplaceable()?(m=["a",this.tagAddress(),k],w=["A",this.tagAddress(),k]):(m=["e",this.tagId(),k,this.pubkey],w=["E",this.tagId(),k,this.pubkey]),r.tags.push(m),r.tags.push(w),r.tags.push(["K",(h=this.kind)==null?void 0:h.toString()]),(s==null?void 0:s.pTags)!==!1&&(s==null?void 0:s.pTagOnATags)!==!1&&r.tags.push(["P",this.pubkey])}r.tags.push(["k",(p=this.kind)==null?void 0:p.toString()]),(s==null?void 0:s.pTags)!==!1&&(r.tags.push(...this.getMatchingTags("p")),r.tags.push(["p",this.pubkey]))}return r}},untrackedUnpublishedEvents=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent(t){return!untrackedUnpublishedEvents.has(t.kind)}var NDKPool=class extends lib$1.EventEmitter{constructor(e,n,{debug:s,name:r}={}){super();g(this,"_relays",new Map);g(this,"status","idle");g(this,"autoConnectRelays",new Set);g(this,"debug");g(this,"temporaryRelayTimers",new Map);g(this,"flappingRelays",new Set);g(this,"backoffTimes",new Map);g(this,"ndk");g(this,"disconnectionTimes",new Map);g(this,"systemEventDetector");g(this,"_name","unnamed");this.debug=s??n.debug.extend("pool"),r&&(this._name=r),this.ndk=n,this.relayUrls=e,this.ndk.pools&&this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(e){this._relays.clear();for(const n of e){const s=new NDKRelay(n,void 0,this.ndk);s.connectivity.netDebug=this.ndk.netDebug,this.addRelay(s)}}get name(){return this._name}set name(e){this._name=e,this.debug=this.debug.extend(e)}useTemporaryRelay(e,n=3e4,s){const r=this.relays.has(e.url);r||(this.addRelay(e),this.debug("Adding temporary relay %s for filters %o",e.url,s));const o=this.temporaryRelayTimers.get(e.url);if(o&&clearTimeout(o),!r||o){const a=setTimeout(()=>{var c;(c=this.ndk.explicitRelayUrls)!=null&&c.includes(e.url)||this.removeRelay(e.url)},n);this.temporaryRelayTimers.set(e.url,a)}}addRelay(e,n=!0){var b;const s=this.relays.has(e.url),r=e.url.includes("/npub1");let o=!0;const a=e.url;if(s)return;if(this.ndk.relayConnectionFilter&&!this.ndk.relayConnectionFilter(a)){this.debug(`Refusing to add relay ${a}: blocked by relayConnectionFilter`);return}if(r){this.debug(`Refusing to add relay ${a}: is a filter relay`);return}if((b=this.ndk.cacheAdapter)!=null&&b.getRelayStatus){const m=this.ndk.cacheAdapter.getRelayStatus(a),w=m instanceof Promise?void 0:m;if(w!=null&&w.dontConnectBefore){if(w.dontConnectBefore>Date.now()){const k=w.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${a}: delayed connect for ${k}ms`),setTimeout(()=>{this.addRelay(e,n)},k);return}o=!1}}const c=m=>this.emit("notice",e,m),l=()=>this.handleRelayConnect(a),u=()=>this.handleRelayReady(e),f=()=>{this.recordDisconnection(e),this.emit("relay:disconnect",e)},h=()=>this.handleFlapping(e),p=m=>this.emit("relay:auth",e,m),y=()=>this.emit("relay:authed",e);e.off("notice",c),e.off("connect",l),e.off("ready",u),e.off("disconnect",f),e.off("flapping",h),e.off("auth",p),e.off("authed",y),e.on("notice",c),e.on("connect",l),e.on("ready",u),e.on("disconnect",f),e.on("flapping",h),e.on("auth",p),e.on("authed",y),e.on("delayed-connect",m=>{var w;(w=this.ndk.cacheAdapter)!=null&&w.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(e.url,{dontConnectBefore:Date.now()+m})}),this._relays.set(a,e),n&&this.autoConnectRelays.add(a),n&&this.status==="active"&&(this.emit("relay:connecting",e),e.connect(void 0,o).catch(m=>{this.debug(`Failed to connect to relay ${a}`,m)}))}removeRelay(e){const n=this.relays.get(e);if(n)return n.disconnect(),this.relays.delete(e),this.autoConnectRelays.delete(e),this.emit("relay:disconnect",n),!0;const s=this.temporaryRelayTimers.get(e);return s&&(clearTimeout(s),this.temporaryRelayTimers.delete(e)),!1}isRelayConnected(e){const n=normalizeRelayUrl(e),s=this.relays.get(n);return s?s.status===5:!1}getRelay(e,n=!0,s=!1,r){let o=this.relays.get(normalizeRelayUrl(e));return o||(o=new NDKRelay(e,void 0,this.ndk),o.connectivity.netDebug=this.ndk.netDebug,s?this.useTemporaryRelay(o,3e4,r):this.addRelay(o,n)),o}handleRelayConnect(e){const n=this.relays.get(e);if(!n){console.error("NDK BUG: relay not found in pool",{relayUrl:e});return}this.emit("relay:connect",n),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(e){this.emit("relay:ready",e)}async connect(e){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${e?`, timeout ${e}ms`:""}...`);const n=Array.from(this.autoConnectRelays.keys()).map(a=>this.relays.get(a)).filter(a=>!!a);for(const a of n)a.status!==5&&a.status!==4&&(this.emit("relay:connecting",a),a.connect().catch(c=>{this.debug(`Failed to connect to relay ${a.url}: ${c??"No reason specified"}`)}));const s=()=>n.every(a=>a.status===5),r=new Promise(a=>{if(s()){a();return}const c=[];for(const l of n){const u=()=>{if(s()){for(let f=0;f<n.length;f++)n[f].off("connect",c[f]);a()}};c.push(u),l.on("connect",u)}}),o=typeof e=="number"?new Promise(a=>setTimeout(a,e)):new Promise(()=>{});await Promise.race([r,o])}checkOnFlappingRelays(){const e=this.flappingRelays.size,n=this.relays.size;if(e/n>=.8)for(const s of this.flappingRelays)this.backoffTimes.set(s,0)}recordDisconnection(e){const n=Date.now();this.disconnectionTimes.set(e.url,n);for(const[s,r]of this.disconnectionTimes.entries())n-r>1e4&&this.disconnectionTimes.delete(s);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const e=Date.now(),n=[];for(const s of this.disconnectionTimes.values())e-s<5e3&&n.push(s);n.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${n.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){if(this.systemEventDetector){this.debug("System-wide reconnection already in progress, skipping");return}this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const e of this.relays.values())e.connectivity&&(e.connectivity.resetReconnectionState(),e.status!==5&&e.status!==4&&e.connect().catch(n=>{this.debug(`Failed to reconnect relay ${e.url} after system event: ${n}`)}));this.disconnectionTimes.clear()}handleFlapping(e){this.debug(`Relay ${e.url} is flapping`);let n=this.backoffTimes.get(e.url)||5e3;n=n*2,this.backoffTimes.set(e.url,n),this.debug(`Backoff time for ${e.url} is ${n}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${e.url}`),this.emit("relay:connecting",e),e.connect(),this.checkOnFlappingRelays()},n),e.disconnect(),this.emit("flapping",e)}size(){return this.relays.size}stats(){const e={total:0,connected:0,disconnected:0,connecting:0};for(const n of this.relays.values())e.total++,n.status===5?e.connected++:n.status===1?e.disconnected++:n.status===4&&e.connecting++;return e}connectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5&&!this.temporaryRelayTimers.has(e.url))}urls(){return Array.from(this.relays.keys())}},Te,NDKDVMJobFeedback=(Te=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=7e3)}static async from(e){const n=new Te(e.ndk,e.rawEvent());return n.encrypted&&await n.dvmDecrypt(),n}get status(){return this.tagValue("status")}set status(e){this.removeTag("status"),e!==void 0&&this.tags.push(["status",e])}get encrypted(){return!!this.getMatchingTags("encrypted")[0]}async dvmDecrypt(){await this.decrypt();const e=JSON.parse(this.content);this.tags.push(...e)}},g(Te,"kinds",[7e3]),Te),te,NDKCashuMintList=(te=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"_p2pk");this.kind??(this.kind=10019)}static from(n){return new te(n.ndk,n)}set relays(n){this.tags=this.tags.filter(s=>s[0]!=="relay");for(const s of n)this.tags.push(["relay",s])}get relays(){const n=[];for(const s of this.tags)s[0]==="relay"&&n.push(s[1]);return n}set mints(n){this.tags=this.tags.filter(s=>s[0]!=="mint");for(const s of n)this.tags.push(["mint",s])}get mints(){const n=[];for(const s of this.tags)s[0]==="mint"&&n.push(s[1]);return Array.from(new Set(n))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(n){this._p2pk=n,this.removeTag("pubkey"),n&&this.tags.push(["pubkey",n])}get relaySet(){return NDKRelaySet.fromRelayUrls(this.relays,this.ndk)}},g(te,"kind",10019),g(te,"kinds",[10019]),te),ne,NDKArticle=(ne=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=30023)}static from(e){return new ne(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e){let n=Number.parseInt(e);return n>1e12&&(n=Math.floor(n/1e3)),n}}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get url(){return this.tagValue("url")}set url(e){e?this.tags.push(["url",e]):this.removeTag("url")}},g(ne,"kind",30023),g(ne,"kinds",[30023]),ne),Se,NDKBlossomList=(Se=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=10063)}static from(e){return new Se(e.ndk,e.rawEvent())}get servers(){return this.tags.filter(e=>e[0]==="server").map(e=>e[1])}set servers(e){this.tags=this.tags.filter(n=>n[0]!=="server");for(const n of e)this.tags.push(["server",n])}get default(){const e=this.servers;return e.length>0?e[0]:void 0}set default(e){if(!e)return;const s=this.servers.filter(r=>r!==e);this.servers=[e,...s]}addServer(e){if(!e)return;const n=this.servers;n.includes(e)||(this.servers=[...n,e])}removeServer(e){if(!e)return;const n=this.servers;this.servers=n.filter(s=>s!==e)}},g(Se,"kinds",[10063]),Se),se,NDKFedimintMint=(se=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=38173)}static async from(e){return new se(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get inviteCodes(){return this.getMatchingTags("u").map(e=>e[1])}set inviteCodes(e){this.removeTag("u");for(const n of e)this.tags.push(["u",n])}get modules(){return this.getMatchingTags("modules").map(e=>e[1])}set modules(e){this.removeTag("modules");for(const n of e)this.tags.push(["modules",n])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},g(se,"kind",38173),g(se,"kinds",[38173]),se),re,NDKCashuMintAnnouncement=(re=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=38172)}static async from(e){return new re(e.ndk,e)}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get url(){return this.tagValue("u")}set url(e){this.removeTag("u"),e&&this.tags.push(["u",e])}get nuts(){return this.getMatchingTags("nuts").map(e=>e[1])}set nuts(e){this.removeTag("nuts");for(const n of e)this.tags.push(["nuts",n])}get network(){return this.tagValue("n")}set network(e){this.removeTag("n"),e&&this.tags.push(["n",e])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(e){e?this.content=JSON.stringify(e):this.content=""}},g(re,"kind",38172),g(re,"kinds",[38172]),re),ie,NDKMintRecommendation=(ie=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=38e3)}static async from(e){return new ie(e.ndk,e)}get recommendedKind(){const e=this.tagValue("k");return e?Number(e):void 0}set recommendedKind(e){this.removeTag("k"),e&&this.tags.push(["k",e.toString()])}get identifier(){return this.tagValue("d")}set identifier(e){this.removeTag("d"),e&&this.tags.push(["d",e])}get urls(){return this.getMatchingTags("u").map(e=>e[1])}set urls(e){this.removeTag("u");for(const n of e)this.tags.push(["u",n])}get mintEventPointers(){return this.getMatchingTags("a").map(e=>({kind:Number(e[1].split(":")[0]),identifier:e[1].split(":")[2],relay:e[2]}))}addMintEventPointer(e,n,s,r){const o=["a",`${e}:${n}:${s}`];r&&o.push(r),this.tags.push(o)}get review(){return this.content}set review(e){this.content=e}},g(ie,"kind",38e3),g(ie,"kinds",[38e3]),ie),Re,NDKClassified=(Re=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=30402)}static from(e){return new Re(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get summary(){return this.tagValue("summary")}set summary(e){this.removeTag("summary"),e&&this.tags.push(["summary",e])}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}set published_at(e){this.removeTag("published_at"),e!==void 0&&this.tags.push(["published_at",e.toString()])}get location(){return this.tagValue("location")}set location(e){this.removeTag("location"),e&&this.tags.push(["location",e])}get price(){const e=this.tags.find(n=>n[0]==="price");if(e)return{amount:Number.parseFloat(e[1]),currency:e[2],frequency:e[3]}}set price(e){if(typeof e=="string"&&(e={amount:Number.parseFloat(e)}),e!=null&&e.amount){const n=["price",e.amount.toString()];e.currency&&n.push(e.currency),e.frequency&&n.push(e.frequency),this.tags.push(n)}else this.removeTag("price")}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}},g(Re,"kinds",[30402]),Re),oe,NDKDraft=(oe=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"_event");g(this,"counterparty");this.kind??(this.kind=31234)}static from(n){return new oe(n.ndk,n)}set identifier(n){this.removeTag("d"),this.tags.push(["d",n])}get identifier(){return this.dTag}set event(n){n instanceof NDKEvent?this._event=n:this._event=new NDKEvent(void 0,n),this.prepareEvent()}set checkpoint(n){n?(this.tags.push(n.tagReference()),this.kind=1234):(this.removeTag("a"),this.kind=31234)}get isCheckpoint(){return this.kind===1234}get isProposal(){const n=this.tagValue("p");return!!n&&n!==this.pubkey}async getEvent(n){var s;if(this._event)return this._event;if(n??(n=(s=this.ndk)==null?void 0:s.signer),!n)throw new Error("No signer available");if(this.content&&this.content.length>0)try{const r=n.pubkey,a=[this.tagValue("p"),this.pubkey].filter(Boolean).find(u=>u!==r);let c;c=new NDKUser({pubkey:a??r}),await this.decrypt(c,n);const l=JSON.parse(this.content);return this._event=await wrapEvent(new NDKEvent(this.ndk,l)),this._event}catch(r){console.error(r);return}else return null}prepareEvent(){if(!this._event)throw new Error("No event has been provided");this.removeTag("k"),this._event.kind&&this.tags.push(["k",this._event.kind.toString()]),this.content=JSON.stringify(this._event.rawEvent())}async save({signer:n,publish:s,relaySet:r}){var a;if(n??(n=(a=this.ndk)==null?void 0:a.signer),!n)throw new Error("No signer available");const o=this.counterparty||await n.user();if(await this.encrypt(o,n),this.counterparty){const c=this.counterparty.pubkey;this.removeTag("p"),this.tags.push(["p",c])}if(s!==!1)return this.publishReplaceable(r)}},g(oe,"kind",31234),g(oe,"kinds",[31234,1234]),oe);function mapImetaTag(t){const e={};if(t.length===2){const s=t[1].split(" ");for(let r=0;r<s.length;r+=2){const o=s[r],a=s[r+1];o==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(a)):e[o]=a}return e}const n=t.slice(1);for(const s of n){const r=s.split(" "),o=r[0],a=r.slice(1).join(" ");o==="fallback"?(e.fallback||(e.fallback=[]),e.fallback.push(a)):e[o]=a}return e}function imetaTagToTag(t){const e=["imeta"];for(const[n,s]of Object.entries(t))if(Array.isArray(s))for(const r of s)e.push(`${n} ${r}`);else s&&e.push(`${n} ${s}`);return e}var ae,NDKFollowPack=(ae=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=39089)}static from(e){return new ae(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get image(){const e=this.tags.find(n=>n[0]==="imeta");if(e){const n=mapImetaTag(e);if(n.url)return n.url}return this.tagValue("image")}set image(e){this.tags=this.tags.filter(n=>n[0]!=="imeta"&&n[0]!=="image"),typeof e=="string"?e!==void 0&&this.tags.push(["image",e]):e&&typeof e=="object"&&(this.tags.push(imetaTagToTag(e)),e.url&&this.tags.push(["image",e.url]))}get pubkeys(){return Array.from(new Set(this.tags.filter(e=>e[0]==="p"&&e[1]&&isValidPubkey(e[1])).map(e=>e[1])))}set pubkeys(e){this.tags=this.tags.filter(n=>n[0]!=="p");for(const n of e)this.tags.push(["p",n])}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}},g(ae,"kind",39089),g(ae,"kinds",[39089,39092]),ae),ce,NDKHighlight=(ce=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"_article");this.kind??(this.kind=9802)}static from(n){return new ce(n.ndk,n)}get url(){return this.tagValue("r")}set context(n){n===void 0?this.tags=this.tags.filter(([s,r])=>s!=="context"):(this.tags=this.tags.filter(([s,r])=>s!=="context"),this.tags.push(["context",n]))}get context(){var n;return((n=this.tags.find(([s,r])=>s==="context"))==null?void 0:n[1])??void 0}get article(){return this._article}set article(n){this._article=n,typeof n=="string"?this.tags.push(["r",n]):this.tag(n)}getArticleTag(){return this.getMatchingTags("a")[0]||this.getMatchingTags("e")[0]||this.getMatchingTags("r")[0]}async getArticle(){var r;if(this._article!==void 0)return this._article;let n;const s=this.getArticleTag();if(s){switch(s[0]){case"a":{const[o,a,c]=s[1].split(":");n=nip19_exports$1.naddrEncode({kind:Number.parseInt(o),pubkey:a,identifier:c});break}case"e":n=nip19_exports$1.noteEncode(s[1]);break;case"r":this._article=s[1];break}if(n){let o=await((r=this.ndk)==null?void 0:r.fetchEvent(n));o&&(o.kind===30023&&(o=NDKArticle.from(o)),this._article=o)}return this._article}}},g(ce,"kind",9802),g(ce,"kinds",[9802]),ce),le,NDKImage=(le=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"_imetas");this.kind??(this.kind=20)}static from(n){return new le(n.ndk,n.rawEvent())}get isValid(){return this.imetas.length>0}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(n=>n[0]==="imeta").map(mapImetaTag).filter(n=>!!n.url),this._imetas)}set imetas(n){this._imetas=n,this.tags=this.tags.filter(s=>s[0]!=="imeta"),this.tags.push(...n.map(imetaTagToTag))}},g(le,"kind",20),g(le,"kinds",[20]),le),Ae,NDKList=(Ae=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"_encryptedTags");g(this,"encryptedTagsLength");this.kind??(this.kind=30001)}static from(n){return new Ae(n.ndk,n)}get title(){const n=this.tagValue("title")||this.tagValue("name");return n||(this.kind===3?"Contacts":this.kind===1e4?"Mute":this.kind===10001?"Pinned Notes":this.kind===10002?"Relay Metadata":this.kind===10003?"Bookmarks":this.kind===10004?"Communities":this.kind===10005?"Public Chats":this.kind===10006?"Blocked Relays":this.kind===10007?"Search Relays":this.kind===10050?"Direct Message Receive Relays":this.kind===10015?"Interests":this.kind===10030?"Emojis":this.tagValue("d"))}set title(n){this.removeTag(["title","name"]),n&&this.tags.push(["title",n])}get name(){return this.title}set name(n){this.title=n}get description(){return this.tagValue("description")}set description(n){this.removeTag("description"),n&&this.tags.push(["description",n])}get image(){return this.tagValue("image")}set image(n){this.removeTag("image"),n&&this.tags.push(["image",n])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(n=!0){if(n&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const s=await this.ndk.signer.user();try{if(this.content.length>0)try{const r=await this.ndk.signer.decrypt(s,this.content),o=JSON.parse(r);return o!=null&&o[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=o):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch{}}catch{}return[]}validateTag(n){return!0}getItems(n){return this.tags.filter(s=>s[0]===n)}get items(){return this.tags.filter(n=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(n[0]))}async addItem(n,s=void 0,r=!1,o="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let a;if(n instanceof NDKEvent)a=[n.tagReference(s)];else if(n instanceof NDKUser)a=n.referenceTags();else if(n instanceof NDKRelay)a=n.referenceTags();else if(Array.isArray(n))a=[n];else throw new Error("Invalid object type");if(s&&a[0].push(s),r){const c=await this.ndk.signer.user(),l=await this.encryptedTags();o==="top"?l.unshift(...a):l.push(...a),this._encryptedTags=l,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(l),await this.encrypt(c)}else o==="top"?this.tags.unshift(...a):this.tags.push(...a);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(n,s=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const r=this.tags.findIndex(l=>l[1]===n);r>=0&&this.tags.splice(r,1);const o=await this.ndk.signer.user(),a=await this.encryptedTags(),c=a.findIndex(l=>l[1]===n);if(c>=0&&(a.splice(c,1),this._encryptedTags=a,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(a),await this.encrypt(o)),s)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(n,s){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(s){const r=await this.ndk.signer.user(),o=await this.encryptedTags();o.splice(n,1),this._encryptedTags=o,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(o),await this.encrypt(r)}else this.tags.splice(n,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(n){return this.items.some(s=>s[1]===n)}filterForItems(){const n=new Set,s=new Map,r=[];for(const o of this.items)if(o[0]==="e"&&o[1])n.add(o[1]);else if(o[0]==="a"&&o[1]){const[a,c,l]=o[1].split(":");if(!a||!c)continue;const u=`${a}:${c}`,f=s.get(u)||[];f.push(l||""),s.set(u,f)}if(n.size>0&&r.push({ids:Array.from(n)}),s.size>0)for(const[o,a]of s.entries()){const[c,l]=o.split(":");r.push({kinds:[Number.parseInt(c)],authors:[l],"#d":a})}return r}},g(Ae,"kinds",[30001,10004,10050,10030,10015,10001,10002,10007,10006,10003]),Ae),Ce,NDKAppHandlerEvent=(Ce=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"profile");this.kind??(this.kind=31990)}static from(n){const s=new Ce(n.ndk,n.rawEvent());return s.isValid?s:null}get isValid(){const n=new Map,s=o=>[o[0],o[2]].join(":").toLowerCase(),r=["web","android","ios"];for(const o of this.tags)if(r.includes(o[0])){const a=s(o);if(n.has(a)&&n.get(a)!==o[1].toLowerCase())return!1;n.set(a,o[1].toLowerCase())}return!0}async fetchProfile(){if(this.profile===void 0&&this.content.length>0)try{const n=JSON.parse(this.content);if(n!=null&&n.name)return n;this.profile=null}catch{this.profile=null}return new Promise((n,s)=>{const r=this.author;r.fetchProfile().then(()=>{n(r.profile)}).catch(s)})}},g(Ce,"kinds",[31990]),Ce),Q,NDKNutzap=(Q=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"debug");g(this,"_proofs",[]);g(this,"sender",this.author);this.kind??(this.kind=9321),this.debug=(n==null?void 0:n.debug.extend("nutzap"))??createDebug5("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const r=this.getMatchingTags("proof");r.length?this._proofs=r.map(o=>JSON.parse(o[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(n){const s=new Q(n.ndk,n);if(!(!s._proofs||!s._proofs.length))return s}set comment(n){this.content=n??""}get comment(){const n=this.tagValue("comment");return n||this.content}set proofs(n){this._proofs=n,this.tags=this.tags.filter(s=>s[0]!=="proof");for(const s of n)this.tags.push(["proof",JSON.stringify(s)])}get proofs(){return this._proofs}get rawP2pk(){var s;const n=this.proofs[0];try{const r=JSON.parse(n.secret);let o;if(typeof r=="string"?(o=JSON.parse(r),this.debug("stringified payload",n.secret)):typeof r=="object"&&(o=r),Array.isArray(o)&&o[0]==="P2PK"&&o.length>1&&typeof o[1]=="object"&&o[1]!==null||typeof o=="object"&&o!==null&&typeof((s=o[1])==null?void 0:s.data)=="string")return o[1].data}catch(r){this.debug("error parsing p2pk pubkey",r,this.proofs[0])}}get p2pk(){const n=this.rawP2pk;if(n)return n.startsWith("02")?n.slice(2):n}get mint(){return this.tagValue("u")}set mint(n){this.replaceTag(["u",n])}get unit(){let n=this.tagValue("unit")??"sat";return n!=null&&n.startsWith("msat")&&(n="sat"),n}set unit(n){if(this.removeTag("unit"),n!=null&&n.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");n&&this.tag(["unit",n])}get amount(){return this.proofs.reduce((s,r)=>s+r.amount,0)}set target(n){this.tags=this.tags.filter(s=>s[0]!=="p"),n instanceof NDKEvent&&this.tags.push(n.tagReference())}set recipientPubkey(n){this.removeTag("p"),this.tag(["p",n])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const n=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:n}):new NDKUser({pubkey:n})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const n=await super.toNostrEvent();return n.content=this.comment,n}get isValid(){let n=0,s=0,r=0;for(const o of this.tags)o[0]==="e"&&n++,o[0]==="p"&&s++,o[0]==="u"&&r++;return s===1&&r===1&&n<=1&&this.proofs.length>0}},g(Q,"kind",9321),g(Q,"kinds",[Q.kind]),Q),ue,NDKProject=(ue=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"_signer");this.kind=31933}static from(n){return new ue(n.ndk,n.rawEvent())}set repo(n){this.removeTag("repo"),n&&this.tags.push(["repo",n])}set hashtags(n){this.removeTag("hashtags"),n.filter(s=>s.length>0).length&&this.tags.push(["hashtags",...n])}get hashtags(){const n=this.tags.find(s=>s[0]==="hashtags");return n?n.slice(1):[]}get repo(){return this.tagValue("repo")}get title(){return this.tagValue("title")}set title(n){this.removeTag("title"),n&&this.tags.push(["title",n])}get picture(){return this.tagValue("picture")}set picture(n){this.removeTag("picture"),n&&this.tags.push(["picture",n])}set description(n){this.content=n}get description(){return this.content}get slug(){return this.dTag??"empty-dtag"}async getSigner(){var s,r;if(this._signer)return this._signer;const n=this.tagValue("key");if(!n)this._signer=NDKPrivateKeySigner.generate(),await this.encryptAndSaveNsec();else{const o=await((r=(s=this.ndk)==null?void 0:s.signer)==null?void 0:r.decrypt(this.ndk.activeUser,n));if(!o)throw new Error("Failed to decrypt project key or missing signer context.");this._signer=new NDKPrivateKeySigner(o)}return this._signer}async getNsec(){return(await this.getSigner()).privateKey}async setNsec(n){this._signer=new NDKPrivateKeySigner(n),await this.encryptAndSaveNsec()}async encryptAndSaveNsec(){var r,o;if(!this._signer)throw new Error("Signer is not set.");const n=this._signer.privateKey,s=await((o=(r=this.ndk)==null?void 0:r.signer)==null?void 0:o.encrypt(this.ndk.activeUser,n));s&&(this.removeTag("key"),this.tags.push(["key",s]))}},g(ue,"kind",31933),g(ue,"kinds",[31933]),ue),he,NDKProjectTemplate=(he=class extends NDKEvent{constructor(e,n){super(e,n),this.kind=30717}static from(e){return new he(e.ndk,e.rawEvent())}get templateId(){return this.dTag??""}set templateId(e){this.dTag=e}get name(){return this.tagValue("title")??""}set name(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get description(){return this.tagValue("description")??""}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get repoUrl(){return this.tagValue("uri")??""}set repoUrl(e){this.removeTag("uri"),e&&this.tags.push(["uri",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}get command(){return this.tagValue("command")}set command(e){this.removeTag("command"),e&&this.tags.push(["command",e])}get agentConfig(){const e=this.tagValue("agent");if(e)try{return JSON.parse(e)}catch{return}}set agentConfig(e){this.removeTag("agent"),e&&this.tags.push(["agent",JSON.stringify(e)])}get templateTags(){return this.getMatchingTags("t").map(e=>e[1]).filter(Boolean)}set templateTags(e){this.tags=this.tags.filter(n=>n[0]!=="t"),e.forEach(n=>{n&&this.tags.push(["t",n])})}},g(he,"kind",30717),g(he,"kinds",[30717]),he),READ_MARKER="read",WRITE_MARKER="write",Ie,NDKRelayList=(Ie=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=10002)}static from(e){return new Ie(e.ndk,e.rawEvent())}get readRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===READ_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set readRelayUrls(e){for(const n of e)this.tags.push(["r",n,READ_MARKER])}get writeRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]||e[2]&&e[2]===WRITE_MARKER).map(e=>tryNormalizeRelayUrl(e[1])).filter(e=>!!e)}set writeRelayUrls(e){for(const n of e)this.tags.push(["r",n,WRITE_MARKER])}get bothRelayUrls(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").filter(e=>!e[2]).map(e=>e[1])}set bothRelayUrls(e){for(const n of e)this.tags.push(["r",n])}get relays(){return this.tags.filter(e=>e[0]==="r"||e[0]==="relay").map(e=>e[1])}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new NDKRelaySet(new Set(this.relays.map(e=>{var n;return(n=this.ndk)==null?void 0:n.pool.getRelay(e)}).filter(e=>!!e)),this.ndk)}},g(Ie,"kinds",[10002]),Ie);function relayListFromKind3(t,e){try{const n=JSON.parse(e.content),s=new NDKRelayList(t),r=new Set,o=new Set;for(let[a,c]of Object.entries(n)){try{a=normalizeRelayUrl(a)}catch{continue}if(!c)r.add(a),o.add(a);else{const l=c;l.write&&o.add(a),l.read&&r.add(a)}}return s.readRelayUrls=Array.from(r),s.writeRelayUrls=Array.from(o),s}catch{}}var Be,NDKRepost=(Be=class extends NDKEvent{constructor(){super(...arguments);g(this,"_repostedEvents")}static from(n){return new Be(n.ndk,n.rawEvent())}async repostedEvents(n,s){const r=[];if(!this.ndk)throw new Error("NDK instance not set");if(this._repostedEvents!==void 0)return this._repostedEvents;for(const o of this.repostedEventIds()){const a=filterForId(o),c=await this.ndk.fetchEvent(a,s);c&&r.push(n?n.from(c):c)}return r}repostedEventIds(){return this.tags.filter(n=>n[0]==="e"||n[0]==="a").map(n=>n[1])}},g(Be,"kinds",[6,16]),Be);function filterForId(t){if(t.match(/:/)){const[e,n,s]=t.split(":");return{kinds:[Number.parseInt(e)],authors:[n],"#d":[s]}}return{ids:[t]}}var de,NDKSimpleGroupMemberList=(de=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"relaySet");g(this,"memberSet",new Set);this.kind??(this.kind=39002),this.memberSet=new Set(this.members)}static from(n){return new de(n.ndk,n)}get members(){return this.getMatchingTags("p").map(n=>n[1])}hasMember(n){return this.memberSet.has(n)}async publish(n,s,r){return n??(n=this.relaySet),super.publishReplaceable(n,s,r)}},g(de,"kind",39002),g(de,"kinds",[39002]),de),pe,NDKSimpleGroupMetadata=(pe=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=39e3)}static from(e){return new pe(e.ndk,e)}get name(){return this.tagValue("name")}get picture(){return this.tagValue("picture")}get about(){return this.tagValue("about")}get scope(){if(this.getMatchingTags("public").length>0)return"public";if(this.getMatchingTags("public").length>0)return"private"}set scope(e){this.removeTag("public"),this.removeTag("private"),e==="public"?this.tags.push(["public",""]):e==="private"&&this.tags.push(["private",""])}get access(){if(this.getMatchingTags("open").length>0)return"open";if(this.getMatchingTags("closed").length>0)return"closed"}set access(e){this.removeTag("open"),this.removeTag("closed"),e==="open"?this.tags.push(["open",""]):e==="closed"&&this.tags.push(["closed",""])}},g(pe,"kind",39e3),g(pe,"kinds",[39e3]),pe);function strToPosition(t){const[e,n]=t.split(",").map(Number);return{x:e,y:n}}function strToDimension(t){const[e,n]=t.split("x").map(Number);return{width:e,height:n}}var J,NDKStorySticker=(J=class{constructor(e){g(this,"type");g(this,"value");g(this,"position");g(this,"dimension");g(this,"properties");g(this,"hasValidDimensions",()=>typeof this.dimension.width=="number"&&typeof this.dimension.height=="number"&&!Number.isNaN(this.dimension.width)&&!Number.isNaN(this.dimension.height));g(this,"hasValidPosition",()=>typeof this.position.x=="number"&&typeof this.position.y=="number"&&!Number.isNaN(this.position.x)&&!Number.isNaN(this.position.y));if(Array.isArray(e)){const n=e;if(n[0]!=="sticker"||n.length<5)throw new Error("Invalid sticker tag");this.type=n[1],this.value=n[2],this.position=strToPosition(n[3]),this.dimension=strToDimension(n[4]);const s={};for(let r=5;r<n.length;r++){const[o,...a]=n[r].split(" ");s[o]=a.join(" ")}Object.keys(s).length>0&&(this.properties=s)}else this.type=e,this.value=void 0,this.position={x:0,y:0},this.dimension={width:0,height:0}}static fromTag(e){try{return new J(e)}catch{return null}}get style(){var e;return(e=this.properties)==null?void 0:e.style}set style(e){var n;e?this.properties={...this.properties,style:e}:(n=this.properties)==null||delete n.style}get rotation(){var e;return(e=this.properties)!=null&&e.rot?Number.parseFloat(this.properties.rot):void 0}set rotation(e){var n;e!==void 0?this.properties={...this.properties,rot:e.toString()}:(n=this.properties)==null||delete n.rot}get isValid(){return this.hasValidDimensions()&&this.hasValidPosition()}toTag(){if(!this.isValid){const s=[this.hasValidDimensions()?void 0:"dimensions is invalid",this.hasValidPosition()?void 0:"position is invalid"].filter(Boolean);throw new Error(`Invalid sticker: ${s.join(", ")}`)}let e;switch(this.type){case"event":e=this.value.tagId();break;case"pubkey":e=this.value.pubkey;break;default:e=this.value}const n=["sticker",this.type,e,coordinates(this.position),dimension(this.dimension)];if(this.properties)for(const[s,r]of Object.entries(this.properties))n.push(`${s} ${r}`);return n}},g(J,"Text","text"),g(J,"Pubkey","pubkey"),g(J,"Event","event"),g(J,"Prompt","prompt"),g(J,"Countdown","countdown"),J),ye,NDKStory=(ye=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"_imeta");g(this,"_dimensions");if(this.kind??(this.kind=23),s)for(const r of s.tags)switch(r[0]){case"imeta":this._imeta=mapImetaTag(r);break;case"dim":this.dimensions=strToDimension(r[1]);break}}static from(n){return new ye(n.ndk,n)}get isValid(){return!!this.imeta}get imeta(){return this._imeta}set imeta(n){this._imeta=n,this.tags=this.tags.filter(s=>s[0]!=="imeta"),n&&this.tags.push(imetaTagToTag(n))}get dimensions(){const n=this.tagValue("dim");if(n)return strToDimension(n)}set dimensions(n){this.removeTag("dim"),n&&this.tags.push(["dim",`${n.width}x${n.height}`])}get duration(){const n=this.tagValue("dur");if(n)return Number.parseInt(n)}set duration(n){this.removeTag("dur"),n!==void 0&&this.tags.push(["dur",n.toString()])}get stickers(){const n=[];for(const s of this.tags){if(s[0]!=="sticker"||s.length<5)continue;const r=NDKStorySticker.fromTag(s);r&&n.push(r)}return n}addSticker(n){let s;if(n instanceof NDKStorySticker)s=n;else{const r=["sticker",n.type,typeof n.value=="string"?n.value:"",coordinates(n.position),dimension(n.dimension)];if(n.properties)for(const[o,a]of Object.entries(n.properties))r.push(`${o} ${a}`);s=new NDKStorySticker(r),s.value=n.value}s.type==="pubkey"?this.tag(s.value):s.type==="event"&&this.tag(s.value),this.tags.push(s.toTag())}removeSticker(n){const s=this.stickers;if(n<0||n>=s.length)return;let r=0;for(let o=0;o<this.tags.length;o++)if(this.tags[o][0]==="sticker"){if(r===n){this.tags.splice(o,1);break}r++}}},g(ye,"kind",23),g(ye,"kinds",[23]),ye),coordinates=t=>`${t.x},${t.y}`,dimension=t=>`${t.width}x${t.height}`,Ne,NDKSubscriptionReceipt=(Ne=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"debug");this.kind??(this.kind=7003),this.debug=(n==null?void 0:n.debug.extend("subscription-start"))??createDebug5("ndk:subscription-start")}static from(n){return new Ne(n.ndk,n.rawEvent())}get recipient(){var r;const n=(r=this.getMatchingTags("p"))==null?void 0:r[0];return n?new NDKUser({pubkey:n[1]}):void 0}set recipient(n){this.removeTag("p"),n&&this.tags.push(["p",n.pubkey])}get subscriber(){var r;const n=(r=this.getMatchingTags("P"))==null?void 0:r[0];return n?new NDKUser({pubkey:n[1]}):void 0}set subscriber(n){this.removeTag("P"),n&&this.tags.push(["P",n.pubkey])}set subscriptionStart(n){this.debug(`before setting subscription start: ${this.rawEvent}`),this.removeTag("e"),this.tag(n,"subscription",!0),this.debug(`after setting subscription start: ${this.rawEvent}`)}get tierName(){var s;const n=(s=this.getMatchingTags("tier"))==null?void 0:s[0];return n==null?void 0:n[1]}get isValid(){const n=this.validPeriod;if(!n||n.start>n.end)return!1;const s=this.getMatchingTags("p"),r=this.getMatchingTags("P");return!(s.length!==1||r.length!==1)}get validPeriod(){var s;const n=(s=this.getMatchingTags("valid"))==null?void 0:s[0];if(n)try{return{start:new Date(Number.parseInt(n[1])*1e3),end:new Date(Number.parseInt(n[2])*1e3)}}catch{return}}set validPeriod(n){this.removeTag("valid"),n&&this.tags.push(["valid",Math.floor(n.start.getTime()/1e3).toString(),Math.floor(n.end.getTime()/1e3).toString()])}get startPeriod(){var n;return(n=this.validPeriod)==null?void 0:n.start}get endPeriod(){var n;return(n=this.validPeriod)==null?void 0:n.end}isActive(n){n??(n=new Date);const s=this.validPeriod;return!(!s||n<s.start||n>s.end)}},g(Ne,"kinds",[7003]),Ne),possibleIntervalFrequencies=["daily","weekly","monthly","quarterly","yearly"];function newAmount(t,e,n){return["amount",t.toString(),e,n]}function parseTagToSubscriptionAmount(t){const e=Number.parseInt(t[1]);if(Number.isNaN(e)||e===void 0||e===null||e<=0)return;const n=t[2];if(n===void 0||n==="")return;const s=t[3];if(s!==void 0&&possibleIntervalFrequencies.includes(s))return{amount:e,currency:n,term:s}}var me,NDKSubscriptionTier=(me=class extends NDKArticle{constructor(e,n){const s=(n==null?void 0:n.kind)??37001;super(e,n),this.kind=s}static from(e){return new me(e.ndk,e)}get perks(){return this.getMatchingTags("perk").map(e=>e[1]).filter(e=>e!==void 0)}addPerk(e){this.tags.push(["perk",e])}get amounts(){return this.getMatchingTags("amount").map(e=>parseTagToSubscriptionAmount(e)).filter(e=>e!==void 0)}addAmount(e,n,s){this.tags.push(newAmount(e,n,s))}set relayUrl(e){this.tags.push(["r",e])}get relayUrls(){return this.getMatchingTags("r").map(e=>e[1]).filter(e=>e!==void 0)}get verifierPubkey(){return this.tagValue("p")}set verifierPubkey(e){this.removeTag("p"),e&&this.tags.push(["p",e])}get isValid(){return this.title!==void 0&&this.amounts.length>0}},g(me,"kind",37001),g(me,"kinds",[37001]),me),Pe,NDKSubscriptionStart=(Pe=class extends NDKEvent{constructor(n,s){super(n,s);g(this,"debug");this.kind??(this.kind=7001),this.debug=(n==null?void 0:n.debug.extend("subscription-start"))??createDebug5("ndk:subscription-start")}static from(n){return new Pe(n.ndk,n.rawEvent())}get recipient(){var r;const n=(r=this.getMatchingTags("p"))==null?void 0:r[0];return n?new NDKUser({pubkey:n[1]}):void 0}set recipient(n){this.removeTag("p"),n&&this.tags.push(["p",n.pubkey])}get amount(){var s;const n=(s=this.getMatchingTags("amount"))==null?void 0:s[0];if(n)return parseTagToSubscriptionAmount(n)}set amount(n){this.removeTag("amount"),n&&this.tags.push(newAmount(n.amount,n.currency,n.term))}get tierId(){var r,o;const n=(r=this.getMatchingTags("e"))==null?void 0:r[0],s=(o=this.getMatchingTags("a"))==null?void 0:o[0];if(!(!n||!s))return n[1]??s[1]}set tier(n){this.removeTag("e"),this.removeTag("a"),this.removeTag("event"),n&&(this.tag(n),this.removeTag("p"),this.tags.push(["p",n.pubkey]),this.tags.push(["event",JSON.stringify(n.rawEvent())]))}async fetchTier(){var o;const n=this.tagValue("event");if(n)try{const a=JSON.parse(n);return new NDKSubscriptionTier(this.ndk,a)}catch{this.debug("Failed to parse event tag")}const s=this.tierId;if(!s)return;const r=await((o=this.ndk)==null?void 0:o.fetchEvent(s));if(r)return NDKSubscriptionTier.from(r)}get isValid(){return this.getMatchingTags("amount").length!==1?(this.debug("Invalid # of amount tag"),!1):this.amount?this.getMatchingTags("p").length!==1?(this.debug("Invalid # of p tag"),!1):this.recipient?!0:(this.debug("Invalid p tag"),!1):(this.debug("Invalid amount tag"),!1)}},g(Pe,"kinds",[7001]),Pe),be,NDKTask=(be=class extends NDKEvent{constructor(e,n){super(e,n),this.kind=1934}static from(e){return new be(e.ndk,e.rawEvent())}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get title(){return this.tagValue("title")}set project(e){this.removeTag("a"),this.tags.push(e.tagReference())}get projectSlug(){var n;const e=this.getMatchingTags("a")[0];return e?(n=e[1].split(/:/))==null?void 0:n[2]:void 0}},g(be,"kind",1934),g(be,"kinds",[1934]),be),we,NDKThread=(we=class extends NDKEvent{constructor(e,n){super(e,n),this.kind??(this.kind=11)}static from(e){return new we(e.ndk,e)}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}},g(we,"kind",11),g(we,"kinds",[11]),we),ve,NDKVideo=(ve=class extends NDKEvent{constructor(){super(...arguments);g(this,"_imetas")}static from(n){return new ve(n.ndk,n.rawEvent())}get title(){return this.tagValue("title")}set title(n){this.removeTag("title"),n&&this.tags.push(["title",n])}get thumbnail(){var s;let n;return this.imetas&&this.imetas.length>0&&(n=(s=this.imetas[0].image)==null?void 0:s[0]),n??this.tagValue("thumb")}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(n=>n[0]==="imeta").map(mapImetaTag),this._imetas)}set imetas(n){this._imetas=n,this.tags=this.tags.filter(s=>s[0]!=="imeta"),this.tags.push(...n.map(imetaTagToTag))}get url(){return this.imetas&&this.imetas.length>0?this.imetas[0].url:this.tagValue("url")}get published_at(){const n=this.tagValue("published_at");if(n)return Number.parseInt(n)}async generateTags(){var n,s;if(super.generateTags(),!this.kind&&(s=(n=this.imetas)==null?void 0:n[0])!=null&&s.dim){const[r,o]=this.imetas[0].dim.split("x"),a=r&&o&&Number.parseInt(r)<Number.parseInt(o);this.duration&&this.duration<120&&a?this.kind=22:this.kind=21}return super.generateTags()}get duration(){const n=this.tagValue("duration");if(n)return Number.parseInt(n)}set duration(n){this.removeTag("duration"),n!==void 0&&this.tags.push(["duration",Math.floor(n).toString()])}},g(ve,"kind",21),g(ve,"kinds",[34235,34236,22,21]),ve),Ee,NDKWiki=(Ee=class extends NDKArticle{static from(e){return new Ee(e.ndk,e.rawEvent())}get isDefered(){return this.hasTag("a","defer")}get deferedId(){return this.tagValue("a","defer")}set defer(e){this.removeTag("a","defer"),this.tag(e,"defer")}},g(Ee,"kind",30818),g(Ee,"kinds",[30818]),Ee),Le,NDKWikiMergeRequest=(Le=class extends NDKEvent{static from(e){return new Le(e.ndk,e.rawEvent())}get targetId(){return this.tagValue("a")}set target(e){this.tags=this.tags.filter(n=>{if(n[0]==="a"||n[0]==="e"&&n[3]!=="source")return!0}),this.tag(e)}get sourceId(){return this.tagValue("e","source")}set source(e){this.removeTag("e","source"),this.tag(e,"source",!1,"e")}},g(Le,"kinds",[818]),Le),registeredEventClasses=new Set;function wrapEvent(t){const e=new Map,s=[...[NDKImage,NDKVideo,NDKCashuMintList,NDKArticle,NDKHighlight,NDKDraft,NDKWiki,NDKWikiMergeRequest,NDKNutzap,NDKProject,NDKTask,NDKProjectTemplate,NDKSimpleGroupMemberList,NDKSimpleGroupMetadata,NDKSubscriptionTier,NDKSubscriptionStart,NDKSubscriptionReceipt,NDKList,NDKRelayList,NDKStory,NDKBlossomList,NDKFollowPack,NDKThread,NDKRepost,NDKClassified,NDKAppHandlerEvent,NDKDVMJobFeedback,NDKCashuMintAnnouncement,NDKFedimintMint,NDKMintRecommendation],...registeredEventClasses];for(const o of s)for(const a of o.kinds)e.set(a,o);const r=e.get(t.kind);return r?r.from(t):t}function checkMissingKind(t,e){(t.kind===void 0||t.kind===null)&&e("event-missing-kind",`Cannot sign event without 'kind'.

 Event data:
    content: ${t.content?`"${t.content.substring(0,50)}${t.content.length>50?"...":""}"`:"(empty)"}
    tags: ${t.tags.length} tag${t.tags.length!==1?"s":""}
    kind: ${t.kind} 

Set event.kind before signing.`,"Example: event.kind = 1; // for text note",!1)}function checkContentIsObject(t,e){if(typeof t.content=="object"){const n=JSON.stringify(t.content,null,2).substring(0,200);e("event-content-is-object",`Event content is an object. Content must be a string.

 Your content (${typeof t.content}):
${n}${JSON.stringify(t.content).length>200?"...":""}

 event.content = { ... }  // WRONG
 event.content = JSON.stringify({ ... })  // CORRECT`,"Use JSON.stringify() for structured data: event.content = JSON.stringify(data)",!1)}}function checkCreatedAtMilliseconds(t,e){if(t.created_at&&t.created_at>1e10){const n=Math.floor(t.created_at/1e3),s=new Date(t.created_at).toISOString();e("event-created-at-milliseconds",`Event created_at is in milliseconds, not seconds.

 Your value:
    created_at: ${t.created_at} 
    Interpreted as: ${s}
    Should be: ${n} 

Nostr timestamps MUST be in seconds since Unix epoch.`,"Use Math.floor(Date.now() / 1000) instead of Date.now()",!1)}}function checkInvalidPTags(t,e){t.getMatchingTags("p").forEach((s,r)=>{if(s[1]&&!/^[0-9a-f]{64}$/i.test(s[1])){const o=JSON.stringify(s);e("tag-invalid-p-tag",`p-tag[${r}] has invalid pubkey.

 Your tag:
   ${o}

 Invalid value: "${s[1]}"
    Length: ${s[1].length} (expected 64)
    Format: ${s[1].startsWith("npub")?"bech32 (npub)":"unknown"}

p-tags MUST contain 64-character hex pubkeys.`,s[1].startsWith("npub")?`Use ndkUser.pubkey instead of npub:
    event.tags.push(['p', ndkUser.pubkey])
    event.tags.push(['p', 'npub1...'])`:"p-tags must contain valid hex pubkeys (64 characters, 0-9a-f)",!1)}})}function checkInvalidETags(t,e){t.getMatchingTags("e").forEach((s,r)=>{if(s[1]&&!/^[0-9a-f]{64}$/i.test(s[1])){const o=JSON.stringify(s),a=s[1].startsWith("note")||s[1].startsWith("nevent");e("tag-invalid-e-tag",`e-tag[${r}] has invalid event ID.

 Your tag:
   ${o}

 Invalid value: "${s[1]}"
    Length: ${s[1].length} (expected 64)
    Format: ${a?"bech32 (note/nevent)":"unknown"}

e-tags MUST contain 64-character hex event IDs.`,a?`Use event.id instead of bech32:
    event.tags.push(['e', referencedEvent.id])
    event.tags.push(['e', 'note1...'])`:"e-tags must contain valid hex event IDs (64 characters, 0-9a-f)",!1)}})}function checkManualReplyMarkers(t,e,n){if(t.kind!==1||n.has(t))return;const s=t.tags.filter(r=>r[0]==="e"&&(r[3]==="reply"||r[3]==="root"));if(s.length>0){const r=s.map((o,a)=>`   ${a+1}. ${JSON.stringify(o)}`).join(`
`);e("event-manual-reply-markers",`Event has ${s.length} e-tag(s) with manual reply/root markers.

 Your tags with markers:
${r}

  Manual reply markers detected! This will cause incorrect threading.`,`Reply events MUST be created using .reply():

    CORRECT:
   const replyEvent = originalEvent.reply();
   replyEvent.content = 'good point!';
   await replyEvent.publish();

    WRONG:
   event.tags.push(['e', eventId, '', 'reply']);

NDK handles all reply threading automatically - never add reply/root markers manually.`)}}function checkHashtagsWithPrefix(t,e){t.getMatchingTags("t").forEach((s,r)=>{if(s[1]&&s[1].startsWith("#")){const o=JSON.stringify(s);e("tag-hashtag-with-prefix",`t-tag[${r}] contains hashtag with # prefix.

 Your tag:
   ${o}

 Invalid value: "${s[1]}"

Hashtag tags should NOT include the # symbol.`,`Remove the # prefix from hashtag tags:
    event.tags.push(['t', 'nostr'])
    event.tags.push(['t', '#nostr'])`,!1)}})}function checkReplaceableWithOldTimestamp(t,e){if(t.kind===void 0||t.kind===null||!t.created_at||!t.isReplaceable())return;const n=Math.floor(Date.now()/1e3),s=n-t.created_at;if(s>10){const o=Math.floor(s/60),a=o>0?`${o} minute${o!==1?"s":""}`:`${s} seconds`;e("event-replaceable-old-timestamp",`Publishing a replaceable event with an old created_at timestamp.

 Event details:
    kind: ${t.kind} (replaceable)
    created_at: ${t.created_at}
    age: ${a} old
    current time: ${n}

  This is wrong and will be rejected by relays.`,`For replaceable events, use publishReplaceable():

    CORRECT:
   await event.publishReplaceable();
   // Automatically updates created_at to now

    WRONG:
   await event.publish();
   // Uses old created_at`)}}function signing(t,e,n,s){checkMissingKind(t,e),checkContentIsObject(t,e),checkCreatedAtMilliseconds(t,e),checkInvalidPTags(t,e),checkInvalidETags(t,e),checkHashtagsWithPrefix(t,e),checkManualReplyMarkers(t,n,s)}function publishing(t,e){checkReplaceableWithOldTimestamp(t,e)}function isNip33Pattern(t){const e=Array.isArray(t)?t:[t];if(e.length!==1)return!1;const n=e[0];return n.kinds&&Array.isArray(n.kinds)&&n.kinds.length===1&&n.authors&&Array.isArray(n.authors)&&n.authors.length===1&&n["#d"]&&Array.isArray(n["#d"])&&n["#d"].length===1}function isReplaceableEventFilter(t){const e=Array.isArray(t)?t:[t];return e.length===0?!1:e.every(n=>!n.kinds||!Array.isArray(n.kinds)||n.kinds.length===0||!n.authors||!Array.isArray(n.authors)||n.authors.length===0?!1:n.kinds.every(r=>r===0||r===3||r>=1e4&&r<=19999))}function formatFilter(t){return JSON.stringify(t,null,2).split(`
`).map((n,s)=>s===0?n:`   ${n}`).join(`
`)}function fetchingEvents(t,e,n,s,r){if(r(),(e==null?void 0:e.cacheUsage)==="ONLY_CACHE")return;const o=Array.isArray(t)?t:[t],a=o.map(formatFilter).join(`

   ---

   `);if(isNip33Pattern(t))o[0],n("fetch-events-usage",`For fetching a NIP-33 addressable event, use fetchEvent() with the naddr directly.

 Your filter:
   `+a+`

   BAD:  const decoded = nip19.decode(naddr);
           const events = await ndk.fetchEvents({
             kinds: [decoded.data.kind],
             authors: [decoded.data.pubkey],
             "#d": [decoded.data.identifier]
           });
           const event = Array.from(events)[0];

   GOOD: const event = await ndk.fetchEvent(naddr);
   GOOD: const event = await ndk.fetchEvent('naddr1...');

fetchEvent() handles naddr decoding automatically and returns the event directly.`);else{if(isReplaceableEventFilter(t))return;{if(!s())return;let c="";const l=o.some(h=>h.limit!==void 0),u=new Set(o.flatMap(h=>h.kinds||[])).size,f=new Set(o.flatMap(h=>h.authors||[])).size;if(l){const h=Math.max(...o.map(p=>p.limit||0));c+=`
    Limit: ${h} event${h!==1?"s":""}`}u>0&&(c+=`
    Kinds: ${u} type${u!==1?"s":""}`),f>0&&(c+=`
    Authors: ${f} author${f!==1?"s":""}`),n("fetch-events-usage",`fetchEvents() is a BLOCKING operation that waits for EOSE.
In most cases, you should use subscribe() instead.

 Your filter`+(o.length>1?"s":"")+`:
   `+a+(c?`

 Filter analysis:`+c:"")+`

   BAD:  const events = await ndk.fetchEvents(filter);
   GOOD: ndk.subscribe(filter, { onEvent: (e) => ... });

Only use fetchEvents() when you MUST block until data arrives.`,"For one-time queries, use fetchEvent() instead of fetchEvents() when expecting a single result.")}}}var GuardrailCheckId={NDK_NO_CACHE:"ndk-no-cache",FILTER_BECH32_IN_ARRAY:"filter-bech32-in-array",FILTER_INVALID_HEX:"filter-invalid-hex",FILTER_ONLY_LIMIT:"filter-only-limit",FILTER_EMPTY:"filter-empty",FILTER_SINCE_AFTER_UNTIL:"filter-since-after-until",FILTER_INVALID_A_TAG:"filter-invalid-a-tag",FILTER_HASHTAG_WITH_PREFIX:"filter-hashtag-with-prefix"};function checkCachePresence(t,e){e(GuardrailCheckId.NDK_NO_CACHE)&&setTimeout(()=>{if(!t.cacheAdapter){const r=`
 AI_GUARDRAILS WARNING: NDK initialized without a cache adapter. Apps perform significantly better with caching.

 ${typeof window<"u"?"Consider using @nostr-dev-kit/ndk-cache-dexie or @nostr-dev-kit/ndk-cache-sqlite-wasm":"Consider using @nostr-dev-kit/ndk-cache-redis or @nostr-dev-kit/ndk-cache-sqlite"}

 To disable this check:
   ndk.aiGuardrails.skip('${GuardrailCheckId.NDK_NO_CACHE}')
   or set: ndk.aiGuardrails = { skip: new Set(['${GuardrailCheckId.NDK_NO_CACHE}']) }`;console.warn(r)}},2500)}var AIGuardrails=class{constructor(t=!1){g(this,"enabled",!1);g(this,"skipSet",new Set);g(this,"extensions",new Map);g(this,"_nextCallDisabled",null);g(this,"_replyEvents",new WeakSet);g(this,"_fetchEventsCount",0);g(this,"_subscribeCount",0);g(this,"ndk",{fetchingEvents:(t,e)=>{this.enabled&&fetchingEvents(t,e,this.warn.bind(this),this.shouldWarnAboutFetchEventsRatio.bind(this),this.incrementFetchEventsCount.bind(this))}});g(this,"event",{signing:t=>{this.enabled&&signing(t,this.error.bind(this),this.warn.bind(this),this._replyEvents)},publishing:t=>{this.enabled&&publishing(t,this.warn.bind(this))},received:(t,e)=>{this.enabled},creatingReply:t=>{this.enabled&&this._replyEvents.add(t)}});g(this,"subscription",{created:(t,e)=>{this.enabled&&this.incrementSubscribeCount()}});g(this,"relay",{connected:t=>{this.enabled}});this.setMode(t)}register(t,e){this.extensions.has(t)&&console.warn(`AIGuardrails: Extension '${t}' already registered, overwriting`);const n={};for(const[s,r]of Object.entries(e))typeof r=="function"&&(n[s]=(...o)=>{this.enabled&&r(...o,this.shouldCheck.bind(this),this.error.bind(this),this.warn.bind(this))});this.extensions.set(t,n),this[t]=n}setMode(t){typeof t=="boolean"?(this.enabled=t,this.skipSet.clear()):t&&typeof t=="object"&&(this.enabled=!0,this.skipSet=t.skip||new Set)}isEnabled(){return this.enabled}shouldCheck(t){return!(!this.enabled||this.skipSet.has(t)||this._nextCallDisabled==="all"||this._nextCallDisabled&&this._nextCallDisabled.has(t))}skip(t){this.skipSet.add(t)}enable(t){this.skipSet.delete(t)}getSkipped(){return Array.from(this.skipSet)}captureAndClearNextCallDisabled(){const t=this._nextCallDisabled;return this._nextCallDisabled=null,t}incrementFetchEventsCount(){this._fetchEventsCount++}incrementSubscribeCount(){this._subscribeCount++}shouldWarnAboutFetchEventsRatio(){const t=this._fetchEventsCount+this._subscribeCount;return t<=6?!1:this._fetchEventsCount/t>.5}error(t,e,n,s=!0){if(!this.shouldCheck(t))return;const r=this.formatMessage(t,"ERROR",e,n,s);throw console.error(r),new Error(r)}warn(t,e,n){if(!this.shouldCheck(t))return;const s=this.formatMessage(t,"WARNING",e,n,!0);throw console.error(s),new Error(s)}formatMessage(t,e,n,s,r=!0){let o=`
 AI_GUARDRAILS ${e}: ${n}`;return s&&(o+=`

 ${s}`),r&&(o+=`

 To disable this check:
   ndk.guardrailOff('${t}').yourMethod()  // For one call`,o+=`
   ndk.aiGuardrails.skip('${t}')  // Permanently`,o+=`
   or set: ndk.aiGuardrails = { skip: new Set(['${t}']) }`),o}ndkInstantiated(t){this.enabled&&checkCachePresence(t,this.shouldCheck.bind(this))}};function processFilters(t,e="validate",n,s){if(e==="ignore")return t;const r=[],o=t.map((a,c)=>(s!=null&&s.aiGuardrails.isEnabled()&&runAIGuardrailsForFilter(a,c,s),processFilter(a,e,c,r,n)));if(e==="validate"&&r.length>0)throw new Error(`Invalid filter(s) detected:
${r.join(`
`)}`);return o}function processFilter(t,e,n,s,r){const o=e==="validate",a=o?t:{...t};if(t.ids){const c=[];t.ids.forEach((l,u)=>{l===void 0?o?s.push(`Filter[${n}].ids[${u}] is undefined`):r==null||r(`Fixed: Removed undefined value at ids[${u}]`):typeof l!="string"?o?s.push(`Filter[${n}].ids[${u}] is not a string (got ${typeof l})`):r==null||r(`Fixed: Removed non-string value at ids[${u}] (was ${typeof l})`):isValidHex64(l)?c.push(l):o?s.push(`Filter[${n}].ids[${u}] is not a valid 64-char hex string: "${l}"`):r==null||r(`Fixed: Removed invalid hex string at ids[${u}]`)}),o||(a.ids=c.length>0?c:void 0)}if(t.authors){const c=[];t.authors.forEach((l,u)=>{l===void 0?o?s.push(`Filter[${n}].authors[${u}] is undefined`):r==null||r(`Fixed: Removed undefined value at authors[${u}]`):typeof l!="string"?o?s.push(`Filter[${n}].authors[${u}] is not a string (got ${typeof l})`):r==null||r(`Fixed: Removed non-string value at authors[${u}] (was ${typeof l})`):isValidHex64(l)?c.push(l):o?s.push(`Filter[${n}].authors[${u}] is not a valid 64-char hex pubkey: "${l}"`):r==null||r(`Fixed: Removed invalid hex pubkey at authors[${u}]`)}),o||(a.authors=c.length>0?c:void 0)}if(t.kinds){const c=[];t.kinds.forEach((l,u)=>{l===void 0?o?s.push(`Filter[${n}].kinds[${u}] is undefined`):r==null||r(`Fixed: Removed undefined value at kinds[${u}]`):typeof l!="number"?o?s.push(`Filter[${n}].kinds[${u}] is not a number (got ${typeof l})`):r==null||r(`Fixed: Removed non-number value at kinds[${u}] (was ${typeof l})`):Number.isInteger(l)?l<0||l>65535?o?s.push(`Filter[${n}].kinds[${u}] is out of valid range (0-65535): ${l}`):r==null||r(`Fixed: Removed out-of-range kind at kinds[${u}]: ${l}`):c.push(l):o?s.push(`Filter[${n}].kinds[${u}] is not an integer: ${l}`):r==null||r(`Fixed: Removed non-integer value at kinds[${u}]: ${l}`)}),o||(a.kinds=c.length>0?c:void 0)}for(const c in t)if(c.startsWith("#")&&c.length===2){const l=t[c];if(Array.isArray(l)){const u=[];l.forEach((f,h)=>{f===void 0?o?s.push(`Filter[${n}].${c}[${h}] is undefined`):r==null||r(`Fixed: Removed undefined value at ${c}[${h}]`):typeof f!="string"?o?s.push(`Filter[${n}].${c}[${h}] is not a string (got ${typeof f})`):r==null||r(`Fixed: Removed non-string value at ${c}[${h}] (was ${typeof f})`):(c==="#e"||c==="#p")&&!isValidHex64(f)?o?s.push(`Filter[${n}].${c}[${h}] is not a valid 64-char hex string: "${f}"`):r==null||r(`Fixed: Removed invalid hex string at ${c}[${h}]`):u.push(f)}),o||(a[c]=u.length>0?u:void 0)}}return o||Object.keys(a).forEach(c=>{a[c]===void 0&&delete a[c]}),a}function runAIGuardrailsForFilter(t,e,n){const s=n.aiGuardrails,r=JSON.stringify(t,null,2);if(Object.keys(t).length===1&&t.limit!==void 0&&s.error(GuardrailCheckId.FILTER_ONLY_LIMIT,`Filter[${e}] contains only 'limit' without any filtering criteria.

 Your filter:
${r}

  This will fetch random events from relays without any criteria.`,`Add filtering criteria:
    { kinds: [1], limit: 10 }
    { authors: [pubkey], limit: 10 }
    { limit: 10 }`),Object.keys(t).length===0&&s.error(GuardrailCheckId.FILTER_EMPTY,`Filter[${e}] is empty.

 Your filter:
${r}

  This will request ALL events from relays, which is never what you want.`,"Add filtering criteria like 'kinds', 'authors', or tags.",!1),t.since!==void 0&&t.until!==void 0&&t.since>t.until){const a=new Date(t.since*1e3).toISOString(),c=new Date(t.until*1e3).toISOString();s.error(GuardrailCheckId.FILTER_SINCE_AFTER_UNTIL,`Filter[${e}] has 'since' AFTER 'until'.

 Your filter:
${r}

 since: ${t.since} (${a})
 until: ${t.until} (${c})

No events can match this time range!`,"'since' must be BEFORE 'until'. Both are Unix timestamps in seconds.",!1)}const o=/^n(addr|event|ote|pub|profile)1/;t.ids&&t.ids.forEach((a,c)=>{typeof a=="string"&&(o.test(a)?s.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].ids[${c}] contains bech32: "${a}". IDs must be hex, not bech32.`,'Use filterFromId() to decode bech32 first: import { filterFromId } from "@nostr-dev-kit/ndk"',!1):isValidHex64(a)||s.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].ids[${c}] is not a valid 64-char hex string: "${a}"`,`Event IDs must be 64-character hexadecimal strings. Invalid IDs often come from corrupted data in user-generated lists. Always validate hex strings before using them in filters:

   const validIds = ids.filter(id => /^[0-9a-f]{64}$/i.test(id));`,!1))}),t.authors&&t.authors.forEach((a,c)=>{typeof a=="string"&&(o.test(a)?s.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].authors[${c}] contains bech32: "${a}". Authors must be hex pubkeys, not npub.`,"Use ndkUser.pubkey instead. Example: { authors: [ndkUser.pubkey] }",!1):isValidHex64(a)||s.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].authors[${c}] is not a valid 64-char hex pubkey: "${a}"`,`Kind:3 follow lists can contain invalid entries like labels ("Follow List"), partial strings ("highlig"), or other corrupted data. You MUST validate all pubkeys before using them in filters.

   Example:
   const validPubkeys = pubkeys.filter(p => /^[0-9a-f]{64}$/i.test(p));
   ndk.subscribe({ authors: validPubkeys, kinds: [1] });`,!1))});for(const a in t)if(a.startsWith("#")&&a.length===2){const c=t[a];Array.isArray(c)&&c.forEach((l,u)=>{typeof l=="string"&&(a==="#e"||a==="#p")&&(o.test(l)?s.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${e}].${a}[${u}] contains bech32: "${l}". Tag values must be decoded.`,"Use filterFromId() or nip19.decode() to get the hex value first.",!1):isValidHex64(l)||s.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${e}].${a}[${u}] is not a valid 64-char hex string: "${l}"`,`${a==="#e"?"Event IDs":"Public keys"} in tag filters must be 64-character hexadecimal strings. Kind:3 follow lists and other user-generated content can contain invalid data. Always filter before using:

   const validValues = values.filter(v => /^[0-9a-f]{64}$/i.test(v));`,!1))})}if(t["#a"]){const a=t["#a"];a==null||a.forEach((c,l)=>{if(typeof c=="string")if(!/^\d+:[0-9a-f]{64}:.*$/.test(c))s.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${l}] has invalid format: "${c}". Must be "kind:pubkey:d-tag".`,'Example: "30023:fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52:my-article"',!1);else{const u=Number.parseInt(c.split(":")[0],10);(u<3e4||u>39999)&&s.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${e}].#a[${l}] uses non-addressable kind ${u}: "${c}". #a filters are only for addressable events (kinds 30000-39999).`,`Addressable events include:
    30000-30039: Parameterized Replaceable Events (profiles, settings, etc.)
    30040-39999: Other addressable events

For regular events (kind ${u}), use:
    #e filter for specific event IDs
    kinds + authors filters for event queries`,!1)}})}if(t["#t"]){const a=t["#t"];a==null||a.forEach((c,l)=>{typeof c=="string"&&c.startsWith("#")&&s.error(GuardrailCheckId.FILTER_HASHTAG_WITH_PREFIX,`Filter[${e}].#t[${l}] contains hashtag with # prefix: "${c}". Hashtag values should NOT include the # symbol.`,`Remove the # prefix from hashtag filters:
    { "#t": ["nostr"] }
    { "#t": ["#nostr"] }`,!1)})}}function queryFullyFilled(t){return!!(filterIncludesIds(t.filter)&&resultHasAllRequestedIds(t))}function filterIncludesIds(t){return!!t.ids}function resultHasAllRequestedIds(t){const e=t.filter.ids;return!!e&&e.length===t.eventFirstSeen.size}function filterFromId(t){let e;if(t.match(NIP33_A_REGEX)){const[n,s,r]=t.split(":"),o={authors:[s],kinds:[Number.parseInt(n)]};return r&&(o["#d"]=[r]),o}if(t.match(BECH32_REGEX))try{switch(e=nip19_exports$1.decode(t),e.type){case"nevent":{const n={ids:[e.data.id]};return e.data.author&&(n.authors=[e.data.author]),e.data.kind&&(n.kinds=[e.data.kind]),n}case"note":return{ids:[e.data]};case"naddr":{const n={authors:[e.data.pubkey],kinds:[e.data.kind]};return e.data.identifier&&(n["#d"]=[e.data.identifier]),n}}}catch(n){console.error("Error decoding",t,n)}return{ids:[t]}}function isNip33AValue(t){return t.match(NIP33_A_REGEX)!==null}var NIP33_A_REGEX=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,BECH32_REGEX=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function relaysFromBech32(t,e){try{const n=nip19_exports$1.decode(t);if(["naddr","nevent"].includes(n==null?void 0:n.type)){const s=n.data;if(s!=null&&s.relays)return s.relays.map(r=>new NDKRelay(r,e.relayAuthDefaultPolicy,e))}}catch{}return[]}var defaultOpts={closeOnEose:!1,cacheUsage:"CACHE_FIRST",dontSaveToCache:!1,groupable:!0,groupableDelay:100,groupableDelayType:"at-most",cacheUnconstrainFilter:["limit","since","until"],includeMuted:!1},NDKSubscription=class extends lib$1.EventEmitter{constructor(e,n,s,r){super();g(this,"subId");g(this,"filters");g(this,"opts");g(this,"pool");g(this,"skipVerification",!1);g(this,"skipValidation",!1);g(this,"exclusiveRelay",!1);g(this,"relayFilters");g(this,"relaySet");g(this,"ndk");g(this,"debug");g(this,"eventFirstSeen",new Map);g(this,"eosesSeen",new Set);g(this,"lastEventReceivedAt");g(this,"mostRecentCacheEventTimestamp");g(this,"internalId");g(this,"closeOnEose");g(this,"poolMonitor");g(this,"skipOptimisticPublishEvent",!1);g(this,"cacheUnconstrainFilter");g(this,"onStopped");g(this,"eoseTimeout");g(this,"eosed",!1);this.ndk=e,this.opts={...defaultOpts,...s||{}},this.pool=this.opts.pool||e.pool;const o=Array.isArray(n)?n:[n],a=e.filterValidationMode==="validate"?"validate":e.filterValidationMode==="fix"?"fix":"ignore";if(this.filters=processFilters(o,a,e.debug,e),this.filters.length===0)throw new Error("Subscription must have at least one filter");this.subId=r||this.opts.subId,this.internalId=Math.random().toString(36).substring(7),this.debug=e.debug.extend(`subscription[${this.opts.subId??this.internalId}]`),this.opts.relaySet?this.relaySet=this.opts.relaySet:this.opts.relayUrls&&(this.relaySet=NDKRelaySet.fromRelayUrls(this.opts.relayUrls,this.ndk)),this.skipVerification=this.opts.skipVerification||!1,this.skipValidation=this.opts.skipValidation||!1,this.closeOnEose=this.opts.closeOnEose||!1,this.skipOptimisticPublishEvent=this.opts.skipOptimisticPublishEvent||!1,this.cacheUnconstrainFilter=this.opts.cacheUnconstrainFilter,this.exclusiveRelay=this.opts.exclusiveRelay||!1,this.opts.onEvent&&this.on("event",this.opts.onEvent),this.opts.onEose&&this.on("eose",this.opts.onEose),this.opts.onClose&&this.on("close",this.opts.onClose)}relaysMissingEose(){var n;return this.relayFilters?Array.from((n=this.relayFilters)==null?void 0:n.keys()).filter(s=>!this.eosesSeen.has(this.pool.getRelay(s,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){var e;if(this.isGroupable())return(e=this.opts)==null?void 0:e.groupableDelay}get groupableDelayType(){var e;return((e=this.opts)==null?void 0:e.groupableDelayType)||"at-most"}isGroupable(){var e;return((e=this.opts)==null?void 0:e.groupable)||!1}shouldQueryCache(){var n;return this.opts.addSinceFromCache?!0:((n=this.opts)==null?void 0:n.cacheUsage)==="ONLY_RELAY"?!1:(this.filters.some(s=>{var r;return(r=s.kinds)==null?void 0:r.some(o=>kindIsEphemeral(o))}),!0)}shouldQueryRelays(){var e;return((e=this.opts)==null?void 0:e.cacheUsage)!=="ONLY_CACHE"}shouldWaitForCache(){var e;return this.opts.addSinceFromCache?!0:!!this.opts.closeOnEose&&!!((e=this.ndk.cacheAdapter)!=null&&e.locking)&&this.opts.cacheUsage!=="PARALLEL"}start(e=!0){let n;const s=o=>{for(const a of o)a.created_at&&(!this.mostRecentCacheEventTimestamp||a.created_at>this.mostRecentCacheEventTimestamp)&&(this.mostRecentCacheEventTimestamp=a.created_at),this.eventReceived(a,void 0,!0,!1);e||(n=o)},r=()=>{this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)};return this.shouldQueryCache()?(n=this.startWithCache(),n instanceof Promise?this.shouldWaitForCache()?(n.then(o=>{if(s(o),queryFullyFilled(this)){this.emit("eose",this);return}r()}),null):(n.then(o=>{s(o),this.shouldQueryRelays()||this.emit("eose",this)}),this.shouldQueryRelays()&&r(),null):(s(n),queryFullyFilled(this)?this.emit("eose",this):r(),n)):(r(),null)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=e=>{var s,r;if((s=this.relayFilters)!=null&&s.has(e.url))return;calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor).get(e.url)&&((r=this.relayFilters)==null||r.set(e.url,this.filters),e.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}stop(){var e;this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),(e=this.onStopped)==null||e.call(this)}hasAuthorsFilter(){return this.filters.some(e=>{var n;return(n=e.authors)==null?void 0:n.length})}startWithCache(){var e;return(e=this.ndk.cacheAdapter)!=null&&e.query?this.ndk.cacheAdapter.query(this):[]}startWithRelays(){let e=this.filters;if(this.opts.addSinceFromCache&&this.mostRecentCacheEventTimestamp){const n=this.mostRecentCacheEventTimestamp+1;e=e.map(s=>({...s,since:Math.max(s.since||0,n)}))}if(!this.relaySet||this.relaySet.relays.size===0)this.relayFilters=calculateRelaySetsFromFilters(this.ndk,e,this.pool,this.opts.relayGoalPerAuthor);else{this.relayFilters=new Map;for(const n of this.relaySet.relays)this.relayFilters.set(n.url,e)}for(const[n,s]of this.relayFilters)this.pool.getRelay(n,!0,!0,s).subscribe(this,s)}refreshRelayConnections(){var n,s;if(this.relaySet&&this.relaySet.relays.size>0)return;const e=calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor);for(const[r,o]of e)(n=this.relayFilters)!=null&&n.has(r)||((s=this.relayFilters)==null||s.set(r,o),this.pool.getRelay(r,!0,!0,o).subscribe(this,o))}eventReceived(e,n,s=!1,r=!1){var l,u,f;const o=e.id,a=this.eventFirstSeen.has(o);let c;if(e instanceof NDKEvent&&(c=e),a){const h=Date.now()-(this.eventFirstSeen.get(o)||0);if(this.emit("event:dup",e,n,h,this,s,r),(u=this.opts)!=null&&u.onEventDup&&this.opts.onEventDup(e,n,h,this,s,r),!s&&!r&&n&&((f=this.ndk.cacheAdapter)!=null&&f.setEventDup)&&!this.opts.dontSaveToCache&&(c??(c=e instanceof NDKEvent?e:new NDKEvent(this.ndk,e)),this.ndk.cacheAdapter.setEventDup(c,n)),n){const p=verifiedSignatures.get(o);if(p&&typeof p=="string")if(e.sig===p)n.addValidatedEvent();else{const y=e instanceof NDKEvent?e:new NDKEvent(this.ndk,e);this.ndk.reportInvalidSignature(y,n)}}}else{if(c??(c=new NDKEvent(this.ndk,e)),c.ndk=this.ndk,c.relay=n,!s&&!r){if(!this.skipValidation&&!c.isValid){this.debug("Event failed validation %s from relay %s",o,n==null?void 0:n.url);return}if(n)if(n.shouldValidateEvent()&&!this.skipVerification)if(c.relay=n,this.ndk.asyncSigVerification)c.verifySignature(!0);else{if(!c.verifySignature(!0)){this.debug("Event failed signature validation",e),this.ndk.reportInvalidSignature(c,n);return}n.addValidatedEvent()}else n.addNonValidatedEvent();this.ndk.cacheAdapter&&!this.opts.dontSaveToCache&&this.ndk.cacheAdapter.setEvent(c,this.filters,n)}if(!this.opts.includeMuted&&this.ndk.muteFilter&&this.ndk.muteFilter(c)){this.debug("Event muted, skipping");return}(!r||this.skipOptimisticPublishEvent!==!0)&&(this.emitEvent(((l=this.opts)==null?void 0:l.wrap)??!1,c,n,s,r),this.eventFirstSeen.set(o,Date.now()))}this.lastEventReceivedAt=Date.now()}emitEvent(e,n,s,r,o){const a=e?wrapEvent(n):n;a instanceof Promise?a.then(c=>this.emitEvent(!1,c,s,r,o)):a&&this.emit("event",a,s,this,r,o)}closedReceived(e,n){this.emit("closed",e,n)}eoseReceived(e){var a;this.debug("EOSE received from %s",e.url),this.eosesSeen.add(e);let n=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const s=this.eosesSeen.size===((a=this.relayFilters)==null?void 0:a.size),r=queryFullyFilled(this),o=c=>{var l;this.debug("Performing EOSE: %s %d",c,this.eosed),!this.eosed&&(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0,(l=this.opts)!=null&&l.closeOnEose&&this.stop())};if(r||s)o("query filled or seen all");else if(this.relayFilters){let c=1e3;const l=new Set(this.pool.connectedRelays().map(h=>h.url)),u=Array.from(this.relayFilters.keys()).filter(h=>l.has(h));if(u.length===0){this.debug("No connected relays, waiting for all relays to connect",Array.from(this.relayFilters.keys()).join(", "));return}const f=this.eosesSeen.size/u.length;if(this.debug("Percentage of relays that have sent EOSE",{subId:this.subId,percentageOfRelaysThatHaveSentEose:f,seen:this.eosesSeen.size,total:u.length}),this.eosesSeen.size>=2&&f>=.5){if(c=c*(1-f),c===0){o("time to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);const h=()=>{n=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,n!==void 0&&n<20?this.eoseTimeout=setTimeout(h,c):o(`send eose timeout: ${c}`)};this.eoseTimeout=setTimeout(h,c)}}}},kindIsEphemeral=t=>t>=2e4&&t<3e4;async function follows(t,e,n=3){var r,o;if(!this.ndk)throw new Error("NDK not set");const s=await this.ndk.fetchEvent({kinds:[n],authors:[this.pubkey]},t||{groupable:!1});if(s){const a=new Set;return s.tags.forEach(c=>{c[0]==="p"&&c[1]&&isValidPubkey(c[1])&&a.add(c[1])}),e&&((o=(r=this.ndk)==null?void 0:r.outboxTracker)==null||o.trackUsers(Array.from(a))),[...a].reduce((c,l)=>{const u=new NDKUser({pubkey:l});return u.ndk=this.ndk,c.add(u),c},new Set)}return new Set}var NIP05_REGEX=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For(t,e,n=fetch,s={}){return await t.queuesNip05.add({id:e,func:async()=>{var l,u,f;if((l=t.cacheAdapter)!=null&&l.loadNip05){const h=await t.cacheAdapter.loadNip05(e);if(h!=="missing"){if(h){const p=new NDKUser({pubkey:h.pubkey,relayUrls:h.relays,nip46Urls:h.nip46});return p.ndk=t,p}if(s.cache!=="no-cache")return null}}const r=e.match(NIP05_REGEX);if(!r)return null;const[o,a="_",c]=r;try{const h=await n(`https://${c}/.well-known/nostr.json?name=${a}`,s),{names:p,relays:y,nip46:b}=parseNIP05Result(await h.json()),m=p[a.toLowerCase()];let w=null;return m&&(w={pubkey:m,relays:y==null?void 0:y[m],nip46:b==null?void 0:b[m]}),(u=t==null?void 0:t.cacheAdapter)!=null&&u.saveNip05&&t.cacheAdapter.saveNip05(e,w),w}catch(h){return(f=t==null?void 0:t.cacheAdapter)!=null&&f.saveNip05&&(t==null||t.cacheAdapter.saveNip05(e,null)),console.error("Failed to fetch NIP05 for",e,h),null}}})}function parseNIP05Result(t){const e={names:{}};for(const[n,s]of Object.entries(t.names))typeof n=="string"&&typeof s=="string"&&(e.names[n.toLowerCase()]=s);if(t.relays){e.relays={};for(const[n,s]of Object.entries(t.relays))typeof n=="string"&&Array.isArray(s)&&(e.relays[n]=s.filter(r=>typeof r=="string"))}if(t.nip46){e.nip46={};for(const[n,s]of Object.entries(t.nip46))typeof n=="string"&&Array.isArray(s)&&(e.nip46[n]=s.filter(r=>typeof r=="string"))}return e}function profileFromEvent(t){const e={};let n;try{n=JSON.parse(t.content)}catch(s){throw new Error(`Failed to parse profile event: ${s}`)}e.profileEvent=JSON.stringify(t.rawEvent());for(const s of Object.keys(n))switch(s){case"name":e.name=n.name;break;case"display_name":e.displayName=n.display_name;break;case"image":case"picture":e.picture=n.picture||n.image,e.image=e.picture;break;case"banner":e.banner=n.banner;break;case"bio":e.bio=n.bio;break;case"nip05":e.nip05=n.nip05;break;case"lud06":e.lud06=n.lud06;break;case"lud16":e.lud16=n.lud16;break;case"about":e.about=n.about;break;case"website":e.website=n.website;break;default:e[s]=n[s];break}return e.created_at=t.created_at,e}function serializeProfile(t){const e={};for(const[n,s]of Object.entries(t))switch(n){case"username":case"name":e.name=s;break;case"displayName":e.display_name=s;break;case"image":case"picture":e.picture=s;break;case"bio":case"about":e.about=s;break;default:e[n]=s;break}return JSON.stringify(e)}var NDKUser=class Ve{constructor(e){g(this,"ndk");g(this,"profile");g(this,"profileEvent");g(this,"_npub");g(this,"_pubkey");g(this,"relayUrls",[]);g(this,"nip46Urls",[]);g(this,"follows",follows.bind(this));if(e.npub&&(this._npub=e.npub),e.hexpubkey&&(this._pubkey=e.hexpubkey),e.pubkey&&(this._pubkey=e.pubkey),e.relayUrls&&(this.relayUrls=e.relayUrls),e.nip46Urls&&(this.nip46Urls=e.nip46Urls),e.nprofile)try{const n=nip19_exports$1.decode(e.nprofile);n.type==="nprofile"&&(this._pubkey=n.data.pubkey,n.data.relays&&n.data.relays.length>0&&this.relayUrls.push(...n.data.relays))}catch(n){console.error("Failed to decode nprofile",n)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$1.npubEncode(this.pubkey)}return this._npub}get nprofile(){var n,s;const e=(s=(n=this.profileEvent)==null?void 0:n.onRelays)==null?void 0:s.map(r=>r.url);return nip19_exports$1.nprofileEncode({pubkey:this.pubkey,relays:e})}set npub(e){this._npub=e}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$1.decode(this.npub).data}return this._pubkey}set pubkey(e){this._pubkey=e}filter(){return{"#p":[this.pubkey]}}async getZapInfo(e){if(!this.ndk)throw new Error("No NDK instance found");const n=async a=>{if(!e)return a;let c;const l=new Promise((u,f)=>{c=setTimeout(()=>f(new Error("Timeout")),e)});try{const u=await Promise.race([a,l]);return c&&clearTimeout(c),u}catch(u){if(u instanceof Error&&u.message==="Timeout")try{return await a}catch{return}return}},[s,r]=await Promise.all([n(this.fetchProfile()),n(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),o=new Map;if(r){const a=NDKCashuMintList.from(r);a.mints.length>0&&o.set("nip61",{mints:a.mints,relays:a.relays,p2pk:a.p2pk})}if(s){const{lud06:a,lud16:c}=s;o.set("nip57",{lud06:a,lud16:c})}return o}static async fromNip05(e,n,s=!1){if(!n)throw new Error("No NDK instance found");const r={};s&&(r.cache="no-cache");const o=await getNip05For(n,e,n==null?void 0:n.httpFetch,r);if(o){const a=new Ve({pubkey:o.pubkey,relayUrls:o.relays,nip46Urls:o.nip46});return a.ndk=n,a}}async fetchProfile(e,n=!1){if(!this.ndk)throw new Error("NDK not set");let s=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&(e==null?void 0:e.cacheUsage)!=="ONLY_RELAY"){let r=null;if(this.ndk.cacheAdapter.fetchProfileSync?r=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(r=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),r)return this.profile=r,r}return e??(e={}),e.cacheUsage??(e.cacheUsage="ONLY_RELAY"),e.closeOnEose??(e.closeOnEose=!0),e.groupable??(e.groupable=!0),e.groupableDelay??(e.groupableDelay=250),s||(s=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},e)),s?(this.profile=profileFromEvent(s),n&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}async followSet(e,n,s=3){const r=await this.follows(e,n,s);return new Set(Array.from(r).map(o=>o.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(e){const n=[["p",this.pubkey]];return e&&n[0].push("",e),n}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent(this.ndk,{kind:0,content:serializeProfile(this.profile)}).publish()}async follow(e,n,s=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,s));const r=typeof e=="string"?e:e.pubkey;if(Array.from(n).some(c=>typeof c=="string"?c===r:c.pubkey===r))return!1;n.add(e);const a=new NDKEvent(this.ndk,{kind:s});for(const c of n)typeof c=="string"?a.tags.push(["p",c]):a.tag(c);return await a.publish(),!0}async unfollow(e,n,s=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,s));const r=typeof e=="string"?e:e.pubkey,o=new Set;let a=!1;for(const l of n)(typeof l=="string"?l:l.pubkey)!==r?o.add(l):a=!0;if(!a)return!1;const c=new NDKEvent(this.ndk,{kind:s});for(const l of o)typeof l=="string"?c.tags.push(["p",l]):c.tag(l);return await c.publish()}async validateNip05(e){if(!this.ndk)throw new Error("No NDK instance found");const n=await getNip05For(this.ndk,e);return n===null?null:n.pubkey===this.pubkey}},signerRegistry=new Map;function registerSigner(t,e){signerRegistry.set(t,e)}var NDKPrivateKeySigner=class Fe{constructor(e,n){g(this,"_user");g(this,"_privateKey");g(this,"_pubkey");if(typeof e=="string")if(e.startsWith("nsec1")){const{type:s,data:r}=nip19_exports$1.decode(e);if(s==="nsec")this._privateKey=r;else throw new Error("Invalid private key provided.")}else if(e.length===64)this._privateKey=hexToBytes(e);else throw new Error("Invalid private key provided.");else this._privateKey=e;this._pubkey=getPublicKey(this._privateKey),n&&(this._user=n.getUser({pubkey:this._pubkey})),this._user??(this._user=new NDKUser({pubkey:this._pubkey}))}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return bytesToHex(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$1.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$1.npubEncode(this._pubkey)}encryptToNcryptsec(e,n=16,s=2){if(!this._privateKey)throw new Error("Private key not available");return encrypt$1(this._privateKey,e,n,s)}static generate(){const e=generateSecretKey();return new Fe(e)}static fromNcryptsec(e,n,s){const r=decrypt$1(e,n);return new Fe(r,s)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(e){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(e,this._privateKey).sig}async encryptionEnabled(e){const n=[];return(!e||e==="nip04")&&n.push("nip04"),(!e||e==="nip44")&&n.push("nip44"),n}async encrypt(e,n,s){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const r=e.pubkey;if(s==="nip44"){const o=nip44_exports.v2.utils.getConversationKey(this._privateKey,r);return await nip44_exports.v2.encrypt(n,o)}return await nip04_exports.encrypt(this._privateKey,r,n)}async decrypt(e,n,s){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const r=e.pubkey;if(s==="nip44"){const o=nip44_exports.v2.utils.getConversationKey(this._privateKey,r);return await nip44_exports.v2.decrypt(n,o)}return await nip04_exports.decrypt(this._privateKey,r,n)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const e={type:"private-key",payload:this.privateKey};return JSON.stringify(e)}static async fromPayload(e,n){const s=JSON.parse(e);if(s.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${s.type}`);if(!s.payload||typeof s.payload!="string")throw new Error("Invalid payload content for private-key signer");return new Fe(s.payload,n)}};registerSigner("private-key",NDKPrivateKeySigner);function dedup(t,e){return t.created_at>e.created_at?t:e}async function getRelayListForUser(t,e){return(await getRelayListForUsers([t],e)).get(t)}async function getRelayListForUsers(t,e,n=!1,s=1e3,r){var p;const o=e.outboxPool||e.pool,a=new Set;for(const y of o.relays.values())a.add(y);if(r)for(const y of r.values())for(const b of y){const m=o.getRelay(b,!0,!0);m&&a.add(m)}const c=new Map,l=new Map,u=new NDKRelaySet(a,e);if((p=e.cacheAdapter)!=null&&p.locking&&!n){const y=await e.fetchEvents({kinds:[3,10002],authors:Array.from(new Set(t))},{cacheUsage:"ONLY_CACHE",subId:"ndk-relay-list-fetch"});for(const b of y)b.kind===10002&&c.set(b.pubkey,NDKRelayList.from(b));for(const b of y)if(b.kind===3){if(c.has(b.pubkey))continue;const m=relayListFromKind3(e,b);m&&l.set(b.pubkey,m)}t=t.filter(b=>!c.has(b)&&!l.has(b))}if(t.length===0)return c;const f=new Map,h=new Map;return new Promise(y=>{let b=!1;(async()=>{const w={closeOnEose:!0,pool:o,groupable:!0,subId:"ndk-relay-list-fetch",addSinceFromCache:!0,relaySet:u};u&&(w.relaySet=u),e.subscribe({kinds:[3,10002],authors:t},w,{onEvent:P=>{if(P.kind===10002){const O=f.get(P.pubkey);if(O&&O.created_at>P.created_at)return;f.set(P.pubkey,P)}else if(P.kind===3){const O=h.get(P.pubkey);if(O&&O.created_at>P.created_at)return;h.set(P.pubkey,P)}},onEose:()=>{if(!b){b=!0,e.debug(`[getRelayListForUsers] EOSE - relayListEvents: ${f.size}, contactListEvents: ${h.size}`);for(const P of f.values())c.set(P.pubkey,NDKRelayList.from(P));for(const P of t){if(c.has(P))continue;const O=h.get(P);if(!O)continue;const U=relayListFromKind3(e,O);U&&c.set(P,U)}e.debug(`[getRelayListForUsers] Returning ${c.size} relay lists for ${t.length} pubkeys`),y(c)}}});const k=Array.from(a).some(P=>P.status<=2),A=Array.from(a).some(P=>P.status===4);let B=s;(k||A)&&(B=s+3e3),e.debug(`[getRelayListForUsers] Setting fallback timeout to ${B}ms (disconnected: ${k}, connecting: ${A})`,{pubkeys:t}),setTimeout(()=>{b||(b=!0,e.debug(`[getRelayListForUsers] Timeout reached, returning ${c.size} relay lists`),y(c))},B)})()})}var OutboxItem=class{constructor(t){g(this,"type");g(this,"relayUrlScores");g(this,"readRelays");g(this,"writeRelays");this.type=t,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},OutboxTracker=class extends lib$1.EventEmitter{constructor(e){super();g(this,"data");g(this,"ndk");g(this,"debug");this.ndk=e,this.debug=e.debug.extend("outbox-tracker"),this.data=new dist.LRUCache({maxSize:1e5,entryExpirationTimeInMS:2*60*1e3})}async trackUsers(e,n=!1){const s=[];for(let r=0;r<e.length;r+=400){const o=e.slice(r,r+400),a=o.map(l=>getKeyFromItem(l)).filter(l=>!this.data.has(l));if(a.length===0)continue;for(const l of a)this.data.set(l,new OutboxItem("user"));const c=new Map;for(const l of o)l instanceof NDKUser&&l.relayUrls.length>0&&c.set(l.pubkey,l.relayUrls);s.push(new Promise(l=>{getRelayListForUsers(a,this.ndk,n,1e3,c).then(u=>{this.debug(`Received relay lists for ${u.size} pubkeys out of ${a.length} requested`);for(const[f,h]of u){let p=this.data.get(f);if(p??(p=new OutboxItem("user")),h){if(p.readRelays=new Set(normalize(h.readRelayUrls)),p.writeRelays=new Set(normalize(h.writeRelayUrls)),this.ndk.relayConnectionFilter){for(const y of p.readRelays)this.ndk.relayConnectionFilter(y)||p.readRelays.delete(y);for(const y of p.writeRelays)this.ndk.relayConnectionFilter(y)||p.writeRelays.delete(y)}this.data.set(f,p),this.emit("user:relay-list-updated",f,p),this.debug(`Adding ${p.readRelays.size} read relays and ${p.writeRelays.size} write relays for ${f}`,h==null?void 0:h.rawEvent())}}}).finally(l)}))}return Promise.all(s)}track(e,n,s=!0){const r=getKeyFromItem(e);n??(n=getTypeFromItem(e));let o=this.data.get(r);return o||(o=new OutboxItem(n),e instanceof NDKUser&&this.trackUsers([e])),o}};function getKeyFromItem(t){return t instanceof NDKUser?t.pubkey:t}function getTypeFromItem(t){return t instanceof NDKUser?"user":"kind"}function correctRelaySet(t,e){const n=e.connectedRelays();if(!Array.from(t.relays).some(r=>n.map(o=>o.url).includes(r.url)))for(const r of n)t.addRelay(r);if(n.length===0)for(const r of e.relays.values())t.addRelay(r);return t}var NDKSubscriptionManager=class{constructor(){g(this,"subscriptions");g(this,"seenEvents",new dist.LRUCache({maxSize:1e4,entryExpirationTimeInMS:5*60*1e3}));this.subscriptions=new Map}add(t){this.subscriptions.set(t.internalId,t),t.onStopped,t.onStopped=()=>{this.subscriptions.delete(t.internalId)},t.on("close",()=>{this.subscriptions.delete(t.internalId)})}seenEvent(t,e){const n=this.seenEvents.get(t)||[];n.some(s=>s.url===e.url)||n.push(e),this.seenEvents.set(t,n)}dispatchEvent(t,e,n=!1){e&&this.seenEvent(t.id,e);const s=this.subscriptions.values(),r=[];for(const o of s)matchFilters(o.filters,t)&&r.push(o);for(const o of r){if(o.exclusiveRelay&&o.relaySet){let a=!1;if(n?a=!o.skipOptimisticPublishEvent:e?a=o.relaySet.relays.has(e):a=(this.seenEvents.get(t.id)||[]).some(l=>o.relaySet.relays.has(l)),!a){o.debug.extend("exclusive-relay")("Rejected event %s from %s (relay not in exclusive set)",t.id,(e==null?void 0:e.url)||(n?"optimistic":"cache"));continue}}o.eventReceived(t,e,!1,n)}}},debug6=createDebug5("ndk:active-user");async function getUserRelayList(t){if(!this.autoConnectUserRelays)return;const e=await getRelayListForUser(t.pubkey,this);if(e){for(const n of e.relays){let s=this.pool.relays.get(n);s||(s=new NDKRelay(n,this.relayAuthDefaultPolicy,this),this.pool.addRelay(s))}return debug6("Connected to %d user relays",e.relays.length),e}}async function setActiveUser(t){if(!this.autoConnectUserRelays)return;const e=this.outboxPool||this.pool;e.connectedRelays.length>0?await getUserRelayList.call(this,t):e.once("connect",async()=>{await getUserRelayList.call(this,t)})}function getEntity(t){try{const e=nip19_exports$1.decode(t);return e.type==="npub"?npub(this,e.data):e.type==="nprofile"?nprofile(this,e.data):e}catch{return null}}function npub(t,e){return t.getUser({pubkey:e})}function nprofile(t,e){const n=t.getUser({pubkey:e.pubkey});return e.relays&&(n.relayUrls=e.relays),n}function isValidHint(t){if(!t||t==="")return!1;try{return new URL(t),!0}catch{return!1}}async function fetchEventFromTag(t,e,n,s={type:"timeout"}){const r=this.debug.extend("fetch-event-from-tag"),[o,a,c]=t;n={},r("fetching event from tag",t,n,s);const l=getRelaysForSync(this,e.pubkey);if(l&&l.size>0){r("fetching event from author relays %o",Array.from(l));const m=NDKRelaySet.fromRelayUrls(Array.from(l),this),w=await this.fetchEvent(a,n,m);if(w)return w}else r("no author relays found for %s",e.pubkey,e);const u=calculateRelaySetsFromFilters(this,[{ids:[a]}],this.pool);r("fetching event without relay hint",u);const f=await this.fetchEvent(a,n);if(f)return f;if(c&&c!==""){const m=await this.fetchEvent(a,n,this.pool.getRelay(c,!0,!0,[{ids:[a]}]));if(m)return m}let h;const p=isValidHint(c)?this.pool.getRelay(c,!1,!0,[{ids:[a]}]):void 0,y=new Promise(m=>{this.fetchEvent(a,n,p).then(m)});if(!isValidHint(c)||s.type==="none")return y;const b=new Promise(async m=>{const w=s.relaySet,k=s.timeout??1500,A=new Promise(B=>setTimeout(B,k));if(s.type==="timeout"&&await A,h)m(h);else{r("fallback fetch triggered");const B=await this.fetchEvent(a,n,w);m(B)}});switch(s.type){case"timeout":return Promise.race([y,b]);case"eose":return h=await y,h||b}}var Queue=class{constructor(t,e){g(this,"queue",[]);g(this,"maxConcurrency");g(this,"processing",new Set);g(this,"promises",new Map);this.maxConcurrency=e}add(t){if(this.promises.has(t.id))return this.promises.get(t.id);const e=new Promise((n,s)=>{this.queue.push({...t,func:()=>t.func().then(r=>(n(r),r),r=>{throw s(r),r})}),this.process()});return this.promises.set(t.id,e),e.finally(()=>{this.promises.delete(t.id),this.processing.delete(t.id),this.process()}),e}process(){if(this.processing.size>=this.maxConcurrency||this.queue.length===0)return;const t=this.queue.shift();!t||this.processing.has(t.id)||(this.processing.add(t.id),t.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},DEFAULT_OUTBOX_RELAYS=["wss://purplepag.es/","wss://nos.lol/"],NDK=class extends lib$1.EventEmitter{constructor(e={}){super();g(this,"_explicitRelayUrls");g(this,"pool");g(this,"outboxPool");g(this,"_signer");g(this,"_activeUser");g(this,"cacheAdapter");g(this,"debug");g(this,"devWriteRelaySet");g(this,"outboxTracker");g(this,"muteFilter");g(this,"relayConnectionFilter");g(this,"clientName");g(this,"clientNip89");g(this,"queuesZapConfig");g(this,"queuesNip05");g(this,"asyncSigVerification",!1);g(this,"initialValidationRatio",1);g(this,"lowestValidationRatio",.1);g(this,"validationRatioFn");g(this,"filterValidationMode","validate");g(this,"subManager");g(this,"aiGuardrails");g(this,"_signatureVerificationFunction");g(this,"_signatureVerificationWorker");g(this,"signatureVerificationTimeMs",0);g(this,"publishingFailureHandled",!1);g(this,"pools",[]);g(this,"relayAuthDefaultPolicy");g(this,"httpFetch");g(this,"netDebug");g(this,"autoConnectUserRelays",!0);g(this,"_wallet");g(this,"walletConfig");g(this,"fetchEventFromTag",fetchEventFromTag.bind(this));g(this,"getEntity",getEntity.bind(this));this.debug=e.debug||createDebug5("ndk"),this.netDebug=e.netDebug,this._explicitRelayUrls=e.explicitRelayUrls||[],this.subManager=new NDKSubscriptionManager,this.pool=new NDKPool(e.explicitRelayUrls||[],this),this.pool.name="Main",this.pool.on("relay:auth",async(n,s)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(n,s)}),this.autoConnectUserRelays=e.autoConnectUserRelays??!0,this.clientName=e.clientName,this.clientNip89=e.clientNip89,this.relayAuthDefaultPolicy=e.relayAuthDefaultPolicy,e.enableOutboxModel!==!1&&(this.outboxPool=new NDKPool(e.outboxRelayUrls||DEFAULT_OUTBOX_RELAYS,this,{debug:this.debug.extend("outbox-pool"),name:"Outbox Pool"}),this.outboxTracker=new OutboxTracker(this),this.outboxTracker.on("user:relay-list-updated",(n,s)=>{this.debug(`Outbox relay list updated for ${n}`);for(const r of this.subManager.subscriptions.values())r.filters.some(a=>{var c;return(c=a.authors)==null?void 0:c.includes(n)})&&typeof r.refreshRelayConnections=="function"&&(this.debug(`Refreshing relay connections for subscription ${r.internalId}`),r.refreshRelayConnections())})),this.signer=e.signer,this.cacheAdapter=e.cacheAdapter,this.muteFilter=e.muteFilter,this.relayConnectionFilter=e.relayConnectionFilter,e.devWriteRelayUrls&&(this.devWriteRelaySet=NDKRelaySet.fromRelayUrls(e.devWriteRelayUrls,this)),this.queuesZapConfig=new Queue("zaps",3),this.queuesNip05=new Queue("nip05",10),e.signatureVerificationWorker&&(this.signatureVerificationWorker=e.signatureVerificationWorker),e.signatureVerificationFunction&&(this.signatureVerificationFunction=e.signatureVerificationFunction),this.initialValidationRatio=e.initialValidationRatio||1,this.lowestValidationRatio=e.lowestValidationRatio||.1,this.validationRatioFn=e.validationRatioFn||this.defaultValidationRatioFn,this.filterValidationMode=e.filterValidationMode||"validate",this.aiGuardrails=new AIGuardrails(e.aiGuardrails||!1),this.aiGuardrails.ndkInstantiated(this);try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(e){this._explicitRelayUrls=e.map(normalizeRelayUrl),this.pool.relayUrls=e}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(e){this._signatureVerificationWorker=e,e?(signatureVerificationInit(e),this.asyncSigVerification=!0):this.asyncSigVerification=!1}set signatureVerificationFunction(e){this._signatureVerificationFunction=e,this.asyncSigVerification=!!e}get signatureVerificationFunction(){return this._signatureVerificationFunction}addExplicitRelay(e,n,s=!0){var o;let r;return typeof e=="string"?r=new NDKRelay(e,n,this):r=e,this.pool.addRelay(r,s),(o=this.explicitRelayUrls)==null||o.push(r.url),r}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(e){var s;const n=((s=this._activeUser)==null?void 0:s.pubkey)!==(e==null?void 0:e.pubkey);this._activeUser=e,n&&this.emit("activeUser:change",e),e&&n&&setActiveUser.call(this,e)}get signer(){return this._signer}set signer(e){this._signer=e,e&&this.emit("signer:ready",e),e==null||e.user().then(n=>{n.ndk=this,this.activeUser=n})}async connect(e){var s,r,o;this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await((r=(s=this._signer).relays)==null?void 0:r.call(s,this))),this._signer.relays&&(await this._signer.relays(this)).forEach(c=>this.pool.addRelay(c)));const n=[this.pool.connect(e)];return this.outboxPool&&n.push(this.outboxPool.connect(e)),(o=this.cacheAdapter)!=null&&o.initializeAsync&&n.push(this.cacheAdapter.initializeAsync(this)),Promise.allSettled(n).then(()=>{})}reportInvalidSignature(e,n){this.debug(`Invalid signature detected for event ${e.id}${n?` from relay ${n.url}`:""}`),this.emit("event:invalid-sig",e,n)}defaultValidationRatioFn(e,n,s){if(n<10)return this.initialValidationRatio;const r=Math.min(n/100,1),o=this.initialValidationRatio*(1-r)+this.lowestValidationRatio*r;return Math.max(o,this.lowestValidationRatio)}getUser(e){if(typeof e=="string")if(e.startsWith("npub1")){const{type:s,data:r}=nip19_exports$1.decode(e);if(s!=="npub")throw new Error(`Invalid npub: ${e}`);return this.getUser({pubkey:r})}else if(e.startsWith("nprofile1")){const{type:s,data:r}=nip19_exports$1.decode(e);if(s!=="nprofile")throw new Error(`Invalid nprofile: ${e}`);return this.getUser({pubkey:r.pubkey,relayUrls:r.relays})}else return this.getUser({pubkey:e});const n=new NDKUser(e);return n.ndk=this,n}async getUserFromNip05(e,n=!1){return NDKUser.fromNip05(e,this,n)}async fetchUser(e,n=!1){if(isValidNip05(e))return NDKUser.fromNip05(e,this,n);if(e.startsWith("npub1")){const{type:s,data:r}=nip19_exports$1.decode(e);if(s!=="npub")throw new Error(`Invalid npub: ${e}`);const o=new NDKUser({pubkey:r});return o.ndk=this,o}else if(e.startsWith("nprofile1")){const{type:s,data:r}=nip19_exports$1.decode(e);if(s!=="nprofile")throw new Error(`Invalid nprofile: ${e}`);const o=new NDKUser({pubkey:r.pubkey,relayUrls:r.relays});return o.ndk=this,o}else{const s=new NDKUser({pubkey:e});return s.ndk=this,s}}subscribe(e,n,s=!0,r=!0){var h,p,y;let o=n==null?void 0:n.relaySet,a=r;s instanceof NDKRelaySet?(console.warn("relaySet is deprecated, use opts.relaySet instead. This will be removed in version v2.14.0"),o=s,a=r):(typeof s=="boolean"||typeof s=="object")&&(a=s);let c;const l={relaySet:o,...n};a&&typeof a=="object"&&(a.onEvent&&(l.onEvent=a.onEvent),a.onEose&&(l.onEose=a.onEose),a.onClose&&(l.onClose=a.onClose),a.onEvents&&(c=a.onEvents));const u=new NDKSubscription(this,e,l);this.subManager.add(u),(p=(h=this.aiGuardrails)==null?void 0:h.subscription)==null||p.created(Array.isArray(e)?e:[e],l);const f=u.pool;if(u.relaySet)for(const b of u.relaySet.relays)f.useTemporaryRelay(b,void 0,u.filters);if(this.outboxPool&&u.hasAuthorsFilter()){const b=u.filters.filter(m=>{var w;return m.authors&&((w=m.authors)==null?void 0:w.length)>0}).flatMap(m=>m.authors);(y=this.outboxTracker)==null||y.trackUsers(b)}return a&&setTimeout(async()=>{var m;(m=this.cacheAdapter)!=null&&m.initializeAsync&&!this.cacheAdapter.ready&&await this.cacheAdapter.initializeAsync(this);const b=u.start(!c);b&&b.length>0&&c&&c(b)},0),u}fetchEventSync(e){if(!this.cacheAdapter)throw new Error("Cache adapter not set");let n;typeof e=="string"?n=[filterFromId(e)]:n=e;const s=new NDKSubscription(this,n),r=this.cacheAdapter.query(s);if(r instanceof Promise)throw new Error("Cache adapter is async");return r.map(o=>(o.ndk=this,o))}async fetchEvent(e,n,s){var a,c;let r,o;if(s instanceof NDKRelay?o=new NDKRelaySet(new Set([s]),this):s instanceof NDKRelaySet&&(o=s),!s&&typeof e=="string"&&!isNip33AValue(e)){const l=relaysFromBech32(e,this);l.length>0&&(o=new NDKRelaySet(new Set(l),this),o=correctRelaySet(o,this.pool))}if(typeof e=="string"?r=[filterFromId(e)]:Array.isArray(e)?r=e:r=[e],typeof e!="string"&&((c=(a=this.aiGuardrails)==null?void 0:a.ndk)==null||c.fetchingEvents(r)),r.length===0)throw new Error(`Invalid filter: ${JSON.stringify(e)}`);return new Promise((l,u)=>{let f=null;const h={...n||{},closeOnEose:!0};o&&(h.relaySet=o);const p=setTimeout(()=>{y.stop(),this.aiGuardrails._nextCallDisabled=null,l(f)},1e4),y=this.subscribe(r,h,{onEvent:b=>{b.ndk=this,b.isReplaceable()?(!f||f.created_at<b.created_at)&&(f=b):(clearTimeout(p),this.aiGuardrails._nextCallDisabled=null,l(b))},onEose:()=>{clearTimeout(p),this.aiGuardrails._nextCallDisabled=null,l(f)}})})}async fetchEvents(e,n,s){var r,o;return(o=(r=this.aiGuardrails)==null?void 0:r.ndk)==null||o.fetchingEvents(e,n),new Promise(a=>{const c=new Map,l={...n||{},closeOnEose:!0};s&&(l.relaySet=s);const u=f=>{let h;f instanceof NDKEvent?h=f:h=new NDKEvent(void 0,f);const p=h.deduplicationKey(),y=c.get(p);y&&(h=dedup(y,h)),h.ndk=this,c.set(p,h)};this.subscribe(e,{...l,onEvent:u,onEose:()=>{this.aiGuardrails._nextCallDisabled=null,a(new Set(c.values()))}})})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}guardrailOff(e){return e?typeof e=="string"?this.aiGuardrails._nextCallDisabled=new Set([e]):this.aiGuardrails._nextCallDisabled=new Set(e):this.aiGuardrails._nextCallDisabled="all",this}set wallet(e){var n,s;if(!e){this._wallet=void 0,this.walletConfig=void 0;return}this._wallet=e,this.walletConfig??(this.walletConfig={}),this.walletConfig.lnPay=(n=e==null?void 0:e.lnPay)==null?void 0:n.bind(e),this.walletConfig.cashuPay=(s=e==null?void 0:e.cashuPay)==null?void 0:s.bind(e)}get wallet(){return this._wallet}},nip19_exports={};__reExport(nip19_exports,nip19_star);var nip49_exports={};__reExport(nip49_exports,nip49_star);function disconnect(t,e){return e??(e=createDebug5("ndk:relay:auth-policies:disconnect")),async n=>{e==null||e(`Relay ${n.url} requested authentication, disconnecting`),t.removeRelay(n.url)}}async function signAndAuth(t,e,n,s,r,o){try{await t.sign(n),r(t)}catch(a){s==null||s(`Failed to publish auth event to relay ${e.url}`,a),o(t)}}function signIn({ndk:t,signer:e,debug:n}={}){return n??(n=createDebug5("ndk:auth-policies:signIn")),async(s,r)=>{n==null||n(`Relay ${s.url} requested authentication, signing in`);const o=new NDKEvent(t);return o.kind=22242,o.tags=[["relay",s.url],["challenge",r]],e??(e=t==null?void 0:t.signer),new Promise(async(a,c)=>{e?await signAndAuth(o,s,e,n,a,c):t==null||t.once("signer:ready",async l=>{await signAndAuth(o,s,l,n,a,c)})})}}var NDKRelayAuthPolicies={disconnect,signIn};async function ndkSignerFromPayload(t,e){let n;try{n=JSON.parse(t)}catch(r){console.error("Failed to parse signer payload string",t,r);return}if(!n||typeof n.type!="string"){console.error("Failed to parse signer payload string",t,new Error("Missing type field"));return}const s=signerRegistry.get(n.type);if(!s)throw new Error(`Unknown signer type: ${n.type}`);try{return await s.fromPayload(t,e)}catch(r){const o=r instanceof Error?r.message:String(r);throw new Error(`Failed to deserialize signer type ${n.type}: ${o}`)}}var NDKNip07Signer=class ze{constructor(e=1e3,n){g(this,"_userPromise");g(this,"encryptionQueue",[]);g(this,"encryptionProcessing",!1);g(this,"debug");g(this,"waitTimeout");g(this,"_pubkey");g(this,"ndk");g(this,"_user");this.debug=createDebug5("ndk:nip07"),this.waitTimeout=e,this.ndk=n}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){var s;await this.waitForExtension();const e=await((s=window.nostr)==null?void 0:s.getPublicKey());if(!e)throw new Error("User rejected access");this._pubkey=e;let n;return this.ndk?n=this.ndk.getUser({pubkey:e}):n=new NDKUser({pubkey:e}),this._user=n,n}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(e){var s;await this.waitForExtension();const n=await((s=window.nostr)==null?void 0:s.signEvent(e));if(!n)throw new Error("Failed to sign event");return n.sig}async relays(e){var r,o;await this.waitForExtension();const n=await((o=(r=window.nostr)==null?void 0:r.getRelays)==null?void 0:o.call(r))||{},s=[];for(const a of Object.keys(n))n[a].read&&n[a].write&&s.push(a);return s.map(a=>new NDKRelay(a,e==null?void 0:e.relayAuthDefaultPolicy,e))}async encryptionEnabled(e){var s,r;const n=[];return(!e||e==="nip04")&&((s=window.nostr)!=null&&s.nip04)&&n.push("nip04"),(!e||e==="nip44")&&((r=window.nostr)!=null&&r.nip44)&&n.push("nip44"),n}async encrypt(e,n,s="nip04"){if(!await this.encryptionEnabled(s))throw new Error(`${s}encryption is not available from your browser extension`);await this.waitForExtension();const r=e.pubkey;return this.queueEncryption(s,"encrypt",r,n)}async decrypt(e,n,s="nip04"){if(!await this.encryptionEnabled(s))throw new Error(`${s}encryption is not available from your browser extension`);await this.waitForExtension();const r=e.pubkey;return this.queueEncryption(s,"decrypt",r,n)}async queueEncryption(e,n,s,r){return new Promise((o,a)=>{this.encryptionQueue.push({scheme:e,method:n,counterpartyHexpubkey:s,value:r,resolve:o,reject:a}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(e,n=0){var f,h;if(!e&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const s=e||this.encryptionQueue.shift();if(!s){this.encryptionProcessing=!1;return}const{scheme:r,method:o,counterpartyHexpubkey:a,value:c,resolve:l,reject:u}=s;this.debug("Processing encryption queue item",{method:o,counterpartyHexpubkey:a,value:c});try{const p=await((h=(f=window.nostr)==null?void 0:f[r])==null?void 0:h[o](a,c));if(!p)throw new Error("Failed to encrypt/decrypt");l(p)}catch(p){const y=p instanceof Error?p.message:String(p);if(y.includes("call already executing")&&n<5){this.debug("Retrying encryption queue item",{method:o,counterpartyHexpubkey:a,value:c,retries:n}),setTimeout(()=>{this.processEncryptionQueue(s,n+1)},50*n);return}u(p instanceof Error?p:new Error(y))}this.processEncryptionQueue()}waitForExtension(){return new Promise((e,n)=>{if(window.nostr){e();return}let s;const r=setInterval(()=>{window.nostr&&(clearTimeout(s),clearInterval(r),e())},100);s=setTimeout(()=>{clearInterval(r),n(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(e,n){const s=JSON.parse(e);if(s.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${s.type}`);return new ze(void 0,n)}};registerSigner("nip07",NDKNip07Signer);var NDKNostrRpc=class extends lib$1.EventEmitter{constructor(e,n,s,r){super();g(this,"ndk");g(this,"signer");g(this,"relaySet");g(this,"debug");g(this,"encryptionType","nip04");g(this,"pool");if(this.ndk=e,this.signer=n,r){this.pool=new NDKPool(r,e,{debug:s.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet(new Set,e,this.pool);for(const o of r){const a=this.pool.getRelay(o,!1,!1);a.authPolicy=NDKRelayAuthPolicies.signIn({ndk:e,signer:n,debug:s}),this.relaySet.addRelay(a),a.connect()}}this.debug=s.extend("rpc")}subscribe(e){return new Promise(n=>{const s=this.ndk.subscribe(e,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet,onEvent:async r=>{try{const o=await this.parseEvent(r);o.method?this.emit("request",o):(this.emit(`response-${o.id}`,o),this.emit("response",o))}catch(o){this.debug("error parsing event",o,r.rawEvent())}},onEose:()=>{this.debug("eosed"),n(s)}})})}async parseEvent(e){this.encryptionType==="nip44"&&e.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!e.content.includes("?iv=")&&(this.encryptionType="nip44");const n=this.ndk.getUser({pubkey:e.pubkey});n.ndk=this.ndk;let s;try{s=await this.signer.decrypt(n,e.content,this.encryptionType)}catch{const h=this.encryptionType==="nip04"?"nip44":"nip04";s=await this.signer.decrypt(n,e.content,h),this.encryptionType=h}const r=JSON.parse(s),{id:o,method:a,params:c,result:l,error:u}=r;return a?{id:o,pubkey:e.pubkey,method:a,params:c,event:e}:{id:o,result:l,error:u,event:e}}async sendResponse(e,n,s,r=24133,o){const a={id:e,result:s};o&&(a.error=o);const c=await this.signer.user(),l=this.ndk.getUser({pubkey:n}),u=new NDKEvent(this.ndk,{kind:r,content:JSON.stringify(a),tags:[["p",n]],pubkey:c.pubkey});u.content=await this.signer.encrypt(l,u.content,this.encryptionType),await u.sign(this.signer),await u.publish(this.relaySet)}async sendRequest(e,n,s=[],r=24133,o){const a=Math.random().toString(36).substring(7),c=await this.signer.user(),l=this.ndk.getUser({pubkey:e}),u={id:a,method:n,params:s},f=new Promise(()=>{const p=y=>{y.result==="auth_url"?(this.once(`response-${a}`,p),this.emit("authUrl",y.error)):o&&o(y)};this.once(`response-${a}`,p)}),h=new NDKEvent(this.ndk,{kind:r,content:JSON.stringify(u),tags:[["p",e]],pubkey:c.pubkey});return h.content=await this.signer.encrypt(l,h.content,this.encryptionType),await h.sign(this.signer),await h.publish(this.relaySet),f}};function nostrConnectGenerateSecret(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri(t,e,n,s){const r={name:s!=null&&s.name?encodeURIComponent(s.name):"",url:s!=null&&s.url?encodeURIComponent(s.url):"",image:s!=null&&s.image?encodeURIComponent(s.image):"",perms:s!=null&&s.perms?encodeURIComponent(s.perms):""};let o=`nostrconnect://${t}?image=${r.image}&url=${r.url}&name=${r.name}&perms=${r.perms}&secret=${encodeURIComponent(e)}`;return n&&(o+=`&relay=${encodeURIComponent(n)}`),o}var NDKNip46Signer=class Me extends lib$1.EventEmitter{constructor(n,s,r,o,a){super();g(this,"ndk");g(this,"_user");g(this,"bunkerPubkey");g(this,"userPubkey");g(this,"secret");g(this,"localSigner");g(this,"nip05");g(this,"rpc");g(this,"debug");g(this,"relayUrls");g(this,"subscription");g(this,"nostrConnectUri");g(this,"nostrConnectSecret");this.ndk=n,this.debug=n.debug.extend("nip46:signer"),this.relayUrls=o,r?typeof r=="string"?this.localSigner=new NDKPrivateKeySigner(r):this.localSigner=r:this.localSigner=NDKPrivateKeySigner.generate(),s===!1||(s?s.startsWith("bunker://")?this.bunkerFlowInit(s):this.nip05Init(s):this.nostrconnectFlowInit(a)),this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls)}get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}static bunker(n,s,r){return new Me(n,s,r)}static nostrconnect(n,s,r,o){return new Me(n,void 0,r,[s],o)}nostrconnectFlowInit(n){var r;this.nostrConnectSecret=nostrConnectGenerateSecret();const s=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri(s,this.nostrConnectSecret,(r=this.relayUrls)==null?void 0:r[0],n)}bunkerFlowInit(n){const s=new URL(n),r=s.hostname||s.pathname.replace(/^\/\//,""),o=s.searchParams.get("pubkey"),a=s.searchParams.getAll("relay"),c=s.searchParams.get("secret");this.bunkerPubkey=r,this.userPubkey=o,this.relayUrls=a,this.secret=c}nip05Init(n){this.nip05=n}async startListening(){if(this.subscription)return;const n=await this.localSigner.user();if(!n)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[n.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((n,s)=>{const r=o=>{o.result===this.nostrConnectSecret&&(this._user=o.event.author,this.userPubkey=o.event.pubkey,this.bunkerPubkey=o.event.pubkey,this.rpc.off("response",r),n(this._user))};this.startListening(),this.rpc.on("response",r)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const n=await NDKUser.fromNip05(this.nip05,this.ndk);n&&(this._user=n,this.userPubkey=n.pubkey,this.relayUrls=n.nip46Urls,this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...n)=>{this.emit("authUrl",...n)}),new Promise((n,s)=>{const r=[this.userPubkey??""];if(this.secret&&r.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",r,24133,o=>{o.result==="ack"?this.getPublicKey().then(a=>{this.userPubkey=a,this._user=this.ndk.getUser({pubkey:a}),n(this._user)}):s(o.error)})})}stop(){var n;(n=this.subscription)==null||n.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((n,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,r=>{n(r.result)})})}async encryptionEnabled(n){return n?[n]:Promise.resolve(["nip04","nip44"])}async encrypt(n,s,r="nip04"){return this.encryption(n,s,r,"encrypt")}async decrypt(n,s,r="nip04"){return this.encryption(n,s,r,"decrypt")}async encryption(n,s,r,o){return new Promise((c,l)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${r}_${o}`,[n.pubkey,s],24133,u=>{u.error?l(u.error):c(u.result)})})}async sign(n){return new Promise((r,o)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(n)],24133,a=>{if(a.error)o(a.error);else{const c=JSON.parse(a.result);r(c.sig)}})})}async createAccount(n,s,r){await this.startListening();const o=[];return n&&o.push(n),s&&o.push(s),r&&o.push(r),new Promise((a,c)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",o,24133,l=>{if(l.error)c(l.error);else{const u=l.result;a(u)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const n={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(n)}static async fromPayload(n,s){if(!s)throw new Error("NDK instance is required to deserialize NIP-46 signer");const r=JSON.parse(n);if(r.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${r.type}`);const o=r.payload;if(!o||typeof o!="object"||!o.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const a=await ndkSignerFromPayload(o.localSignerPayload,s);if(!a)throw new Error("Failed to deserialize local signer for NIP-46");if(!(a instanceof NDKPrivateKeySigner))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let c;return c=new Me(s,!1,a,o.relayUrls),c.userPubkey=o.userPubkey,c.bunkerPubkey=o.bunkerPubkey,c.relayUrls=o.relayUrls,c.secret=o.secret,o.userPubkey&&(c._user=new NDKUser({pubkey:o.userPubkey}),c._user&&(c._user.ndk=s)),c}};registerSigner("nip46",NDKNip46Signer);createDebug5("ndk:zapper:ln");createDebug5("ndk:zapper");const index=Object.freeze(Object.defineProperty({__proto__:null,BECH32_REGEX,NDKAppHandlerEvent,NDKArticle,NDKBlossomList,NDKCashuMintAnnouncement,NDKCashuMintList,NDKClassified,NDKDVMJobFeedback,NDKDraft,NDKEvent,NDKFedimintMint,NDKFollowPack,NDKHighlight,NDKImage,NDKKind,NDKList,NDKMintRecommendation,NDKNip07Signer,NDKNip46Signer,NDKNostrRpc,NDKNutzap,NDKPool,NDKPrivateKeySigner,NDKProject,NDKProjectTemplate,NDKPublishError,NDKRelay,NDKRelayAuthPolicies,NDKRelayList,NDKRelaySet,NDKRepost,NDKSimpleGroupMemberList,NDKSimpleGroupMetadata,NDKStory,NDKStorySticker,NDKSubscription,NDKSubscriptionReceipt,NDKSubscriptionStart,NDKSubscriptionTier,NDKTask,NDKThread,NDKUser,NDKVideo,NDKWiki,NDKWikiMergeRequest,NIP33_A_REGEX,calculateRelaySetFromEvent,default:NDK,defaultOpts,deserialize,eventHasETagMarkers,fetchRelayInformation,filterFingerprint,filterFromId,generateContentTags,generateHashtags,getRelayListForUser,getRelayListForUsers,getReplyTag,getRootTag,imetaTagToTag,isNip33AValue,isValidHex64,isValidNip05,isValidPubkey,mapImetaTag,mergeFilters,mergeTags,ndkSignerFromPayload,newAmount,nip19:nip19_exports,nip49:nip49_exports,normalize,normalizeRelayUrl,normalizeUrl,parseTagToSubscriptionAmount,possibleIntervalFrequencies,processFilters,profileFromEvent,queryFullyFilled,registerSigner,relayListFromKind3,relaysFromBech32,serialize,serializeProfile,strToDimension,strToPosition,tryNormalizeRelayUrl,wrapEvent},Symbol.toStringTag,{value:"Module"})),DEFAULT_RELAYS=["wss://relay.damus.io","wss://nostr.wine","wss://relay.nostr.net","wss://relay.nostr.band","wss://nos.lol","wss://nostr-pub.wellorder.net","wss://relay.getalby.com","wss://relay.primal.net"],MILLISATS_PER_SAT=1e3,DEFAULT_PROFILE_IMAGE="./assets/default_dp.png",xe=class xe{constructor(){g(this,"ndk");g(this,"isConnected",!1);this.ndk=new NDK}static getInstance(){return xe.instance||(xe.instance=new xe),xe.instance}async connectToNostr(e=[...DEFAULT_RELAYS]){const n=e.filter(s=>!this.getRelays().includes(s));if(this.isConnected&&n.length){n.forEach(s=>this.ndk.addExplicitRelay(s));return}this.ndk.explicitRelayUrls=e,await this.ndk.connect(),this.isConnected=!0}getRelays(){return this.ndk.explicitRelayUrls||DEFAULT_RELAYS}async resolveNDKUser(e){return e.npub?this.ndk.getUser({npub:e.npub}):e.nip05?await this.ndk.getUserFromNip05(e.nip05)??null:e.pubkey?this.ndk.getUser({pubkey:e.pubkey}):null}async resolveNDKEvent(e){return e.hex?this.ndk.fetchEvent(e.hex):null}async getZapCount(e){const n=await this.resolveNDKUser(e);return n?this.fetchZaps(n):0}async getProfile(e){if(!e)return null;await e.fetchProfile();const n=e.profile;return n&&(n.picture===void 0||n.picture===null)&&(n.picture=DEFAULT_PROFILE_IMAGE),n}async getPost(e){const n=await this.ndk.fetchEvent(e);if(!n)return null;const s=n.getMatchingTags("e");if(s.length>0){const o=s.map(a=>a[1]);await this.ndk.fetchEvents({ids:o})}const r=n.getMatchingTags("a");for(const o of r){const a=o[1],c=o[2];a!=null&&a.startsWith("video/")&&c&&(n.content=n.content+`
${c}`)}return n}async fetchFollows(e){try{return(await e.followSet()).size}catch{return 0}}async fetchFollowers(e){try{const n=await this.ndk.fetchEvents({kinds:[NDKKind.Contacts],"#p":[e.pubkey]}),s=new Set;return n.forEach(o=>s.add(o.pubkey)),s.size}catch{return 0}}async fetchNotesAndReplies(e){try{const n=await this.ndk.fetchEvents({kinds:[NDKKind.Text],authors:[e.pubkey],limit:1e3});let s=0,r=0;n.forEach(c=>{c&&(c.tags.some(u=>u[0]==="e"&&u[3]!=="mention")&&s++,r++)});const o=s;return[Math.max(0,r-s),o]}catch{return[0,0]}}async fetchZaps(e){try{return(await this.ndk.fetchEvents({kinds:[9735],"#p":[e.pubkey],limit:1e3})).size}catch{return 0}}getNDK(){return this.ndk}hasSigner(){return typeof window<"u"&&window.nostr||typeof window<"u"&&typeof localStorage<"u"&&localStorage.getItem("nostr_nsec")?!0:!!this.ndk.signer}};g(xe,"instance");let NostrService=xe;export{DEFAULT_PROFILE_IMAGE as D,MILLISATS_PER_SAT as M,NDKNip07Signer as N,SimplePool as S,nip19_exports$1 as a,NostrService as b,DEFAULT_RELAYS as c,NDKEvent as d,NDKKind as e,bytesToHex$2 as f,sha256$2 as g,nip57_exports as h,finalizeEvent as i,index$1 as j,index as k,nip21_exports as n,schnorr$1 as s};
//# sourceMappingURL=nostr-service-CP2wXEbP.js.map
