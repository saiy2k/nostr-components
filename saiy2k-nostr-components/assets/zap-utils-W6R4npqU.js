import{S as E,h as N,i as P}from"./nostr-service-CP2wXEbP.js";import{e as R,s as S}from"./nostr-login-service-D2FmscPI.js";import{n as k}from"./utils--bxLbhGF.js";import"./preload-helper-D7HrI6pR.js";const d={},x=async t=>{if(d[t])return d[t];const e=new E,s=["wss://relay.nostr.band","wss://purplepag.es","wss://relay.damus.io","wss://nostr.wine"];try{const a=await e.get(s,{authors:[t],kinds:[0]});return d[t]=a,a}finally{e.close(s)}},D=async t=>{const e=t.filter(r=>!d[r]);if(e.length===0)return t.map(r=>({id:r,profile:d[r]}));const s=new E,a=["wss://relay.nostr.band","wss://purplepag.es","wss://relay.damus.io","wss://nostr.wine"];try{return(await s.querySync(a,{authors:e,kinds:[0]})).forEach(n=>{d[n.pubkey]=n}),t.map(n=>({id:n,profile:d[n]||null}))}finally{s.close(a)}},J=t=>{try{return JSON.parse((t==null?void 0:t.content)||"{}")}catch{return{}}},I=async t=>{const e=await N.getZapEndpoint(t);if(!e)throw new Error("Failed to retrieve zap LNURL");return e},L=async(t,e)=>{try{return await R(),await S(t)}catch{}return P(t,C())},Z=async({profile:t,nip19Target:e,amount:s,relays:a,comment:r,anon:i,url:n})=>{const f={profile:t,amount:s,relays:a,comment:r||""},c=N.makeZapRequest(f);n&&(c.tags.push(["k","web"]),c.tags.push(["i",k(n)]));let l=!1;try{await R(),l=typeof window<"u"&&!!window.nostr}catch{l=!1}return(!l||i)&&c.tags.push(["anon"]),L(c)},M=async({zapEndpoint:t,amount:e,comment:s,authorId:a,nip19Target:r,normalizedRelays:i,anon:n,url:f})=>{const c=await Z({profile:a,nip19Target:r,amount:e,relays:i,comment:s??"",anon:n,url:f});let l=`${t}?amount=${e}&nostr=${encodeURIComponent(JSON.stringify(c))}`;s&&(l+=`&comment=${encodeURIComponent(s??"")}`);const p=await fetch(l,{method:"GET"});if(!p.ok)throw new Error(`LNURL request failed: ${p.status} ${p.statusText}`);let m;try{m=await p.json()}catch{throw new Error("Invalid JSON from LNURL endpoint")}const{pr:h,reason:b,status:g}=m||{};if(h)return h;throw g==="ERROR"?new Error(b??"Unable to fetch invoice"):new Error("Unable to fetch invoice")},C=()=>{const t=new Uint8Array(32);if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function")crypto.getRandomValues(t);else{console.warn("crypto.getRandomValues not available, using Math.random as fallback");for(let e=0;e<32;e++)t[e]=Math.floor(Math.random()*256)}return t},V=async({pubkey:t,relays:e,url:s})=>{var f,c,l,p;const a=s?k(s):void 0,r=new E;let i=0;const n=[];try{const m={kinds:[9735],"#p":[t],limit:1e3},h=await r.querySync(e,m);for(const b of h){const g=(f=b.tags)==null?void 0:f.find(o=>o[0]==="description");if(g!=null&&g[1])try{const o=JSON.parse(g[1]),w=(c=o==null?void 0:o.tags)==null?void 0:c.find(u=>u[0]==="amount");if(a){const u=(l=o==null?void 0:o.tags)==null?void 0:l.find(y=>y[0]==="k"),v=(p=o==null?void 0:o.tags)==null?void 0:p.find(y=>y[0]==="i"),U=v!=null&&v[1]?k(v[1]):"";if((u==null?void 0:u[1])==="web"&&U===a&&(w!=null&&w[1])){const y=parseInt(w[1],10);y>0&&(i+=y,n.push({amount:y/1e3,date:new Date(b.created_at*1e3),authorPubkey:o.pubkey,comment:o.content}))}}else if(w!=null&&w[1]){const u=parseInt(w[1],10);u>0&&(i+=u,n.push({amount:u/1e3,date:new Date(b.created_at*1e3),authorPubkey:o.pubkey,comment:o.content}))}}catch(o){console.error("Nostr-Components: Zap button: Could not parse zap request from description tag",o)}}}catch(m){console.error("Nostr-Components: Zap button: Error fetching zap receipts",m)}finally{r.close(e)}return n.sort((m,h)=>h.date.getTime()-m.date.getTime()),{totalAmount:i/1e3,zapDetails:n}},_=({relays:t,receiversPubKey:e,invoice:s,onSuccess:a})=>{const r=new E,i=Array.from(new Set([...t,"wss://relay.nostr.band"])),n=Math.floor((Date.now()-24*60*60*1e3)/1e3);r.subscribe(i,{kinds:[9735],"#p":[e],since:n},{onevent(c){c.tags.some(p=>p[0]==="bolt11"&&p[1]===s)&&(a(),f())}});const f=()=>{r.close(i)};return f};export{J as extractProfileMetadataContent,M as fetchInvoice,V as fetchTotalZapAmount,D as getBatchedProfileMetadata,x as getProfileMetadata,I as getZapEndpoint,_ as listenForZapReceipt};
//# sourceMappingURL=zap-utils-W6R4npqU.js.map
